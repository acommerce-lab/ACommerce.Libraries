using System.ComponentModel.DataAnnotations.Schema;
using ACommerce.Accounting.Core.Enums;
using ACommerce.SharedKernel.Abstractions.Entities;
using System.ComponentModel.DataAnnotations.Schema;

namespace ACommerce.Accounting.Core.Entities;

/// <summary>
/// ????? ????????
/// </summary>
public class AccountingEntry : IBaseEntity
{
	public Guid Id { get; set; }
	public DateTime CreatedAt { get; set; }
	public DateTime? UpdatedAt { get; set; }
	public bool IsDeleted { get; set; }

	/// <summary>
	/// ??? ?????
	/// </summary>
	public required string Number { get; set; }

	/// <summary>
	/// ??? ?????
	/// </summary>
	public EntryType Type { get; set; }

	/// <summary>
	/// ????? ?????
	/// </summary>
	public DateTime Date { get; set; }

	/// <summary>
	/// ?????/??????
	/// </summary>
	public required string Description { get; set; }

	/// <summary>
	/// ???? ??????? ???????? (?? Transactions)
	/// </summary>
	public Guid? SourceDocumentId { get; set; }

	/// <summary>
	/// ??? ??????? ????????
	/// </summary>
	public Guid? SourceDocumentTypeId { get; set; }

	/// <summary>
	/// ??? ??????? ????????
	/// </summary>
	public string? SourceDocumentNumber { get; set; }

	/// <summary>
	/// ???? ??? ??????? ??????? (??? ??? ????? ?? ???)
	/// </summary>
	public Guid? SourceDocumentItemId { get; set; }

	/// <summary>
	/// ??????
	/// </summary>
	public EntryStatus Status { get; set; } = EntryStatus.Draft;

	/// <summary>
	/// ????? ???????
	/// </summary>
	public DateTime? PostedDate { get; set; }

	/// <summary>
	/// ???? ???????? ???? ????
	/// </summary>
	public string? PostedByUserId { get; set; }

	/// <summary>
	/// ????? ????????
	/// </summary>
	public DateTime? ApprovedDate { get; set; }

	/// <summary>
	/// ???? ???????? ???? ?????
	/// </summary>
	public string? ApprovedByUserId { get; set; }

	/// <summary>
	/// ???? ????? ??????? (??? ?? ??? ??? ?????)
	/// </summary>
	public Guid? ReversedByEntryId { get; set; }
	public AccountingEntry? ReversedByEntry { get; set; }

	/// <summary>
	/// ???? ????? ?????? (??? ??? ??? ????? ??? ???? ???)
	/// </summary>
	public Guid? ReversalOfEntryId { get; set; }
	public AccountingEntry? ReversalOfEntry { get; set; }

	/// <summary>
	/// ????? ???????
	/// </summary>
	public int FiscalYear { get; set; }

	/// <summary>
	/// ?????? ??????? (?????)
	/// </summary>
	public int FiscalPeriod { get; set; }

	/// <summary>
	/// ??????? ??????
	/// </summary>
	[NotMapped]
	public Dictionary<string, string> Metadata { get; set; } = new();

	/// <summary>
	/// ????? ????? (????????: ???? ?????)
	/// </summary>
	public List<EntrySide> Sides { get; set; } = new();

	/// <summary>
	/// ?????? ?? ????? ?????
	/// </summary>
	public bool IsBalanced()
	{
		var totalDebitAmount = Sides.Sum(s => s.DebitAmount ?? 0);
		var totalCreditAmount = Sides.Sum(s => s.CreditAmount ?? 0);

		return Math.Abs(totalDebitAmount - totalCreditAmount) < 0.01m; // ??????? ?? ?????? ???????
	}
}

