using ACommerce.Notifications.Abstractions.Enums;
using System.ComponentModel.DataAnnotations.Schema;

namespace ACommerce.Notifications.Abstractions.Models;

/// <summary>
/// ???? ????? ??? ?????? ??? ???????? ??? ????? ??????
/// </summary>
public record Notification
{
	/// <summary>
	/// ???? ???? ???????
	/// </summary>
	public Guid Id { get; init; } = Guid.NewGuid();

	/// <summary>
	/// ???? ???????? ???????
	/// </summary>
	public required string UserId { get; init; }

	/// <summary>
	/// ????? ???????
	/// </summary>
	public required string Title { get; init; }

	/// <summary>
	/// ????? ???????
	/// </summary>
	public required string Message { get; init; }

	/// <summary>
	/// ??? ???????
	/// </summary>
	public NotificationType Type { get; init; } = NotificationType.Info;

	/// <summary>
	/// ?????? ???????
	/// </summary>
	public NotificationPriority Priority { get; init; } = NotificationPriority.Normal;

	/// <summary>
	/// ????? ????? ???????
	/// </summary>
	public DateTimeOffset CreatedAt { get; init; } = DateTimeOffset.UtcNow;

	/// <summary>
	/// ????? ????? ??????? (??????? ??????)
	/// </summary>
	public DateTimeOffset? ScheduledAt { get; init; }

	/// <summary>
	/// ????? ?????? ?????? ???????
	/// </summary>
	public DateTimeOffset? ExpiresAt { get; init; }

    /// <summary>
    /// ?????? ?????? ?????? ????????
    /// </summary>
    [NotMapped] public Dictionary<string, string>? Data { get; init; }

	/// <summary>
	/// ??????? ??????? ????? ??????? ????? ?? ???? ?? ????
	/// </summary>
	public List<ChannelDelivery> Channels { get; init; } = [];

	/// <summary>
	/// ???? ??????? (Action URL) ??? ????? ??? ???????
	/// </summary>
	public string? ActionUrl { get; init; }

	/// <summary>
	/// ???? ?????? ??????? ????????
	/// </summary>
	public string? ImageUrl { get; init; }

	/// <summary>
	/// ??? ??????? (????????? ???????)
	/// </summary>
	public string? Sound { get; init; }

	/// <summary>
	/// Badge count (???????? ????????)
	/// </summary>
	public int? BadgeCount { get; init; }

	/// <summary>
	/// ?? ????? ?????? ????????
	/// </summary>
	public bool IsExpired => ExpiresAt.HasValue && ExpiresAt.Value < DateTimeOffset.UtcNow;

	/// <summary>
	/// ?? ??????? ????? ?????????
	/// </summary>
	public bool IsScheduled => ScheduledAt.HasValue && ScheduledAt.Value > DateTimeOffset.UtcNow;

	/// <summary>
	/// ?? ?? ????? ??????? ????? ??? ???? ????????
	/// </summary>
	public bool IsFullyDelivered => Channels.All(c => c.Status == DeliveryStatus.Sent);

	/// <summary>
	/// ?? ?? ????? ??????? ????? ??? ???? ????? ??? ??????
	/// </summary>
	public bool IsPartiallyDelivered => Channels.Any(c => c.Status == DeliveryStatus.Sent);

	/// <summary>
	/// ?? ??? ??????? ??? ???? ????????
	/// </summary>
	public bool IsCompletelyFailed => Channels.All(c =>
		c.Status == DeliveryStatus.Failed && !c.CanRetry());
}

