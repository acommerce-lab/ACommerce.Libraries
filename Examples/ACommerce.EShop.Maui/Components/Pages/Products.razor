@page "/products"
@using ACommerce.Client.Products
@inject ProductsClient ProductsClient

<PageTitle>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - ACommerce Shop</PageTitle>

<h1>ğŸ“¦ ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>

<div class="filters-section mb-3">
    <SfTextBox Placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." @bind-Value="@searchQuery" />
    <SfButton CssClass="e-primary" @onclick="SearchProducts">Ø¨Ø­Ø«</SfButton>
    <SfButton CssClass="e-info" @onclick="LoadProducts">ØªØ­Ø¯ÙŠØ«</SfButton>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="error-message">
        <p>âš ï¸ @errorMessage</p>
        <small>ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Backend API Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 5001</small>
    </div>
}

@if (isLoading)
{
    <div class="text-center">
        <div class="loading-spinner"></div>
        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
    </div>
}
else if (products?.Any() == true)
{
    <div class="products-grid">
        @foreach (var product in products)
        {
            <div class="product-card">
                <img src="@(product.FeaturedImage ?? "https://via.placeholder.com/300x200?text=ğŸ“¦")"
                     alt="@product.Name"
                     class="product-image" />
                <div class="p-2">
                    <h3 class="product-title">@product.Name</h3>
                    <p class="text-secondary">@(product.ShortDescription ?? "Ø¨Ø¯ÙˆÙ† ÙˆØµÙ")</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="product-price">@GetFormattedPrice(product)</span>
                        <SfButton CssClass="e-success" @onclick="() => AddToCart(product)">
                            Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø© ğŸ›’
                        </SfButton>
                    </div>
                </div>
            </div>
        }
    </div>
}
else if (!isLoading)
{
    <div class="text-center p-3">
        <p class="empty-icon">ğŸ“¦</p>
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>
        <SfButton CssClass="e-info" @onclick="LoadProducts">ØªØ­Ø¯ÙŠØ«</SfButton>
    </div>
}

@code {
    private List<ProductDto>? products;
    private string searchQuery = string.Empty;
    private bool isLoading = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();

            // Try to load from API
            products = await ProductsClient.GetAllAsync();

            // If API returns empty, show demo data
            if (products == null || products.Count == 0)
            {
                products = GetDemoProducts();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading products: {ex.Message}");
            errorMessage = $"ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…";

            // Fallback to demo data
            products = GetDemoProducts();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private List<ProductDto> GetDemoProducts() => new()
    {
        new() { Id = Guid.NewGuid(), Name = "Ø¢ÙŠÙÙˆÙ† 15 Ø¨Ø±Ùˆ", ShortDescription = "Ø£Ø­Ø¯Ø« Ù‡ÙˆØ§ØªÙ Ø¢Ø¨Ù„", Price = 4999, Currency = "SAR" },
        new() { Id = Guid.NewGuid(), Name = "Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬ Ø¬Ø§Ù„Ø§ÙƒØ³ÙŠ S24", ShortDescription = "Ù‡Ø§ØªÙ Ø°ÙƒÙŠ Ù…ØªØ·ÙˆØ±", Price = 3999, Currency = "SAR" },
        new() { Id = Guid.NewGuid(), Name = "Ù…Ø§Ùƒ Ø¨ÙˆÙƒ Ø¨Ø±Ùˆ", ShortDescription = "Ù„Ø§Ø¨ØªÙˆØ¨ Ø§Ø­ØªØ±Ø§ÙÙŠ", Price = 8999, Currency = "SAR" },
        new() { Id = Guid.NewGuid(), Name = "Ø¢ÙŠØ¨Ø§Ø¯ Ø¨Ø±Ùˆ", ShortDescription = "ØªØ§Ø¨Ù„Øª Ù„Ù„Ù…Ø­ØªØ±ÙÙŠÙ†", Price = 3499, Currency = "SAR" }
    };

    private async Task SearchProducts()
    {
        await LoadProducts();
    }

    private string GetFormattedPrice(ProductDto product)
    {
        var price = product.Price ?? 0;
        var currency = product.Currency ?? "SAR";
        return currency == "SAR" ? $"{price:N0} Ø±.Ø³" : $"{price:N2} {currency}";
    }

    private void AddToCart(ProductDto product)
    {
        Console.WriteLine($"Added {product.Name} to cart");
    }
}

<style>
    .filters-section {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        text-align: center;
    }

    .empty-icon {
        font-size: 4rem;
    }

    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
    }

    .product-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .product-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .product-title {
        font-size: 1.1rem;
        margin: 0 0 0.5rem;
    }

    .product-price {
        font-size: 1.2rem;
        font-weight: bold;
        color: #6200ea;
    }

    .p-2 {
        padding: 1rem;
    }

    .d-flex {
        display: flex;
    }

    .justify-content-between {
        justify-content: space-between;
    }

    .align-items-center {
        align-items: center;
    }

    .text-secondary {
        color: #666;
        margin: 0 0 1rem;
    }
</style>
