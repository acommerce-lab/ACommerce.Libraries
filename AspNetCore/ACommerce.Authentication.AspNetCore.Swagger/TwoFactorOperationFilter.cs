using Microsoft.OpenApi;
using Microsoft.OpenApi.Any;
using Microsoft.OpenApi.Models;
using Swashbuckle.AspNetCore.SwaggerGen;
using System.Text.Json;

namespace ACommerce.Authentication.AspNetCore.Swagger;

/// <summary>
/// Custom operation filter to enhance Swagger documentation for 2FA endpoints
/// </summary>
public class TwoFactorOperationFilter : IOperationFilter
{
	public void Apply(OpenApiOperation operation, OperationFilterContext context)
	{
		var actionName = context.ApiDescription.ActionDescriptor.RouteValues["action"];

		switch (actionName?.ToLower())
		{
			case "initiatetwofactor":
				operation.Summary = "??? ???????? ????????";
				operation.Description = "???? ????? ???????? ???????? ???????? ?????? ?????? (????? SMS? ???)";

				// ? ?????: ??????? OpenApiTag ???? ????
				if (operation.Tags == null || operation.Tags.Count == 0)
				{
					operation.Tags = [new() { Name = "???????? ????????" }];
				}

				// Add response examples
				AddResponseExample(operation, "200", new
				{
					success = true,
					transactionId = "550e8400-e29b-41d4-a716-446655440000",
					verificationCode = "00",
					message = "???? ?????? ?? ???? ????? ????",
					expiresIn = 300,
					provider = "Nafath"
				});

				AddResponseExample(operation, "400", new
				{
					error = "NAFATH_API_ERROR",
					message = "??? ??????? ????? ????"
				});
			break;

			case "verifytwofactor":
				operation.Summary = "?????? ?? ???????? ????????";
				operation.Description = "????? ?? ????? ???????? ???????? ?????? ??? ?????? (Access Token)";

				if (operation.Tags == null || operation.Tags.Count == 0)
				{
					operation.Tags = [new() { Name = "???????? ????????" }];
				}

				AddResponseExample(operation, "200", new
				{
					success = true,
					accessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
					refreshToken = "refresh_token_here",
					tokenType = "Bearer",
					expiresAt = "2024-12-31T23:59:59Z",
					userId = "2507643761"
				});
			break;

			case "canceltwofactor":
				operation.Summary = "????? ???????? ????????";
				operation.Description = "???? ???? ???????? ???????? ???????";

				if (operation.Tags == null || operation.Tags.Count == 0)
				{
					operation.Tags = [new() { Name = "???????? ????????" }];
				}
			break;

			case "refreshtoken":
				operation.Summary = "????? ??? ??????";
				operation.Description = "???? ??? ?????? ???????? ??? ??????? (Refresh Token)";

				if (operation.Tags == null || operation.Tags.Count == 0)
				{
					operation.Tags = [new() { Name = "????? ??????" }];
				}
			break;

			case "getinfo":
				operation.Summary = "??????? ???????";
				operation.Description = "???? ??????? ?? ?????? ???????? ?????????";

				if (operation.Tags == null || operation.Tags.Count == 0)
				{
					operation.Tags = [new() { Name = "??????? ??????" }];
				}
			break;
		}
	}

	private void AddResponseExample(OpenApiOperation operation, string statusCode, object example)
	{
		if (!operation.Responses.ContainsKey(statusCode))
		{
			operation.Responses.Add(statusCode, new OpenApiResponse
			{
				Description = statusCode == "200" ? "Success" : "Error"
			});
		}

		var response = operation.Responses[statusCode];

		if (response.Content == null)
		{
			response.Content.TryAdd("application/json", new OpenApiMediaType());
		}

		if (!response.Content.ContainsKey("application/json"))
		{
			response.Content["application/json"] = new OpenApiMediaType();
		}

		// ? ?????: ??????? OpenApiString ????? ?? OpenApiAnyFactory
		var jsonString = JsonSerializer.Serialize(example, new JsonSerializerOptions
		{
			WriteIndented = true
		});

		response.Content["application/json"].Example = new OpenApiString(jsonString);
	}
}

