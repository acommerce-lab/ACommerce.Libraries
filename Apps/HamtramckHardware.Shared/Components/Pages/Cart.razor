@page "/cart"
@using ACommerce.Templates.Customer.Pages
@inject ILocalizationService L
@inject IAppNavigationService Navigation
@inject CartClient CartClient

<CartPage Items="@_cartItems"
          IsLoading="@_isLoading"
          Currency="$"
          Subtotal="@_subtotal"
          Discount="@_discount"
          ShippingCost="@_shipping"
          Tax="@_tax"
          TaxRate="6"
          Total="@_total"
          FreeShippingThreshold="50"
          AppliedCoupon="@_appliedCoupon"
          OnQuantityChange="HandleQuantityChange"
          OnRemoveItem="HandleRemoveItem"
          OnApplyCoupon="HandleApplyCoupon"
          OnRemoveCoupon="HandleRemoveCoupon"
          OnCheckout="HandleCheckout"
          OnStartShopping="HandleStartShopping" />

@code {
    private bool _isLoading = true;
    private List<CartItemModel> _cartItems = new();
    private decimal _subtotal = 0;
    private decimal _discount = 0;
    private decimal _tax = 0;
    private decimal _shipping = 0;
    private decimal _total = 0;
    private CouponModel? _appliedCoupon;

    protected override async Task OnInitializedAsync()
    {
        await LoadCart();
    }

    private async Task LoadCart()
    {
        try
        {
            _isLoading = true;
            await Task.Delay(300);

            // Mock cart data
            _cartItems = new List<CartItemModel>
            {
                new() {
                    Id = Guid.NewGuid(),
                    ProductId = Guid.NewGuid(),
                    Name = "DeWalt 20V MAX XR Brushless Drill/Driver Kit",
                    Price = 149.99m,
                    OldPrice = 179.99m,
                    Quantity = 1,
                    MaxQuantity = 10,
                    ImageUrl = "/images/products/drill.jpg",
                    Attributes = new() { { "Brand", "DeWalt" }, { "Voltage", "20V" } }
                },
                new() {
                    Id = Guid.NewGuid(),
                    ProductId = Guid.NewGuid(),
                    Name = "Copper Pipe Fittings Set 1/2\"",
                    Price = 24.99m,
                    Quantity = 2,
                    MaxQuantity = 50,
                    ImageUrl = "/images/products/fittings.jpg",
                    Variant = "1/2 inch",
                    Attributes = new() { { "Size", "1/2\"" } }
                },
                new() {
                    Id = Guid.NewGuid(),
                    ProductId = Guid.NewGuid(),
                    Name = "Southwire Romex 12/2 NM-B Wire 250ft",
                    Price = 89.99m,
                    OldPrice = 99.99m,
                    Quantity = 1,
                    MaxQuantity = 20,
                    ImageUrl = "/images/products/romex.jpg",
                    Variant = "250ft",
                    Attributes = new() { { "Length", "250ft" }, { "Gauge", "12/2" } }
                },
            };

            CalculateTotals();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading cart: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void CalculateTotals()
    {
        _subtotal = _cartItems.Sum(i => i.Price * i.Quantity);
        _shipping = _subtotal >= 50 ? 0 : 5.99m;
        _tax = (_subtotal - _discount) * 0.06m; // Michigan sales tax
        _total = _subtotal - _discount + _shipping + _tax;
    }

    private async Task HandleQuantityChange((Guid ItemId, int Quantity) change)
    {
        var item = _cartItems.FirstOrDefault(i => i.Id == change.ItemId);
        if (item != null)
        {
            item.Quantity = Math.Max(1, Math.Min(change.Quantity, item.MaxQuantity));
            CalculateTotals();
        }
    }

    private async Task HandleRemoveItem(Guid itemId)
    {
        _cartItems.RemoveAll(i => i.Id == itemId);
        CalculateTotals();
    }

    private async Task HandleApplyCoupon(string code)
    {
        // Mock coupon validation
        if (code.ToUpper() == "SAVE10")
        {
            _appliedCoupon = new CouponModel
            {
                Code = code.ToUpper(),
                DiscountPercent = 10
            };
            _discount = _subtotal * 0.10m;
        }
        else if (code.ToUpper() == "HARDWARE20")
        {
            _appliedCoupon = new CouponModel
            {
                Code = code.ToUpper(),
                DiscountPercent = 20
            };
            _discount = _subtotal * 0.20m;
        }
        else
        {
            _appliedCoupon = null;
            _discount = 0;
        }

        CalculateTotals();
    }

    private async Task HandleRemoveCoupon()
    {
        _appliedCoupon = null;
        _discount = 0;
        CalculateTotals();
    }

    private async Task HandleCheckout()
    {
        Navigation.NavigateTo("/checkout");
    }

    private async Task HandleStartShopping()
    {
        Navigation.NavigateTo("/");
    }
}
