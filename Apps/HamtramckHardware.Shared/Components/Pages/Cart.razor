@page "/cart"
@using ACommerce.Templates.Customer.Pages
@using Microsoft.Extensions.Logging
@inject ILocalizationService L
@inject IAppNavigationService Navigation
@inject CartClient CartClient
@inject TokenManager TokenManager
@inject ILogger<Cart> Logger

<CartPage Items="@_cartItems"
          IsLoading="@_isLoading"
          Currency="$"
          Subtotal="@_subtotal"
          Discount="@_discount"
          ShippingCost="@_shipping"
          Tax="@_tax"
          TaxRate="6"
          Total="@_total"
          FreeShippingThreshold="50"
          AppliedCoupon="@_appliedCoupon"
          OnQuantityChange="HandleQuantityChange"
          OnRemoveItem="HandleRemoveItem"
          OnApplyCoupon="HandleApplyCoupon"
          OnRemoveCoupon="HandleRemoveCoupon"
          OnCheckout="HandleCheckout"
          OnStartShopping="HandleStartShopping" />

@code {
    private bool _isLoading = true;
    private List<CartItemModel> _cartItems = new();
    private decimal _subtotal = 0;
    private decimal _discount = 0;
    private decimal _tax = 0;
    private decimal _shipping = 0;
    private decimal _total = 0;
    private CouponModel? _appliedCoupon;

    protected override async Task OnInitializedAsync()
    {
        await LoadCart();
    }

    private async Task LoadCart()
    {
        try
        {
            _isLoading = true;

            // Try to get cart from API using session ID
            var sessionId = await GetOrCreateSessionId();

            try
            {
                var cartResponse = await CartClient.GetCartAsync(sessionId);
                if (cartResponse?.Items != null && cartResponse.Items.Any())
                {
                    _cartItems = cartResponse.Items.Select(item => new CartItemModel
                    {
                        Id = item.Id,
                        ProductId = item.ProductId,
                        Name = item.ProductName,
                        Price = item.UnitPrice,
                        OldPrice = item.OldPrice,
                        Quantity = item.Quantity,
                        MaxQuantity = 99,
                        ImageUrl = item.ImageUrl,
                        Variant = item.VariantName
                    }).ToList();

                    CalculateTotals();
                    Logger.LogInformation("Cart loaded from API with {Count} items", _cartItems.Count);
                    return;
                }
            }
            catch (Exception apiEx)
            {
                Logger.LogWarning(apiEx, "Failed to load cart from API, starting with empty cart");
            }

            // Start with empty cart (no more mock data)
            _cartItems = new List<CartItemModel>();
            CalculateTotals();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading cart");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task<string> GetOrCreateSessionId()
    {
        // Try to get user token first
        var token = await TokenManager.GetTokenAsync();
        if (!string.IsNullOrEmpty(token))
        {
            // Parse user ID from token if available
            return $"user-{token.GetHashCode():X8}";
        }

        // Use a guest session ID (in production, this should be stored in browser)
        return $"guest-{Guid.NewGuid():N}";
    }

    private void CalculateTotals()
    {
        _subtotal = _cartItems.Sum(i => i.Price * i.Quantity);
        _shipping = _subtotal >= 50 ? 0 : 5.99m;
        _tax = (_subtotal - _discount) * 0.06m; // Michigan sales tax
        _total = _subtotal - _discount + _shipping + _tax;
    }

    private async Task HandleQuantityChange((Guid ItemId, int Quantity) change)
    {
        var item = _cartItems.FirstOrDefault(i => i.Id == change.ItemId);
        if (item != null)
        {
            item.Quantity = Math.Max(1, Math.Min(change.Quantity, item.MaxQuantity));
            CalculateTotals();
        }
    }

    private async Task HandleRemoveItem(Guid itemId)
    {
        _cartItems.RemoveAll(i => i.Id == itemId);
        CalculateTotals();
    }

    private async Task HandleApplyCoupon(string code)
    {
        // Mock coupon validation
        if (code.ToUpper() == "SAVE10")
        {
            _appliedCoupon = new CouponModel
            {
                Code = code.ToUpper(),
                DiscountPercent = 10
            };
            _discount = _subtotal * 0.10m;
        }
        else if (code.ToUpper() == "HARDWARE20")
        {
            _appliedCoupon = new CouponModel
            {
                Code = code.ToUpper(),
                DiscountPercent = 20
            };
            _discount = _subtotal * 0.20m;
        }
        else
        {
            _appliedCoupon = null;
            _discount = 0;
        }

        CalculateTotals();
    }

    private async Task HandleRemoveCoupon()
    {
        _appliedCoupon = null;
        _discount = 0;
        CalculateTotals();
    }

    private async Task HandleCheckout()
    {
        Navigation.NavigateTo("/checkout");
    }

    private async Task HandleStartShopping()
    {
        Navigation.NavigateTo("/");
    }
}
