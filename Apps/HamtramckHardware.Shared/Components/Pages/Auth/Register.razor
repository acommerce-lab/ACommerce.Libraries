@page "/register"
@using ACommerce.Templates.Customer.Components
@inject ILocalizationService L
@inject IAppNavigationService Navigation
@inject TokenManager TokenManager
@inject AuthClient AuthClient

<div class="hh-register-page">
    <div class="hh-register-card">
        <div class="hh-register-header">
            <i class="bi bi-tools"></i>
            <h1>Create Account</h1>
            <p>Join Hamtramck Hardware</p>
        </div>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="hh-alert hh-alert-error">
                <i class="bi bi-exclamation-circle"></i>
                @_errorMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <div class="hh-alert hh-alert-success">
                <i class="bi bi-check-circle"></i>
                @_successMessage
            </div>
        }

        <EditForm Model="_model" OnValidSubmit="HandleRegister" FormName="registerForm">
            <div class="hh-form-row">
                <div class="hh-form-group">
                    <label>First Name *</label>
                    <input type="text" @bind="_model.FirstName" placeholder="John" required />
                </div>
                <div class="hh-form-group">
                    <label>Last Name *</label>
                    <input type="text" @bind="_model.LastName" placeholder="Doe" required />
                </div>
            </div>

            <div class="hh-form-group">
                <label>Email *</label>
                <input type="email" @bind="_model.Email" placeholder="you@example.com" required />
            </div>

            <div class="hh-form-group">
                <label>Phone (optional)</label>
                <input type="tel" @bind="_model.Phone" placeholder="(313) 555-0123" />
            </div>

            <div class="hh-form-group">
                <label>Password *</label>
                <input type="password" @bind="_model.Password" placeholder="At least 8 characters" required />
            </div>

            <div class="hh-form-group">
                <label>Confirm Password *</label>
                <input type="password" @bind="_model.ConfirmPassword" placeholder="Confirm password" required />
            </div>

            <div class="hh-checkbox-group">
                <label>
                    <input type="checkbox" @bind="_model.AcceptTerms" />
                    <span>I agree to the <a href="/terms">Terms of Service</a> and <a href="/privacy">Privacy Policy</a></span>
                </label>
            </div>

            <button type="submit" class="hh-btn hh-btn-primary hh-btn-block" disabled="@_isLoading">
                @if (_isLoading)
                {
                    <span>Creating Account...</span>
                }
                else
                {
                    <i class="bi bi-person-plus"></i>
                    <span>Create Account</span>
                }
            </button>
        </EditForm>

        <div class="hh-register-footer">
            <span>Already have an account?</span>
            <a href="/login">Sign In</a>
        </div>

        <div class="hh-divider">
            <span>Or sign up with</span>
        </div>

        <button type="button" class="hh-btn hh-btn-outline hh-btn-block" @onclick="SignUpWithGoogle">
            <i class="bi bi-google"></i>
            <span>Sign up with Google</span>
        </button>
    </div>
</div>

<style>
    .hh-register-page {
        min-height: calc(100vh - 120px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px 16px;
        background: var(--ac-bg-alt, #f5f5f5);
    }

    .hh-register-card {
        width: 100%;
        max-width: 440px;
        background: white;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .hh-register-header {
        text-align: center;
        margin-bottom: 24px;
    }

    .hh-register-header i {
        font-size: 48px;
        color: var(--ac-primary, #E65100);
    }

    .hh-register-header h1 {
        font-size: 24px;
        font-weight: 700;
        margin: 12px 0 4px;
        color: #1a1a1a;
    }

    .hh-register-header p {
        color: #666;
        margin: 0;
    }

    .hh-alert {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 14px;
    }

    .hh-alert-error {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
    }

    .hh-alert-success {
        background: #f0fdf4;
        color: #16a34a;
        border: 1px solid #bbf7d0;
    }

    .hh-form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .hh-form-group {
        margin-bottom: 16px;
    }

    .hh-form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
    }

    .hh-form-group input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 15px;
        transition: border-color 0.2s, box-shadow 0.2s;
        box-sizing: border-box;
    }

    .hh-form-group input:focus {
        outline: none;
        border-color: var(--ac-primary, #E65100);
        box-shadow: 0 0 0 3px rgba(230, 81, 0, 0.1);
    }

    .hh-checkbox-group {
        margin: 20px 0;
    }

    .hh-checkbox-group label {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        cursor: pointer;
        font-size: 14px;
        color: #4b5563;
    }

    .hh-checkbox-group input[type="checkbox"] {
        margin-top: 2px;
        width: 16px;
        height: 16px;
        accent-color: var(--ac-primary, #E65100);
    }

    .hh-checkbox-group a {
        color: var(--ac-primary, #E65100);
        text-decoration: none;
    }

    .hh-checkbox-group a:hover {
        text-decoration: underline;
    }

    .hh-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px 24px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .hh-btn-block {
        width: 100%;
    }

    .hh-btn-primary {
        background: var(--ac-primary, #E65100);
        color: white;
    }

    .hh-btn-primary:hover:not(:disabled) {
        background: var(--ac-primary-dark, #BF360C);
    }

    .hh-btn-primary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .hh-btn-outline {
        background: white;
        color: #374151;
        border: 1px solid #d1d5db;
    }

    .hh-btn-outline:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }

    .hh-register-footer {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #6b7280;
    }

    .hh-register-footer a {
        color: var(--ac-primary, #E65100);
        text-decoration: none;
        font-weight: 500;
        margin-left: 4px;
    }

    .hh-divider {
        display: flex;
        align-items: center;
        margin: 24px 0;
        color: #9ca3af;
        font-size: 14px;
    }

    .hh-divider::before,
    .hh-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: #e5e7eb;
    }

    .hh-divider span {
        padding: 0 16px;
    }

    @@media (max-width: 480px) {
        .hh-form-row {
            grid-template-columns: 1fr;
        }

        .hh-register-card {
            padding: 24px 20px;
        }
    }
</style>

@code {
    private RegisterModel _model = new();
    private bool _isLoading = false;
    private string? _errorMessage = null;
    private string? _successMessage = null;

    protected override async Task OnInitializedAsync()
    {
        var token = await TokenManager.GetTokenAsync();
        if (!string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task HandleRegister()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;
            _successMessage = null;
            StateHasChanged();

            // Validate
            if (string.IsNullOrWhiteSpace(_model.FirstName) || string.IsNullOrWhiteSpace(_model.LastName))
            {
                _errorMessage = "Please enter your first and last name.";
                return;
            }

            if (string.IsNullOrWhiteSpace(_model.Email))
            {
                _errorMessage = "Please enter your email address.";
                return;
            }

            if (_model.Password != _model.ConfirmPassword)
            {
                _errorMessage = "Passwords do not match.";
                return;
            }

            if (_model.Password.Length < 8)
            {
                _errorMessage = "Password must be at least 8 characters long.";
                return;
            }

            if (!_model.AcceptTerms)
            {
                _errorMessage = "Please accept the Terms of Service and Privacy Policy.";
                return;
            }

            var response = await AuthClient.RegisterAsync(new ACommerce.Client.Auth.Models.RegisterRequest
            {
                Email = _model.Email,
                Password = _model.Password,
                FullName = $"{_model.FirstName} {_model.LastName}".Trim(),
                PhoneNumber = string.IsNullOrWhiteSpace(_model.Phone) ? null : _model.Phone
            });

            if (response?.Success == true)
            {
                _successMessage = "Account created successfully! Redirecting...";
                StateHasChanged();
                await Task.Delay(1000);
                Navigation.NavigateTo("/");
            }
            else
            {
                _errorMessage = response?.Message ?? "Failed to create account. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "Unable to connect to server. Please try again.";
            Console.WriteLine($"[Register] Error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SignUpWithGoogle()
    {
        // TODO: Implement Google OAuth
        _errorMessage = "Google Sign-Up coming soon! Please use email/password for now.";
    }

    private class RegisterModel
    {
        public string FirstName { get; set; } = "";
        public string LastName { get; set; } = "";
        public string Email { get; set; } = "";
        public string Phone { get; set; } = "";
        public string Password { get; set; } = "";
        public string ConfirmPassword { get; set; } = "";
        public bool AcceptTerms { get; set; } = false;
    }
}
