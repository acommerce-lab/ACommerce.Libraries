@page "/product/{ProductId:guid}"
@using ACommerce.Templates.Customer.Components
@inject ILocalizationService L
@inject IAppNavigationService Navigation
@inject ProductsClient ProductsClient
@inject CartClient CartClient

<div class="ac-page hh-product-details">
    @if (_isLoading)
    {
        <div class="ac-loading-container">
            <AcSpinner />
        </div>
    }
    else if (_product == null)
    {
        <AcEmptyState Icon="bi-box-seam"
                      Title="Product Not Found"
                      Description="The product you're looking for doesn't exist or has been removed."
                      ActionText="Go Back"
                      ActionIcon="bi-arrow-left"
                      OnAction="GoBack" />
    }
    else
    {
        <!-- Product Images -->
        <div class="ac-product-gallery" style="padding: 16px;">
            <img src="@(_product.Images.FirstOrDefault() ?? "/images/placeholder-product.png")"
                 alt="@_product.Name"
                 style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: var(--ac-radius-lg); background: var(--ac-surface);" />
            @if (_product.Images.Count > 1)
            {
                <div style="display: flex; gap: 8px; margin-top: 12px; overflow-x: auto;">
                    @foreach (var (image, index) in _product.Images.Select((img, i) => (img, i)))
                    {
                        <img src="@image"
                             alt="@_product.Name @(index + 1)"
                             style="width: 64px; height: 64px; object-fit: cover; border-radius: var(--ac-radius-sm); cursor: pointer; border: 2px solid @(_selectedImageIndex == index ? "var(--ac-primary)" : "transparent");"
                             @onclick="() => SelectImage(index)" />
                    }
                </div>
            }
        </div>

        <!-- Product Info -->
        <div class="ac-product-info-section" style="padding: 0 16px;">
            <div style="margin-bottom: 16px;">
                <span style="color: var(--ac-primary); font-size: 0.875rem; font-weight: 500;">@_product.Brand</span>
                <h1 style="font-size: 1.5rem; font-weight: 700; margin: 8px 0;">@_product.Name</h1>
                <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; color: var(--ac-text-muted); font-size: 0.875rem;">
                    <span>SKU: @_product.Sku</span>
                    @if (_product.Rating.HasValue)
                    {
                        <span style="display: flex; align-items: center; gap: 4px;">
                            <i class="bi bi-star-fill" style="color: #FFC107;"></i>
                            @_product.Rating.Value.ToString("0.0")
                            <span>(@_product.ReviewCount reviews)</span>
                        </span>
                    }
                </div>
            </div>

            <div style="margin-bottom: 16px;">
                <span style="font-size: 1.75rem; font-weight: 700; color: var(--ac-primary);">$@_product.Price.ToString("0.00")</span>
                @if (_product.OriginalPrice.HasValue && _product.OriginalPrice > _product.Price)
                {
                    <span style="text-decoration: line-through; color: var(--ac-text-muted); margin-left: 8px;">$@_product.OriginalPrice.Value.ToString("0.00")</span>
                    <span style="background: var(--ac-success); color: white; padding: 2px 8px; border-radius: var(--ac-radius-sm); font-size: 0.75rem; margin-left: 8px;">
                        Save $@((_product.OriginalPrice.Value - _product.Price).ToString("0.00"))
                    </span>
                }
            </div>

            <div style="margin-bottom: 16px;">
                @if (_product.InStock)
                {
                    <span class="ac-badge" style="background: var(--ac-success-light); color: var(--ac-success);">
                        <i class="bi bi-check-circle"></i> In Stock
                    </span>
                    @if (_product.StockQuantity.HasValue && _product.StockQuantity < 10)
                    {
                        <span style="color: var(--ac-warning); font-size: 0.875rem; margin-left: 8px;">Only @_product.StockQuantity left!</span>
                    }
                }
                else
                {
                    <span class="ac-badge" style="background: var(--ac-danger-light); color: var(--ac-danger);">
                        <i class="bi bi-x-circle"></i> Out of Stock
                    </span>
                }
            </div>

            <!-- Quantity Selector -->
            @if (_product.InStock)
            {
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <span>Quantity:</span>
                    <div style="display: flex; align-items: center; gap: 0; border: 1px solid var(--ac-border); border-radius: var(--ac-radius-md);">
                        <button style="width: 40px; height: 40px; border: none; background: transparent; cursor: pointer;" @onclick="DecreaseQuantity" disabled="@(_quantity <= 1)">
                            <i class="bi bi-dash"></i>
                        </button>
                        <span style="min-width: 40px; text-align: center; font-weight: 600;">@_quantity</span>
                        <button style="width: 40px; height: 40px; border: none; background: transparent; cursor: pointer;" @onclick="IncreaseQuantity">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div style="flex: 1;">
                        <AcButton Text="@(_addedToCart ? "Added!" : "Add to Cart")"
                                  Icon="@(_isAddingToCart ? "" : "bi-cart-plus")"
                                  Variant="ButtonVariant.Primary"
                                  Size="ButtonSize.Large"
                                  Block="true"
                                  Loading="_isAddingToCart"
                                  OnClick="AddToCart" />
                    </div>
                    <button style="width: 48px; height: 48px; border: 1px solid var(--ac-border); background: var(--ac-surface); border-radius: var(--ac-radius-md); cursor: pointer; display: flex; align-items: center; justify-content: center;" @onclick="ToggleFavorite">
                        <i class="@(_isFavorite ? "bi bi-heart-fill" : "bi bi-heart")" style="font-size: 1.25rem; color: @(_isFavorite ? "var(--ac-danger)" : "var(--ac-text-secondary)");"></i>
                    </button>
                </div>
            }
            else
            {
                <AcButton Text="Notify When Available"
                          Icon="bi-bell"
                          Variant="ButtonVariant.Secondary"
                          Block="true"
                          OnClick="NotifyWhenAvailable" />
            }

            <!-- Store Pickup -->
            <div class="ac-card" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--ac-surface-secondary);">
                <i class="bi bi-shop" style="font-size: 1.5rem; color: var(--ac-primary);"></i>
                <div>
                    <strong>Store Pickup Available</strong>
                    <p style="margin: 0; color: var(--ac-text-muted); font-size: 0.875rem;">Ready in 2 hours at Hamtramck Hardware</p>
                </div>
            </div>
        </div>

        <!-- Product Description -->
        <div class="ac-card" style="margin: 16px; padding: 16px;">
            <h3 style="margin: 0 0 12px; font-size: 1.125rem;">Description</h3>
            <p style="margin: 0; color: var(--ac-text-secondary); line-height: 1.6;">@_product.Description</p>
        </div>

        <!-- Specifications -->
        @if (_product.Specifications?.Any() == true)
        {
            <div class="ac-card" style="margin: 16px; padding: 16px;">
                <h3 style="margin: 0 0 12px; font-size: 1.125rem;">Specifications</h3>
                <dl style="margin: 0; display: grid; gap: 8px;">
                    @foreach (var spec in _product.Specifications)
                    {
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--ac-border);">
                            <dt style="color: var(--ac-text-muted);">@spec.Key</dt>
                            <dd style="margin: 0; font-weight: 500;">@spec.Value</dd>
                        </div>
                    }
                </dl>
            </div>
        }

        <!-- Related Products -->
        @if (_relatedProducts.Any())
        {
            <section class="ac-section" style="margin: 16px;">
                <div class="ac-section-header">
                    <h2 class="ac-section-title">Related Products</h2>
                </div>
                <div style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px;">
                    @foreach (var product in _relatedProducts)
                    {
                        <div style="flex-shrink: 0; width: 160px;">
                            <AcProductCard Id="product.Id"
                                           Name="@product.Name"
                                           ImageUrl="@product.ImageUrl"
                                           Price="product.Price"
                                           Currency="$"
                                           ShowQuickActions="false"
                                           OnClick="@(id => ViewProduct(product.Id))" />
                        </div>
                    }
                </div>
            </section>
        }
    }
</div>

@code {
    [Parameter]
    public Guid ProductId { get; set; }

    private bool _isLoading = true;
    private ProductDetailModel? _product;
    private List<RelatedProductModel> _relatedProducts = new();
    private int _quantity = 1;
    private int _selectedImageIndex = 0;
    private bool _isFavorite = false;
    private bool _isAddingToCart = false;
    private bool _addedToCart = false;

    protected override async Task OnParametersSetAsync()
    {
        await LoadProduct();
    }

    private async Task LoadProduct()
    {
        try
        {
            _isLoading = true;

            // Simulate API call
            await Task.Delay(300);

            // Mock product data
            _product = new ProductDetailModel(
                ProductId,
                "DeWalt",
                "DeWalt 20V MAX Cordless Drill/Driver Kit",
                "DCD771C2",
                149.99m,
                179.99m,
                true,
                15,
                "The DeWalt DCD771C2 20V MAX Cordless Drill/Driver Kit delivers the power and runtime you need to get the job done. The lightweight design fits into tight areas and reduces user fatigue. High-speed transmission delivers 2 speeds (0-450 & 1,500 rpm) for a range of fastening and drilling applications.",
                new List<string>
                {
                    "https://images.unsplash.com/photo-1504148455328-c376907d081c?w=600&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1572981779307-38b8cabb2407?w=600&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1581147036324-c17ac41f3f2c?w=600&h=600&fit=crop"
                },
                new Dictionary<string, string>
                {
                    { "Voltage", "20V MAX" },
                    { "Speed", "0-450/0-1,500 RPM" },
                    { "Chuck Size", "1/2 inch" },
                    { "Battery Type", "Lithium Ion" },
                    { "Weight", "3.6 lbs" },
                    { "Warranty", "3 Years" }
                },
                4.7m,
                256
            );

            _relatedProducts = new List<RelatedProductModel>
            {
                new(Guid.NewGuid(), "DeWalt 20V Battery 2-Pack", 99.99m, "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=300&h=300&fit=crop"),
                new(Guid.NewGuid(), "Drill Bit Set 29pc", 34.99m, "https://images.unsplash.com/photo-1580901368919-7738efb0f87e?w=300&h=300&fit=crop"),
                new(Guid.NewGuid(), "DeWalt Tool Bag", 24.99m, "https://images.unsplash.com/photo-1586864387967-d02ef85d93e8?w=300&h=300&fit=crop"),
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading product: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void SelectImage(int index)
    {
        _selectedImageIndex = index;
    }

    private void IncreaseQuantity()
    {
        if (_product?.StockQuantity == null || _quantity < _product.StockQuantity)
            _quantity++;
    }

    private void DecreaseQuantity()
    {
        if (_quantity > 1)
            _quantity--;
    }

    private async Task AddToCart()
    {
        _isAddingToCart = true;
        StateHasChanged();

        try
        {
            // Simulate API call
            await Task.Delay(500);

            _addedToCart = true;
            StateHasChanged();

            // Reset after delay
            await Task.Delay(2000);
            _addedToCart = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding to cart: {ex.Message}");
        }
        finally
        {
            _isAddingToCart = false;
        }
    }

    private void ToggleFavorite()
    {
        _isFavorite = !_isFavorite;
    }

    private void NotifyWhenAvailable()
    {
        // TODO: Implement notification signup
    }

    private void ViewProduct(Guid id)
    {
        Navigation.NavigateTo($"/product/{id}");
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private record ProductDetailModel(
        Guid Id,
        string Brand,
        string Name,
        string Sku,
        decimal Price,
        decimal? OriginalPrice,
        bool InStock,
        int? StockQuantity,
        string Description,
        List<string> Images,
        Dictionary<string, string> Specifications,
        decimal? Rating,
        int ReviewCount
    );

    private record RelatedProductModel(Guid Id, string Name, decimal Price, string? ImageUrl);
}
