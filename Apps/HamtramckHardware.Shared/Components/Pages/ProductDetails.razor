@page "/product/{ProductId:guid}"
@using ACommerce.Templates.Customer.Components
@using ACommerce.Templates.Customer.Pages
@using HamtramckHardware.Shared.Services
@inject HamtramckDataService DataService
@inject IAppNavigationService Navigation

<div class="ac-page hh-product-details" style="direction: ltr;">
    @if (_isLoading)
    {
        <div class="ac-loading-container"><AcSpinner /></div>
    }
    else if (_product == null)
    {
        <AcEmptyState Icon="bi-box-seam" Title="Product Not Found"
                      Description="The product you're looking for doesn't exist."
                      ActionText="Go Back" ActionIcon="bi-arrow-left" OnAction='() => Navigation.NavigateTo("/")' />
    }
    else
    {
        <!-- Product Images -->
        <div style="padding: 16px;">
            <img src="@(_product.Images.FirstOrDefault() ?? "/images/placeholder-product.png")"
                 alt="@_product.Name" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: var(--ac-radius-lg); background: var(--ac-surface);" />
            @if (_product.Images.Count > 1)
            {
                <div style="display: flex; gap: 8px; margin-top: 12px; overflow-x: auto;">
                    @foreach (var (image, index) in _product.Images.Select((img, i) => (img, i)))
                    {
                        <img src="@image" alt="@_product.Name @(index + 1)"
                             style="width: 64px; height: 64px; object-fit: cover; border-radius: var(--ac-radius-sm); cursor: pointer; border: 2px solid @(_selectedImageIndex == index ? "var(--ac-primary)" : "transparent");"
                             @onclick="() => _selectedImageIndex = index" />
                    }
                </div>
            }
        </div>

        <!-- Product Info -->
        <div style="padding: 0 16px;">
            <span style="color: var(--ac-primary); font-size: 0.875rem; font-weight: 500;">@_product.Brand</span>
            <h1 style="font-size: 1.5rem; font-weight: 700; margin: 8px 0;">@_product.Name</h1>
            <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; color: var(--ac-text-muted); font-size: 0.875rem;">
                <span>SKU: @_product.Sku</span>
                <span style="display: flex; align-items: center; gap: 4px;">
                    <i class="bi bi-star-fill" style="color: #FFC107;"></i>
                    @_product.Rating.ToString("0.0")
                    <span>(@_product.ReviewCount reviews)</span>
                </span>
            </div>

            <div style="margin: 16px 0;">
                <span style="font-size: 1.75rem; font-weight: 700; color: var(--ac-primary);">$@_product.Price.ToString("0.00")</span>
                @if (_product.OriginalPrice.HasValue && _product.OriginalPrice > _product.Price)
                {
                    <span style="text-decoration: line-through; color: var(--ac-text-muted); margin-left: 8px;">$@_product.OriginalPrice.Value.ToString("0.00")</span>
                    <span style="background: var(--ac-success); color: white; padding: 2px 8px; border-radius: var(--ac-radius-sm); font-size: 0.75rem; margin-left: 8px;">
                        Save $@((_product.OriginalPrice.Value - _product.Price).ToString("0.00"))
                    </span>
                }
            </div>

            <div style="margin-bottom: 16px;">
                @if (_product.InStock)
                {
                    <span class="ac-badge" style="background: var(--ac-success-light); color: var(--ac-success);">
                        <i class="bi bi-check-circle"></i> In Stock (@_product.StockQuantity)
                    </span>
                }
                else
                {
                    <span class="ac-badge" style="background: var(--ac-danger-light); color: var(--ac-danger);">
                        <i class="bi bi-x-circle"></i> Out of Stock
                    </span>
                }
            </div>

            @if (_product.InStock)
            {
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <span>Quantity:</span>
                    <div style="display: flex; align-items: center; border: 1px solid var(--ac-border); border-radius: var(--ac-radius-md);">
                        <button style="width: 40px; height: 40px; border: none; background: transparent; cursor: pointer;" @onclick="() => { if (_quantity > 1) _quantity--; }" disabled="@(_quantity <= 1)"><i class="bi bi-dash"></i></button>
                        <span style="min-width: 40px; text-align: center; font-weight: 600;">@_quantity</span>
                        <button style="width: 40px; height: 40px; border: none; background: transparent; cursor: pointer;" @onclick="() => _quantity++"><i class="bi bi-plus"></i></button>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div style="flex: 1;">
                        <AcButton Text="@(_addedToCart ? "Added!" : "Add to Cart")" Icon="@(_isAddingToCart ? "" : "bi-cart-plus")"
                                  Variant="ButtonVariant.Primary" Size="ButtonSize.Large" Block="true" Loading="_isAddingToCart" OnClick="AddToCart" />
                    </div>
                    <button style="width: 48px; height: 48px; border: 1px solid var(--ac-border); background: var(--ac-surface); border-radius: var(--ac-radius-md); cursor: pointer;" @onclick="() => _isFavorite = !_isFavorite">
                        <i class="@(_isFavorite ? "bi bi-heart-fill" : "bi bi-heart")" style="font-size: 1.25rem; color: @(_isFavorite ? "var(--ac-danger)" : "var(--ac-text-secondary)");"></i>
                    </button>
                </div>
            }

            <div class="ac-card" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--ac-surface-secondary);">
                <i class="bi bi-shop" style="font-size: 1.5rem; color: var(--ac-primary);"></i>
                <div>
                    <strong>Store Pickup Available</strong>
                    <p style="margin: 0; color: var(--ac-text-muted); font-size: 0.875rem;">Ready in 2 hours at Hamtramck Hardware</p>
                </div>
            </div>
        </div>

        <!-- Description -->
        <div class="ac-card" style="margin: 16px; padding: 16px;">
            <h3 style="margin: 0 0 12px; font-size: 1.125rem;">Description</h3>
            <p style="margin: 0; color: var(--ac-text-secondary); line-height: 1.6;">@_product.Description</p>
        </div>

        <!-- Specifications -->
        @if (_product.Specifications?.Any() == true)
        {
            <div class="ac-card" style="margin: 16px; padding: 16px;">
                <h3 style="margin: 0 0 12px; font-size: 1.125rem;">Specifications</h3>
                <dl style="margin: 0; display: grid; gap: 8px;">
                    @foreach (var spec in _product.Specifications)
                    {
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--ac-border);">
                            <dt style="color: var(--ac-text-muted);">@spec.Key</dt>
                            <dd style="margin: 0; font-weight: 500;">@spec.Value</dd>
                        </div>
                    }
                </dl>
            </div>
        }

        <!-- Related Products -->
        @if (_relatedProducts.Any())
        {
            <section class="ac-section" style="margin: 16px;">
                <div class="ac-section-header"><h2 class="ac-section-title">Related Products</h2></div>
                <div style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px;">
                    @foreach (var product in _relatedProducts)
                    {
                        <div style="flex-shrink: 0; width: 160px;">
                            <AcProductCard Id="@product.Id" Name="@product.Name" ImageUrl="@product.Image"
                                           Price="@product.Price" Currency="$" CurrencyBeforePrice="true" ShowQuickActions="false"
                                           FeaturedLabel="Featured" NewLabel="New" InStockLabel="In Stock ({0})" OutOfStockLabel="Out of Stock"
                                           AddToCartLabel="Add to Cart" AddToWishlistLabel="Add to Wishlist"
                                           OnClick="@(id => Navigation.NavigateTo($"/product/{product.Id}"))" />
                        </div>
                    }
                </div>
            </section>
        }
    }
</div>

@code {
    [Parameter] public Guid ProductId { get; set; }

    private bool _isLoading = true;
    private HamtramckDataService.ProductDetail? _product;
    private List<HomeProductItem> _relatedProducts = new();
    private int _quantity = 1, _selectedImageIndex = 0;
    private bool _isFavorite = false, _isAddingToCart = false, _addedToCart = false;

    protected override async Task OnParametersSetAsync()
    {
        _isLoading = true;
        _quantity = 1;
        _selectedImageIndex = 0;
        await Task.Delay(200);
        _product = DataService.GetProductDetails(ProductId);
        _relatedProducts = DataService.GetRelatedProducts(ProductId, 4);
        _isLoading = false;
    }

    private async Task AddToCart()
    {
        _isAddingToCart = true;
        StateHasChanged();
        await Task.Delay(500);
        _addedToCart = true;
        StateHasChanged();
        await Task.Delay(2000);
        _addedToCart = false;
        _isAddingToCart = false;
    }
}
