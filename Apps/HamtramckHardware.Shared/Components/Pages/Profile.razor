@page "/profile"
@using ACommerce.Client.Profiles
@inject ILocalizationService L
@inject IAppNavigationService Navigation
@inject TokenManager TokenManager
@inject ProfilesClient ProfilesClient
@inject IAppVersionService VersionService

<div class="hh-page-content">
    @if (!_isLoggedIn)
    {
        <div class="hh-empty-state">
            <i class="bi bi-person-circle"></i>
            <h2>Welcome to Hamtramck Hardware</h2>
            <p>Sign in to manage your account, track orders, and more.</p>
            <button class="hh-btn hh-btn-primary" @onclick="GoToLogin">
                <i class="bi bi-box-arrow-in-right"></i> Sign In
            </button>
            <button class="hh-btn hh-btn-secondary" style="margin-top: 12px;" @onclick="GoToRegister">
                <i class="bi bi-person-plus"></i> Create Account
            </button>
        </div>
    }
    else
    {
        <!-- Profile Header -->
        <div class="hh-profile-header hh-card">
            <div class="hh-profile-avatar">
                @if (!string.IsNullOrEmpty(_user?.AvatarUrl))
                {
                    <img src="@_user.AvatarUrl" alt="@_user.Name" />
                }
                else
                {
                    <i class="bi bi-person-fill"></i>
                }
            </div>
            <div class="hh-profile-info">
                <h2>@(_user?.Name ?? "Customer")</h2>
                <p>@(_user?.Email ?? "")</p>
            </div>
            <button class="hh-btn hh-btn-secondary hh-btn-sm" @onclick="EditProfile">
                <i class="bi bi-pencil"></i> Edit
            </button>
        </div>

        <!-- Account Menu -->
        <div class="hh-menu-section">
            <h3 class="hh-menu-title">My Account</h3>

            <div class="hh-menu-item" @onclick='() => Navigation.NavigateTo("/orders")'>
                <div class="hh-menu-icon" style="background-color: #E65100;">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="hh-menu-content">
                    <span>My Orders</span>
                    <small>Track and manage your orders</small>
                </div>
                <i class="bi bi-chevron-right"></i>
            </div>

            <div class="hh-menu-item" @onclick='() => Navigation.NavigateTo("/addresses")'>
                <div class="hh-menu-icon" style="background-color: #2196F3;">
                    <i class="bi bi-geo-alt"></i>
                </div>
                <div class="hh-menu-content">
                    <span>Saved Addresses</span>
                    <small>Manage delivery addresses</small>
                </div>
                <i class="bi bi-chevron-right"></i>
            </div>

            <div class="hh-menu-item" @onclick='() => Navigation.NavigateTo("/payment-methods")'>
                <div class="hh-menu-icon" style="background-color: #4CAF50;">
                    <i class="bi bi-credit-card"></i>
                </div>
                <div class="hh-menu-content">
                    <span>Payment Methods</span>
                    <small>Manage payment options</small>
                </div>
                <i class="bi bi-chevron-right"></i>
            </div>

            <div class="hh-menu-item" @onclick='() => Navigation.NavigateTo("/favorites")'>
                <div class="hh-menu-icon" style="background-color: #F44336;">
                    <i class="bi bi-heart"></i>
                </div>
                <div class="hh-menu-content">
                    <span>Favorites</span>
                    <small>Your saved items</small>
                </div>
                <i class="bi bi-chevron-right"></i>
            </div>
        </div>

        <!-- Settings Menu -->
        <div class="hh-menu-section">
            <h3 class="hh-menu-title">Settings</h3>

            <div class="hh-menu-item" @onclick='() => Navigation.NavigateTo("/notifications")'>
                <div class="hh-menu-icon" style="background-color: #9C27B0;">
                    <i class="bi bi-bell"></i>
                </div>
                <div class="hh-menu-content">
                    <span>Notifications</span>
                    <small>Manage notification preferences</small>
                </div>
                <i class="bi bi-chevron-right"></i>
            </div>

            <div class="hh-menu-item" @onclick='() => Navigation.NavigateTo("/settings")'>
                <div class="hh-menu-icon" style="background-color: #607D8B;">
                    <i class="bi bi-gear"></i>
                </div>
                <div class="hh-menu-content">
                    <span>Settings</span>
                    <small>App preferences</small>
                </div>
                <i class="bi bi-chevron-right"></i>
            </div>
        </div>

        <!-- Support Menu -->
        <div class="hh-menu-section">
            <h3 class="hh-menu-title">Support</h3>

            <div class="hh-menu-item" @onclick='() => Navigation.NavigateTo("/help")'>
                <div class="hh-menu-icon" style="background-color: #00BCD4;">
                    <i class="bi bi-question-circle"></i>
                </div>
                <div class="hh-menu-content">
                    <span>Help & FAQ</span>
                    <small>Get help with your orders</small>
                </div>
                <i class="bi bi-chevron-right"></i>
            </div>

            <div class="hh-menu-item" @onclick="ContactSupport">
                <div class="hh-menu-icon" style="background-color: #795548;">
                    <i class="bi bi-chat-dots"></i>
                </div>
                <div class="hh-menu-content">
                    <span>Contact Us</span>
                    <small>(313) 365-2400</small>
                </div>
                <i class="bi bi-chevron-right"></i>
            </div>

            <div class="hh-menu-item" @onclick='() => Navigation.NavigateTo("/about")'>
                <div class="hh-menu-icon" style="background-color: #455A64;">
                    <i class="bi bi-info-circle"></i>
                </div>
                <div class="hh-menu-content">
                    <span>About</span>
                    <small>Version @_appVersion</small>
                </div>
                <i class="bi bi-chevron-right"></i>
            </div>
        </div>

        <!-- Sign Out -->
        <div class="hh-menu-section">
            <button class="hh-btn hh-btn-outline-danger hh-btn-block" @onclick="SignOut">
                <i class="bi bi-box-arrow-left"></i> Sign Out
            </button>
        </div>
    }
</div>

@code {
    private bool _isLoggedIn = false;
    private UserModel? _user;
    private string _appVersion = "1.0.0";

    protected override async Task OnInitializedAsync()
    {
        var token = await TokenManager.GetTokenAsync();
        _isLoggedIn = !string.IsNullOrEmpty(token);

        if (_isLoggedIn)
        {
            await LoadProfile();
        }

        _appVersion = VersionService.GetCurrentVersion();
    }

    private async Task LoadProfile()
    {
        try
        {
            // Simulate API call - in production this would call ProfilesClient
            await Task.Delay(100);

            _user = new UserModel(
                "John Smith",
                "john.smith@example.com",
                null
            );
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading profile: {ex.Message}");
        }
    }

    private void EditProfile()
    {
        Navigation.NavigateTo("/profile/edit");
    }

    private void ContactSupport()
    {
        // In mobile app, this would open the phone dialer
        // For web, we can show the phone number or open tel: link
        Navigation.NavigateTo("tel:+13133652400");
    }

    private async Task SignOut()
    {
        await TokenManager.ClearTokenAsync();
        _isLoggedIn = false;
        _user = null;
        Navigation.NavigateTo("/");
    }

    private void GoToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    private void GoToRegister()
    {
        Navigation.NavigateTo("/register");
    }

    private record UserModel(string Name, string Email, string? AvatarUrl);
}
