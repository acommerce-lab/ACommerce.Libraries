@page "/search"
@using ACommerce.Templates.Customer.Components
@using HamtramckHardware.Shared.Services
@inject HamtramckDataService DataService
@inject IAppNavigationService Navigation

<div class="ac-page hh-search-page" style="direction: ltr;">
    <div style="padding: 16px;">
        <AcSearchBox Placeholder="Search tools, plumbing, electrical..."
                     Value="@_searchQuery"
                     ValueChanged="OnSearchChanged"
                     OnSearch="ExecuteSearch"
                     ShowVoiceSearch="false" />
    </div>

    @if (!string.IsNullOrWhiteSpace(_searchQuery))
    {
        <div class="ac-page-header" style="padding: 0 16px 16px;">
            <h2 class="ac-page-title">Results for "@_searchQuery"</h2>
            <p style="color: var(--ac-text-muted); margin: 0;">@_results.Count products found</p>
        </div>
    }

    @if (_isLoading)
    {
        <div class="ac-loading-container"><AcSpinner /><p>Searching...</p></div>
    }
    else if (string.IsNullOrWhiteSpace(_searchQuery))
    {
        <div style="padding: 16px;">
            <h3 style="margin-bottom: 12px;">Popular Categories</h3>
            <div class="hh-category-grid">
                @foreach (var category in _categories)
                {
                    <div class="hh-category-card" @onclick="() => Navigation.NavigateTo($\"/products?category={category.Id}\")">
                        <i class="@category.Icon"></i>
                        <span>@category.Name</span>
                    </div>
                }
            </div>
        </div>
    }
    else if (!_results.Any())
    {
        <AcEmptyState Icon="bi-search" Title="No Results Found"
                      Description="Try different keywords or browse our categories."
                      ActionText="Browse Products" OnAction='() => Navigation.NavigateTo("/products")' />
    }
    else
    {
        <div class="ac-products-grid" style="padding: 0 16px;">
            @foreach (var product in _results)
            {
                <AcProductCard Id="product.Id" Name="@product.Name" ImageUrl="@product.Image"
                               Price="product.Price" OldPrice="@product.OldPrice"
                               Currency="$" CurrencyBeforePrice="true"
                               Rating="@product.Rating" ReviewCount="@product.ReviewCount"
                               ShowQuickActions="false"
                               FeaturedLabel="Featured" NewLabel="New"
                               InStockLabel="In Stock ({0})" OutOfStockLabel="Out of Stock"
                               AddToCartLabel="Add to Cart" AddToWishlistLabel="Add to Wishlist"
                               OnClick="@(id => Navigation.NavigateTo($\"/product/{product.Id}\"))" />
            }
        </div>
    }
</div>

<style>
    .hh-category-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .hh-category-card { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 20px; background: var(--ac-surface); border-radius: var(--ac-radius-lg); cursor: pointer; transition: all 0.2s; }
    .hh-category-card:hover { background: var(--ac-surface-hover); transform: translateY(-2px); }
    .hh-category-card i { font-size: 1.5rem; color: var(--ac-primary); }
</style>

@code {
    [SupplyParameterFromQuery(Name = "q")] public string? Query { get; set; }

    private string? _searchQuery;
    private bool _isLoading = false;
    private List<HomeProductItem> _results = new();
    private List<HomeCategoryItem> _categories = new();

    protected override async Task OnInitializedAsync()
    {
        _categories = DataService.GetCategories();
        _searchQuery = Query;
        if (!string.IsNullOrWhiteSpace(_searchQuery)) await Search();
    }

    private void OnSearchChanged(string value) => _searchQuery = value;
    private async Task ExecuteSearch(string query) { _searchQuery = query; await Search(); }

    private async Task Search()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery)) { _results.Clear(); return; }
        _isLoading = true;
        await Task.Delay(200);
        _results = DataService.SearchProducts(_searchQuery);
        _isLoading = false;
    }
}
