@page "/search"
@using ACommerce.Templates.Customer.Components
@inject ILocalizationService L
@inject IAppNavigationService Navigation
@inject ProductsClient ProductsClient

<div class="ac-page hh-search-page" style="direction: ltr;">
    <!-- Search Input -->
    <div style="padding: 16px; background: var(--ac-surface); border-bottom: 1px solid var(--ac-border);">
        <div style="display: flex; gap: 12px; align-items: center;">
            <div style="flex: 1; position: relative;">
                <i class="bi bi-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--ac-text-muted);"></i>
                <input type="text"
                       style="width: 100%; padding: 12px 40px 12px 40px; border: 1px solid var(--ac-border); border-radius: var(--ac-radius-md); font-size: 1rem; background: var(--ac-background);"
                       placeholder="Search tools, plumbing, electrical..."
                       @bind="_searchQuery"
                       @bind:event="oninput"
                       @onkeyup="HandleKeyUp"
                       autofocus />
                @if (!string.IsNullOrEmpty(_searchQuery))
                {
                    <button style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--ac-text-muted); cursor: pointer;" @onclick="ClearSearch">
                        <i class="bi bi-x-circle-fill"></i>
                    </button>
                }
            </div>
            <AcButton Text="Search"
                      Variant="ButtonVariant.Primary"
                      Disabled="@(string.IsNullOrWhiteSpace(_searchQuery))"
                      OnClick="PerformSearch" />
        </div>
    </div>

    @if (!_hasSearched)
    {
        <div style="padding: 16px;">
            <!-- Recent Searches -->
            @if (_recentSearches.Any())
            {
                <section style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h2 style="font-size: 1.125rem; font-weight: 600; margin: 0;">Recent Searches</h2>
                        <button style="background: none; border: none; color: var(--ac-primary); cursor: pointer; font-size: 0.875rem;" @onclick="ClearRecentSearches">Clear</button>
                    </div>
                    <div class="ac-card" style="overflow: hidden;">
                        @foreach (var (search, index) in _recentSearches.Select((s, i) => (s, i)))
                        {
                            <div style="display: flex; align-items: center; padding: 12px 16px; cursor: pointer; @(index < _recentSearches.Count - 1 ? "border-bottom: 1px solid var(--ac-border);" : "")" @onclick="() => SearchFromRecent(search)">
                                <i class="bi bi-clock-history" style="color: var(--ac-text-muted); margin-right: 12px;"></i>
                                <span>@search</span>
                            </div>
                        }
                    </div>
                </section>
            }

            <!-- Popular Searches -->
            <section style="margin-bottom: 24px;">
                <h2 style="font-size: 1.125rem; font-weight: 600; margin: 0 0 12px;">Popular Searches</h2>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    @foreach (var tag in _popularSearches)
                    {
                        <button style="padding: 8px 16px; background: var(--ac-surface); border: 1px solid var(--ac-border); border-radius: 20px; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;" @onclick="() => SearchFromRecent(tag)">
                            @tag
                        </button>
                    }
                </div>
            </section>

            <!-- Browse by Department -->
            <section>
                <h2 style="font-size: 1.125rem; font-weight: 600; margin: 0 0 12px;">Browse Departments</h2>
                <div class="ac-card" style="overflow: hidden;">
                    @foreach (var (dept, index) in _departments.Select((d, i) => (d, i)))
                    {
                        <div style="display: flex; align-items: center; padding: 14px 16px; cursor: pointer; @(index < _departments.Count - 1 ? "border-bottom: 1px solid var(--ac-border);" : "")" @onclick="() => BrowseDepartment(dept.Code)">
                            <i class="@dept.Icon" style="font-size: 1.25rem; color: var(--ac-primary); width: 32px;"></i>
                            <span style="flex: 1;">@dept.Name</span>
                            <i class="bi bi-chevron-right" style="color: var(--ac-text-muted);"></i>
                        </div>
                    }
                </div>
            </section>
        </div>
    }
    else if (_isSearching)
    {
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 48px 16px;">
            <AcSpinner />
            <p style="margin-top: 16px; color: var(--ac-text-muted);">Searching...</p>
        </div>
    }
    else if (!_searchResults.Any())
    {
        <div style="padding: 16px;">
            <AcEmptyState Icon="bi-search"
                          Title="No Results Found"
                          Description="@($"We couldn't find anything for \"{_searchQuery}\"")" />
            <div style="text-align: center; margin-top: 16px; color: var(--ac-text-muted);">
                <p style="margin-bottom: 8px;">Try:</p>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li>• Checking your spelling</li>
                    <li>• Using more general terms</li>
                    <li>• Browsing our categories</li>
                </ul>
            </div>
        </div>
    }
    else
    {
        <!-- Search Results -->
        <div style="padding: 16px;">
            <p style="color: var(--ac-text-muted); margin: 0 0 16px;">@_searchResults.Count results for "@_searchQuery"</p>

            <div class="ac-products-grid">
                @foreach (var product in _searchResults)
                {
                    <AcProductCard Id="product.Id"
                                   Name="@product.Name"
                                   ImageUrl="@product.ImageUrl"
                                   Price="product.Price"
                                   OldPrice="@(product.OriginalPrice ?? 0)"
                                   Currency="$"
                                   CurrencyBeforePrice="true"
                                   DiscountPercent="@(product.OriginalPrice.HasValue && product.OriginalPrice > product.Price ? (int)Math.Round((product.OriginalPrice.Value - product.Price) / product.OriginalPrice.Value * 100) : 0)"
                                   StockQuantity="@(product.InStock ? 10 : 0)"
                                   ShowQuickActions="false"
                                   FeaturedLabel="Featured"
                                   NewLabel="New"
                                   InStockLabel="In Stock ({0})"
                                   OutOfStockLabel="Out of Stock"
                                   AddToCartLabel="Add to Cart"
                                   AddToWishlistLabel="Add to Wishlist"
                                   OnClick="@(id => ViewProduct(product.Id))" />
                }
            </div>
        </div>
    }
</div>

@code {
    private string _searchQuery = "";
    private bool _hasSearched = false;
    private bool _isSearching = false;
    private List<ProductItem> _searchResults = new();
    private List<string> _recentSearches = new() { "cordless drill", "pvc pipe 10ft", "romex wire", "sharkbite fittings" };
    private List<string> _popularSearches = new() { "DeWalt 20V", "Milwaukee M18", "Copper Fittings", "LED Shop Light", "Klein Tools", "RIDGID", "Husky Tool Chest", "Bosch Router" };
    private List<DepartmentItem> _departments = new();

    protected override void OnInitialized()
    {
        _departments = new List<DepartmentItem>
        {
            new("plumbing", "Plumbing", "bi bi-droplet"),
            new("electrical", "Electrical", "bi bi-lightning-charge"),
            new("tools", "Tools", "bi bi-tools"),
            new("lawn", "Lawn & Garden", "bi bi-flower1"),
            new("paint", "Paint", "bi bi-palette"),
            new("lumber", "Lumber", "bi bi-box"),
        };
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_searchQuery))
        {
            await PerformSearch();
        }
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery)) return;

        _isSearching = true;
        _hasSearched = true;
        StateHasChanged();

        try
        {
            // Simulate API call
            await Task.Delay(500);

            // Add to recent searches
            if (!_recentSearches.Contains(_searchQuery, StringComparer.OrdinalIgnoreCase))
            {
                _recentSearches.Insert(0, _searchQuery);
                if (_recentSearches.Count > 5)
                    _recentSearches = _recentSearches.Take(5).ToList();
            }

            // Mock search results based on query
            _searchResults = GetMockSearchResults(_searchQuery);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Search error: {ex.Message}");
        }
        finally
        {
            _isSearching = false;
        }
    }

    private List<ProductItem> GetMockSearchResults(string query)
    {
        // IDs match backend seed data for consistent navigation
        var allProducts = new List<ProductItem>
        {
            // Power Tools
            new(Guid.Parse("p0000001-0000-0000-0000-000000000001"), "DeWalt 20V MAX XR Brushless Drill/Driver Kit", 149.99m, 179.99m, true, "https://images.unsplash.com/photo-1504148455328-c376907d081c?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000005-0000-0000-0000-000000000005"), "DeWalt 20V MAX Circular Saw", 159.99m, null, true, "https://images.unsplash.com/photo-1530124566582-a618bc2615dc?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000024-0000-0000-0000-000000000024"), "DeWalt 20V MAX XR Battery 2-Pack", 99.99m, null, true, "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000002-0000-0000-0000-000000000002"), "Milwaukee M18 FUEL Hammer Drill", 299.99m, 349.99m, true, "https://images.unsplash.com/photo-1580901368919-7738efb0f87e?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000023-0000-0000-0000-000000000023"), "Bosch Plunge & Fixed Base Router", 199.99m, null, true, "https://images.unsplash.com/photo-1590122959498-1ccae0d48bc8?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000003-0000-0000-0000-000000000003"), "Makita 18V LXT Impact Driver", 179.99m, null, true, "https://images.unsplash.com/photo-1572981779307-38b8cabb2407?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000006-0000-0000-0000-000000000006"), "Ryobi ONE+ 18V 6-Tool Combo Kit", 299.99m, 449.99m, true, "https://images.unsplash.com/photo-1616401784845-180882ba9ba8?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000004-0000-0000-0000-000000000004"), "Bosch 12V Flexiclick 5-In-1 Drill System", 199.99m, 229.99m, true, "https://images.unsplash.com/photo-1590122959498-1ccae0d48bc8?w=400&h=400&fit=crop"),
            // Plumbing
            new(Guid.Parse("p0000010-0000-0000-0000-000000000010"), "Copper Pipe Fittings Set 1/2\"", 24.99m, 29.99m, true, "https://images.unsplash.com/photo-1585704032915-c3400ca199e7?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000011-0000-0000-0000-000000000011"), "SharkBite 1/2\" Push-to-Connect Coupling", 12.99m, null, true, "https://images.unsplash.com/photo-1585704032915-c3400ca199e7?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000013-0000-0000-0000-000000000013"), "PVC Pipe 10ft Schedule 40 Bundle", 18.99m, null, true, "https://images.unsplash.com/photo-1504917595217-d4dc5ebe6122?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000012-0000-0000-0000-000000000012"), "Stanley FatMax Copper Pipe Cutter", 34.99m, null, true, "https://images.unsplash.com/photo-1581147036324-c17ac41f3f2c?w=400&h=400&fit=crop"),
            // Electrical
            new(Guid.Parse("p0000015-0000-0000-0000-000000000015"), "LED Shop Light 4ft Linkable", 39.99m, null, true, "https://images.unsplash.com/photo-1565814329452-e1efa11c5b89?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000014-0000-0000-0000-000000000014"), "Southwire Romex 12/2 NM-B Wire 250ft", 89.99m, 99.99m, true, "https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000016-0000-0000-0000-000000000016"), "Leviton 15A Tamper-Resistant Outlet (10-Pack)", 24.99m, null, true, "https://images.unsplash.com/photo-1558402529-d2638a7023e9?w=400&h=400&fit=crop"),
            // Hand Tools
            new(Guid.Parse("p0000007-0000-0000-0000-000000000007"), "Klein Tools 11-in-1 Screwdriver/Nut Driver", 24.99m, null, true, "https://images.unsplash.com/photo-1426927308491-6380b6a9936f?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000008-0000-0000-0000-000000000008"), "CRAFTSMAN 320-Piece Mechanic's Tool Set", 199.99m, 299.99m, true, "https://images.unsplash.com/photo-1581244277943-fe4a9c777189?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000009-0000-0000-0000-000000000009"), "Husky 52\" 15-Drawer Tool Chest & Cabinet", 599.99m, 899.99m, true, "https://images.unsplash.com/photo-1586864387967-d02ef85d93e8?w=400&h=400&fit=crop"),
            // Other
            new(Guid.Parse("p0000019-0000-0000-0000-000000000019"), "3M Scotch Blue Painter's Tape 1.88\"", 8.99m, null, true, "https://images.unsplash.com/photo-1562259949-e8e7689d7828?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000021-0000-0000-0000-000000000021"), "WD-40 Multi-Use Product 12oz", 6.99m, null, true, "https://images.unsplash.com/photo-1585771724684-38269d6639fd?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000020-0000-0000-0000-000000000020"), "Gorilla Heavy Duty Construction Adhesive", 7.49m, null, true, "https://images.unsplash.com/photo-1557166983-5939644c3b5e?w=400&h=400&fit=crop"),
            new(Guid.Parse("p0000017-0000-0000-0000-000000000017"), "Flexzilla Garden Hose 50ft", 29.99m, null, false, "https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=400&h=400&fit=crop"),
        };

        return allProducts
            .Where(p => p.Name.Contains(query, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private void SearchFromRecent(string query)
    {
        _searchQuery = query;
        _ = PerformSearch();
    }

    private void ClearSearch()
    {
        _searchQuery = "";
        _hasSearched = false;
        _searchResults.Clear();
    }

    private void ClearRecentSearches()
    {
        _recentSearches.Clear();
    }

    private void BrowseDepartment(string code)
    {
        Navigation.NavigateTo($"/products?category={code}");
    }

    private void ViewProduct(Guid id)
    {
        Navigation.NavigateTo($"/product/{id}");
    }

    private record ProductItem(Guid Id, string Name, decimal Price, decimal? OriginalPrice, bool InStock, string? ImageUrl);
    private record DepartmentItem(string Code, string Name, string Icon);
}
