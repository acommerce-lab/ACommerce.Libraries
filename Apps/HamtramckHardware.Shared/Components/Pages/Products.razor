@page "/products"
@inject ILocalizationService L
@inject IAppNavigationService Navigation
@inject ProductsClient ProductsClient

<div class="hh-page-content hh-products-page">
    <!-- Page Header -->
    <div class="hh-products-header">
        <h1 class="hh-page-title">@(_currentCategory?.Name ?? "All Products")</h1>
        <p class="hh-products-count">@_products.Count products</p>
    </div>

    <!-- Filter Bar -->
    <div class="hh-filter-bar">
        <button class="hh-filter-btn" @onclick="ToggleFilters">
            <i class="bi bi-funnel"></i>
            Filters
            @if (_activeFiltersCount > 0)
            {
                <span class="hh-filter-badge">@_activeFiltersCount</span>
            }
        </button>

        <div class="hh-sort-dropdown">
            <select @bind="_sortBy" @bind:after="ApplySort">
                <option value="featured">Featured</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="newest">Newest</option>
                <option value="bestselling">Best Selling</option>
                <option value="rating">Top Rated</option>
            </select>
        </div>
    </div>

    <!-- Category Pills (when no category selected) -->
    @if (string.IsNullOrEmpty(_categoryCode))
    {
        <div class="hh-category-scroll">
            @foreach (var category in _categories)
            {
                <button class="hh-category-pill @(_categoryCode == category.Code ? "active" : "")"
                        @onclick="() => FilterByCategory(category.Code)">
                    <i class="@category.Icon"></i>
                    @category.Name
                </button>
            }
        </div>
    }

    <!-- Filter Panel (shown when toggled) -->
    @if (_showFilters)
    {
        <div class="hh-filter-panel hh-card">
            <div class="hh-filter-header">
                <h3>Filters</h3>
                <button class="hh-link-btn" @onclick="ClearFilters">Clear All</button>
            </div>

            <!-- Price Range -->
            <div class="hh-filter-section">
                <h4>Price Range</h4>
                <div class="hh-price-inputs">
                    <input type="number" placeholder="Min" @bind="_minPrice" />
                    <span>to</span>
                    <input type="number" placeholder="Max" @bind="_maxPrice" />
                </div>
            </div>

            <!-- Brands -->
            <div class="hh-filter-section">
                <h4>Brands</h4>
                @foreach (var brand in _brands)
                {
                    <label class="hh-checkbox">
                        <input type="checkbox"
                               checked="@_selectedBrands.Contains(brand)"
                               @onchange="e => ToggleBrand(brand, (bool)(e.Value ?? false))" />
                        <span>@brand</span>
                    </label>
                }
            </div>

            <!-- In Stock Only -->
            <div class="hh-filter-section">
                <label class="hh-checkbox">
                    <input type="checkbox" @bind="_inStockOnly" />
                    <span>In Stock Only</span>
                </label>
            </div>

            <!-- On Sale -->
            <div class="hh-filter-section">
                <label class="hh-checkbox">
                    <input type="checkbox" @bind="_onSaleOnly" />
                    <span>On Sale</span>
                </label>
            </div>

            <button class="hh-btn hh-btn-primary hh-btn-block" @onclick="ApplyFilters">
                Apply Filters
            </button>
        </div>
    }

    <!-- Products Grid -->
    @if (_isLoading)
    {
        <div class="hh-loading-container">
            <div class="hh-spinner"></div>
            <p>Loading products...</p>
        </div>
    }
    else if (!_products.Any())
    {
        <div class="hh-empty-state">
            <i class="bi bi-box-seam"></i>
            <h2>No Products Found</h2>
            <p>Try adjusting your filters or browse our categories.</p>
            <button class="hh-btn hh-btn-secondary" @onclick="ClearFilters">
                Clear Filters
            </button>
        </div>
    }
    else
    {
        <div class="hh-products-grid">
            @foreach (var product in _products)
            {
                <div class="hh-product-card" @onclick="() => ViewProduct(product.Id)">
                    @if (product.OriginalPrice.HasValue && product.OriginalPrice > product.Price)
                    {
                        <span class="hh-sale-badge">Sale</span>
                    }
                    <img src="@(product.ImageUrl ?? "/images/placeholder-product.png")"
                         alt="@product.Name"
                         class="hh-product-image" />
                    <div class="hh-product-info">
                        <span class="hh-product-brand">@product.Brand</span>
                        <div class="hh-product-name">@product.Name</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="hh-product-price">$@product.Price.ToString("0.00")</span>
                            @if (product.OriginalPrice.HasValue && product.OriginalPrice > product.Price)
                            {
                                <span class="hh-product-original-price">$@product.OriginalPrice.Value.ToString("0.00")</span>
                            }
                        </div>
                        @if (product.Rating.HasValue)
                        {
                            <div class="hh-product-rating">
                                <i class="bi bi-star-fill"></i>
                                <span>@product.Rating.Value.ToString("0.0")</span>
                            </div>
                        }
                        <span class="hh-stock-badge @(product.InStock ? "in-stock" : "out-of-stock")">
                            @(product.InStock ? L["InStock"] : L["OutOfStock"])
                        </span>
                    </div>
                </div>
            }
        </div>

        <!-- Load More -->
        @if (_hasMore)
        {
            <div class="hh-load-more">
                <button class="hh-btn hh-btn-secondary" @onclick="LoadMore" disabled="@_isLoadingMore">
                    @if (_isLoadingMore)
                    {
                        <span class="hh-spinner-sm"></span>
                    }
                    Load More
                </button>
            </div>
        }
    }
</div>

@code {
    [SupplyParameterFromQuery]
    public string? Category { get; set; }

    [SupplyParameterFromQuery]
    public string? Sort { get; set; }

    private bool _isLoading = true;
    private bool _isLoadingMore = false;
    private bool _showFilters = false;
    private bool _hasMore = true;
    private int _page = 1;

    private string? _categoryCode;
    private CategoryInfo? _currentCategory;
    private string _sortBy = "featured";
    private decimal? _minPrice;
    private decimal? _maxPrice;
    private bool _inStockOnly = false;
    private bool _onSaleOnly = false;
    private List<string> _selectedBrands = new();
    private int _activeFiltersCount => (_minPrice.HasValue ? 1 : 0) + (_maxPrice.HasValue ? 1 : 0) +
                                        (_inStockOnly ? 1 : 0) + (_onSaleOnly ? 1 : 0) + _selectedBrands.Count;

    private List<ProductItem> _products = new();
    private List<CategoryInfo> _categories = new();
    private List<string> _brands = new() { "DeWalt", "Milwaukee", "Makita", "Bosch", "Ryobi", "Stanley" };

    protected override async Task OnInitializedAsync()
    {
        _categories = GetCategories();
        _categoryCode = Category;
        _sortBy = Sort ?? "featured";

        if (!string.IsNullOrEmpty(_categoryCode))
        {
            _currentCategory = _categories.FirstOrDefault(c => c.Code == _categoryCode);
        }

        await LoadProducts();
    }

    private List<CategoryInfo> GetCategories()
    {
        return new List<CategoryInfo>
        {
            new("plumbing", "Plumbing", "bi bi-droplet"),
            new("electrical", "Electrical", "bi bi-lightning-charge"),
            new("tools", "Tools", "bi bi-tools"),
            new("lawn", "Lawn & Garden", "bi bi-flower1"),
            new("paint", "Paint", "bi bi-palette"),
            new("lumber", "Lumber", "bi bi-box"),
            new("flooring", "Flooring", "bi bi-grid-3x3"),
            new("hardware", "Hardware", "bi bi-nut"),
        };
    }

    private async Task LoadProducts()
    {
        try
        {
            _isLoading = true;

            // Simulate API call
            await Task.Delay(300);

            _products = GetMockProducts();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading products: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private List<ProductItem> GetMockProducts()
    {
        return new List<ProductItem>
        {
            new(Guid.NewGuid(), "DeWalt", "DeWalt 20V MAX Cordless Drill", 149.99m, 179.99m, true, 4.7m, "/images/products/drill.jpg"),
            new(Guid.NewGuid(), "Milwaukee", "Milwaukee M18 Impact Driver", 129.99m, null, true, 4.8m, "/images/products/impact.jpg"),
            new(Guid.NewGuid(), "Stanley", "Copper Pipe Fittings Set", 24.99m, 29.99m, true, 4.2m, "/images/products/fittings.jpg"),
            new(Guid.NewGuid(), "Makita", "LED Shop Light 4ft", 39.99m, null, true, 4.5m, "/images/products/light.jpg"),
            new(Guid.NewGuid(), "Milwaukee", "Milwaukee Hammer Drill", 299.99m, 349.99m, true, 4.9m, "/images/products/hammer-drill.jpg"),
            new(Guid.NewGuid(), "Generic", "PVC Pipe 10ft Bundle", 18.99m, null, true, 4.0m, "/images/products/pvc.jpg"),
            new(Guid.NewGuid(), "Southwire", "Electrical Wire 100ft", 45.99m, null, true, 4.3m, "/images/products/wire.jpg"),
            new(Guid.NewGuid(), "Craftsman", "Socket Wrench Set 40pc", 79.99m, 99.99m, true, 4.6m, "/images/products/socket-set.jpg"),
            new(Guid.NewGuid(), "Flexzilla", "Garden Hose 50ft", 29.99m, null, false, 4.4m, "/images/products/hose.jpg"),
            new(Guid.NewGuid(), "DeWalt", "DeWalt Circular Saw", 159.99m, null, true, 4.7m, "/images/products/saw.jpg"),
            new(Guid.NewGuid(), "Ryobi", "Ryobi Leaf Blower", 89.99m, 109.99m, true, 4.1m, "/images/products/blower.jpg"),
            new(Guid.NewGuid(), "Bosch", "Bosch Router Kit", 199.99m, null, true, 4.8m, "/images/products/router.jpg"),
        };
    }

    private void ToggleFilters()
    {
        _showFilters = !_showFilters;
    }

    private void ToggleBrand(string brand, bool isChecked)
    {
        if (isChecked)
            _selectedBrands.Add(brand);
        else
            _selectedBrands.Remove(brand);
    }

    private async Task ApplyFilters()
    {
        _showFilters = false;
        _page = 1;
        await LoadProducts();
    }

    private async Task ClearFilters()
    {
        _minPrice = null;
        _maxPrice = null;
        _inStockOnly = false;
        _onSaleOnly = false;
        _selectedBrands.Clear();
        _categoryCode = null;
        _currentCategory = null;
        _page = 1;
        await LoadProducts();
    }

    private async Task ApplySort()
    {
        _page = 1;
        await LoadProducts();
    }

    private void FilterByCategory(string code)
    {
        _categoryCode = code;
        _currentCategory = _categories.FirstOrDefault(c => c.Code == code);
        Navigation.NavigateTo($"/products?category={code}");
    }

    private async Task LoadMore()
    {
        _isLoadingMore = true;
        _page++;

        // Simulate API call
        await Task.Delay(500);

        // Add more products
        _products.AddRange(GetMockProducts().Take(4));

        _isLoadingMore = false;
        _hasMore = _page < 3; // Limit for demo
    }

    private void ViewProduct(Guid id)
    {
        Navigation.NavigateTo($"/product/{id}");
    }

    private record CategoryInfo(string Code, string Name, string Icon);
    private record ProductItem(Guid Id, string Brand, string Name, decimal Price, decimal? OriginalPrice, bool InStock, decimal? Rating, string? ImageUrl);
}
