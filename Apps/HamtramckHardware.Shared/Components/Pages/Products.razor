@page "/products"
@using ACommerce.Templates.Customer.Components
@using HamtramckHardware.Shared.Services
@inject HamtramckDataService DataService
@inject IAppNavigationService Navigation

<div class="ac-page hh-products-page" style="direction: ltr;">
    <div class="ac-page-header" style="padding: 16px;">
        <h1 class="ac-page-title">@(_currentCategory?.Name ?? "All Products")</h1>
        <p style="color: var(--ac-text-muted); margin: 0;">@_products.Count products</p>
    </div>

    <div class="ac-filter-bar" style="display: flex; justify-content: space-between; align-items: center; padding: 0 16px 16px;">
        <AcButton Text="@($"Filters{(_activeFiltersCount > 0 ? $" ({_activeFiltersCount})" : "")}")"
                  Icon="bi-funnel" Variant="ButtonVariant.Secondary" Size="ButtonSize.Small" OnClick="ToggleFilters" />
        <select class="ac-select" style="padding: 8px 12px; border-radius: var(--ac-radius-md); border: 1px solid var(--ac-border);" @bind="_sortBy" @bind:after="ApplySort">
            <option value="featured">Featured</option>
            <option value="price-low">Price: Low to High</option>
            <option value="price-high">Price: High to Low</option>
            <option value="rating">Top Rated</option>
        </select>
    </div>

    @if (string.IsNullOrEmpty(_categoryId))
    {
        <div class="hh-category-scroll">
            @foreach (var category in _categories)
            {
                <button class="hh-category-pill" @onclick="() => FilterByCategory(category.Id)">
                    <i class="@category.Icon"></i> @category.Name
                </button>
            }
        </div>
    }

    @if (_showFilters)
    {
        <div class="ac-card" style="margin: 0 16px 16px; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin: 0; font-size: 1.125rem;">Filters</h3>
                <button class="ac-link-btn" @onclick="ClearFilters">Clear All</button>
            </div>
            <div style="margin-bottom: 16px;">
                <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 8px;">Price Range</h4>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="number" placeholder="Min" @bind="_minPrice" style="flex: 1; padding: 8px; border-radius: var(--ac-radius-sm); border: 1px solid var(--ac-border);" />
                    <span>to</span>
                    <input type="number" placeholder="Max" @bind="_maxPrice" style="flex: 1; padding: 8px; border-radius: var(--ac-radius-sm); border: 1px solid var(--ac-border);" />
                </div>
            </div>
            <div style="margin-bottom: 8px;">
                <label class="ac-checkbox" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" @bind="_inStockOnly" /><span>In Stock Only</span>
                </label>
            </div>
            <div style="margin-bottom: 16px;">
                <label class="ac-checkbox" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" @bind="_onSaleOnly" /><span>On Sale</span>
                </label>
            </div>
            <AcButton Text="Apply Filters" Variant="ButtonVariant.Primary" Block="true" OnClick="ApplyFilters" />
        </div>
    }

    @if (_isLoading)
    {
        <div class="ac-loading-container"><AcSpinner /><p>Loading products...</p></div>
    }
    else if (!_products.Any())
    {
        <AcEmptyState Icon="bi-box-seam" Title="No Products Found"
                      Description="Try adjusting your filters or browse our categories."
                      ActionText="Clear Filters" OnAction="ClearFilters" />
    }
    else
    {
        <div class="ac-products-grid">
            @foreach (var product in _products)
            {
                <AcProductCard Id="product.Id" Name="@product.Name" ImageUrl="@product.Image"
                               Price="product.Price" OldPrice="@product.OldPrice"
                               Currency="$" CurrencyBeforePrice="true"
                               DiscountPercent="@(product.OldPrice > 0 ? (int)Math.Round((product.OldPrice - product.Price) / product.OldPrice * 100) : 0)"
                               Rating="@product.Rating" StockQuantity="@product.InStock"
                               ShowQuickActions="false"
                               FeaturedLabel="Featured" NewLabel="New"
                               InStockLabel="In Stock ({0})" OutOfStockLabel="Out of Stock"
                               AddToCartLabel="Add to Cart" AddToWishlistLabel="Add to Wishlist"
                               OnClick="@(id => Navigation.NavigateTo($\"/product/{product.Id}\"))" />
            }
        </div>
    }
</div>

<style>
    .hh-category-scroll { display: flex; gap: 8px; padding: 0 16px 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .hh-category-scroll::-webkit-scrollbar { display: none; }
    .hh-category-pill { display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: var(--ac-surface); border: 1px solid var(--ac-border); border-radius: 20px; font-size: 0.875rem; white-space: nowrap; cursor: pointer; }
    .hh-category-pill:hover { background: var(--ac-surface-hover); border-color: var(--ac-primary); }
    .hh-category-pill i { color: var(--ac-primary); }
</style>

@code {
    [SupplyParameterFromQuery] public string? Category { get; set; }
    [SupplyParameterFromQuery] public string? Sort { get; set; }

    private bool _isLoading = true;
    private bool _showFilters = false;
    private string? _categoryId;
    private HomeCategoryItem? _currentCategory;
    private string _sortBy = "featured";
    private decimal? _minPrice, _maxPrice;
    private bool _inStockOnly = false, _onSaleOnly = false;
    private int _activeFiltersCount => (_minPrice.HasValue ? 1 : 0) + (_maxPrice.HasValue ? 1 : 0) + (_inStockOnly ? 1 : 0) + (_onSaleOnly ? 1 : 0);

    private List<HomeProductItem> _products = new();
    private List<HomeCategoryItem> _categories = new();

    protected override async Task OnInitializedAsync()
    {
        _categories = DataService.GetCategories();
        _categoryId = Category;
        _sortBy = Sort ?? "featured";

        if (!string.IsNullOrEmpty(_categoryId) && Guid.TryParse(_categoryId, out var catId))
            _currentCategory = _categories.FirstOrDefault(c => c.Id == catId);

        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        _isLoading = true;
        await Task.Delay(200);

        var allProducts = DataService.GetAllProducts();
        _products = ApplyFiltersAndSort(allProducts);
        _isLoading = false;
    }

    private List<HomeProductItem> ApplyFiltersAndSort(List<HomeProductItem> products)
    {
        var result = products.AsEnumerable();

        if (_currentCategory != null)
        {
            var slug = _currentCategory.Name.ToLower().Replace(" & ", "-").Replace(" ", "-");
            result = result.Where(p => p.Attributes?.TryGetValue("Category", out var cat) == true && cat == slug);
        }

        if (_minPrice.HasValue) result = result.Where(p => p.Price >= _minPrice.Value);
        if (_maxPrice.HasValue) result = result.Where(p => p.Price <= _maxPrice.Value);
        if (_inStockOnly) result = result.Where(p => p.InStock > 0);
        if (_onSaleOnly) result = result.Where(p => p.OldPrice > 0);

        return _sortBy switch
        {
            "price-low" => result.OrderBy(p => p.Price).ToList(),
            "price-high" => result.OrderByDescending(p => p.Price).ToList(),
            "rating" => result.OrderByDescending(p => p.Rating).ToList(),
            _ => result.ToList()
        };
    }

    private void ToggleFilters() => _showFilters = !_showFilters;
    private async Task ApplyFilters() { _showFilters = false; await LoadProducts(); }
    private async Task ClearFilters() { _minPrice = _maxPrice = null; _inStockOnly = _onSaleOnly = false; _categoryId = null; _currentCategory = null; await LoadProducts(); }
    private async Task ApplySort() => await LoadProducts();
    private void FilterByCategory(Guid id) { _categoryId = id.ToString(); _currentCategory = _categories.FirstOrDefault(c => c.Id == id); Navigation.NavigateTo($"/products?category={id}"); }
}
