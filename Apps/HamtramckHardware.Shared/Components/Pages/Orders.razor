@page "/orders"
@using ACommerce.Templates.Customer.Components
@using Microsoft.Extensions.Logging
@inject ILocalizationService L
@inject IAppNavigationService Navigation
@inject OrdersClient OrdersClient
@inject TokenManager TokenManager
@inject ILogger<Orders> Logger

<div class="ac-page" style="direction: ltr;">
    <h1 class="ac-page-title" style="padding: 16px; margin: 0;">
        <i class="bi bi-box-seam"></i> My Orders
    </h1>

    @if (!_isLoggedIn)
    {
        <AcEmptyState Icon="bi-person-lock"
                      Title="Sign In Required"
                      Description="Please sign in to view your order history."
                      ActionText="Sign In"
                      ActionIcon="bi-box-arrow-in-right"
                      OnAction="GoToLogin" />
    }
    else if (_isLoading)
    {
        <div class="ac-loading-container">
            <AcSpinner />
            <p>Loading your orders...</p>
        </div>
    }
    else if (!_orders.Any())
    {
        <AcEmptyState Icon="bi-bag-x"
                      Title="No Orders Yet"
                      Description="You haven't placed any orders yet."
                      ActionText="Start Shopping"
                      ActionIcon="bi-bag"
                      OnAction="GoShopping" />
    }
    else
    {
        <!-- Order Tabs -->
        <div class="ac-tabs" style="padding: 0 16px; margin-bottom: 16px;">
            <button class="ac-tab @(_selectedTab == "all" ? "active" : "")" @onclick='() => SelectTab("all")'>
                All
            </button>
            <button class="ac-tab @(_selectedTab == "pending" ? "active" : "")" @onclick='() => SelectTab("pending")'>
                Pending
            </button>
            <button class="ac-tab @(_selectedTab == "shipped" ? "active" : "")" @onclick='() => SelectTab("shipped")'>
                Shipped
            </button>
            <button class="ac-tab @(_selectedTab == "delivered" ? "active" : "")" @onclick='() => SelectTab("delivered")'>
                Delivered
            </button>
        </div>

        <!-- Orders List -->
        <div class="ac-orders-list" style="padding: 0 16px; display: flex; flex-direction: column; gap: 12px;">
            @foreach (var order in FilteredOrders)
            {
                <div class="ac-card" style="padding: 16px;">
                    <div class="hh-order-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <span style="font-weight: 600;">Order #@order.OrderNumber</span>
                            <span style="color: var(--ac-text-muted); font-size: 0.875rem; margin-left: 8px;">@order.Date.ToString("MMM dd, yyyy")</span>
                        </div>
                        <span class="ac-badge ac-badge-@order.Status.ToLower()">
                            @order.Status
                        </span>
                    </div>

                    <div class="hh-order-items" style="display: flex; gap: 8px; margin-bottom: 12px; overflow-x: auto;">
                        @foreach (var item in order.Items.Take(3))
                        {
                            <div class="hh-order-item" style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                                <img src="@(item.ImageUrl ?? "/images/placeholder-product.png")"
                                     alt="@item.Name"
                                     style="width: 48px; height: 48px; object-fit: cover; border-radius: var(--ac-radius-sm);" />
                                <div style="min-width: 0;">
                                    <div style="font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;">@item.Name</div>
                                    <div style="font-size: 0.75rem; color: var(--ac-text-muted);">Qty: @item.Quantity</div>
                                </div>
                            </div>
                        }
                        @if (order.Items.Count > 3)
                        {
                            <div style="display: flex; align-items: center; font-size: 0.875rem; color: var(--ac-text-muted);">
                                +@(order.Items.Count - 3) more
                            </div>
                        }
                    </div>

                    <div class="hh-order-footer" style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--ac-border);">
                        <div>
                            <span style="color: var(--ac-text-muted);">Total:</span>
                            <span style="font-weight: 600; margin-left: 4px;">$@order.Total.ToString("0.00")</span>
                        </div>
                        <AcButton Text="View Details"
                                  Variant="ButtonVariant.Secondary"
                                  Size="ButtonSize.Small"
                                  OnClick="@(() => ViewOrder(order.Id))" />
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private bool _isLoading = true;
    private bool _isLoggedIn = false;
    private string _selectedTab = "all";
    private List<OrderModel> _orders = new();

    private IEnumerable<OrderModel> FilteredOrders => _selectedTab == "all"
        ? _orders
        : _orders.Where(o => o.Status.Equals(_selectedTab, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        var token = await TokenManager.GetTokenAsync();
        _isLoggedIn = !string.IsNullOrEmpty(token);

        if (_isLoggedIn)
        {
            await LoadOrders();
        }
        else
        {
            _isLoading = false;
        }
    }

    private async Task LoadOrders()
    {
        try
        {
            _isLoading = true;

            // Get customer ID from token
            var token = await TokenManager.GetTokenAsync();
            var customerId = $"user-{token?.GetHashCode():X8}";

            // Try to load orders from API
            try
            {
                var ordersList = await OrdersClient.GetMyOrdersAsync(customerId);
                if (ordersList != null && ordersList.Any())
                {
                    _orders = ordersList.Select(o => new OrderModel(
                        o.Id,
                        o.OrderNumber ?? $"HH-{o.Id.ToString()[..6].ToUpper()}",
                        o.CreatedAt,
                        o.Status ?? "Pending",
                        o.TotalAmount,
                        o.Items?.Select(i => new OrderItemModel(
                            i.ProductName ?? "Product",
                            i.Quantity,
                            null // OrderItemDto doesn't have ImageUrl
                        )).ToList() ?? new List<OrderItemModel>()
                    )).ToList();

                    Logger.LogInformation("Orders loaded from API: {Count} orders", _orders.Count);
                    return;
                }
            }
            catch (Exception apiEx)
            {
                Logger.LogWarning(apiEx, "Failed to load orders from API");
            }

            // No orders found or API failed - show empty state
            _orders = new List<OrderModel>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading orders");
            _orders = new List<OrderModel>();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void SelectTab(string tab)
    {
        _selectedTab = tab;
    }

    private string GetStatusIcon(string status)
    {
        return status.ToLower() switch
        {
            "pending" => "<i class='bi bi-clock'></i>",
            "processing" => "<i class='bi bi-gear'></i>",
            "shipped" => "<i class='bi bi-truck'></i>",
            "delivered" => "<i class='bi bi-check-circle'></i>",
            "cancelled" => "<i class='bi bi-x-circle'></i>",
            _ => "<i class='bi bi-circle'></i>"
        };
    }

    private void ViewOrder(Guid orderId)
    {
        Navigation.NavigateTo($"/order/{orderId}");
    }

    private void GoToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    private void GoShopping()
    {
        Navigation.NavigateTo("/");
    }

    private record OrderModel(Guid Id, string OrderNumber, DateTime Date, string Status, decimal Total, List<OrderItemModel> Items);
    private record OrderItemModel(string Name, int Quantity, string? ImageUrl);
}
