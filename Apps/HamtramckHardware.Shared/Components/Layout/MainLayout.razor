@inherits LayoutComponentBase
@using ACommerce.Templates.Customer.Components
@using TemplateThemeService = ACommerce.Templates.Customer.Themes.ThemeService
@inject ThemeService ThemeService
@inject TemplateThemeService TemplateTheme
@inject IAppNavigationService Navigation
@inject TokenManager TokenManager
@inject ILocalizationService L
@implements IDisposable

<div class="ac-app hh-app" style="@GetThemeStyles()">
    <!-- Top Navbar -->
    <AcNavbar BrandName="Hamtramck Hardware"
              ShowSearch="true"
              ShowCart="true"
              ShowNotifications="false"
              CartItemCount="@_cartCount"
              OnSearchClick="HandleSearchClick"
              OnCartClick="HandleCartClick">
        <LogoContent>
            <div style="display: flex; align-items: center; gap: 8px; cursor: pointer;" @onclick="HandleLogoClick">
                <i class="bi bi-tools" style="font-size: 1.5rem;"></i>
                <span style="font-weight: 700;">Hamtramck Hardware</span>
            </div>
        </LogoContent>
    </AcNavbar>

    <!-- Promo Banner -->
    <div class="hh-promo-banner">
        <i class="bi bi-fire"></i> Propane Refill Only $9.99! | Same Day Window Repair
    </div>

    <!-- Main Content -->
    <main class="ac-main">
        @Body
    </main>

    <!-- Bottom Navigation -->
    <AcBottomNav Items="@_navItems" OnItemClick="HandleNavClick" />
</div>

<style>
    .hh-app {
        /* Override direction to LTR for English */
        direction: ltr !important;
    }

    /* Fix RTL issues from template */
    .hh-app .ac-navbar,
    .hh-app .ac-bottom-nav,
    .hh-app .ac-main,
    .hh-app .ac-section,
    .hh-app .ac-page {
        direction: ltr;
        text-align: left;
    }

    .hh-app .ac-navbar-actions {
        margin-left: auto;
        margin-right: 0;
    }

    .hh-app .bi-arrow-right::before {
        content: "\f12f"; /* bi-arrow-left */
    }

    .hh-promo-banner {
        background: linear-gradient(135deg, var(--ac-accent) 0%, var(--ac-accent-dark) 100%);
        color: white;
        padding: 10px 16px;
        text-align: center;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .hh-promo-banner i {
        margin-right: 8px;
    }

    /* Fix menu items direction */
    .hh-app .ac-menu-item,
    .hh-app .ac-profile-menu a {
        flex-direction: row;
    }

    .hh-app .ac-profile-menu .bi-chevron-left::before {
        content: "\f285"; /* bi-chevron-right */
    }
</style>

@code {
    private int _cartCount = 0; // Start with 0, will be updated when cart changes
    private bool _isLoggedIn = false;
    private List<BottomNavItem> _navItems = new();

    protected override async Task OnInitializedAsync()
    {
        ThemeService.OnThemeChanged += OnThemeChanged;

        var token = await TokenManager.GetTokenAsync();
        _isLoggedIn = !string.IsNullOrEmpty(token);

        InitializeNavItems();
    }

    protected override void OnParametersSet()
    {
        UpdateActiveNavItem();
    }

    private void InitializeNavItems()
    {
        _navItems = new List<BottomNavItem>
        {
            new() { Id = "home", Href = "/", Label = "Home", Icon = "bi-house", ActiveIcon = "bi-house-fill" },
            new() { Id = "categories", Href = "/categories", Label = "Categories", Icon = "bi-grid", ActiveIcon = "bi-grid-fill" },
            new() { Id = "cart", Href = "/cart", Label = "Cart", Icon = "bi-cart3", ActiveIcon = "bi-cart-fill", BadgeCount = _cartCount },
            new() { Id = "orders", Href = "/orders", Label = "My Orders", Icon = "bi-box-seam", ActiveIcon = "bi-box-seam-fill" },
            new() { Id = "profile", Href = "/profile", Label = "My Account", Icon = "bi-person", ActiveIcon = "bi-person-fill" },
        };
        UpdateActiveNavItem();
    }

    private void UpdateActiveNavItem()
    {
        var currentPath = "/";
        try
        {
            var uri = new Uri(Navigation.CurrentUri);
            currentPath = uri.AbsolutePath;
        }
        catch { }

        foreach (var item in _navItems)
        {
            item.IsActive = item.Href == currentPath ||
                           (item.Href == "/" && currentPath == "/") ||
                           (item.Href != "/" && currentPath.StartsWith(item.Href));
        }
    }

    private void HandleLogoClick()
    {
        Navigation.NavigateTo("/");
    }

    private void HandleSearchClick()
    {
        Navigation.NavigateTo("/search");
    }

    private void HandleCartClick()
    {
        Navigation.NavigateTo("/cart");
    }

    private void HandleNavClick(BottomNavItem item)
    {
        Navigation.NavigateTo(item.Href);
    }

    private void OnThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }

    private string GetThemeStyles()
    {
        // Apply theme CSS variables from the template theme service
        return $"direction: ltr; {TemplateTheme.GenerateInlineStyles()}";
    }
}
