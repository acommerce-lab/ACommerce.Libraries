@page "/book/{SpaceId:guid}"
@using ACommerce.Client.Auth
@using ACommerce.Templates.Customer.Services
@using Ashare.Shared.Components.Shared
@inject AshareApiService ApiService
@inject IAppNavigationService Navigation
@inject TokenManager TokenManager

<div class="ac-page ashare-booking-create">
    @if (_showPayment && !string.IsNullOrEmpty(_paymentUrl))
    {
        @* Payment WebView *@
        <PaymentWebView PaymentUrl="@_paymentUrl"
                        PaymentId="@_bookingId"
                        OnPaymentCompleted="HandlePaymentCompleted"
                        OnPaymentCancelled="HandlePaymentCancelled" />
    }
    else if (_isLoading)
    {
        <div class="ashare-loading">
            <div class="ac-spinner"></div>
            <span>جاري التحميل...</span>
        </div>
    }
    else if (_space == null)
    {
        <div class="ashare-error-state">
            <i class="bi bi-exclamation-circle"></i>
            <h2>العرض غير موجود</h2>
            <button class="ac-btn ac-btn-primary" @onclick="GoBack">العودة</button>
        </div>
    }
    else
    {
        @* Header *@
        <div class="ashare-booking-header">
            <button class="ashare-back-btn" @onclick="GoBack">
                <i class="bi bi-arrow-right"></i>
            </button>
            <h1>حجز العقار</h1>
        </div>

        @* Space Summary *@
        <div class="ashare-booking-space-card">
            <div class="ashare-booking-space-image">
                @if (_space.Images.Any())
                {
                    <img src="@_space.Images.First()" alt="@_space.Name" />
                }
                else
                {
                    <div class="ashare-space-no-image">
                        <i class="bi bi-building"></i>
                    </div>
                }
            </div>
            <div class="ashare-booking-space-info">
                <h3>@_space.Name</h3>
                <p class="ashare-booking-space-location">
                    <i class="bi bi-geo-alt"></i>
                    @GetLocationDisplay()
                </p>
            </div>
        </div>

        @* Payment Protection Banner *@
        <div class="ashare-protection-banner">
            <div class="ashare-protection-icon">
                <i class="bi bi-shield-check"></i>
            </div>
            <div class="ashare-protection-content">
                <h3>حماية المبلغ</h3>
                <p>مبلغك محمي بالكامل - لن يتم تحويله للمعلن إلا بعد اتفاق الطرفين، ويمكنك استرداده فوراً في أي وقت</p>
            </div>
        </div>

        @* Pricing Details *@
        <div class="ashare-booking-section">
            <h2 class="ashare-section-title">تفاصيل السعر</h2>

            <div class="ashare-price-breakdown">
                <div class="ashare-price-row">
                    <span>إيجار @GetRentTypeLabel()</span>
                    <span>@GetPrice() ر.س</span>
                </div>

                @if (_depositPercentage > 0)
                {
                    <div class="ashare-price-row deposit">
                        <span>العربون (@_depositPercentage%)</span>
                        <span>@CalculateDeposit() ر.س</span>
                    </div>
                }

                <div class="ashare-price-divider"></div>

                <div class="ashare-price-row total">
                    <span>المبلغ المطلوب الآن</span>
                    <span>@GetRequiredAmount() ر.س</span>
                </div>
            </div>
        </div>

        @* How It Works *@
        <div class="ashare-booking-section">
            <h2 class="ashare-section-title">
                <i class="bi bi-question-circle"></i>
                كيف تعمل الحماية؟
            </h2>
            <div class="ashare-steps">
                <div class="ashare-step">
                    <div class="ashare-step-number">1</div>
                    <div class="ashare-step-content">
                        <h4>ادفع العربون</h4>
                        <p>ادفع العربون الآن وسيتم حفظه في حسابك المحمي</p>
                    </div>
                </div>
                <div class="ashare-step">
                    <div class="ashare-step-number">2</div>
                    <div class="ashare-step-content">
                        <h4>تواصل مع المعلن</h4>
                        <p>تواصل مع المعلن واتفق على تفاصيل العقد والمعاينة</p>
                    </div>
                </div>
                <div class="ashare-step">
                    <div class="ashare-step-number">3</div>
                    <div class="ashare-step-content">
                        <h4>أكد الاتفاق أو استرد</h4>
                        <p>بعد الاتفاق، أكد الحجز ليتم تحويل العربون للمعلن، أو استرده فوراً</p>
                    </div>
                </div>
            </div>
        </div>

        @* Important Notes *@
        <div class="ashare-booking-section ashare-notes-section">
            <h2 class="ashare-section-title">ملاحظات مهمة</h2>
            <ul class="ashare-booking-notes">
                <li>
                    <i class="bi bi-check-circle-fill"></i>
                    <span>العربون <strong>مسترد بالكامل</strong> في حال عدم الاتفاق</span>
                </li>
                <li>
                    <i class="bi bi-check-circle-fill"></i>
                    <span>لا يتم تحويل أي مبلغ للمعلن إلا <strong>بعد تأكيدك</strong></span>
                </li>
                <li>
                    <i class="bi bi-check-circle-fill"></i>
                    <span>يمكنك <strong>الاسترداد الفوري</strong> بضغطة زر بدون تعقيدات</span>
                </li>
                <li>
                    <i class="bi bi-check-circle-fill"></i>
                    <span>باقي الإيجار يتم دفعه <strong>مباشرة للمعلن</strong> عند التسليم</span>
                </li>
            </ul>
        </div>

        @* Agreement *@
        <div class="ashare-booking-agreement">
            <label class="ashare-checkbox">
                <input type="checkbox" @bind="_agreedToTerms" />
                <span class="ashare-checkbox-mark"></span>
                <span>أوافق على <a href="/legal/terms">شروط الاستخدام</a> و<a href="/legal/privacy">سياسة الخصوصية</a></span>
            </label>
        </div>

        @* Error Message *@
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="ashare-booking-error">
                <i class="bi bi-exclamation-triangle"></i>
                @_errorMessage
            </div>
        }

        @* Submit Button *@
        <div class="ashare-booking-submit">
            <button class="ac-btn ac-btn-primary ac-btn-lg ac-btn-block"
                    @onclick="StartPayment"
                    disabled="@(!_agreedToTerms || _isSubmitting)">
                @if (_isSubmitting)
                {
                    <div class="ac-spinner ac-spinner-sm"></div>
                    <span>جاري تجهيز الدفع...</span>
                }
                else
                {
                    <i class="bi bi-shield-lock"></i>
                    <span>دفع العربون @GetRequiredAmount() ر.س</span>
                }
            </button>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid SpaceId { get; set; }

    private SpaceItem? _space;
    private bool _isLoading = true;
    private bool _isSubmitting;
    private bool _agreedToTerms;
    private string? _errorMessage;
    private decimal _depositPercentage = 10; // Default 10%, will be fetched from backend

    // Payment state
    private bool _showPayment;
    private string? _paymentUrl;
    private string? _bookingId;

    protected override async Task OnInitializedAsync()
    {
        await LoadSpaceAsync();
    }

    private async Task LoadSpaceAsync()
    {
        _isLoading = true;
        try
        {
            _space = await ApiService.GetSpaceByIdAsync(SpaceId);

            // TODO: Fetch deposit percentage from backend settings
            // var settings = await SettingsClient.GetAsync("Booking.DepositPercentage");
            // if (decimal.TryParse(settings?.Value, out var percentage))
            //     _depositPercentage = percentage;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[BookingCreate] Error loading space: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetLocationDisplay()
    {
        var parts = new List<string>();

        if (HasAttribute("district"))
            parts.Add(GetAttribute("district"));
        else if (!string.IsNullOrEmpty(_space?.Location))
            parts.Add(_space.Location);

        if (HasAttribute("city"))
            parts.Add(GetAttribute("city"));
        else if (!string.IsNullOrEmpty(_space?.City))
            parts.Add(_space.City);

        return parts.Any() ? string.Join("، ", parts) : "غير محدد";
    }

    private bool HasAttribute(string key)
    {
        return _space?.Attributes?.ContainsKey(key) == true &&
               _space.Attributes[key] != null &&
               !string.IsNullOrEmpty(_space.Attributes[key].ToString());
    }

    private string GetAttribute(string key)
    {
        if (_space?.Attributes?.TryGetValue(key, out var value) == true && value != null)
        {
            return value.ToString() ?? "";
        }
        return "";
    }

    private string GetRentTypeLabel()
    {
        if (!HasAttribute("rent_type")) return "شهري";

        return GetAttribute("rent_type").ToLower() switch
        {
            "monthly" => "شهري",
            "yearly" or "annual" => "سنوي",
            "daily" => "يومي",
            "weekly" => "أسبوعي",
            _ => "شهري"
        };
    }

    private decimal GetPrice()
    {
        if (HasAttribute("price") && decimal.TryParse(GetAttribute("price"), out var price))
        {
            return price;
        }
        return _space?.PricePerHour ?? 0;
    }

    private decimal CalculateDeposit()
    {
        return Math.Round(GetPrice() * _depositPercentage / 100, 2);
    }

    private decimal GetRequiredAmount()
    {
        return CalculateDeposit();
    }

    private async Task StartPayment()
    {
        if (!_agreedToTerms)
        {
            _errorMessage = "يجب الموافقة على الشروط والأحكام";
            return;
        }

        // Check if user is logged in
        var userId = TokenManager.GetUserIdFromToken();
        if (string.IsNullOrEmpty(userId))
        {
            Navigation.NavigateTo("/login?returnUrl=/book/" + SpaceId);
            return;
        }

        _isSubmitting = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            // TODO: Create booking and get payment URL from API
            // var result = await ApiService.CreateBookingWithPaymentAsync(new CreateBookingRequest
            // {
            //     SpaceId = SpaceId,
            //     DepositAmount = CalculateDeposit(),
            //     TotalPrice = GetPrice(),
            //     RentType = GetAttribute("rent_type")
            // });
            //
            // if (result.Success && !string.IsNullOrEmpty(result.PaymentUrl))
            // {
            //     _bookingId = result.BookingId;
            //     _paymentUrl = result.PaymentUrl;
            //     _showPayment = true;
            // }

            // Temporary: For testing, navigate to payment simulation
            Console.WriteLine($"[BookingCreate] Creating booking for space {SpaceId} with deposit {CalculateDeposit()} SAR");

            // For now, show that we need to implement the payment API
            _errorMessage = "جاري تطوير نظام الدفع - سيتم التفعيل قريباً";
        }
        catch (Exception ex)
        {
            _errorMessage = "حدث خطأ أثناء تجهيز الدفع. حاول مرة أخرى.";
            Console.WriteLine($"[BookingCreate] Error: {ex.Message}");
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task HandlePaymentCompleted(PaymentResult result)
    {
        _showPayment = false;

        if (result.Success)
        {
            // Payment successful, navigate to booking confirmation
            Console.WriteLine($"[BookingCreate] Payment successful: {result.TransactionId}");
            Navigation.NavigateTo($"/bookings/{_bookingId}?status=success");
        }
        else
        {
            // Payment failed
            _errorMessage = result.Message ?? "فشلت عملية الدفع. حاول مرة أخرى.";
            StateHasChanged();
        }
    }

    private void HandlePaymentCancelled()
    {
        _showPayment = false;
        _paymentUrl = null;
        StateHasChanged();
    }

    private void GoBack()
    {
        if (_showPayment)
        {
            _showPayment = false;
            _paymentUrl = null;
            StateHasChanged();
        }
        else
        {
            Navigation.NavigateBack();
        }
    }
}

<style>
    .ashare-booking-create {
        padding-bottom: 100px;
    }

    .ashare-booking-header {
        display: flex;
        align-items: center;
        gap: var(--ashare-spacing-md);
        padding: var(--ashare-spacing-md);
        background: var(--ashare-surface);
        border-bottom: 1px solid var(--ashare-gray-200);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .ashare-booking-header h1 {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
    }

    .ashare-booking-space-card {
        display: flex;
        gap: var(--ashare-spacing-md);
        padding: var(--ashare-spacing-md);
        background: var(--ashare-surface);
        margin: var(--ashare-spacing-md);
        border-radius: var(--ashare-radius-lg);
        box-shadow: var(--ashare-shadow-sm);
    }

    .ashare-booking-space-image {
        width: 80px;
        height: 80px;
        border-radius: var(--ashare-radius-md);
        overflow: hidden;
        flex-shrink: 0;
    }

    .ashare-booking-space-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .ashare-booking-space-info {
        flex: 1;
        min-width: 0;
    }

    .ashare-booking-space-info h3 {
        font-size: 16px;
        font-weight: 600;
        margin: 0 0 var(--ashare-spacing-xs);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .ashare-booking-space-location {
        font-size: 14px;
        color: var(--ashare-gray-500);
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--ashare-spacing-xs);
    }

    /* Protection Banner */
    .ashare-protection-banner {
        display: flex;
        gap: var(--ashare-spacing-md);
        padding: var(--ashare-spacing-md);
        margin: var(--ashare-spacing-md);
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: var(--ashare-radius-lg);
        color: white;
    }

    .ashare-protection-icon {
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .ashare-protection-icon i {
        font-size: 24px;
    }

    .ashare-protection-content h3 {
        font-size: 16px;
        font-weight: 700;
        margin: 0 0 var(--ashare-spacing-xs);
    }

    .ashare-protection-content p {
        font-size: 13px;
        margin: 0;
        opacity: 0.9;
        line-height: 1.5;
    }

    .ashare-booking-section {
        padding: var(--ashare-spacing-md);
        margin: var(--ashare-spacing-md);
        background: var(--ashare-surface);
        border-radius: var(--ashare-radius-lg);
        box-shadow: var(--ashare-shadow-sm);
    }

    .ashare-section-title {
        font-size: 16px;
        font-weight: 600;
        margin: 0 0 var(--ashare-spacing-md);
        display: flex;
        align-items: center;
        gap: var(--ashare-spacing-sm);
    }

    .ashare-section-title i {
        color: var(--ashare-primary);
    }

    .ashare-price-breakdown {
        display: flex;
        flex-direction: column;
        gap: var(--ashare-spacing-sm);
    }

    .ashare-price-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
    }

    .ashare-price-row.deposit {
        color: var(--ashare-secondary);
        font-weight: 500;
    }

    .ashare-price-row.total {
        font-size: 18px;
        font-weight: 700;
        color: var(--ashare-primary);
    }

    .ashare-price-divider {
        height: 1px;
        background: var(--ashare-gray-200);
        margin: var(--ashare-spacing-sm) 0;
    }

    /* Steps */
    .ashare-steps {
        display: flex;
        flex-direction: column;
        gap: var(--ashare-spacing-md);
    }

    .ashare-step {
        display: flex;
        gap: var(--ashare-spacing-md);
    }

    .ashare-step-number {
        width: 32px;
        height: 32px;
        background: var(--ashare-primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        flex-shrink: 0;
    }

    .ashare-step-content h4 {
        font-size: 14px;
        font-weight: 600;
        margin: 0 0 4px;
    }

    .ashare-step-content p {
        font-size: 13px;
        color: var(--ashare-gray-500);
        margin: 0;
        line-height: 1.4;
    }

    /* Notes */
    .ashare-notes-section {
        background: var(--ashare-gray-50);
    }

    .ashare-booking-notes {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: var(--ashare-spacing-sm);
    }

    .ashare-booking-notes li {
        display: flex;
        align-items: flex-start;
        gap: var(--ashare-spacing-sm);
        font-size: 14px;
        color: var(--ashare-gray-700);
    }

    .ashare-booking-notes li i {
        color: #10b981;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .ashare-booking-notes li strong {
        color: var(--ashare-primary);
    }

    .ashare-booking-agreement {
        padding: var(--ashare-spacing-md);
        margin: var(--ashare-spacing-md);
    }

    .ashare-checkbox {
        display: flex;
        align-items: flex-start;
        gap: var(--ashare-spacing-sm);
        cursor: pointer;
        font-size: 14px;
    }

    .ashare-checkbox input {
        width: 20px;
        height: 20px;
        accent-color: var(--ashare-primary);
        flex-shrink: 0;
    }

    .ashare-checkbox a {
        color: var(--ashare-primary);
        text-decoration: underline;
    }

    .ashare-booking-error {
        display: flex;
        align-items: center;
        gap: var(--ashare-spacing-sm);
        padding: var(--ashare-spacing-md);
        margin: var(--ashare-spacing-md);
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border-radius: var(--ashare-radius-md);
        font-size: 14px;
    }

    .ashare-booking-submit {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: var(--ashare-spacing-md);
        padding-bottom: calc(var(--ashare-spacing-md) + var(--safe-area-bottom));
        background: var(--ashare-surface);
        border-top: 1px solid var(--ashare-gray-200);
    }

    .ac-btn-block {
        width: 100%;
    }

    .ashare-error-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 60vh;
        gap: var(--ashare-spacing-md);
        text-align: center;
        padding: var(--ashare-spacing-xl);
    }

    .ashare-error-state i {
        font-size: 48px;
        color: var(--ashare-gray-400);
    }

    .ashare-error-state h2 {
        font-size: 18px;
        color: var(--ashare-gray-600);
        margin: 0;
    }

    /* Tablet+ */
    @@media (min-width: 768px) {
        .ashare-booking-submit {
            max-width: 430px;
            left: 50%;
            transform: translateX(-50%);
        }
    }
</style>
