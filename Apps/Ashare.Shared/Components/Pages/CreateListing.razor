@page "/host/add"
@page "/create-listing"
@inject AshareApiService ApiService
@inject IAppNavigationService Navigation
@inject ACommerce.Client.Auth.TokenManager TokenManager
@inject ILocalizationService L
@inject ACommerce.Client.Subscriptions.SubscriptionClient SubscriptionClient
@inject ACommerce.Client.Auth.AuthClient AuthClient
@using ACommerce.Templates.Customer.Pages
@using ACommerce.Subscriptions.DTOs

@if (!_isAuthenticated)
{
    <div class="ac-page" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; padding: 20px;">
        <i class="bi bi-lock" style="font-size: 48px; color: var(--ashare-primary); margin-bottom: 16px;"></i>
        <h2 style="margin-bottom: 8px;">@L["LoginRequired"]</h2>
        <p style="color: var(--ashare-text-secondary); margin-bottom: 24px; text-align: center;">
            @L["LoginToCreateListing"]
        </p>
        <button class="ac-btn ac-btn-primary ac-btn-lg" @onclick="NavigateToLogin">
            <i class="bi bi-box-arrow-in-right"></i>
            @L["LoginWithNafath"]
        </button>
    </div>
}
else
{
    <CreateListingPage @ref="_createListingPage"
                   Categories="@_categories"
                   OnLoadCategoryAttributes="LoadCategoryAttributes"
                   OnSubmit="SubmitListing"
                   OnViewListing="ViewListing"
                   OnRequestLocation="RequestLocation" />

    @* Subscription Required Sheet *@
    @if (_showSubscriptionSheet)
    {
        <div class="ac-overlay" @onclick="CloseSubscriptionSheet"></div>
        <div class="ac-bottom-sheet ac-subscription-sheet">
            <div class="ac-sheet-header">
                <h2>@(_subscriptionCheckResult?.SubscriptionRequired == true ? "اشتراك مطلوب" : "ترقية الباقة")</h2>
                <button class="ac-close-btn" @onclick="CloseSubscriptionSheet">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="ac-sheet-content">
                @if (_subscriptionCheckResult?.SubscriptionRequired == true)
                {
                    <div class="ac-subscription-message">
                        <div class="ac-icon-circle warning">
                            <i class="bi bi-credit-card"></i>
                        </div>
                        <h3>لإنشاء عروض، تحتاج للاشتراك في إحدى الباقات</h3>
                        <p>اختر الباقة المناسبة لك للبدء في نشر عروضك</p>
                    </div>
                }
                else
                {
                    <div class="ac-subscription-message">
                        <div class="ac-icon-circle info">
                            <i class="bi bi-arrow-up-circle"></i>
                        </div>
                        <h3>@_subscriptionCheckResult?.Reason</h3>
                        <p>لديك @_subscriptionCheckResult?.CurrentCount من @(_subscriptionCheckResult?.MaxAllowed == -1 ? "غير محدود" : _subscriptionCheckResult?.MaxAllowed.ToString()) عرض</p>
                    </div>
                }

                <div class="ac-sheet-actions">
                    <button class="ac-btn ac-btn-primary ac-btn-lg" @onclick="GoToSubscriptionPlans">
                        <i class="bi bi-credit-card"></i>
                        عرض الباقات
                    </button>
                    <button class="ac-btn ac-btn-secondary" @onclick="CloseSubscriptionSheet">
                        إلغاء
                    </button>
                </div>
            </div>
        </div>
    }
}

@code {
    private bool _isAuthenticated;
    private CreateListingPage? _createListingPage;
    private List<ListingCategory>? _categories;
    private bool _showSubscriptionSheet;
    private CanAddListingResult? _subscriptionCheckResult;
    private CreateListingModel? _pendingModel;
    private Guid? _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        // التحقق من المصادقة أولاً (use async to trigger token initialization)
        var token = await TokenManager.GetTokenAsync();
        _isAuthenticated = !string.IsNullOrEmpty(token);

        if (_isAuthenticated)
        {
            await LoadCategories();
            await LoadCurrentUser();
        }
    }

    private async Task LoadCurrentUser()
    {
        try
        {
            var user = await AuthClient.GetMeAsync();
            _currentUserId = user?.Id;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading current user: {ex.Message}");
        }
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    private async Task LoadCategories()
    {
        try
        {
            var apiCategories = await ApiService.GetCategoriesAsync();
            _categories = apiCategories.Select(c => new ListingCategory
            {
                Id = c.Id,
                Name = c.Name,
                Slug = c.Name.ToLower().Replace(" ", "-"),
                Description = null,
                Icon = c.Icon,
                Image = c.Image
            }).ToList();

            _createListingPage?.SetCategories(_categories);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading categories: {ex.Message}");
        }
    }

    private async Task LoadCategoryAttributes(Guid categoryId)
    {
        try
        {
            Console.WriteLine($"[CreateListing] Loading attributes for category: {categoryId}");
            var apiAttributes = await ApiService.GetAttributesForCategoryAsync(categoryId);
            Console.WriteLine($"[CreateListing] Received {apiAttributes?.Count ?? 0} attributes from API");

            if (apiAttributes != null)
            {
                foreach (var attr in apiAttributes)
                {
                    Console.WriteLine($"[CreateListing] Attribute: {attr.Name} ({attr.Code}) - Type: {attr.Type}");
                }
            }

            var attributes = apiAttributes.Select(a => new ListingAttributeDefinition
            {
                Id = a.Id,
                Name = a.Name,
                Code = a.Code,
                Type = a.Type,
                Description = a.Description,
                IsRequired = a.IsRequired,
                IsFilterable = a.IsFilterable,
                IsVisibleInList = a.IsVisibleInList,
                IsVisibleInDetail = a.IsVisibleInDetail,
                SortOrder = a.SortOrder,
                ValidationRules = a.ValidationRules,
                DefaultValue = a.DefaultValue,
                Values = a.Values.Select(v => new ListingAttributeValue
                {
                    Id = v.Id,
                    Value = v.Value,
                    DisplayName = v.DisplayName,
                    Code = v.Code,
                    Description = v.Description,
                    ColorHex = v.ColorHex,
                    ImageUrl = v.ImageUrl,
                    SortOrder = v.SortOrder,
                    IsActive = v.IsActive
                }).ToList()
            }).ToList();

            Console.WriteLine($"[CreateListing] Setting {attributes.Count} attributes to page");
            _createListingPage?.SetCategoryAttributes(attributes);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[CreateListing] Error loading attributes: {ex.Message}");
            Console.WriteLine($"[CreateListing] Stack trace: {ex.StackTrace}");
            _createListingPage?.SetError("حدث خطأ أثناء تحميل الخصائص");
        }
    }

    private async Task SubmitListing(CreateListingModel model)
    {
        try
        {
            // التحقق من إمكانية إنشاء عرض (الاشتراك)
            if (_currentUserId.HasValue)
            {
                var canAddResult = await SubscriptionClient.CanAddListingAsync(_currentUserId.Value);

                if (canAddResult != null && !canAddResult.CanAdd)
                {
                    // لا يمكن إنشاء عرض - عرض شاشة الاشتراك
                    _subscriptionCheckResult = canAddResult;
                    _pendingModel = model;
                    _showSubscriptionSheet = true;
                    StateHasChanged();
                    return;
                }
            }

            // إكمال إنشاء العرض
            await CreateListingInternal(model);
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            // لا توجد باقات في النظام - متابعة الإنشاء مباشرة
            Console.WriteLine("[CreateListing] No subscription plans in system, allowing creation");
            await CreateListingInternal(model);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in SubmitListing: {ex.Message}");
            _createListingPage?.SetError("حدث خطأ أثناء إنشاء العرض. حاول مرة أخرى.");
        }
    }

    private async Task CreateListingInternal(CreateListingModel model)
    {
        try
        {
            var request = new CreateSpaceRequest
            {
                CategoryId = model.CategoryId,
                Title = model.Title,
                Description = model.Description,
                PricePerMonth = model.Attributes
                    .FirstOrDefault(a => a.Code == "price")?.NumberValue ?? 0,
                Images = model.Images,
                Latitude = model.Latitude,
                Longitude = model.Longitude,
                Address = model.Address,
                Attributes = model.Attributes.ToDictionary(
                    a => a.Code,
                    a => (object)(a.TextValue ?? a.NumberValue?.ToString() ?? string.Empty))
            };

            var result = await ApiService.CreateSpaceAsync(request);

            if (result != null)
            {
                _createListingPage?.SetCreatedListingId(result.Id);
            }
            else
            {
                _createListingPage?.SetError("حدث خطأ أثناء إنشاء العرض. حاول مرة أخرى.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating listing: {ex.Message}");
            _createListingPage?.SetError("حدث خطأ أثناء إنشاء العرض. حاول مرة أخرى.");
        }
    }

    private void CloseSubscriptionSheet()
    {
        _showSubscriptionSheet = false;
        _subscriptionCheckResult = null;
    }

    private void GoToSubscriptionPlans()
    {
        _showSubscriptionSheet = false;
        Navigation.NavigateTo("/host/subscription/plans");
    }

    private void ViewListing(Guid listingId)
    {
        Navigation.NavigateTo($"/space/{listingId}");
    }

    private async Task RequestLocation()
    {
        // TODO: Implement geolocation request
        // For now, set a default location (Riyadh)
        _createListingPage?.SetLocation(24.7136, 46.6753, "الرياض، المملكة العربية السعودية");
    }
}
