@page "/register"
@using ACommerce.Client.Auth
@using ACommerce.Client.Auth.Models
@inject AuthClient AuthClient
@inject IAppNavigationService Navigation
@inject ILocalizationService L
@inject Ashare.Shared.Services.ThemeService Theme

<div class="ac-page ashare-register-page @(Theme.IsDarkMode ? "ac-dark" : "")" dir="@(L.IsRtl ? "rtl" : "ltr")">
    <div class="ashare-register-header">
        <button class="ashare-back-btn" @onclick="() => Navigation.NavigateBack()">
            <i class="bi bi-arrow-right"></i>
        </button>
        <div class="ashare-logo">
            <span class="ashare-logo-text">@L["AppName"]</span>
            <span class="ashare-logo-subtitle">@L["CreateNewAccount"]</span>
        </div>
    </div>

    <div class="ashare-register-content">
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="ashare-error-alert">
                <i class="bi bi-exclamation-triangle"></i>
                <span>@_errorMessage</span>
            </div>
        }

        @if (_showSuccess)
        {
            <div class="ashare-success-alert">
                <i class="bi bi-check-circle-fill"></i>
                <span>@L["RegistrationSuccessful"]</span>
                <p>@L["RedirectingToLogin"]</p>
            </div>
        }
        else
        {
            <div class="ashare-register-form">
                @* Full Name *@
                <div class="ac-form-group">
                    <label>@L["FullName"]</label>
                    <div class="ashare-input-wrapper">
                        <i class="bi bi-person"></i>
                        <input type="text"
                               class="ac-input @(!string.IsNullOrEmpty(_fullNameError) ? "error" : "")"
                               placeholder="@L["EnterFullName"]"
                               @bind="_fullName"
                               @bind:event="oninput"
                               @onfocus="() => _fullNameError = null" />
                    </div>
                    @if (!string.IsNullOrEmpty(_fullNameError))
                    {
                        <span class="ashare-field-error">@_fullNameError</span>
                    }
                </div>

                @* Phone Number *@
                <div class="ac-form-group">
                    <label>@L["PhoneNumber"]</label>
                    <div class="ashare-input-wrapper ashare-phone-input">
                        <span class="ashare-phone-prefix">+966</span>
                        <input type="tel"
                               class="ac-input @(!string.IsNullOrEmpty(_phoneError) ? "error" : "")"
                               placeholder="5XXXXXXXX"
                               @bind="_phoneNumber"
                               @bind:event="oninput"
                               maxlength="9"
                               inputmode="numeric"
                               @onfocus="() => _phoneError = null" />
                    </div>
                    @if (!string.IsNullOrEmpty(_phoneError))
                    {
                        <span class="ashare-field-error">@_phoneError</span>
                    }
                </div>

                @* Email *@
                <div class="ac-form-group">
                    <label>@L["Email"]</label>
                    <div class="ashare-input-wrapper">
                        <i class="bi bi-envelope"></i>
                        <input type="email"
                               class="ac-input @(!string.IsNullOrEmpty(_emailError) ? "error" : "")"
                               placeholder="@L["EnterEmail"]"
                               @bind="_email"
                               @bind:event="oninput"
                               @onfocus="() => _emailError = null" />
                    </div>
                    @if (!string.IsNullOrEmpty(_emailError))
                    {
                        <span class="ashare-field-error">@_emailError</span>
                    }
                </div>

                @* Password *@
                <div class="ac-form-group">
                    <label>@L["Password"]</label>
                    <div class="ashare-input-wrapper">
                        <i class="bi bi-lock"></i>
                        <input type="@(_showPassword ? "text" : "password")"
                               class="ac-input @(!string.IsNullOrEmpty(_passwordError) ? "error" : "")"
                               placeholder="@L["EnterPassword"]"
                               @bind="_password"
                               @bind:event="oninput"
                               @onfocus="() => _passwordError = null" />
                        <button type="button" class="ashare-toggle-password" @onclick="() => _showPassword = !_showPassword">
                            <i class="bi @(_showPassword ? "bi-eye-slash" : "bi-eye")"></i>
                        </button>
                    </div>
                    @if (!string.IsNullOrEmpty(_passwordError))
                    {
                        <span class="ashare-field-error">@_passwordError</span>
                    }
                    <div class="ashare-password-strength">
                        <div class="ashare-strength-bar @GetPasswordStrengthClass()"></div>
                        <span>@GetPasswordStrengthText()</span>
                    </div>
                </div>

                @* Confirm Password *@
                <div class="ac-form-group">
                    <label>@L["ConfirmPassword"]</label>
                    <div class="ashare-input-wrapper">
                        <i class="bi bi-lock-fill"></i>
                        <input type="@(_showConfirmPassword ? "text" : "password")"
                               class="ac-input @(!string.IsNullOrEmpty(_confirmPasswordError) ? "error" : "")"
                               placeholder="@L["ReEnterPassword"]"
                               @bind="_confirmPassword"
                               @bind:event="oninput"
                               @onfocus="() => _confirmPasswordError = null" />
                        <button type="button" class="ashare-toggle-password" @onclick="() => _showConfirmPassword = !_showConfirmPassword">
                            <i class="bi @(_showConfirmPassword ? "bi-eye-slash" : "bi-eye")"></i>
                        </button>
                    </div>
                    @if (!string.IsNullOrEmpty(_confirmPasswordError))
                    {
                        <span class="ashare-field-error">@_confirmPasswordError</span>
                    }
                </div>

                @* Terms and Conditions *@
                <div class="ashare-terms-checkbox">
                    <label class="ashare-checkbox">
                        <input type="checkbox" @bind="_acceptTerms" />
                        <span class="ashare-checkbox-mark"></span>
                        <span class="ashare-checkbox-text">
                            @L["IAgreeToThe"]
                            <a href="/terms" @onclick:preventDefault @onclick="GoToTerms">@L["TermsOfService"]</a>
                            @L["And"]
                            <a href="/privacy" @onclick:preventDefault @onclick="GoToPrivacy">@L["PrivacyPolicy"]</a>
                        </span>
                    </label>
                </div>

                @* Register Button *@
                <button class="ac-btn ac-btn-primary ac-btn-lg ac-btn-block"
                        @onclick="RegisterAsync"
                        disabled="@(_isLoading || !_acceptTerms)">
                    @if (_isLoading)
                    {
                        <span class="ac-spinner"></span>
                    }
                    else
                    {
                        <span>@L["CreateAccount"]</span>
                    }
                </button>

                <div class="ashare-divider">
                    <span>@L["Or"]</span>
                </div>

                @* Nafath Registration *@
                <button class="ac-btn ac-btn-nafath ac-btn-lg ac-btn-block" @onclick="RegisterWithNafath">
                    <i class="bi bi-shield-check"></i>
                    @L["RegisterWithNafath"]
                </button>

                <p class="ashare-login-link">
                    @L["AlreadyHaveAccount"]
                    <a href="/login">@L["Login"]</a>
                </p>
            </div>
        }
    </div>

    @* Language Selector *@
    <div class="ashare-language-selector">
        @foreach (var lang in L.SupportedLanguages)
        {
            <button class="@(L.CurrentLanguage == lang.Code ? "active" : "")"
                    @onclick="() => L.SetLanguageAsync(lang.Code)">
                @lang.NativeName
            </button>
        }
    </div>
</div>

@code {
    private string _fullName = "";
    private string _phoneNumber = "";
    private string _email = "";
    private string _password = "";
    private string _confirmPassword = "";
    private bool _showPassword;
    private bool _showConfirmPassword;
    private bool _acceptTerms;
    private bool _isLoading;
    private bool _showSuccess;
    private string? _errorMessage;

    // Field-level errors
    private string? _fullNameError;
    private string? _phoneError;
    private string? _emailError;
    private string? _passwordError;
    private string? _confirmPasswordError;

    private bool ValidateForm()
    {
        var isValid = true;

        // Full Name validation
        if (string.IsNullOrWhiteSpace(_fullName))
        {
            _fullNameError = L["FullNameRequired"];
            isValid = false;
        }
        else if (_fullName.Length < 3)
        {
            _fullNameError = L["FullNameTooShort"];
            isValid = false;
        }

        // Phone validation
        if (string.IsNullOrWhiteSpace(_phoneNumber))
        {
            _phoneError = L["PhoneRequired"];
            isValid = false;
        }
        else if (!System.Text.RegularExpressions.Regex.IsMatch(_phoneNumber, @"^5\d{8}$"))
        {
            _phoneError = L["InvalidPhoneNumber"];
            isValid = false;
        }

        // Email validation
        if (string.IsNullOrWhiteSpace(_email))
        {
            _emailError = L["EmailRequired"];
            isValid = false;
        }
        else if (!_email.Contains("@") || !_email.Contains("."))
        {
            _emailError = L["InvalidEmail"];
            isValid = false;
        }

        // Password validation
        if (string.IsNullOrWhiteSpace(_password))
        {
            _passwordError = L["PasswordRequired"];
            isValid = false;
        }
        else if (_password.Length < 8)
        {
            _passwordError = L["PasswordTooShort"];
            isValid = false;
        }

        // Confirm password validation
        if (_password != _confirmPassword)
        {
            _confirmPasswordError = L["PasswordsDoNotMatch"];
            isValid = false;
        }

        return isValid;
    }

    private async Task RegisterAsync()
    {
        _errorMessage = null;

        if (!ValidateForm())
        {
            return;
        }

        _isLoading = true;

        try
        {
            // Parse full name into first and last name
            var nameParts = _fullName.Trim().Split(' ', 2);
            var firstName = nameParts[0];
            var lastName = nameParts.Length > 1 ? nameParts[1] : "";

            var result = await AuthClient.RegisterAsync(new RegisterRequest
            {
                FullName = _fullName,
                Username = _email, // Use email as username
                Email = _email,
                PhoneNumber = $"+966{_phoneNumber}",
                Password = _password,
                ConfirmPassword = _confirmPassword,
                AcceptTerms = _acceptTerms,
                Role = "Customer"
            });

            if (result?.Success == true)
            {
                _showSuccess = true;
                await Task.Delay(2000);
                Navigation.NavigateTo("/login");
            }
            else
            {
                _errorMessage = result?.Message ?? L["RegistrationFailed"];
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }

        _isLoading = false;
    }

    private void RegisterWithNafath()
    {
        // Navigate to Nafath registration flow
        Navigation.NavigateTo("/login?nafath=true");
    }

    private string GetPasswordStrengthClass()
    {
        if (string.IsNullOrEmpty(_password)) return "";
        if (_password.Length < 6) return "weak";
        if (_password.Length < 8) return "fair";

        var hasUpper = _password.Any(char.IsUpper);
        var hasLower = _password.Any(char.IsLower);
        var hasDigit = _password.Any(char.IsDigit);
        var hasSpecial = _password.Any(c => !char.IsLetterOrDigit(c));

        var score = (hasUpper ? 1 : 0) + (hasLower ? 1 : 0) + (hasDigit ? 1 : 0) + (hasSpecial ? 1 : 0);

        return score switch
        {
            >= 4 => "strong",
            >= 3 => "good",
            >= 2 => "fair",
            _ => "weak"
        };
    }

    private string GetPasswordStrengthText()
    {
        var strengthClass = GetPasswordStrengthClass();
        return strengthClass switch
        {
            "strong" => L["PasswordStrong"],
            "good" => L["PasswordGood"],
            "fair" => L["PasswordFair"],
            "weak" => L["PasswordWeak"],
            _ => ""
        };
    }

    private void GoToTerms()
    {
        Navigation.NavigateTo("/terms");
    }

    private void GoToPrivacy()
    {
        Navigation.NavigateTo("/privacy");
    }
}
