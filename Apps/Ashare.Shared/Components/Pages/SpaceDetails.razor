@page "/space/{SpaceId:guid}"
@using ACommerce.Client.Chats
@using ACommerce.Client.Auth
@using ACommerce.Client.Profiles
@inject AshareApiService ApiService
@inject IAppNavigationService Navigation
@inject IJSRuntime JS
@inject ChatsClient ChatsClient
@inject ProfilesClient ProfilesClient
@inject TokenManager TokenManager

<div class="ac-page ashare-space-details">
    @if (_space != null)
    {
        @* Image Gallery *@
        <div class="ashare-gallery">
            <div class="ashare-gallery-main">
                @if (_space.Images.Any())
                {
                    <img src="@_space.Images[_currentImageIndex]" alt="@_space.Name" />
                }
                else
                {
                    <div class="ashare-space-no-image large">
                        <i class="bi bi-building"></i>
                    </div>
                }
                <button class="ashare-back-btn" @onclick="GoBack">
                    <i class="bi bi-arrow-right"></i>
                </button>
                <button class="ashare-favorite-btn large" @onclick="ToggleFavorite">
                    <i class="bi @(_isFavorite ? "bi-heart-fill" : "bi-heart")"></i>
                </button>
                <button class="ashare-share-btn" @onclick="ShareSpace">
                    <i class="bi bi-share"></i>
                </button>
            </div>
            @if (_space.Images.Count > 1)
            {
                <div class="ashare-gallery-thumbnails">
                    @for (int i = 0; i < _space.Images.Count; i++)
                    {
                        var index = i;
                        <button class="ashare-thumbnail @(index == _currentImageIndex ? "active" : "")"
                                @onclick="() => _currentImageIndex = index">
                            <img src="@_space.Images[index]" alt="" />
                        </button>
                    }
                </div>
            }
        </div>

        @* Space Info *@
        <div class="ashare-space-info">
            <div class="ashare-space-header">
                <span class="ashare-space-category">@_space.CategoryName</span>
                <div class="ashare-space-rating-large">
                    <i class="bi bi-star-fill"></i>
                    <span>@_space.Rating</span>
                    <span class="ashare-reviews-count">(@_space.ReviewsCount تقييم)</span>
                </div>
            </div>

            <h1 class="ashare-space-title">@_space.Name</h1>

            <div class="ashare-space-location-large">
                <i class="bi bi-geo-alt"></i>
                <span>@GetLocationDisplay()</span>
                @if (_space.Latitude.HasValue && _space.Longitude.HasValue)
                {
                    <a href="#map" class="ashare-map-link">عرض الخريطة</a>
                }
            </div>

            @* Main Attributes - Quick Stats *@
            <div class="ashare-space-stats">
                @if (HasAttribute("property_type"))
                {
                    <div class="ashare-stat">
                        <i class="bi bi-house"></i>
                        <span>@TranslatePropertyType(GetAttribute("property_type"))</span>
                    </div>
                }
                @if (HasAttribute("area"))
                {
                    <div class="ashare-stat">
                        <i class="bi bi-rulers"></i>
                        <span>المساحة: @GetAttribute("area") م²</span>
                    </div>
                }
                @if (HasAttribute("rooms_count"))
                {
                    <div class="ashare-stat">
                        <i class="bi bi-door-open"></i>
                        <span>@GetAttribute("rooms_count") غرف</span>
                    </div>
                }
                @if (HasAttribute("bathrooms_count"))
                {
                    <div class="ashare-stat">
                        <i class="bi bi-droplet"></i>
                        <span>@GetAttribute("bathrooms_count") حمام</span>
                    </div>
                }
                @if (_space.Capacity > 0)
                {
                    <div class="ashare-stat">
                        <i class="bi bi-people"></i>
                        <span>السعة: @_space.Capacity شخص</span>
                    </div>
                }
                @if (_space.Area > 0 && !HasAttribute("area"))
                {
                    <div class="ashare-stat">
                        <i class="bi bi-rulers"></i>
                        <span>المساحة: @_space.Area م²</span>
                    </div>
                }
            </div>

            @* Description *@
            @if (!string.IsNullOrEmpty(GetDescription()))
            {
                <div class="ashare-section">
                    <h2 class="ashare-section-title">الوصف</h2>
                    <p class="ashare-description">@GetDescription()</p>
                </div>
            }

            @* Property Details - Dynamic Attributes *@
            @{
                var propertyDetails = GetPropertyDetails();
            }
            @if (propertyDetails.Any())
            {
                <div class="ashare-section">
                    <h2 class="ashare-section-title">تفاصيل العقار</h2>
                    <div class="ashare-details-list">
                        @foreach (var detail in propertyDetails)
                        {
                            <div class="ashare-detail-item">
                                <span class="ashare-detail-label">@detail.Label</span>
                                <span class="ashare-detail-value">@detail.Value</span>
                            </div>
                        }
                    </div>
                </div>
            }

            @* Amenities - Dynamic from Attributes *@
            @{
                var amenities = GetAmenities();
            }
            @if (amenities.Any())
            {
                <div class="ashare-section">
                    <h2 class="ashare-section-title">المرافق والخدمات</h2>
                    <div class="ashare-amenities-list">
                        @foreach (var amenity in amenities)
                        {
                            <div class="ashare-amenity-item">
                                <i class="bi @GetAmenityIcon(amenity)"></i>
                                <span>@amenity</span>
                            </div>
                        }
                    </div>
                </div>
            }

            @* Pricing *@
            @if (HasAttribute("price"))
            {
                <div class="ashare-section">
                    <h2 class="ashare-section-title">السعر</h2>
                    <div class="ashare-pricing-display">
                        <span class="ashare-price-amount">@GetAttribute("price") ر.س</span>
                        <span class="ashare-price-period">/ @GetRentTypeLabel()</span>
                    </div>
                </div>
            }

            @* Rules *@
            @if (_space.Rules?.Any() == true)
            {
                <div class="ashare-section">
                    <h2 class="ashare-section-title">القواعد والشروط</h2>
                    <ul class="ashare-rules-list">
                        @foreach (var rule in _space.Rules)
                        {
                            <li><i class="bi bi-check-circle"></i> @rule</li>
                        }
                    </ul>
                </div>
            }

            @* Contact Options *@
            @{
                var contactOptions = GetContactOptions();
            }
            @if (contactOptions.Any())
            {
                <div class="ashare-section">
                    <h2 class="ashare-section-title">طرق التواصل</h2>
                    <div class="ashare-contact-options">
                        @foreach (var option in contactOptions)
                        {
                            <button class="ashare-contact-btn @option.Class" @onclick="() => HandleContact(option.Type)">
                                <i class="bi @option.Icon"></i>
                                <span>@option.Label</span>
                            </button>
                        }
                    </div>
                </div>
            }

            @* Location Map *@
            @if (_space.Latitude.HasValue && _space.Longitude.HasValue)
            {
                <div class="ashare-section" id="map">
                    <h2 class="ashare-section-title">
                        <i class="bi bi-geo-alt-fill"></i>
                        الموقع
                    </h2>
                    <div class="ashare-location-card">
                        @* Mini Map *@
                        <div class="ashare-mini-map" id="detailsMap">
                            <div class="ashare-map-loading">
                                <i class="bi bi-map"></i>
                                <span>جاري تحميل الخريطة...</span>
                            </div>
                        </div>

                        @* Address *@
                        @if (!string.IsNullOrEmpty(GetLocationDisplay()))
                        {
                            <div class="ashare-location-address">
                                <i class="bi bi-signpost"></i>
                                <span>@GetLocationDisplay()</span>
                            </div>
                        }

                        @* Open in Maps Button *@
                        <button class="ashare-open-maps-btn" @onclick="OpenInNativeMaps">
                            <i class="bi bi-box-arrow-up-right"></i>
                            <span>فتح في تطبيق الخرائط</span>
                        </button>
                    </div>
                </div>
            }

            @* Owner Info *@
            <div class="ashare-section ashare-owner-section">
                <h2 class="ashare-section-title">مالك المساحة</h2>
                <div class="ashare-owner-card">
                    <div class="ashare-owner-avatar">
                        @if (!string.IsNullOrEmpty(_ownerProfile?.Avatar))
                        {
                            <img src="@_ownerProfile.Avatar" alt="@GetOwnerDisplayName()" />
                        }
                        else
                        {
                            <i class="bi bi-person-circle"></i>
                        }
                    </div>
                    <div class="ashare-owner-info">
                        <h3>@GetOwnerDisplayName()</h3>
                        @if (_ownerProfile?.CreatedAt != null && _ownerProfile.CreatedAt != default)
                        {
                            <span>عضو منذ @_ownerProfile.CreatedAt.ToString("yyyy")</span>
                        }
                        else if (_space.OwnerJoinDate != default)
                        {
                            <span>عضو منذ @_space.OwnerJoinDate.ToString("yyyy")</span>
                        }
                    </div>
                    @if (_isOwnListing)
                    {
                        <span class="ac-badge ac-badge-primary">معلنك</span>
                    }
                    else
                    {
                        <button class="ac-btn ac-btn-secondary" @onclick="ContactOwner">
                            <i class="bi bi-chat"></i>
                            تواصل
                        </button>
                    }
                </div>
            </div>

            @* Reviews *@
            <div class="ashare-section" id="reviews">
                <div class="ashare-section-header">
                    <h2 class="ashare-section-title">التقييمات</h2>
                    <a href="/space/@SpaceId/reviews" class="ashare-view-all">عرض الكل</a>
                </div>
                @if (_reviews?.Any() == true)
                {
                    @foreach (var review in _reviews.Take(3))
                    {
                        <div class="ashare-review-card">
                            <div class="ashare-review-header">
                                <div class="ashare-review-avatar">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                                <div class="ashare-review-info">
                                    <h4>@review.UserName</h4>
                                    <span>@review.Date.ToString("yyyy/MM/dd")</span>
                                </div>
                                <div class="ashare-review-rating">
                                    @for (int i = 0; i < 5; i++)
                                    {
                                        <i class="bi @(i < review.Rating ? "bi-star-fill" : "bi-star")"></i>
                                    }
                                </div>
                            </div>
                            <p class="ashare-review-text">@review.Comment</p>
                        </div>
                    }
                }
                else
                {
                    <p class="ashare-no-reviews">لا توجد تقييمات بعد</p>
                }
            </div>
        </div>

        @* Booking Bar *@
        @if (!_isOwnListing)
        {
            <div class="ashare-booking-bar">
                <div class="ashare-booking-price">
                    @if (HasAttribute("price"))
                    {
                        <span class="ashare-booking-amount">@GetAttribute("price") ر.س</span>
                        <span class="ashare-booking-period">/ @GetRentTypeLabel()</span>
                    }
                </div>
                <button class="ac-btn ac-btn-primary ac-btn-lg" @onclick="StartBooking">
                    <i class="bi bi-calendar-check"></i>
                    <span>احجز الآن</span>
                </button>
            </div>
        }
    }
    else
    {
        <div class="ashare-loading">
            <div class="ac-spinner"></div>
            <span>جاري التحميل...</span>
        </div>
    }
</div>


@code {
    [Parameter]
    public Guid SpaceId { get; set; }

    private SpaceItem? _space;
    private List<SpaceReview>? _reviews;
    private ProfileDto? _ownerProfile; // بروفايل صاحب العرض
    private bool _isFavorite;
    private bool _isOwnListing; // هل هذا معلن المستخدم الحالي
    private int _currentImageIndex;
    private bool _isLoading = true;

    private bool _mapInitialized;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Initialize mini map after data is loaded
        if (!_mapInitialized && _space?.Latitude != null && _space?.Longitude != null)
        {
            _mapInitialized = true;
            try
            {
                await JS.InvokeVoidAsync("AcMap.initializeDetailsMap",
                    "detailsMap",
                    _space.Latitude.Value,
                    _space.Longitude.Value,
                    _space.Name ?? "الموقع");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing map: {ex.Message}");
            }
        }
    }

    private async Task OpenInNativeMaps()
    {
        if (_space?.Latitude == null || _space?.Longitude == null)
        {
            Console.WriteLine("[SpaceDetails] Cannot open map - coordinates are null");
            return;
        }

        try
        {
            // Open in native maps using platform-specific service
            var label = _space.Name ?? "الموقع";
            await Navigation.OpenMapAsync(_space.Latitude.Value, _space.Longitude.Value, label);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[SpaceDetails] Error opening native maps: {ex.Message}");
        }
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            var spaceTask = ApiService.GetSpaceByIdAsync(SpaceId);
            var reviewsTask = ApiService.GetSpaceReviewsAsync(SpaceId);

            await Task.WhenAll(spaceTask, reviewsTask);

            _space = await spaceTask;
            _reviews = await reviewsTask;
            _isFavorite = ApiService.GetFavorites().Contains(SpaceId);

            if (_space != null)
            {
                // التحقق من أن هذا المعلن خاص بالمستخدم الحالي
                var currentUserId = TokenManager.GetUserIdFromToken();
                _isOwnListing = !string.IsNullOrEmpty(currentUserId) &&
                                _space.OwnerId != Guid.Empty &&
                                _space.OwnerId.ToString().Equals(currentUserId, StringComparison.OrdinalIgnoreCase);

                // جلب بروفايل صاحب العرض
                if (_space.OwnerId != Guid.Empty)
                {
                    try
                    {
                        _ownerProfile = await ProfilesClient.GetByUserIdAsync(_space.OwnerId.ToString());
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"[SpaceDetails] Error loading owner profile: {ex.Message}");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading space details: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    // ═══════════════════════════════════════════════════════════════════
    // Attribute Helpers
    // ═══════════════════════════════════════════════════════════════════

    private bool HasAttribute(string key)
    {
        return _space?.Attributes?.ContainsKey(key) == true &&
               _space.Attributes[key] != null &&
               !string.IsNullOrEmpty(_space.Attributes[key].ToString());
    }

    private string GetAttribute(string key)
    {
        if (_space?.Attributes?.TryGetValue(key, out var value) == true && value != null)
        {
            return value.ToString() ?? "";
        }
        return "";
    }

    private bool GetBoolAttribute(string key)
    {
        if (_space?.Attributes?.TryGetValue(key, out var value) == true)
        {
            if (value is bool b) return b;
            if (value is string s) return s.ToLower() == "true" || s == "1";
        }
        return false;
    }

    private string GetDescription()
    {
        // Try to get description from attributes first
        if (HasAttribute("description"))
            return GetAttribute("description");

        return _space?.Description ?? "";
    }

    private string GetLocationDisplay()
    {
        var parts = new List<string>();

        if (HasAttribute("district"))
            parts.Add(GetAttribute("district"));
        else if (!string.IsNullOrEmpty(_space?.Location))
            parts.Add(_space.Location);

        if (HasAttribute("city"))
            parts.Add(TranslateCity(GetAttribute("city")));
        else if (!string.IsNullOrEmpty(_space?.City))
            parts.Add(_space.City);

        return parts.Any() ? string.Join("، ", parts) : "غير محدد";
    }

    private string GetDisplayPrice()
    {
        if (_space == null) return "";

        if (HasAttribute("price"))
        {
            var price = GetAttribute("price");
            var rentType = HasAttribute("rent_type") ? TranslateRentType(GetAttribute("rent_type")) : "شهرياً";
            return $"{price} ر.س / {rentType}";
        }

        return _space.DisplayPrice;
    }

    // ═══════════════════════════════════════════════════════════════════
    // Property Details Builder
    // ═══════════════════════════════════════════════════════════════════

    private List<(string Label, string Value)> GetPropertyDetails()
    {
        var details = new List<(string Label, string Value)>();

        if (HasAttribute("property_type"))
            details.Add(("نوع العقار", TranslatePropertyType(GetAttribute("property_type"))));

        if (HasAttribute("area"))
            details.Add(("المساحة", $"{GetAttribute("area")} م²"));

        if (HasAttribute("rooms_count"))
            details.Add(("عدد الغرف", GetAttribute("rooms_count")));

        if (HasAttribute("bathrooms_count"))
            details.Add(("عدد الحمامات", GetAttribute("bathrooms_count")));

        if (HasAttribute("floor_number"))
            details.Add(("الطابق", GetAttribute("floor_number")));

        if (HasAttribute("building_age"))
            details.Add(("عمر المبنى", $"{GetAttribute("building_age")} سنة"));

        if (HasAttribute("furnished"))
            details.Add(("مفروش", TranslateFurnished(GetAttribute("furnished"))));

        if (HasAttribute("city"))
            details.Add(("المدينة", TranslateCity(GetAttribute("city"))));

        if (HasAttribute("district"))
            details.Add(("الحي", GetAttribute("district")));

        if (HasAttribute("street"))
            details.Add(("الشارع", GetAttribute("street")));

        if (HasAttribute("rent_type"))
            details.Add(("نوع الإيجار", TranslateRentType(GetAttribute("rent_type"))));

        if (HasAttribute("price"))
            details.Add(("السعر", $"{GetAttribute("price")} ر.س"));

        return details;
    }

    // ═══════════════════════════════════════════════════════════════════
    // Amenities Builder
    // ═══════════════════════════════════════════════════════════════════

    private List<string> GetAmenities()
    {
        var amenities = new List<string>();

        // Check boolean amenity attributes
        if (GetBoolAttribute("has_wifi") || GetBoolAttribute("wifi"))
            amenities.Add("واي فاي");

        if (GetBoolAttribute("has_parking") || GetBoolAttribute("parking"))
            amenities.Add("موقف سيارات");

        if (GetBoolAttribute("has_ac") || GetBoolAttribute("ac"))
            amenities.Add("مكيف");

        if (GetBoolAttribute("has_elevator") || GetBoolAttribute("elevator"))
            amenities.Add("مصعد");

        if (GetBoolAttribute("has_kitchen") || GetBoolAttribute("kitchen"))
            amenities.Add("مطبخ");

        if (GetBoolAttribute("has_pool") || GetBoolAttribute("pool"))
            amenities.Add("مسبح");

        if (GetBoolAttribute("has_gym") || GetBoolAttribute("gym"))
            amenities.Add("صالة رياضية");

        if (GetBoolAttribute("has_security") || GetBoolAttribute("security"))
            amenities.Add("حراسة أمنية");

        if (GetBoolAttribute("has_garden") || GetBoolAttribute("garden"))
            amenities.Add("حديقة");

        if (GetBoolAttribute("has_balcony") || GetBoolAttribute("balcony"))
            amenities.Add("شرفة");

        if (GetBoolAttribute("has_storage") || GetBoolAttribute("storage"))
            amenities.Add("مخزن");

        if (GetBoolAttribute("has_maid_room") || GetBoolAttribute("maid_room"))
            amenities.Add("غرفة خادمة");

        if (GetBoolAttribute("has_driver_room") || GetBoolAttribute("driver_room"))
            amenities.Add("غرفة سائق");

        // Fallback to legacy amenities list
        if (!amenities.Any() && _space?.Amenities?.Any() == true)
        {
            return _space.Amenities;
        }

        return amenities;
    }

    // ═══════════════════════════════════════════════════════════════════
    // Contact Options Builder
    // ═══════════════════════════════════════════════════════════════════

    private List<(string Type, string Icon, string Label, string Class)> GetContactOptions()
    {
        var options = new List<(string Type, string Icon, string Label, string Class)>();

        if (GetBoolAttribute("is_phone_allowed"))
        {
            options.Add(("phone", "bi-telephone", "اتصال", "contact-phone"));
        }

        if (GetBoolAttribute("is_whatsapp_allowed"))
        {
            options.Add(("whatsapp", "bi-whatsapp", "واتساب", "contact-whatsapp"));
        }

        if (GetBoolAttribute("is_messaging_allowed"))
        {
            options.Add(("chat", "bi-chat-dots", "رسالة", "contact-chat"));
        }

        // Default fallback if no contact options specified
        if (!options.Any())
        {
            options.Add(("chat", "bi-chat-dots", "تواصل", "contact-chat"));
        }

        return options;
    }

    private void HandleContact(string type)
    {
        switch (type)
        {
            case "phone":
                if (HasAttribute("phone"))
                {
                    Navigation.NavigateTo($"tel:{GetAttribute("phone")}");
                }
                break;
            case "whatsapp":
                if (HasAttribute("phone"))
                {
                    var phone = GetAttribute("phone").Replace("+", "").Replace(" ", "");
                    Navigation.NavigateTo($"https://wa.me/{phone}");
                }
                break;
            case "chat":
            default:
                ContactOwner();
                break;
        }
    }

    // ═══════════════════════════════════════════════════════════════════
    // Translation Helpers
    // ═══════════════════════════════════════════════════════════════════

    private string TranslatePropertyType(string type) => type?.ToLower() switch
    {
        "apartment" => "شقة",
        "villa" => "فيلا",
        "duplex" => "دوبلكس",
        "studio" => "استوديو",
        "room" => "غرفة",
        "office" => "مكتب",
        "shop" => "محل",
        "warehouse" => "مستودع",
        "land" => "أرض",
        "building" => "عمارة",
        "floor" => "دور كامل",
        "chalet" => "شاليه",
        "farm" => "مزرعة",
        "rest_house" => "استراحة",
        "tent" => "خيمة",
        _ => type ?? ""
    };

    private string TranslateCity(string city) => city?.ToLower() switch
    {
        "riyadh" => "الرياض",
        "jeddah" => "جدة",
        "makkah" or "mecca" => "مكة المكرمة",
        "madinah" or "medina" => "المدينة المنورة",
        "dammam" => "الدمام",
        "khobar" => "الخبر",
        "dhahran" => "الظهران",
        "taif" => "الطائف",
        "tabuk" => "تبوك",
        "abha" => "أبها",
        "khamis_mushait" => "خميس مشيط",
        "hail" => "حائل",
        "najran" => "نجران",
        "jubail" => "الجبيل",
        "yanbu" => "ينبع",
        "qatif" => "القطيف",
        "hofuf" => "الهفوف",
        "buraydah" => "بريدة",
        _ => city ?? ""
    };

    private string TranslateRentType(string type) => type?.ToLower() switch
    {
        "daily" => "يومياً",
        "weekly" => "أسبوعياً",
        "monthly" => "شهرياً",
        "yearly" or "annual" => "سنوياً",
        "hourly" => "بالساعة",
        _ => type ?? ""
    };

    private string TranslateFurnished(string value) => value?.ToLower() switch
    {
        "furnished" or "true" or "yes" or "1" => "نعم",
        "semi_furnished" or "semi" => "شبه مفروش",
        "unfurnished" or "false" or "no" or "0" => "لا",
        _ => value ?? ""
    };

    // ═══════════════════════════════════════════════════════════════════
    // Owner Profile Helper
    // ═══════════════════════════════════════════════════════════════════

    private string GetOwnerDisplayName()
    {
        // أولاً: من البروفايل
        if (_ownerProfile != null)
        {
            if (!string.IsNullOrEmpty(_ownerProfile.FullName))
                return _ownerProfile.FullName;
            if (!string.IsNullOrEmpty(_ownerProfile.BusinessName))
                return _ownerProfile.BusinessName;
        }

        // ثانياً: من بيانات المساحة
        if (!string.IsNullOrEmpty(_space?.OwnerName))
            return _space.OwnerName;

        return "المعلن";
    }

    // ═══════════════════════════════════════════════════════════════════
    // Navigation & Actions
    // ═══════════════════════════════════════════════════════════════════

    private void GoBack()
    {
        Navigation.NavigateBack();
    }

    private void ToggleFavorite()
    {
        ApiService.ToggleFavorite(SpaceId);
        _isFavorite = !_isFavorite;
    }

    private void ShareSpace()
    {
        // Platform share functionality
    }

    private async Task ContactOwner()
    {
        if (_space?.OwnerId == null || _space.OwnerId == Guid.Empty)
        {
            Console.WriteLine("[SpaceDetails] Cannot contact owner - OwnerId is null or empty");
            return;
        }

        // التحقق من أن المستخدم لا يحاول التواصل مع نفسه
        var currentUserId = TokenManager.GetUserIdFromToken();
        if (!string.IsNullOrEmpty(currentUserId) &&
            _space.OwnerId.ToString().Equals(currentUserId, StringComparison.OrdinalIgnoreCase))
        {
            Console.WriteLine("[SpaceDetails] Cannot contact yourself - this is your own listing");
            // يمكن إظهار رسالة للمستخدم هنا
            return;
        }

        try
        {
            // الحصول على أو إنشاء محادثة مع المالك
            var conversation = await ChatsClient.GetOrCreateConversationAsync(_space.OwnerId.ToString());

            if (conversation != null)
            {
                Navigation.NavigateTo($"/chat/{conversation.Id}");
            }
            else
            {
                Console.WriteLine("[SpaceDetails] Failed to create/get conversation");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[SpaceDetails] Error contacting owner: {ex.Message}");
        }
    }

    private string GetRentTypeLabel()
    {
        if (!HasAttribute("rent_type")) return "شهرياً";

        return GetAttribute("rent_type").ToLower() switch
        {
            "monthly" => "شهرياً",
            "yearly" or "annual" => "سنوياً",
            "daily" => "يومياً",
            "weekly" => "أسبوعياً",
            _ => "شهرياً"
        };
    }

    private string GetAmenityIcon(string amenity) => amenity switch
    {
        "واي فاي" => "bi-wifi",
        "موقف سيارات" => "bi-p-square",
        "مكيف" => "bi-snow",
        "مصعد" => "bi-arrow-up-square",
        "مطبخ" => "bi-cup-hot",
        "مسبح" => "bi-water",
        "صالة رياضية" => "bi-bicycle",
        "حراسة أمنية" => "bi-shield-check",
        "حديقة" => "bi-tree",
        "شرفة" => "bi-box-arrow-up-right",
        "مخزن" => "bi-box",
        "غرفة خادمة" => "bi-person",
        "غرفة سائق" => "bi-car-front",
        "شاشة عرض" => "bi-display",
        "غرفة اجتماعات" => "bi-people",
        "طابعة" => "bi-printer",
        "قهوة وشاي" => "bi-cup",
        "إنترنت سريع" => "bi-router",
        "سبورة" => "bi-easel",
        "إضاءة احترافية" => "bi-lightbulb",
        "نظام صوت" => "bi-speaker",
        "مسرح" => "bi-film",
        "كراسي" => "bi-grid",
        "غرفة مفروشة" => "bi-house-door",
        "مطبخ مشترك" => "bi-cup-straw",
        "غسالة" => "bi-droplet-half",
        "نظافة أسبوعية" => "bi-stars",
        _ => "bi-check-circle"
    };

    // ═══════════════════════════════════════════════════════════════════
    // Booking
    // ═══════════════════════════════════════════════════════════════════

    private void StartBooking()
    {
        // Navigate to booking page with space ID
        Navigation.NavigateTo($"/book/{SpaceId}");
    }
}
