@page "/chat/{ChatId:guid}"
@using ACommerce.Client.Chats
@using ACommerce.Client.Profiles
@using ACommerce.Client.Realtime
@using Ashare.Shared.Services
@inject ChatsClient ChatsClient
@inject ProfilesClient ProfilesClient
@inject RealtimeClient RealtimeClient
@inject IAppNavigationService Navigation
@inject ILocalizationService L
@inject ITimezoneService Timezone
@implements IAsyncDisposable

<div class="ac-page ashare-chatroom-page">
    @* Chat Header *@
    <div class="ashare-chatroom-header">
        <button class="ashare-back-btn" @onclick="() => Navigation.NavigateBack()">
            <i class="bi bi-arrow-right"></i>
        </button>
        <div class="ashare-chat-user">
            <div class="ashare-chat-avatar-sm">
                @if (!string.IsNullOrEmpty(_chat?.Avatar))
                {
                    <img src="@_chat.Avatar" alt="" />
                }
                else
                {
                    <i class="bi bi-person-circle"></i>
                }
            </div>
            <div class="ashare-chat-user-info">
                <h3>@_chat?.Name</h3>
                <span class="@(_isOnline ? "online" : "")">
                    @(_isOnline ? L["Online"] : L["Offline"])
                </span>
            </div>
        </div>
        <button class="ashare-chat-menu">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
    </div>

    @* Messages *@
    <div class="ashare-messages-container" @ref="_messagesContainer">
        @if (_isLoading)
        {
            <div class="ashare-loading">
                <div class="ac-spinner"></div>
            </div>
        }
        else
        {
            @foreach (var message in _messages)
            {
                <div class="ashare-message @(message.IsMine ? "mine" : "theirs")">
                    <div class="ashare-message-bubble">
                        @if (message.Type == "image")
                        {
                            <img src="@message.Content" alt="" class="ashare-message-image" />
                        }
                        else
                        {
                            <p>@message.Content</p>
                        }
                        <span class="ashare-message-time">
                            @GetFormattedTime(message.Id, message.SentAt)
                            @if (message.IsMine)
                            {
                                <i class="bi @(message.IsRead ? "bi-check-all" : "bi-check")"></i>
                            }
                        </span>
                    </div>
                </div>
            }

            @if (_isTyping)
            {
                <div class="ashare-message theirs">
                    <div class="ashare-typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            }
        }
    </div>

    @* Input *@
    <div class="ashare-chat-input">
        <button class="ashare-attach-btn">
            <i class="bi bi-paperclip"></i>
        </button>
        <input type="text"
               class="ac-input"
               placeholder="@L["TypeMessage"]"
               @bind="_newMessage"
               @bind:event="oninput"
               @onkeyup="HandleKeyUp" />
        <button class="ashare-send-btn"
                @onclick="SendMessage"
                disabled="@string.IsNullOrWhiteSpace(_newMessage)">
            <i class="bi bi-send-fill"></i>
        </button>
    </div>
</div>

@code {
    [Parameter]
    public Guid ChatId { get; set; }

    private ChatInfo? _chat;
    private List<ChatMessage> _messages = new();
    private string _newMessage = "";
    private bool _isLoading = true;
    private bool _isOnline = false;
    private bool _isTyping = false;
    private ElementReference _messagesContainer;
    private IDisposable? _messageSubscription;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load chat info
            var chat = await ChatsClient.GetConversationAsync(ChatId);

            // تعيين بيانات أولية
            var otherPartyId = chat?.OtherPartyId;
            var displayName = "مستخدم";
            string? avatar = chat?.OtherPartyAvatar;

            // جلب اسم المستخدم الحقيقي من البروفايل
            if (!string.IsNullOrEmpty(otherPartyId))
            {
                try
                {
                    var profile = await ProfilesClient.GetByUserIdAsync(otherPartyId);
                    if (profile != null)
                    {
                        displayName = profile.FullName ?? profile.BusinessName ?? "مستخدم";
                        avatar = profile.Avatar ?? avatar;
                    }
                }
                catch
                {
                    // إذا فشل جلب البروفايل، نستخدم الاسم الافتراضي
                }
            }

            _chat = new()
            {
                Avatar = avatar ?? "",
                Id = chat?.Id ?? Guid.Empty,
                Name = displayName
            };

            // Load messages
            var messages = await ChatsClient.GetMessagesAsync(ChatId);
            _messages = messages?
            .Select(message =>
            new ChatMessage
            {
                Content = message.Content,
                Id = message.Id,
                IsFailed = false,
                IsMine = message.IsMine,
                IsRead = message.IsRead,
                SentAt = message.SentAt,
                Type = message.Type
            })
            .ToList() ?? [];

            // Subscribe to real-time updates (connect to chat hub)
            await RealtimeClient.ConnectAsync("Marketplace", "/hubs/chat");
            _messageSubscription = RealtimeClient.On<object>("ReceiveMessage", HandleNewMessage);

            // Mark as read
            await ChatsClient.MarkAsReadAsync(ChatId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ChatRoom] Error loading chat: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void HandleNewMessage(object message)
    {
        // Handle incoming real-time message
        InvokeAsync(StateHasChanged);
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_newMessage))
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_newMessage)) return;

        var message = new ChatMessage
        {
            Id = Guid.NewGuid(),
            Content = _newMessage,
            Type = "text",
            IsMine = true,
            SentAt = DateTime.UtcNow // Use UTC for storage/transmission
        };

        _messages.Add(message);
        var messageToSend = _newMessage;
        _newMessage = "";

        try
        {
            await ChatsClient.SendMessageAsync(ChatId, new SendMessageRequest
            {
                Content = messageToSend,
                Type = "text"
            });
        }
        catch
        {
            // Handle send failure
            message.IsFailed = true;
        }

        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        _messageSubscription?.Dispose();
        await RealtimeClient.DisconnectAsync();
    }

    // Cache for formatted times to avoid blocking renders
    private Dictionary<Guid, string> _formattedTimes = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || _messages.Any(m => !_formattedTimes.ContainsKey(m.Id)))
        {
            // Format all message times using timezone service
            foreach (var message in _messages.Where(m => !_formattedTimes.ContainsKey(m.Id)))
            {
                var formattedTime = await Timezone.FormatTimeAsync(message.SentAt, "HH:mm");
                _formattedTimes[message.Id] = formattedTime;
            }
            StateHasChanged();
        }
    }

    private string GetFormattedTime(Guid messageId, DateTime sentAt)
    {
        if (_formattedTimes.TryGetValue(messageId, out var formatted))
            return formatted;
        return sentAt.ToString("HH:mm"); // Fallback to raw time
    }

    // DTOs
    public class ChatInfo
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public string? Avatar { get; set; }
    }

    public class ChatMessage
    {
        public Guid Id { get; set; }
        public string Content { get; set; } = "";
        public string Type { get; set; } = "text";
        public bool IsMine { get; set; }
        public bool IsRead { get; set; }
        public bool IsFailed { get; set; }
        public DateTime SentAt { get; set; } // Stored in UTC
    }
}
