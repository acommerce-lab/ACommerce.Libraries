@page "/chats"
@using ACommerce.Client.Chats
@using ACommerce.Client.Profiles
@using ACommerce.Client.Auth
@using Ashare.Shared.Services
@inject ChatsClient ChatsClient
@inject ProfilesClient ProfilesClient
@inject TokenManager TokenManager
@inject IAppNavigationService Navigation
@inject ILocalizationService L
@inject ITimezoneService Timezone

<div class="ac-page ashare-chats-page">
    <div class="ac-page-header">
        <h1>@L["Messages"]</h1>
    </div>

    @if (_isLoading)
    {
        <div class="ashare-loading">
            <div class="ac-spinner"></div>
            <span>@L["Loading"]</span>
        </div>
    }
    else if (_chats?.Any() == true)
    {
        <div class="ashare-chats-list">
            @foreach (var chat in _chats)
            {
                <div class="ashare-chat-item" @onclick="() => OpenChat(chat.Id)">
                    <div class="ashare-chat-avatar">
                        @if (!string.IsNullOrEmpty(chat.Avatar))
                        {
                            <img src="@chat.Avatar" alt="" />
                        }
                        else
                        {
                            <i class="bi bi-person-circle"></i>
                        }
                        @if (chat.IsOnline)
                        {
                            <span class="ashare-online-indicator"></span>
                        }
                    </div>
                    <div class="ashare-chat-content">
                        <div class="ashare-chat-header">
                            <h4 class="ashare-chat-name">@chat.Name</h4>
                            <span class="ashare-chat-time">@GetFormattedTime(chat.Id)</span>
                        </div>
                        <div class="ashare-chat-preview">
                            @if (chat.IsTyping)
                            {
                                <span class="ashare-typing">@L["Typing"]</span>
                            }
                            else
                            {
                                <span class="@(chat.UnreadCount > 0 ? "unread" : "")">@chat.LastMessage</span>
                            }
                            @if (chat.UnreadCount > 0)
                            {
                                <span class="ashare-unread-badge">@chat.UnreadCount</span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="ashare-empty-state">
            <i class="bi bi-chat-dots"></i>
            <h3>@L["NoChats"]</h3>
            <p>@L["StartChatHint"]</p>
        </div>
    }
</div>

@code {
    private List<ChatListItem>? _chats;
    private bool _isLoading = true;
    private Dictionary<Guid, string> _formattedTimes = new();
    private string? _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // الحصول على معرف المستخدم الحالي
            _currentUserId = TokenManager.GetUserIdFromToken();
            Console.WriteLine($"[Chats] Current user: {_currentUserId}");

            var conversations = await ChatsClient.GetConversationsAsync();
            Console.WriteLine($"[Chats] Loaded {conversations?.Count ?? 0} conversations");

            if (conversations == null || !conversations.Any())
            {
                _chats = [];
                return;
            }

            // تحويل المحادثات إلى قائمة مبدئية
            _chats = conversations.Select(chat => new ChatListItem
            {
                Id = chat.Id,
                OtherPartyUserId = GetOtherPartyUserId(chat),
                Avatar = chat.OtherPartyAvatar,
                IsOnline = chat.IsOnline,
                LastMessage = chat.LastMessage?.Content ?? "",
                LastMessageAt = chat.LastMessage?.SentAt ?? DateTime.UtcNow,
                Name = chat.Title ?? "محادثة", // مؤقت حتى يتم جلب البروفايل
                UnreadCount = chat.UnreadCount,
                IsTyping = false,
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Chats] Error: {ex.Message}");
            _chats = [];
        }
        finally
        {
            _isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _chats != null && _chats.Any())
        {
            // جلب بروفايلات الأطراف الأخرى
            await LoadOtherPartyProfilesAsync();
        }

        // تنسيق الأوقات
        if (_chats != null && _chats.Any(c => !_formattedTimes.ContainsKey(c.Id)))
        {
            foreach (var chat in _chats.Where(c => !_formattedTimes.ContainsKey(c.Id)))
            {
                var formattedTime = await Timezone.FormatRelativeTimeAsync(chat.LastMessageAt, L);
                _formattedTimes[chat.Id] = formattedTime;
            }
            StateHasChanged();
        }
    }

    /// <summary>
    /// الحصول على معرف الطرف الآخر في المحادثة
    /// </summary>
    private string? GetOtherPartyUserId(ConversationResponse chat)
    {
        // أولاً: من OtherPartyId مباشرة
        if (!string.IsNullOrEmpty(chat.OtherPartyId))
        {
            return chat.OtherPartyId;
        }

        // ثانياً: من قائمة المشاركين - نبحث عن المستخدم الآخر
        if (chat.Participants?.Any() == true && !string.IsNullOrEmpty(_currentUserId))
        {
            var otherParty = chat.Participants.FirstOrDefault(p => p != _currentUserId);
            if (!string.IsNullOrEmpty(otherParty))
            {
                return otherParty;
            }
        }

        return null;
    }

    /// <summary>
    /// جلب بروفايلات الأطراف الأخرى من الـ API
    /// </summary>
    private async Task LoadOtherPartyProfilesAsync()
    {
        if (_chats == null) return;

        var updated = false;

        foreach (var chat in _chats.Where(c => !string.IsNullOrEmpty(c.OtherPartyUserId)))
        {
            try
            {
                var profile = await ProfilesClient.GetByUserIdAsync(chat.OtherPartyUserId!);
                if (profile != null)
                {
                    // تحديث الاسم من البروفايل
                    chat.Name = !string.IsNullOrEmpty(profile.FullName)
                        ? profile.FullName
                        : (!string.IsNullOrEmpty(profile.BusinessName) ? profile.BusinessName : chat.Name);

                    // تحديث الصورة إذا كانت فارغة
                    if (string.IsNullOrEmpty(chat.Avatar) && !string.IsNullOrEmpty(profile.Avatar))
                    {
                        chat.Avatar = profile.Avatar;
                    }

                    updated = true;
                    Console.WriteLine($"[Chats] Loaded profile for {chat.OtherPartyUserId}: {chat.Name}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[Chats] Error loading profile for {chat.OtherPartyUserId}: {ex.Message}");
            }
        }

        if (updated)
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OpenChat(Guid chatId)
    {
        Navigation.NavigateTo($"/chat/{chatId}");
    }

    private string GetFormattedTime(Guid chatId)
    {
        if (_formattedTimes.TryGetValue(chatId, out var formatted))
            return formatted;

        var chat = _chats?.FirstOrDefault(c => c.Id == chatId);
        if (chat != null)
            return FormatTimeQuick(chat.LastMessageAt);
        return "";
    }

    private string FormatTimeQuick(DateTime utcTime)
    {
        var diff = DateTime.UtcNow - utcTime;
        if (diff.TotalMinutes < 1) return L["Now"];
        if (diff.TotalHours < 1) return $"{(int)diff.TotalMinutes}m";
        if (diff.TotalDays < 1) return $"{(int)diff.TotalHours}h";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d";
        return utcTime.ToString("MM/dd");
    }

    // Chat List Item DTO
    public class ChatListItem
    {
        public Guid Id { get; set; }
        public string? OtherPartyUserId { get; set; }
        public string Name { get; set; } = "";
        public string? Avatar { get; set; }
        public string? LastMessage { get; set; }
        public DateTime LastMessageAt { get; set; }
        public int UnreadCount { get; set; }
        public bool IsOnline { get; set; }
        public bool IsTyping { get; set; }
    }
}
