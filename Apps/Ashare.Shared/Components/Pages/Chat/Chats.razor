@page "/chats"
@using ACommerce.Client.Chats
@using Ashare.Shared.Services
@inject ChatsClient ChatsClient
@inject IAppNavigationService Navigation
@inject ILocalizationService L
@inject ITimezoneService Timezone

<div class="ac-page ashare-chats-page">
    <div class="ac-page-header">
        <h1>@L["Messages"]</h1>
    </div>

    @if (_isLoading)
    {
        <div class="ashare-loading">
            <div class="ac-spinner"></div>
            <span>@L["Loading"]</span>
        </div>
    }
    else if (_chats?.Any() == true)
    {
        <div class="ashare-chats-list">
            @foreach (var chat in _chats)
            {
                <div class="ashare-chat-item" @onclick="() => OpenChat(chat.Id)">
                    <div class="ashare-chat-avatar">
                        @if (!string.IsNullOrEmpty(chat.Avatar))
                        {
                            <img src="@chat.Avatar" alt="" />
                        }
                        else
                        {
                            <i class="bi bi-person-circle"></i>
                        }
                        @if (chat.IsOnline)
                        {
                            <span class="ashare-online-indicator"></span>
                        }
                    </div>
                    <div class="ashare-chat-content">
                        <div class="ashare-chat-header">
                            <h4 class="ashare-chat-name">@chat.Name</h4>
                            <span class="ashare-chat-time">@GetFormattedTime(chat.Id)</span>
                        </div>
                        <div class="ashare-chat-preview">
                            @if (chat.IsTyping)
                            {
                                <span class="ashare-typing">@L["Typing"]</span>
                            }
                            else
                            {
                                <span class="@(chat.UnreadCount > 0 ? "unread" : "")">@chat.LastMessage</span>
                            }
                            @if (chat.UnreadCount > 0)
                            {
                                <span class="ashare-unread-badge">@chat.UnreadCount</span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="ashare-empty-state">
            <i class="bi bi-chat-dots"></i>
            <h3>@L["NoChats"]</h3>
            <p>@L["StartChatHint"]</p>
        </div>
    }
</div>

@code {
    private List<ChatListItem>? _chats;
    private bool _isLoading = true;
    private Dictionary<Guid, string> _formattedTimes = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _chats = (await ChatsClient.GetConversationsAsync())?
            .Select(chat =>
            new ChatListItem
                {
                    Avatar = chat.OtherPartyAvatar,
                    IsOnline = chat.IsOnline,
                    LastMessage = chat.LastMessage?.Content ?? "",
                    LastMessageAt = chat.LastMessage?.SentAt ?? DateTime.UtcNow, // Use UTC
                    Name = chat.OtherPartyName,
                    Id = chat.Id,
                    IsTyping = false,
                    UnreadCount = chat.UnreadCount,
                })
            .ToList() ?? [];
        }
        catch
        {
            _chats = [];
        }
        finally
        {
            _isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_chats != null && _chats.Any(c => !_formattedTimes.ContainsKey(c.Id)))
        {
            // Format all chat times using timezone service
            foreach (var chat in _chats.Where(c => !_formattedTimes.ContainsKey(c.Id)))
            {
                var formattedTime = await Timezone.FormatRelativeTimeAsync(chat.LastMessageAt, L);
                _formattedTimes[chat.Id] = formattedTime;
            }
            StateHasChanged();
        }
    }

    private void OpenChat(Guid chatId)
    {
        Navigation.NavigateTo($"/chat/{chatId}");
    }

    private string GetFormattedTime(Guid chatId)
    {
        if (_formattedTimes.TryGetValue(chatId, out var formatted))
            return formatted;

        // Fallback: find the chat and show raw time
        var chat = _chats?.FirstOrDefault(c => c.Id == chatId);
        if (chat != null)
            return FormatTimeQuick(chat.LastMessageAt);
        return "";
    }

    // Quick synchronous fallback for initial render
    private string FormatTimeQuick(DateTime utcTime)
    {
        var diff = DateTime.UtcNow - utcTime;
        if (diff.TotalMinutes < 1) return L["Now"];
        if (diff.TotalHours < 1) return $"{(int)diff.TotalMinutes}m";
        if (diff.TotalDays < 1) return $"{(int)diff.TotalHours}h";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d";
        return utcTime.ToString("MM/dd");
    }

    // Chat List Item DTO
    public class ChatListItem
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public string? Avatar { get; set; }
        public string? LastMessage { get; set; }
        public DateTime LastMessageAt { get; set; } // Stored in UTC
        public int UnreadCount { get; set; }
        public bool IsOnline { get; set; }
        public bool IsTyping { get; set; }
    }
}
