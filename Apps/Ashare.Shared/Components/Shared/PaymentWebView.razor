@using Microsoft.JSInterop
@using Ashare.Shared.Models
@using Ashare.Shared.Services
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject IAppNavigationService AppNavigation
@implements IAsyncDisposable

<div class="payment-webview-container">
    @if (UseRedirect)
    {
        @* Redirect mode - Payment gateways don't allow iframe embedding *@
        <div class="payment-redirect-message">
            <div class="payment-redirect-icon">
                <i class="bi bi-credit-card-2-front"></i>
            </div>
            <h3>جاري توجيهك لصفحة الدفع الآمنة</h3>
            <p>سيتم فتح صفحة الدفع في نافذة جديدة أو توجيهك لها تلقائياً</p>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="payment-error-message">
                    <i class="bi bi-exclamation-triangle"></i>
                    @_errorMessage
                </div>
            }

            <div class="payment-redirect-actions">
                <button class="ac-btn ac-btn-primary ac-btn-lg" @onclick="OpenPaymentPage" disabled="@_isOpening">
                    @if (_isOpening)
                    {
                        <div class="ac-spinner ac-spinner-sm"></div>
                        <span>جاري الفتح...</span>
                    }
                    else
                    {
                        <i class="bi bi-box-arrow-up-right"></i>
                        <span>فتح صفحة الدفع</span>
                    }
                </button>

                        <a href="@PaymentUrl" target="_blank" class="ac-btn ac-btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i>
                            فتح يدوياً
                        </a>

                <button class="ac-btn ac-btn-outline-secondary" @onclick="HandleCancel">
                    إلغاء
                </button>
            </div>

            <p class="payment-redirect-note">
                <i class="bi bi-shield-check"></i>
                سيتم إرجاعك تلقائياً بعد إتمام الدفع
            </p>

            @* Debug info - can be removed in production *@
            @if (!string.IsNullOrEmpty(PaymentUrl))
            {
                <details class="payment-debug-info">
                    <summary>معلومات تقنية</summary>
                    <p class="payment-url-display">@PaymentUrl</p>
                </details>
            }
                else
                {
                    <div class="payment-actions">
                        <button class="ac-btn ac-btn-outline-secondary" @onclick="HandleCancel">
                            العودة
                        </button>
        </div>
    }
            </div>
        }
    else
    {
        @* Iframe mode - for gateways that allow it *@
        @if (_isLoading)
        {
            <div class="payment-loading">
                <div class="ac-spinner"></div>
                <span>جاري تحميل صفحة الدفع...</span>
            </div>
        }

        <div class="payment-header">
            <button class="payment-close-btn" @onclick="HandleCancel">
                <i class="bi bi-x-lg"></i>
            </button>
            <span class="payment-secure-badge">
                <i class="bi bi-shield-lock-fill"></i>
                دفع آمن
            </span>
        </div>

        <iframe
            @ref="_iframeRef"
            src="@PaymentUrl"
            class="payment-iframe @(_isLoading ? "loading" : "")"
            sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation"
            @onload="HandleIframeLoad">
        </iframe>
    }
</div>
</div>

@code {
    [Parameter, EditorRequired]
    public string PaymentUrl { get; set; } = string.Empty;

    [Parameter]
    public string? PaymentId { get; set; }

    [Parameter]
    public string ReturnUrlPattern { get; set; } = "/payment/callback";

    [Parameter]
    public EventCallback<PaymentResult> OnPaymentCompleted { get; set; }

    [Parameter]
    public EventCallback OnPaymentCancelled { get; set; }

    /// <summary>
    /// Use redirect mode instead of iframe (required for most payment gateways)
    /// </summary>
    [Parameter]
    public bool UseRedirect { get; set; } = true;

    /// <summary>
    /// Payment ID for tracking
    /// </summary>
    [Parameter]
    public string? PaymentId { get; set; }

    private ElementReference _iframeRef;
    private bool _isLoading = true;
    private DotNetObjectReference<PaymentWebView>? _objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);

            if (UseRedirect)
            {
                // Auto-open payment page on first render
                await OpenPaymentPage();
            }
            else
            {
                await SetupNavigationListener();
            }
        }
    }

    private string? _errorMessage;
    private bool _isOpening = false;

    private async Task OpenPaymentPage()
    {
        if (string.IsNullOrEmpty(PaymentUrl))
        {
            _openFailed = true;
            _errorMessage = "رابط الدفع غير متوفر";
            Console.WriteLine("[PaymentWebView] PaymentUrl is null or empty");
            StateHasChanged();
            return;
        }

        _isOpening = true;
        _openFailed = false;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            Console.WriteLine($"[PaymentWebView] Opening payment URL: {PaymentUrl}");

            // Use IAppNavigationService.OpenExternalAsync which handles
            // platform-specific URL opening (MAUI Browser for mobile, browser for web)
            await AppNavigation.OpenExternalAsync(PaymentUrl);

            Console.WriteLine("[PaymentWebView] OpenExternalAsync completed");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[PaymentWebView] Error opening payment page: {ex.Message}");
            _errorMessage = $"فشل فتح صفحة الدفع: {ex.Message}";

            // Fallback: Direct navigation
            try
            {
                Navigation.NavigateTo(PaymentUrl, forceLoad: true);
            }
            catch (Exception navEx)
            {
                Console.WriteLine($"[PaymentWebView] Fallback navigation also failed: {navEx.Message}");
            }
        }
        finally
        {
            _isOpening = false;
            StateHasChanged();
        }
    }

    private async Task SetupNavigationListener()
    {
        try
        {
            // Setup message listener for payment completion
            await JS.InvokeVoidAsync("eval", $@"
                window.paymentMessageHandler = function(event) {{
                    // Check if message is from payment gateway
                    if (event.data && event.data.type === 'payment_complete') {{
                        DotNet.invokeMethodAsync('Ashare.Shared', 'OnPaymentMessage', JSON.stringify(event.data));
                    }}
                }};
                window.addEventListener('message', window.paymentMessageHandler);
            ");
        }
        catch
        {
            // JS interop not available (e.g., prerendering)
        }
    }

    private void HandleIframeLoad()
    {
        _isLoading = false;
        StateHasChanged();

        // Try to detect URL change in iframe (for same-origin)
        CheckIframeNavigation();
    }

    private async void CheckIframeNavigation()
    {
        try
        {
            // This only works for same-origin URLs
            var currentUrl = await JS.InvokeAsync<string>("eval", @"
                try {
                    return document.querySelector('.payment-iframe').contentWindow.location.href;
                } catch(e) {
                    return '';
                }
            ");

            if (!string.IsNullOrEmpty(currentUrl) && currentUrl.Contains(ReturnUrlPattern))
            {
                await ProcessReturnUrl(currentUrl);
            }
        }
        catch
        {
            // Cross-origin - can't access iframe URL
        }
    }

    private async Task ProcessReturnUrl(string url)
    {
        var uri = new Uri(url);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        var result = new PaymentResult
        {
            Success = query["status"]?.ToLower() == "success" ||
                     query["status"]?.ToLower() == "captured" ||
                     query["resultCode"] == "0",
            TransactionId = query["orderId"] ?? query["transactionId"] ?? "",
            Message = query["message"] ?? query["error"] ?? ""
        };

        await OnPaymentCompleted.InvokeAsync(result);
    }

    [JSInvokable]
    public async Task OnPaymentMessage(string messageJson)
    {
        try
        {
            var message = System.Text.Json.JsonSerializer.Deserialize<PaymentMessage>(messageJson);
            if (message != null)
            {
                var result = new PaymentResult
                {
                    Success = message.Status == "success",
                    TransactionId = message.TransactionId ?? "",
                    Message = message.Message ?? ""
                };
                await OnPaymentCompleted.InvokeAsync(result);
            }
        }
        catch
        {
            // Invalid message format
        }
    }

    private async Task HandleCancel()
    {
        await OnPaymentCancelled.InvokeAsync();
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", @"
                if (window.paymentMessageHandler) {
                    window.removeEventListener('message', window.paymentMessageHandler);
                    delete window.paymentMessageHandler;
                }
            ");
        }
        catch
        {
            // Ignore disposal errors
        }

        _objRef?.Dispose();
    }

    private class PaymentMessage
    {
        public string Type { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string? TransactionId { get; set; }
        public string? Message { get; set; }
    }
}

<style>
    .payment-webview-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: var(--ac-bg-primary);
        position: relative;
    }

    .payment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--ac-spacing-sm) var(--ac-spacing-md);
        background: var(--ac-bg-secondary);
        border-bottom: 1px solid var(--ac-border);
    }

    .payment-close-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border: none;
        background: transparent;
        border-radius: 50%;
        cursor: pointer;
        transition: background 0.2s;
    }

    .payment-close-btn:hover {
        background: var(--ac-bg-tertiary);
    }

    .payment-close-btn i {
        font-size: 18px;
        color: var(--ac-text-primary);
    }

    .payment-secure-badge {
        display: flex;
        align-items: center;
        gap: var(--ac-spacing-xs);
        color: var(--ac-success);
        font-size: var(--ac-font-sm);
        font-weight: 500;
    }

    .payment-secure-badge i {
        font-size: 16px;
    }

    .payment-iframe {
        flex: 1;
        width: 100%;
        border: none;
        background: white;
    }

    .payment-iframe.loading {
        opacity: 0;
    }

    .payment-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--ac-spacing-md);
        z-index: 10;
    }

    .payment-loading span {
        color: var(--ac-text-secondary);
    }

    /* Redirect mode styles */
    .payment-redirect-message {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: var(--ac-spacing-xl);
        gap: var(--ac-spacing-md);
        min-height: 400px;
    }

    .payment-redirect-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--ac-primary-light, rgba(99, 102, 241, 0.1));
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: var(--ac-spacing-md);
    }

    .payment-redirect-icon i {
        font-size: 40px;
        color: var(--ac-primary);
    }

    .payment-redirect-message h3 {
        margin: 0;
        font-size: var(--ac-font-lg);
        color: var(--ac-text-primary);
    }

    .payment-redirect-message p {
        margin: 0;
        color: var(--ac-text-secondary);
        font-size: var(--ac-font-sm);
    }

    .payment-redirect-actions {
        display: flex;
        flex-direction: column;
        gap: var(--ac-spacing-sm);
        width: 100%;
        max-width: 300px;
        margin-top: var(--ac-spacing-md);
    }

    .payment-redirect-note {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--ac-spacing-xs);
        color: var(--ac-success) !important;
        font-size: var(--ac-font-xs) !important;
        margin-top: var(--ac-spacing-md);
    }

    .payment-redirect-note i {
        font-size: 14px;
    }

    .payment-error-message {
        display: flex;
        align-items: center;
        gap: var(--ac-spacing-sm);
        padding: var(--ac-spacing-md);
        background: var(--ac-danger-light, rgba(239, 68, 68, 0.1));
        color: var(--ac-danger);
        border-radius: var(--ac-radius-md);
        font-size: var(--ac-font-sm);
        width: 100%;
        max-width: 300px;
    }

    .payment-error-message i {
        font-size: 18px;
    }

    .payment-debug-info {
        margin-top: var(--ac-spacing-lg);
        width: 100%;
        max-width: 400px;
        text-align: start;
    }

    .payment-debug-info summary {
        cursor: pointer;
        color: var(--ac-text-tertiary);
        font-size: var(--ac-font-xs);
    }

    .payment-url-display {
        margin: var(--ac-spacing-sm) 0 0;
        padding: var(--ac-spacing-sm);
        background: var(--ac-bg-tertiary);
        border-radius: var(--ac-radius-sm);
        font-size: var(--ac-font-xs);
        word-break: break-all;
        color: var(--ac-text-secondary);
        font-family: monospace;
    }
</style>
