@using Ashare.Shared.Models
@using Ashare.Shared.Services
@inject IPaymentService PaymentService
@inject IAppNavigationService Navigation

<div class="payment-webview-container">
    <div class="payment-content">
        @if (_isOpening)
        {
            <div class="payment-loading">
                <div class="payment-icon spinning">
                    <i class="bi bi-arrow-repeat"></i>
                </div>
                <h3>جاري فتح صفحة الدفع...</h3>
                <p>يرجى الانتظار</p>
            </div>
        }
        else if (_openFailed)
        {
            <div class="payment-error">
                <div class="payment-icon error">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <h3>فشل فتح صفحة الدفع</h3>
                <p>@_errorMessage</p>

                @if (!string.IsNullOrEmpty(PaymentUrl))
                {
                    <div class="payment-actions">
                        <button class="ac-btn ac-btn-primary ac-btn-lg" @onclick="TryOpenPayment">
                            <i class="bi bi-arrow-clockwise"></i>
                            إعادة المحاولة
                        </button>

                        <a href="@PaymentUrl" target="_blank" class="ac-btn ac-btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i>
                            فتح يدوياً
                        </a>

                        <button class="ac-btn ac-btn-outline-secondary" @onclick="HandleCancel">
                            إلغاء
                        </button>
                    </div>

                    <details class="payment-url-details">
                        <summary>رابط الدفع</summary>
                        <code>@PaymentUrl</code>
                    </details>
                }
                else
                {
                    <div class="payment-actions">
                        <button class="ac-btn ac-btn-outline-secondary" @onclick="HandleCancel">
                            العودة
                        </button>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="payment-ready">
                <div class="payment-icon">
                    <i class="bi bi-credit-card-2-front"></i>
                </div>
                <h3>جاهز للدفع</h3>
                <p>سيتم توجيهك لصفحة الدفع الآمنة</p>

                <div class="payment-actions">
                    <button class="ac-btn ac-btn-primary ac-btn-lg" @onclick="TryOpenPayment">
                        <i class="bi bi-lock"></i>
                        متابعة للدفع الآمن
                    </button>

                    <button class="ac-btn ac-btn-outline-secondary" @onclick="HandleCancel">
                        إلغاء
                    </button>
                </div>

                <p class="payment-note">
                    <i class="bi bi-shield-check"></i>
                    ستعود تلقائياً بعد إتمام الدفع
                </p>
            </div>
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public string PaymentUrl { get; set; } = string.Empty;

    [Parameter]
    public string? PaymentId { get; set; }

    [Parameter]
    public string ReturnUrlPattern { get; set; } = "/payment/callback";

    [Parameter]
    public bool UseRedirect { get; set; } = true;

    [Parameter]
    public bool AutoOpen { get; set; } = true;

    [Parameter]
    public EventCallback<PaymentResult> OnPaymentCompleted { get; set; }

    [Parameter]
    public EventCallback OnPaymentCancelled { get; set; }

    private bool _isOpening = false;
    private bool _openFailed = false;
    private string? _errorMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && AutoOpen && !string.IsNullOrEmpty(PaymentUrl))
        {
            await TryOpenPayment();
        }
    }

    private async Task TryOpenPayment()
    {
        if (string.IsNullOrEmpty(PaymentUrl))
        {
            _openFailed = true;
            _errorMessage = "رابط الدفع غير متوفر";
            StateHasChanged();
            return;
        }

        _isOpening = true;
        _openFailed = false;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            Console.WriteLine($"[PaymentWebView] Opening: {PaymentUrl}");

            var success = await PaymentService.OpenPaymentPageAsync(PaymentUrl);

            if (!success)
            {
                _openFailed = true;
                _errorMessage = "لم نتمكن من فتح صفحة الدفع. جرب الفتح يدوياً.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[PaymentWebView] Error: {ex.Message}");
            _openFailed = true;
            _errorMessage = $"حدث خطأ: {ex.Message}";
        }
        finally
        {
            _isOpening = false;
            StateHasChanged();
        }
    }

    private async Task HandleCancel()
    {
        await OnPaymentCancelled.InvokeAsync();
    }
}

<style>
    .payment-webview-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        padding: var(--ac-spacing-xl);
        background: var(--ac-bg);
    }

    .payment-content {
        text-align: center;
        max-width: 400px;
        width: 100%;
    }

    .payment-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto var(--ac-spacing-lg);
        font-size: 36px;
    }

    .payment-ready .payment-icon {
        background: var(--ashare-primary-light, rgba(52, 84, 84, 0.1));
        color: var(--ashare-primary);
    }

    .payment-loading .payment-icon {
        background: var(--ashare-secondary-light, rgba(244, 132, 76, 0.1));
        color: var(--ashare-secondary);
    }

    .payment-loading .payment-icon.spinning i {
        animation: spin 1s linear infinite;
    }

    .payment-error .payment-icon {
        background: rgba(239, 68, 68, 0.1);
        color: #EF4444;
    }

    .payment-error .payment-icon.error {
        background: rgba(239, 68, 68, 0.1);
    }

    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .payment-content h3 {
        margin: 0 0 var(--ac-spacing-sm);
        font-size: var(--ac-font-lg, 18px);
        color: var(--ac-text);
    }

    .payment-content p {
        margin: 0 0 var(--ac-spacing-lg);
        color: var(--ac-text-secondary);
        font-size: var(--ac-font-sm, 14px);
    }

    .payment-actions {
        display: flex;
        flex-direction: column;
        gap: var(--ac-spacing-sm);
        margin-bottom: var(--ac-spacing-lg);
    }

    .payment-note {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--ac-spacing-xs);
        color: var(--ac-success, #10B981) !important;
        font-size: var(--ac-font-xs, 12px) !important;
    }

    .payment-url-details {
        margin-top: var(--ac-spacing-lg);
        text-align: start;
    }

    .payment-url-details summary {
        cursor: pointer;
        color: var(--ac-text-muted);
        font-size: var(--ac-font-xs, 12px);
    }

    .payment-url-details code {
        display: block;
        margin-top: var(--ac-spacing-sm);
        padding: var(--ac-spacing-sm);
        background: var(--ac-bg-secondary);
        border-radius: var(--ac-radius-sm);
        font-size: 11px;
        word-break: break-all;
        color: var(--ac-text-secondary);
    }
</style>
