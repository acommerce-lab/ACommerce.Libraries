@inherits LayoutComponentBase
@inject Ashare.Shared.Services.ThemeService ThemeService
@inject IAppNavigationService Navigation
@inject AshareApiService ApiService
@inject ACommerce.Client.Auth.TokenManager TokenManager
@inject ACommerce.Client.Auth.AuthClient AuthClient
@inject Ashare.Shared.Services.GuestModeService GuestMode

<div class="ashare-app @(ThemeService.IsDarkMode ? "ac-dark" : "")">
    @* Navbar *@
    @if (!HideNavigation)
    {
        <nav class="ac-navbar ac-navbar-sticky">
            <div class="ac-navbar-container">
                <div class="ac-navbar-brand">
                    <img src="_content/Ashare.Shared/images/ashare-icon.svg" alt="عشير" class="ac-navbar-logo" width="36" height="36" />
                    <span class="ac-navbar-brand-text">عشير</span>
                </div>

                <div class="ac-navbar-actions">
                    <button class="ac-navbar-action" @onclick="HandleSearchClick" title="البحث">
                        <i class="bi bi-search"></i>
                    </button>
                    <button class="ac-navbar-action" @onclick="HandleNotificationsClick" title="الإشعارات">
                        <i class="bi bi-bell"></i>
                        @if (NotificationCount > 0)
                        {
                            <span class="ac-badge ac-badge-danger ac-badge-sm">@NotificationCount</span>
                        }
                    </button>
                </div>
            </div>
        </nav>
    }

    @* Main Content *@
    <main class="ac-main @(HideNavigation ? "" : "ac-has-navbar ac-has-bottom-nav")">
        @Body
    </main>

    @* Bottom Navigation *@
    @if (!HideNavigation)
    {
        <nav class="ac-bottom-nav">
            <a href="/" class="ac-bottom-nav-item @(IsActive("/") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-house"></i></span>
                <span class="ac-bottom-nav-label">الرئيسية</span>
            </a>
            <a href="/explore" class="ac-bottom-nav-item @(IsActive("/explore") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-compass"></i></span>
                <span class="ac-bottom-nav-label">استكشف</span>
            </a>
            <a href="/bookings" class="ac-bottom-nav-item @(IsActive("/bookings") ? "active" : "")">
                <span class="ac-bottom-nav-icon">
                    <i class="bi bi-calendar-check"></i>
                    @if (BookingsCount > 0)
                    {
                        <span class="ac-badge ac-badge-primary ac-badge-sm">@BookingsCount</span>
                    }
                </span>
                <span class="ac-bottom-nav-label">حجوزاتي</span>
            </a>
            <a href="/favorites" class="ac-bottom-nav-item @(IsActive("/favorites") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-heart"></i></span>
                <span class="ac-bottom-nav-label">المفضلة</span>
            </a>
            <a href="/profile" class="ac-bottom-nav-item @(IsActive("/profile") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-person"></i></span>
                <span class="ac-bottom-nav-label">حسابي</span>
            </a>
        </nav>
    }
</div>

@code {
    [CascadingParameter]
    private RouteData? RouteData { get; set; }

    private int BookingsCount { get; set; }
    private int NotificationCount { get; set; }
    private bool _initialized;
    private string? _lastCheckedPath;

    private bool IsAuthPage
    {
        get
        {
            // التحقق من اسم الصفحة
            var pageName = RouteData?.PageType?.Name;
            if (pageName is "Login" or "Register" or "ProfileEdit")
                return true;

            // التحقق من المسار (للتوافق مع MAUI)
            var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
            return currentPath.Contains("/login") ||
                   currentPath.Contains("/register") ||
                   currentPath.Contains("/profile/edit");
        }
    }

    /// <summary>
    /// صفحات تحتاج شاشة كاملة بدون navbar و bottom nav
    /// </summary>
    private bool IsFullScreenPage
    {
        get
        {
            var pageName = RouteData?.PageType?.Name;
            if (pageName is "ChatRoom")
                return true;

            var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
            return currentPath.Contains("/chat/");
        }
    }

    /// <summary>
    /// صفحات محمية تتطلب تسجيل الدخول (لا يمكن للضيف الوصول إليها)
    /// </summary>
    private bool IsProtectedPage
    {
        get
        {
            var pageName = RouteData?.PageType?.Name;
            if (pageName is "Bookings" or "Favorites" or "Profile" or "Chat" or "ChatRoom" or "Notifications")
                return true;

            var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
            return currentPath.Contains("/bookings") ||
                   currentPath.Contains("/favorites") ||
                   currentPath.Contains("/profile") ||
                   currentPath.Contains("/chat") ||
                   currentPath.Contains("/notifications");
        }
    }

    /// <summary>
    /// هل يجب إخفاء القوائم (لصفحات المصادقة أو الشاشة الكاملة)
    /// </summary>
    private bool HideNavigation => IsAuthPage || IsFullScreenPage;

    protected override Task OnInitializedAsync()
    {
        // تحميل عدد الإشعارات (متزامن)
        NotificationCount = ApiService.GetNotificationsCount();
        
        // تحميل عدد الحجوزات في الخلفية (غير متزامن - لا يُعيق عرض الصفحة)
        _ = LoadBookingsCountAsync();
        
        return Task.CompletedTask;
    }

    private async Task LoadBookingsCountAsync()
    {
        try
        {
            BookingsCount = await ApiService.GetBookingsCountAsync();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MainLayout] Error loading bookings count: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // تهيئة حالة وضع الضيف من التخزين
            await GuestMode.InitializeAsync();
            _initialized = true;
        }

        // التحقق من المصادقة بعد التهيئة
        if (_initialized)
        {
            await CheckAuthAsync();
        }
    }

    private async Task CheckAuthAsync()
    {
        // تجنب التحقق المتكرر لنفس المسار (للأداء)
        var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
        
        // دائماً تحقق للصفحات المحمية حتى لو تم التحقق سابقاً
        var needsCheck = IsProtectedPage || currentPath != _lastCheckedPath;
        if (!needsCheck) return;
        
        _lastCheckedPath = currentPath;

        var token = await TokenManager.GetTokenAsync();
        var isGuest = GuestMode.IsGuestMode;

        Console.WriteLine($"[MainLayout] Auth check - Path: {currentPath}, Token: {(token != null ? "exists" : "null")}, IsGuest: {isGuest}, IsAuthPage: {IsAuthPage}, IsProtectedPage: {IsProtectedPage}");

        if (IsAuthPage)
        {
            // صفحة مصادقة - لا نتدخل
            return;
        }

        if (token != null)
        {
            // لديه توكن - لا حاجة للتحقق من الصلاحية كل مرة (للأداء)
            // التحقق من الصلاحية يتم عند أول تحميل فقط
            return;
        }

        // لا يوجد توكن
        if (isGuest)
        {
            if (IsProtectedPage)
            {
                // ضيف يحاول الوصول لصفحة محمية - توجيه لصفحة الدخول
                Console.WriteLine("[Auth] Guest trying to access protected page - redirecting to login");
                Navigation.NavigateTo("/login");
            }
            // إذا كان ضيف ويريد الوصول لصفحة عامة - نسمح له
        }
        else
        {
            // لا يوجد توكن وليس في وضع الضيف - توجيه لصفحة الدخول
            Console.WriteLine("[Auth] No token and not guest - redirecting to login");
            Navigation.NavigateTo("/login");
        }
    }

    /// <summary>
    /// التحقق من صلاحية التوكن من الباك اند
    /// </summary>
    private async Task<bool> ValidateTokenAsync()
    {
        try
        {
            // استدعاء /api/auth/me للتحقق من صلاحية التوكن
            var user = await AuthClient.GetMeAsync();
            return user != null;
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            // 401 = التوكن غير صالح
            Console.WriteLine("[Auth] Token validation failed: Unauthorized");
            return false;
        }
        catch (Exception ex)
        {
            // أي خطأ آخر - نفترض أن التوكن صالح لتجنب تسجيل الخروج بسبب مشاكل الشبكة
            Console.WriteLine($"[Auth] Token validation error (assuming valid): {ex.Message}");
            return true;
        }
    }

    private bool IsActive(string path)
    {
        var currentPath = Navigation.CurrentUri;
        if (path == "/")
            return currentPath.EndsWith("/") || currentPath.EndsWith("/index");
        return currentPath.Contains(path);
    }

    private void HandleSearchClick()
    {
        Navigation.NavigateTo("/search");
    }

    private void HandleNotificationsClick()
    {
        Navigation.NavigateTo("/notifications");
    }
}
