@inherits LayoutComponentBase
@using ACommerce.Templates.Customer.Components
@inject Ashare.Shared.Services.ThemeService ThemeService
@inject IAppNavigationService Navigation
@inject AshareApiService ApiService
@inject ACommerce.Client.Auth.TokenManager TokenManager
@inject ACommerce.Client.Auth.AuthClient AuthClient
@inject ACommerce.Templates.Customer.Services.GuestModeService GuestMode
@inject Ashare.Shared.Services.VersionCheckService VersionCheck
@inject ILocalizationService L
@implements IDisposable

@* Version Blocker - يظهر فوق كل شيء إذا كان الإصدار غير مدعوم *@
@if (VersionCheck.IsBlocked)
{
    <AcVersionBlocker
        IsBlocked="true"
        Message="@GetBlockerMessage()"
        CurrentVersion="@CurrentAppVersion"
        LatestVersion="@VersionCheck.LastCheckResult?.LatestVersion?.VersionNumber"
        ReleaseNotes="@(L.IsRtl ? VersionCheck.LastCheckResult?.LatestVersion?.ReleaseNotesAr : VersionCheck.LastCheckResult?.LatestVersion?.ReleaseNotesEn)"
        UpdateUrl="@VersionCheck.LastCheckResult?.LatestVersion?.UpdateUrl"
        StoreUrl="@GetStoreUrl()"
        SupportEmail="support@ashare.app"
        IsArabic="@L.IsRtl"
        Title="@L["VersionUnsupported"]"
        YourVersionLabel="@L["YourVersion"]"
        LatestVersionLabel="@L["LatestVersion"]"
        WhatsNewLabel="@L["WhatsNew"]"
        UpdateNowLabel="@L["UpdateNow"]"
        OpenStoreLabel="@L["OpenStore"]"
        NeedHelpLabel="@L["NeedHelp"]" />
}

<div class="ashare-app @(ThemeService.IsDarkMode ? "ac-dark" : "")" dir="@(L.IsRtl ? "rtl" : "ltr")">
    @* Navbar *@
    @if (!HideNavigation)
    {
        <nav class="ac-navbar ac-navbar-sticky">
            <div class="ac-navbar-container">
                <div class="ac-navbar-brand">
                    <img src="_content/Ashare.Shared/images/ashare-logo.png" alt="عشير" class="ac-navbar-logo" height="40" />
                </div>

                <div class="ac-navbar-actions">
                    <button class="ac-navbar-action" @onclick="HandleSearchClick" title="@L["Search"]">
                        <i class="bi bi-search"></i>
                    </button>
                    <button class="ac-navbar-action" @onclick="HandleNotificationsClick" title="@L["Notifications"]">
                        <i class="bi bi-bell"></i>
                        @if (NotificationCount > 0)
                        {
                            <span class="ac-badge ac-badge-danger ac-badge-sm">@NotificationCount</span>
                        }
                    </button>
                </div>
            </div>
        </nav>
    }

    @* Version Alert - تنبيه للإصدارات المتقادمة أو المتوفر لها تحديث *@
    @if (!VersionCheck.IsBlocked && !_versionAlertDismissed && (VersionCheck.HasWarning || VersionCheck.UpdateAvailable))
    {
        <AcVersionAlert
            AlertType="@(VersionCheck.HasWarning ? VersionAlertType.Warning : VersionAlertType.Info)"
            Message="@GetVersionAlertMessage()"
            EndOfSupportDate="@VersionCheck.LastCheckResult?.EndOfSupportDate"
            UpdateUrl="@GetStoreUrl()"
            IsArabic="@L.IsRtl"
            OnDismiss="@HandleVersionAlertDismiss"
            EndOfSupportLabel="@L["EndOfSupport"]"
            UpdateNowLabel="@L["UpdateNow"]"
            LaterLabel="@L["Later"]" />
    }

    @* Main Content *@
    <main class="ac-main @(HideNavigation ? "" : "ac-has-navbar ac-has-bottom-nav")">
        @Body
    </main>

    @* Bottom Navigation *@
    @if (!HideNavigation)
    {
        <nav class="ac-bottom-nav">
            <a href="/" class="ac-bottom-nav-item @(IsActive("/") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-house"></i></span>
                <span class="ac-bottom-nav-label">@L["Home"]</span>
            </a>
            <a href="/explore" class="ac-bottom-nav-item @(IsActive("/explore") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-compass"></i></span>
                <span class="ac-bottom-nav-label">@L["Explore"]</span>
            </a>
            <a href="/bookings" class="ac-bottom-nav-item @(IsActive("/bookings") ? "active" : "")">
                <span class="ac-bottom-nav-icon">
                    <i class="bi bi-calendar-check"></i>
                    @if (BookingsCount > 0)
                    {
                        <span class="ac-badge ac-badge-primary ac-badge-sm">@BookingsCount</span>
                    }
                </span>
                <span class="ac-bottom-nav-label">@L["Bookings"]</span>
            </a>
            <a href="/favorites" class="ac-bottom-nav-item @(IsActive("/favorites") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-heart"></i></span>
                <span class="ac-bottom-nav-label">@L["Favorites"]</span>
            </a>
            <a href="/profile" class="ac-bottom-nav-item @(IsActive("/profile") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-person"></i></span>
                <span class="ac-bottom-nav-label">@L["Profile"]</span>
            </a>
        </nav>
    }
</div>

@code {
    [CascadingParameter]
    private RouteData? RouteData { get; set; }

    private int BookingsCount { get; set; }
    private int NotificationCount { get; set; }
    private bool _initialized;
    private string? _lastCheckedPath;
    private static bool _bookingsCountLoaded;
    private static int _cachedBookingsCount;
    private static bool _versionChecked;
    private bool _versionAlertDismissed;

    /// <summary>
    /// إصدار التطبيق الحالي
    /// </summary>
    private string CurrentAppVersion => GetCurrentAppVersion();

    /// <summary>
    /// الحصول على إصدار التطبيق من Assembly
    /// </summary>
    private static string GetCurrentAppVersion()
    {
        try
        {
            var assembly = System.Reflection.Assembly.GetEntryAssembly();
            var version = assembly?.GetName().Version;
            if (version != null)
            {
                return $"{version.Major}.{version.Minor}";
            }
        }
        catch
        {
            // تجاهل أي أخطاء
        }
        return "1.0";
    }

    /// <summary>
    /// الحصول على رابط المتجر المناسب (App Store أو Play Store)
    /// </summary>
    private string GetStoreUrl()
    {
        // يمكن تحديد المتجر بناءً على المنصة
        // حالياً نعيد رابط عام
        return VersionCheck.LastCheckResult?.LatestVersion?.UpdateUrl ?? "https://ashare.app";
    }

    /// <summary>
    /// الحصول على رسالة شاشة الحظر
    /// </summary>
    private string GetBlockerMessage()
    {
        // أولاً نحاول استخدام الرسالة المخصصة من الـ API
        var customMessage = L.IsRtl
            ? VersionCheck.LastCheckResult?.MessageAr
            : VersionCheck.LastCheckResult?.MessageEn;

        if (!string.IsNullOrEmpty(customMessage))
        {
            return customMessage;
        }

        // إذا لم توجد رسالة مخصصة، نستخدم الترجمة
        return L["VersionUnsupportedMessage"];
    }

    /// <summary>
    /// الحصول على رسالة تنبيه الإصدار
    /// </summary>
    private string GetVersionAlertMessage()
    {
        // أولاً نحاول استخدام الرسالة المخصصة من الـ API
        var customMessage = L.IsRtl
            ? VersionCheck.LastCheckResult?.MessageAr
            : VersionCheck.LastCheckResult?.MessageEn;

        if (!string.IsNullOrEmpty(customMessage))
        {
            return customMessage;
        }

        // إذا لم توجد رسالة مخصصة، نستخدم الترجمة
        if (VersionCheck.HasWarning)
        {
            return L["VersionDeprecatedMessage"];
        }

        if (VersionCheck.UpdateAvailable)
        {
            return L["VersionUpdateAvailable"];
        }

        return "";
    }

    /// <summary>
    /// إغلاق تنبيه الإصدار
    /// </summary>
    private void HandleVersionAlertDismiss()
    {
        _versionAlertDismissed = true;
        StateHasChanged();
    }

    private bool IsAuthPage
    {
        get
        {
            // التحقق من اسم الصفحة
            var pageName = RouteData?.PageType?.Name;
            if (pageName is "Login" or "Register" or "ProfileEdit")
                return true;

            // التحقق من المسار (للتوافق مع MAUI)
            var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
            return currentPath.Contains("/login") ||
                   currentPath.Contains("/register") ||
                   currentPath.Contains("/profile/edit");
        }
    }

    /// <summary>
    /// صفحات تحتاج شاشة كاملة بدون navbar و bottom nav
    /// </summary>
    private bool IsFullScreenPage
    {
        get
        {
            var pageName = RouteData?.PageType?.Name;
            if (pageName is "ChatRoom")
                return true;

            var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
            return currentPath.Contains("/chat/");
        }
    }

    /// <summary>
    /// صفحات محمية تتطلب تسجيل الدخول (لا يمكن للضيف الوصول إليها)
    /// </summary>
    private bool IsProtectedPage
    {
        get
        {
            var pageName = RouteData?.PageType?.Name;
            if (pageName is "Bookings" or "Favorites" or "Profile" or "Chat" or "ChatRoom" or "Notifications")
                return true;

            var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
            return currentPath.Contains("/bookings") ||
                   currentPath.Contains("/favorites") ||
                   currentPath.Contains("/profile") ||
                   currentPath.Contains("/chat") ||
                   currentPath.Contains("/notifications");
        }
    }

    /// <summary>
    /// هل يجب إخفاء القوائم (لصفحات المصادقة أو الشاشة الكاملة)
    /// </summary>
    private bool HideNavigation => IsAuthPage || IsFullScreenPage;

    protected override Task OnInitializedAsync()
    {
        // الاشتراك في حدث تغيير اللغة
        L.OnLanguageChanged += HandleLanguageChanged;

        // تحميل عدد الإشعارات (متزامن)
        NotificationCount = ApiService.GetNotificationsCount();

        // استخدام القيمة المخزنة مباشرة إذا تم تحميلها سابقاً
        if (_bookingsCountLoaded)
        {
            BookingsCount = _cachedBookingsCount;
        }
        else
        {
            // تحميل عدد الحجوزات في الخلفية (مرة واحدة فقط)
            _ = LoadBookingsCountAsync();
        }

        // فحص إصدار التطبيق (مرة واحدة فقط)
        if (!_versionChecked)
        {
            _ = CheckVersionAsync();
        }

        return Task.CompletedTask;
    }

    /// <summary>
    /// فحص إصدار التطبيق والتحقق من أنه مدعوم
    /// </summary>
    private async Task CheckVersionAsync()
    {
        if (_versionChecked) return;

        try
        {
            var currentVersion = CurrentAppVersion;
            Console.WriteLine($"[VersionCheck] Checking version {currentVersion}...");

            var result = await VersionCheck.CheckVersionAsync(currentVersion);
            _versionChecked = true;

            if (result != null)
            {
                Console.WriteLine($"[VersionCheck] Result - IsSupported: {result.IsSupported}, Status: {result.CurrentStatus}, ForceUpdate: {result.IsForceUpdate}");

                if (VersionCheck.IsBlocked)
                {
                    Console.WriteLine("[VersionCheck] ⛔ Version is BLOCKED - App will be locked");
                    await InvokeAsync(StateHasChanged);
                }
                else if (VersionCheck.HasWarning)
                {
                    Console.WriteLine($"[VersionCheck] ⚠️ Version is DEPRECATED - End of support: {result.EndOfSupportDate}");
                    await InvokeAsync(StateHasChanged);
                }
                else if (VersionCheck.UpdateAvailable)
                {
                    Console.WriteLine($"[VersionCheck] ℹ️ Update available - Latest: {result.LatestVersion?.VersionNumber}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[VersionCheck] Error: {ex.Message}");
            // في حالة الخطأ، نسمح بالمتابعة
            _versionChecked = true;
        }
    }
    
    private void HandleLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        L.OnLanguageChanged -= HandleLanguageChanged;
    }

    private async Task LoadBookingsCountAsync()
    {
        // تجنب التحميل المتكرر
        if (_bookingsCountLoaded) return;
        
        try
        {
            var count = await ApiService.GetBookingsCountAsync();
            _cachedBookingsCount = count;
            _bookingsCountLoaded = true;
            BookingsCount = count;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MainLayout] Error loading bookings count: {ex.Message}");
        }
    }
    
    /// <summary>
    /// إعادة تحميل عدد الحجوزات (يُستدعى بعد إنشاء حجز جديد)
    /// </summary>
    public static void InvalidateBookingsCache()
    {
        _bookingsCountLoaded = false;
        _cachedBookingsCount = 0;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // تهيئة حالة وضع الضيف من التخزين
            await GuestMode.InitializeAsync();
            _initialized = true;
        }

        // التحقق من المصادقة بعد التهيئة
        if (_initialized)
        {
            await CheckAuthAsync();
        }
    }

    private async Task CheckAuthAsync()
    {
        // تجنب التحقق المتكرر لنفس المسار (للأداء)
        var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
        
        // دائماً تحقق للصفحات المحمية حتى لو تم التحقق سابقاً
        var needsCheck = IsProtectedPage || currentPath != _lastCheckedPath;
        if (!needsCheck) return;
        
        _lastCheckedPath = currentPath;

        var token = await TokenManager.GetTokenAsync();
        var isGuest = GuestMode.IsGuestMode;

        Console.WriteLine($"[MainLayout] Auth check - Path: {currentPath}, Token: {(token != null ? "exists" : "null")}, IsGuest: {isGuest}, IsAuthPage: {IsAuthPage}, IsProtectedPage: {IsProtectedPage}");

        if (IsAuthPage)
        {
            // صفحة مصادقة - لا نتدخل
            return;
        }

        if (token != null)
        {
            // لديه توكن - لا حاجة للتحقق من الصلاحية كل مرة (للأداء)
            // التحقق من الصلاحية يتم عند أول تحميل فقط
            return;
        }

        // لا يوجد توكن
        if (isGuest)
        {
            if (IsProtectedPage)
            {
                // ضيف يحاول الوصول لصفحة محمية - توجيه لصفحة الدخول
                Console.WriteLine("[Auth] Guest trying to access protected page - redirecting to login");
                Navigation.NavigateTo("/login");
            }
            // إذا كان ضيف ويريد الوصول لصفحة عامة - نسمح له
        }
        else
        {
            // لا يوجد توكن وليس في وضع الضيف - توجيه لصفحة الدخول
            Console.WriteLine("[Auth] No token and not guest - redirecting to login");
            Navigation.NavigateTo("/login");
        }
    }

    /// <summary>
    /// التحقق من صلاحية التوكن من الباك اند
    /// </summary>
    private async Task<bool> ValidateTokenAsync()
    {
        try
        {
            // استدعاء /api/auth/me للتحقق من صلاحية التوكن
            var user = await AuthClient.GetMeAsync();
            return user != null;
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            // 401 = التوكن غير صالح
            Console.WriteLine("[Auth] Token validation failed: Unauthorized");
            return false;
        }
        catch (Exception ex)
        {
            // أي خطأ آخر - نفترض أن التوكن صالح لتجنب تسجيل الخروج بسبب مشاكل الشبكة
            Console.WriteLine($"[Auth] Token validation error (assuming valid): {ex.Message}");
            return true;
        }
    }

    private bool IsActive(string path)
    {
        var currentPath = Navigation.CurrentUri;
        if (path == "/")
            return currentPath.EndsWith("/") || currentPath.EndsWith("/index");
        return currentPath.Contains(path);
    }

    private void HandleSearchClick()
    {
        Navigation.NavigateTo("/search");
    }

    private void HandleNotificationsClick()
    {
        Navigation.NavigateTo("/notifications");
    }
}
