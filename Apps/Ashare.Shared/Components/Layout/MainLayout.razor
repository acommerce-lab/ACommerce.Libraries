@inherits LayoutComponentBase
@inject Ashare.Shared.Services.ThemeService ThemeService
@inject IAppNavigationService Navigation
@inject AshareApiService ApiService
@inject ACommerce.Client.Auth.TokenManager TokenManager
@inject ACommerce.Client.Auth.AuthClient AuthClient
@inject Ashare.Shared.Services.GuestModeService GuestMode

<div class="ashare-app @(ThemeService.IsDarkMode ? "ac-dark" : "")">
    @* Navbar *@
    @if (!HideNavigation)
    {
        <nav class="ac-navbar ac-navbar-sticky">
            <div class="ac-navbar-container">
                <div class="ac-navbar-brand">
                    <img src="_content/Ashare.Shared/images/ashare-icon.svg" alt="عشير" class="ac-navbar-logo" width="36" height="36" />
                    <span class="ac-navbar-brand-text">عشير</span>
                </div>

                <div class="ac-navbar-actions">
                    <button class="ac-navbar-action" @onclick="HandleSearchClick" title="البحث">
                        <i class="bi bi-search"></i>
                    </button>
                    <button class="ac-navbar-action" @onclick="HandleNotificationsClick" title="الإشعارات">
                        <i class="bi bi-bell"></i>
                        @if (NotificationCount > 0)
                        {
                            <span class="ac-badge ac-badge-danger ac-badge-sm">@NotificationCount</span>
                        }
                    </button>
                </div>
            </div>
        </nav>
    }

    @* Main Content *@
    <main class="ac-main @(HideNavigation ? "" : "ac-has-navbar ac-has-bottom-nav")">
        @Body
    </main>

    @* Bottom Navigation *@
    @if (!HideNavigation)
    {
        <nav class="ac-bottom-nav">
            <a href="/" class="ac-bottom-nav-item @(IsActive("/") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-house"></i></span>
                <span class="ac-bottom-nav-label">الرئيسية</span>
            </a>
            <a href="/explore" class="ac-bottom-nav-item @(IsActive("/explore") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-compass"></i></span>
                <span class="ac-bottom-nav-label">استكشف</span>
            </a>
            <a href="/bookings" class="ac-bottom-nav-item @(IsActive("/bookings") ? "active" : "")">
                <span class="ac-bottom-nav-icon">
                    <i class="bi bi-calendar-check"></i>
                    @if (BookingsCount > 0)
                    {
                        <span class="ac-badge ac-badge-primary ac-badge-sm">@BookingsCount</span>
                    }
                </span>
                <span class="ac-bottom-nav-label">حجوزاتي</span>
            </a>
            <a href="/favorites" class="ac-bottom-nav-item @(IsActive("/favorites") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-heart"></i></span>
                <span class="ac-bottom-nav-label">المفضلة</span>
            </a>
            <a href="/profile" class="ac-bottom-nav-item @(IsActive("/profile") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-person"></i></span>
                <span class="ac-bottom-nav-label">حسابي</span>
            </a>
        </nav>
    }
</div>

@code {
    [CascadingParameter]
    private RouteData? RouteData { get; set; }

    private int BookingsCount { get; set; }
    private int NotificationCount { get; set; }
    private bool _authChecked;

    private bool IsAuthPage
    {
        get
        {
            // التحقق من اسم الصفحة
            var pageName = RouteData?.PageType?.Name;
            if (pageName is "Login" or "Register" or "ProfileEdit")
                return true;

            // التحقق من المسار (للتوافق مع MAUI)
            var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
            return currentPath.Contains("/login") ||
                   currentPath.Contains("/register") ||
                   currentPath.Contains("/profile/edit");
        }
    }

    /// <summary>
    /// صفحات تحتاج شاشة كاملة بدون navbar و bottom nav
    /// </summary>
    private bool IsFullScreenPage
    {
        get
        {
            var pageName = RouteData?.PageType?.Name;
            if (pageName is "ChatRoom")
                return true;

            var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
            return currentPath.Contains("/chat/");
        }
    }

    /// <summary>
    /// هل يجب إخفاء القوائم (لصفحات المصادقة أو الشاشة الكاملة)
    /// </summary>
    private bool HideNavigation => IsAuthPage || IsFullScreenPage;

    protected override async Task OnInitializedAsync()
    {
        // تحميل عدد الحجوزات والإشعارات
        BookingsCount = await ApiService.GetBookingsCountAsync();
        NotificationCount = ApiService.GetNotificationsCount();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_authChecked)
        {
            _authChecked = true;

            // التحقق من المصادقة
            var token = await TokenManager.GetTokenAsync();
            var isGuest = GuestMode.IsGuestMode;

            if (token != null && !IsAuthPage)
            {
                // التحقق من صلاحية التوكن مع الباك اند
                var isValid = await ValidateTokenAsync();
                if (!isValid)
                {
                    // التوكن غير صالح - حذفه والذهاب لصفحة الدخول
                    Console.WriteLine("[Auth] Token is invalid, clearing and redirecting to login");
                    TokenManager.ClearToken();
                    Navigation.NavigateTo("/login");
                    return;
                }
            }
            else if (token == null && !isGuest && !IsAuthPage)
            {
                // لا يوجد توكن وليس في وضع الضيف
                Navigation.NavigateTo("/login");
            }
        }
    }

    /// <summary>
    /// التحقق من صلاحية التوكن من الباك اند
    /// </summary>
    private async Task<bool> ValidateTokenAsync()
    {
        try
        {
            // استدعاء /api/auth/me للتحقق من صلاحية التوكن
            var user = await AuthClient.GetMeAsync();
            return user != null;
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            // 401 = التوكن غير صالح
            Console.WriteLine("[Auth] Token validation failed: Unauthorized");
            return false;
        }
        catch (Exception ex)
        {
            // أي خطأ آخر - نفترض أن التوكن صالح لتجنب تسجيل الخروج بسبب مشاكل الشبكة
            Console.WriteLine($"[Auth] Token validation error (assuming valid): {ex.Message}");
            return true;
        }
    }

    private bool IsActive(string path)
    {
        var currentPath = Navigation.CurrentUri;
        if (path == "/")
            return currentPath.EndsWith("/") || currentPath.EndsWith("/index");
        return currentPath.Contains(path);
    }

    private void HandleSearchClick()
    {
        Navigation.NavigateTo("/search");
    }

    private void HandleNotificationsClick()
    {
        Navigation.NavigateTo("/notifications");
    }
}
