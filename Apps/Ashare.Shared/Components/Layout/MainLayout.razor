@inherits LayoutComponentBase
@using ACommerce.Templates.Customer.Components
@inject Ashare.Shared.Services.ThemeService ThemeService
@inject IAppNavigationService Navigation
@inject AshareApiService ApiService
@inject ACommerce.Client.Auth.TokenManager TokenManager
@inject ACommerce.Client.Auth.AuthClient AuthClient
@inject ACommerce.Templates.Customer.Services.GuestModeService GuestMode
@inject Ashare.Shared.Services.VersionCheckService VersionCheck
@inject ACommerce.Templates.Customer.Services.IAppVersionService AppVersion
@inject ILocalizationService L
@implements IDisposable

@* Version Blocker ØªÙ… Ù†Ù‚Ù„Ù‡ Ø¥Ù„Ù‰ AppStartup.razor Ù„Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ *@

<div class="ashare-app @(ThemeService.IsDarkMode ? "ac-dark" : "")" dir="@(L.IsRtl ? "rtl" : "ltr")">
    @* Navbar *@
    @if (!HideNavigation)
    {
        <nav class="ac-navbar ac-navbar-sticky">
            <div class="ac-navbar-container">
                <div class="ac-navbar-brand">
                    <img src="_content/Ashare.Shared/images/ashare-logo.png" alt="Ø¹Ø´ÙŠØ±" class="ac-navbar-logo" height="40" />
                </div>

                <div class="ac-navbar-actions">
                    <button class="ac-navbar-action" @onclick="HandleSearchClick" title="@L["Search"]">
                        <i class="bi bi-search"></i>
                    </button>
                    <button class="ac-navbar-action" @onclick="HandleNotificationsClick" title="@L["Notifications"]">
                        <i class="bi bi-bell"></i>
                        @if (NotificationCount > 0)
                        {
                            <span class="ac-badge ac-badge-danger ac-badge-sm">@NotificationCount</span>
                        }
                    </button>
                </div>
            </div>
        </nav>
    }

    @* Version Alert - ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ø£Ø­Ø¯Ø« *@
    @if (ShouldShowVersionAlert)
    {
        <AcVersionAlert
            AlertType="@CurrentAlertType"
            Message="@GetVersionAlertMessage()"
            EndOfSupportDate="@VersionCheck.LastCheckResult?.EndOfSupportDate"
            UpdateUrl="@GetStoreUrl()"
            IsArabic="@L.IsRtl"
            OnDismiss="@HandleVersionAlertDismiss"
            EndOfSupportLabel="@L["EndOfSupport"]"
            UpdateNowLabel="@L["UpdateNow"]"
            LaterLabel="@L["Later"]" />
    }

    @* Main Content *@
    <main class="ac-main @(HideNavigation ? "" : "ac-has-navbar ac-has-bottom-nav")">
        @Body
    </main>

    @* Bottom Navigation *@
    @if (!HideNavigation)
    {
        <nav class="ac-bottom-nav">
            <a href="/" class="ac-bottom-nav-item @(IsActive("/") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-house"></i></span>
                <span class="ac-bottom-nav-label">@L["Home"]</span>
            </a>
            <a href="/explore" class="ac-bottom-nav-item @(IsActive("/explore") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-compass"></i></span>
                <span class="ac-bottom-nav-label">@L["Explore"]</span>
            </a>
            <a href="/bookings" class="ac-bottom-nav-item @(IsActive("/bookings") ? "active" : "")">
                <span class="ac-bottom-nav-icon">
                    <i class="bi bi-calendar-check"></i>
                    @if (BookingsCount > 0)
                    {
                        <span class="ac-badge ac-badge-primary ac-badge-sm">@BookingsCount</span>
                    }
                </span>
                <span class="ac-bottom-nav-label">@L["Bookings"]</span>
            </a>
            <a href="/favorites" class="ac-bottom-nav-item @(IsActive("/favorites") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-heart"></i></span>
                <span class="ac-bottom-nav-label">@L["Favorites"]</span>
            </a>
            <a href="/profile" class="ac-bottom-nav-item @(IsActive("/profile") ? "active" : "")">
                <span class="ac-bottom-nav-icon"><i class="bi bi-person"></i></span>
                <span class="ac-bottom-nav-label">@L["Profile"]</span>
            </a>
        </nav>
    }
</div>

@code {
    [CascadingParameter]
    private RouteData? RouteData { get; set; }

    private int BookingsCount { get; set; }
    private int NotificationCount { get; set; }
    private bool _initialized;
    private string? _lastCheckedPath;
    private static bool _bookingsCountLoaded;
    private static int _cachedBookingsCount;
    private static string? _cachedBookingsCustomerId; // Ù„ØªØªØ¨Ø¹ Ù…Ù† ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯ Ù„Ù‡
    private static bool _versionChecked;
    private bool _versionAlertDismissed;

    /// <summary>
    /// Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ù† IAppVersionService)
    /// </summary>
    private string CurrentAppVersion => AppVersion.Version;

    /// <summary>
    /// Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ù† IAppVersionService)
    /// </summary>
    private int CurrentBuildNumber => AppVersion.BuildNumber;

    /// <summary>
    /// Ù‡Ù„ ÙŠØ¬Ø¨ Ø¥Ø¸Ù‡Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¥ØµØ¯Ø§Ø± (ÙÙŠ ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù…Ø§Ø¹Ø¯Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø£Ø­Ø¯Ø« Ø£Ùˆ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±)
    /// </summary>
    private bool ShouldShowVersionAlert =>
        !VersionCheck.IsBlocked &&
        !_versionAlertDismissed &&
        VersionCheck.LastCheckResult != null &&
        VersionCheck.LastCheckResult.CurrentStatus != ACommerce.Client.Versions.VersionStatus.Latest;

    /// <summary>
    /// Ù†ÙˆØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø­Ø§Ù„ÙŠ
    /// </summary>
    private ACommerce.Templates.Customer.Components.VersionAlertType CurrentAlertType
    {
        get
        {
            var status = VersionCheck.LastCheckResult?.CurrentStatus;
            return status switch
            {
                ACommerce.Client.Versions.VersionStatus.Deprecated => ACommerce.Templates.Customer.Components.VersionAlertType.Warning,
                ACommerce.Client.Versions.VersionStatus.Unsupported => ACommerce.Templates.Customer.Components.VersionAlertType.Critical,
                _ => ACommerce.Templates.Customer.Components.VersionAlertType.Info
            };
        }
    }

    /// <summary>
    /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ (App Store Ø£Ùˆ Play Store)
    /// </summary>
    private string GetStoreUrl()
    {
        // ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ¬Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØµØ©
        // Ø­Ø§Ù„ÙŠØ§Ù‹ Ù†Ø¹ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø¹Ø§Ù…
        return VersionCheck.LastCheckResult?.LatestVersion?.UpdateUrl ?? "https://ashare.sa";
    }

    /// <summary>
    /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¸Ø±
    /// </summary>
    private string GetBlockerMessage()
    {
        // Ø£ÙˆÙ„Ø§Ù‹ Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ù…Ù† Ø§Ù„Ù€ API
        var customMessage = L.IsRtl
            ? VersionCheck.LastCheckResult?.MessageAr
            : VersionCheck.LastCheckResult?.MessageEn;

        if (!string.IsNullOrEmpty(customMessage))
        {
            return customMessage;
        }

        // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø©
        return L["VersionUnsupportedMessage"];
    }

    /// <summary>
    /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¥ØµØ¯Ø§Ø±
    /// </summary>
    private string GetVersionAlertMessage()
    {
        // Ø£ÙˆÙ„Ø§Ù‹ Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ù…Ù† Ø§Ù„Ù€ API
        var customMessage = L.IsRtl
            ? VersionCheck.LastCheckResult?.MessageAr
            : VersionCheck.LastCheckResult?.MessageEn;

        if (!string.IsNullOrEmpty(customMessage))
        {
            return customMessage;
        }

        // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
        var status = VersionCheck.LastCheckResult?.CurrentStatus;
        return status switch
        {
            ACommerce.Client.Versions.VersionStatus.Deprecated => L["VersionDeprecatedMessage"],
            ACommerce.Client.Versions.VersionStatus.Unsupported => L["VersionUnsupportedMessage"],
            ACommerce.Client.Versions.VersionStatus.Supported => L["VersionUpdateAvailable"],
            ACommerce.Client.Versions.VersionStatus.Development => L["VersionUpdateAvailable"],
            _ => L["VersionUpdateAvailable"]
        };
    }

    /// <summary>
    /// Ø¥ØºÙ„Ø§Ù‚ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¥ØµØ¯Ø§Ø±
    /// </summary>
    private void HandleVersionAlertDismiss()
    {
        _versionAlertDismissed = true;
        StateHasChanged();
    }

    private bool IsAuthPage
    {
        get
        {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„ØµÙØ­Ø©
            var pageName = RouteData?.PageType?.Name;
            if (pageName is "Login" or "Register" or "ProfileEdit")
                return true;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ MAUI)
            var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
            return currentPath.Contains("/login") ||
                   currentPath.Contains("/register") ||
                   currentPath.Contains("/profile/edit");
        }
    }

    /// <summary>
    /// ØµÙØ­Ø§Øª ØªØ­ØªØ§Ø¬ Ø´Ø§Ø´Ø© ÙƒØ§Ù…Ù„Ø© Ø¨Ø¯ÙˆÙ† navbar Ùˆ bottom nav
    /// </summary>
    private bool IsFullScreenPage
    {
        get
        {
            var pageName = RouteData?.PageType?.Name;
            if (pageName is "ChatRoom" or "SpaceDetails" or "BookingCreate")
                return true;

            var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
            return currentPath.Contains("/chat/") ||
                   currentPath.Contains("/space/") ||
                   currentPath.Contains("/book/");
        }
    }

    /// <summary>
    /// ØµÙØ­Ø§Øª Ù…Ø­Ù…ÙŠØ© ØªØªØ·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù„Ø¶ÙŠÙ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§)
    /// </summary>
    private bool IsProtectedPage
    {
        get
        {
            var pageName = RouteData?.PageType?.Name;
            if (pageName is "Bookings" or "Favorites" or "Profile" or "Chat" or "ChatRoom" or "Notifications")
                return true;

            var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
            return currentPath.Contains("/bookings") ||
                   currentPath.Contains("/favorites") ||
                   currentPath.Contains("/profile") ||
                   currentPath.Contains("/chat") ||
                   currentPath.Contains("/notifications");
        }
    }

    /// <summary>
    /// Ù‡Ù„ ÙŠØ¬Ø¨ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø£Ùˆ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©)
    /// </summary>
    private bool HideNavigation => IsAuthPage || IsFullScreenPage;

    protected override Task OnInitializedAsync()
    {
        // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø­Ø¯Ø« ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©
        L.OnLanguageChanged += HandleLanguageChanged;

        // ØªØ­Ù…ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ù…ØªØ²Ø§Ù…Ù†)
        NotificationCount = ApiService.GetNotificationsCount();

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ø°Ø§ ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹
        if (_bookingsCountLoaded)
        {
            BookingsCount = _cachedBookingsCount;
        }
        else
        {
            // ØªØ­Ù…ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
            _ = LoadBookingsCountAsync();
        }

        // ÙØ­Øµ Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
        if (!_versionChecked)
        {
            _ = CheckVersionAsync();
        }

        return Task.CompletedTask;
    }

    /// <summary>
    /// ÙØ­Øµ Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù†Ù‡ Ù…Ø¯Ø¹ÙˆÙ…
    /// </summary>
    private async Task CheckVersionAsync()
    {
        if (_versionChecked) return;

        try
        {
            var currentVersion = CurrentAppVersion;
            var buildNumber = CurrentBuildNumber;
            Console.WriteLine($"[VersionCheck] Checking version {currentVersion} (build {buildNumber})...");

            var result = await VersionCheck.CheckVersionAsync(currentVersion, buildNumber);
            _versionChecked = true;

            if (result != null)
            {
                Console.WriteLine($"[VersionCheck] Result - IsSupported: {result.IsSupported}, Status: {result.CurrentStatus}, ForceUpdate: {result.IsForceUpdate}");
                Console.WriteLine($"[VersionCheck] ShouldShowVersionAlert: {ShouldShowVersionAlert}, IsBlocked: {VersionCheck.IsBlocked}, Dismissed: {_versionAlertDismissed}");

                if (VersionCheck.IsBlocked)
                {
                    Console.WriteLine("[VersionCheck] â›” Version is BLOCKED - App will be locked");
                }
                else if (result.CurrentStatus != ACommerce.Client.Versions.VersionStatus.Latest)
                {
                    Console.WriteLine($"[VersionCheck] ğŸ“¢ Alert will be shown - Status: {result.CurrentStatus}, AlertType: {CurrentAlertType}");
                }
                else
                {
                    Console.WriteLine("[VersionCheck] âœ… Version is LATEST - No alert needed");
                }

                // Always update state to ensure alert is shown
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[VersionCheck] Error: {ex.Message}");
            // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
            _versionChecked = true;
        }
    }
    
    private void HandleLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        L.OnLanguageChanged -= HandleLanguageChanged;
    }

    private async Task LoadBookingsCountAsync()
    {
        try
        {
            var customerId = TokenManager.GetUserIdFromToken();

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù€ cache Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµØ­ÙŠØ­
            if (_bookingsCountLoaded && _cachedBookingsCustomerId == customerId)
            {
                BookingsCount = _cachedBookingsCount;
                return;
            }

            var count = await ApiService.GetBookingsCountAsync(customerId);
            _cachedBookingsCount = count;
            _cachedBookingsCustomerId = customerId;
            _bookingsCountLoaded = true;
            BookingsCount = count;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MainLayout] Error loading bookings count: {ex.Message}");
        }
    }
    
    /// <summary>
    /// Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (ÙŠÙØ³ØªØ¯Ø¹Ù‰ Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯)
    /// </summary>
    public static void InvalidateBookingsCache()
    {
        _bookingsCountLoaded = false;
        _cachedBookingsCount = 0;
        _cachedBookingsCustomerId = null;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© ÙˆØ¶Ø¹ Ø§Ù„Ø¶ÙŠÙ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
            await GuestMode.InitializeAsync();
            _initialized = true;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        if (_initialized)
        {
            await CheckAuthAsync();
        }
    }

    private async Task CheckAuthAsync()
    {
        // ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ØªÙƒØ±Ø± Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³Ø§Ø± (Ù„Ù„Ø£Ø¯Ø§Ø¡)
        var currentPath = Navigation.CurrentUri?.ToLowerInvariant() ?? "";
        
        // Ø¯Ø§Ø¦Ù…Ø§Ù‹ ØªØ­Ù‚Ù‚ Ù„Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙŠØ© Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø³Ø§Ø¨Ù‚Ø§Ù‹
        var needsCheck = IsProtectedPage || currentPath != _lastCheckedPath;
        if (!needsCheck) return;
        
        _lastCheckedPath = currentPath;

        var token = await TokenManager.GetTokenAsync();
        var isGuest = GuestMode.IsGuestMode;

        Console.WriteLine($"[MainLayout] Auth check - Path: {currentPath}, Token: {(token != null ? "exists" : "null")}, IsGuest: {isGuest}, IsAuthPage: {IsAuthPage}, IsProtectedPage: {IsProtectedPage}");

        if (IsAuthPage)
        {
            // ØµÙØ­Ø© Ù…ØµØ§Ø¯Ù‚Ø© - Ù„Ø§ Ù†ØªØ¯Ø®Ù„
            return;
        }

        if (token != null)
        {
            // Ù„Ø¯ÙŠÙ‡ ØªÙˆÙƒÙ† - Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙƒÙ„ Ù…Ø±Ø© (Ù„Ù„Ø£Ø¯Ø§Ø¡)
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙŠØªÙ… Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø·
            return;
        }

        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙƒÙ†
        if (isGuest)
        {
            // Ø§Ù„Ø¶ÙŠÙ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
            // Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙŠØ© Ø³ØªØ¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
            return;
        }
        else
        {
            // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙƒÙ† ÙˆÙ„ÙŠØ³ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¶ÙŠÙ - ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
            Console.WriteLine("[Auth] No token and not guest - redirecting to login");
            Navigation.NavigateTo("/login");
        }
    }

    /// <summary>
    /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯
    /// </summary>
    private async Task<bool> ValidateTokenAsync()
    {
        try
        {
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ /api/auth/me Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªÙˆÙƒÙ†
            var user = await AuthClient.GetMeAsync();
            return user != null;
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            // 401 = Ø§Ù„ØªÙˆÙƒÙ† ØºÙŠØ± ØµØ§Ù„Ø­
            Console.WriteLine("[Auth] Token validation failed: Unauthorized");
            return false;
        }
        catch (Exception ex)
        {
            // Ø£ÙŠ Ø®Ø·Ø£ Ø¢Ø®Ø± - Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„ØªÙˆÙƒÙ† ØµØ§Ù„Ø­ Ù„ØªØ¬Ù†Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø³Ø¨Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø´Ø¨ÙƒØ©
            Console.WriteLine($"[Auth] Token validation error (assuming valid): {ex.Message}");
            return true;
        }
    }

    private bool IsActive(string path)
    {
        var currentPath = Navigation.CurrentUri;
        if (path == "/")
            return currentPath.EndsWith("/") || currentPath.EndsWith("/index");
        return currentPath.Contains(path);
    }

    private void HandleSearchClick()
    {
        Navigation.NavigateTo("/search");
    }

    private void HandleNotificationsClick()
    {
        Navigation.NavigateTo("/notifications");
    }
}
