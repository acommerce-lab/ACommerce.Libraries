@page "/marketing"
@inject MarketingAnalyticsService AnalyticsService

<div class="marketing-page">
    <div class="page-header">
        <div class="search-filters">
            <SfDateRangePicker TValue="DateTime?" @bind-StartDate="StartDate" @bind-EndDate="EndDate" 
                               Placeholder="Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®" Width="300px" />
            <SfButton CssClass="e-primary" OnClick="LoadData">ØªØ­Ø¯ÙŠØ«</SfButton>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon primary">ğŸ‘ï¸</div>
            <div class="stat-content">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h3>
                <div class="value">@Data.Totals.TotalVisits.ToString("N0")</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon success">ğŸ‘¤</div>
            <div class="stat-content">
                <h3>Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</h3>
                <div class="value">@Data.Totals.TotalRegistrations.ToString("N0")</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon warning">ğŸ›’</div>
            <div class="stat-content">
                <h3>Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</h3>
                <div class="value">@Data.Totals.TotalPurchases.ToString("N0")</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon danger">ğŸ’°</div>
            <div class="stat-content">
                <h3>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h3>
                <div class="value">@Data.Totals.TotalRevenue.ToString("N0") Ø±.Ø³</div>
            </div>
        </div>
    </div>

    <div class="content-grid">
        <div class="card">
            <div class="card-header">
                <h2>Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†ØµØ©</h2>
            </div>
            <div class="card-body">
                <SfGrid DataSource="@Data.PlatformStats" AllowSorting="true">
                    <GridColumns>
                        <GridColumn HeaderText="Ø§Ù„Ù…Ù†ØµØ©" Width="150">
                            <Template>
                                @{
                                    var item = (context as PlatformStatsDto);
                                    <span>@item?.PlatformIcon @item?.Platform</span>
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn Field="@nameof(PlatformStatsDto.Visits)" HeaderText="Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª" Format="N0" Width="100" />
                        <GridColumn Field="@nameof(PlatformStatsDto.Registrations)" HeaderText="Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª" Format="N0" Width="100" />
                        <GridColumn Field="@nameof(PlatformStatsDto.Purchases)" HeaderText="Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª" Format="N0" Width="100" />
                        <GridColumn HeaderText="Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª" Width="120">
                            <Template>
                                @{
                                    var item = (context as PlatformStatsDto);
                                    <span class="revenue">@item?.Revenue.ToString("N0") Ø±.Ø³</span>
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn HeaderText="Ø§Ù„ØªØ­ÙˆÙŠÙ„" Width="100">
                            <Template>
                                @{
                                    var item = (context as PlatformStatsDto);
                                    <span class="conversion">@item?.ConversionRate.ToString("F2")%</span>
                                }
                            </Template>
                        </GridColumn>
                    </GridColumns>
                </SfGrid>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h2>
            </div>
            <div class="card-body">
                <SfAccumulationChart Height="300px">
                    <AccumulationChartSeriesCollection>
                        <AccumulationChartSeries DataSource="@Data.PlatformStats" 
                                                  XName="Platform" 
                                                  YName="Revenue"
                                                  InnerRadius="40%">
                            <AccumulationDataLabelSettings Visible="true" Name="Platform" Position="AccumulationLabelPosition.Outside" />
                        </AccumulationChartSeries>
                    </AccumulationChartSeriesCollection>
                    <AccumulationChartTooltipSettings Enable="true" Format="${point.x}: ${point.y} Ø±.Ø³" />
                    <AccumulationChartLegendSettings Visible="true" Position="LegendPosition.Bottom" />
                </SfAccumulationChart>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top: 24px;">
        <div class="card-header">
            <h2>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
        </div>
        <div class="card-body">
            <SfChart Height="350px">
                <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.DateTime" LabelFormat="dd/MM" />
                <ChartPrimaryYAxis Title="Ø§Ù„Ø¹Ø¯Ø¯" />
                <ChartSeriesCollection>
                    <ChartSeries DataSource="@Data.DailyStats" 
                                 XName="Date" 
                                 YName="Visits" 
                                 Name="Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª"
                                 Type="ChartSeriesType.SplineArea"
                                 Fill="#2563eb"
                                 Opacity="0.3">
                    </ChartSeries>
                    <ChartSeries DataSource="@Data.DailyStats" 
                                 XName="Date" 
                                 YName="Registrations" 
                                 Name="Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª"
                                 Type="ChartSeriesType.Spline"
                                 Fill="#22c55e">
                        <ChartMarker Visible="true" Height="8" Width="8" />
                    </ChartSeries>
                    <ChartSeries DataSource="@Data.DailyStats" 
                                 XName="Date" 
                                 YName="Purchases" 
                                 Name="Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª"
                                 Type="ChartSeriesType.Spline"
                                 Fill="#f59e0b">
                        <ChartMarker Visible="true" Height="8" Width="8" />
                    </ChartSeries>
                </ChartSeriesCollection>
                <ChartTooltipSettings Enable="true" />
                <ChartLegendSettings Visible="true" Position="LegendPosition.Top" />
            </SfChart>
        </div>
    </div>

    <div class="card" style="margin-top: 24px;">
        <div class="card-header">
            <h2>Ø£ÙØ¶Ù„ Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©</h2>
        </div>
        <div class="card-body">
            <SfGrid DataSource="@Data.TopCampaigns" AllowSorting="true">
                <GridColumns>
                    <GridColumn Field="@nameof(CampaignStatsDto.Campaign)" HeaderText="Ø§Ù„Ø­Ù…Ù„Ø©" Width="200" />
                    <GridColumn Field="@nameof(CampaignStatsDto.Platform)" HeaderText="Ø§Ù„Ù…Ù†ØµØ©" Width="120" />
                    <GridColumn Field="@nameof(CampaignStatsDto.Visits)" HeaderText="Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª" Format="N0" Width="100" />
                    <GridColumn Field="@nameof(CampaignStatsDto.Registrations)" HeaderText="Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª" Format="N0" Width="100" />
                    <GridColumn Field="@nameof(CampaignStatsDto.Purchases)" HeaderText="Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª" Format="N0" Width="100" />
                    <GridColumn HeaderText="Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª" Width="130">
                        <Template>
                            @{
                                var item = (context as CampaignStatsDto);
                                <span class="revenue">@item?.Revenue.ToString("N0") Ø±.Ø³</span>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </SfGrid>
        </div>
    </div>
</div>

<style>
    .revenue {
        font-weight: 600;
        color: #2563eb;
    }
    
    .conversion {
        font-weight: 600;
        color: #22c55e;
    }
</style>

@code {
    private DateTime? StartDate { get; set; } = DateTime.Now.AddDays(-30);
    private DateTime? EndDate { get; set; } = DateTime.Now;
    private MarketingAnalyticsData Data { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        Data = await AnalyticsService.GetAnalyticsAsync(
            StartDate ?? DateTime.Now.AddDays(-30), 
            EndDate ?? DateTime.Now);
    }
}
