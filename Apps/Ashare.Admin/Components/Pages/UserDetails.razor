@page "/users/{UserId}"
@inject AdminApiService ApiService
@inject NavigationManager NavigationManager

<div class="user-details-page">
    @if (User == null)
    {
        <div class="loading">
            <SfSpinner Visible="true" />
            <p>جاري تحميل البيانات...</p>
        </div>
    }
    else
    {
        <div class="page-header">
            <SfButton CssClass="e-flat" IconCss="e-icons e-arrow-right" OnClick="GoBack">رجوع</SfButton>
        </div>

        @* User Info Card *@
        <div class="user-info-card">
            <div class="user-avatar">
                <span>@GetInitials(User.Name)</span>
            </div>
            <div class="user-main-info">
                <h2>@User.Name</h2>
                <div class="user-meta">
                    <span class="role-badge @GetRoleClass(User.Role)">@User.Role</span>
                    <span class="status-badge @GetStatusClass(User.Status)">@User.Status</span>
                </div>
                <div class="user-contact">
                    <span><i class="bi bi-envelope"></i> @User.Email</span>
                    <span><i class="bi bi-phone"></i> @User.Phone</span>
                    <span><i class="bi bi-calendar"></i> انضم في @User.CreatedAt.ToString("yyyy/MM/dd")</span>
                </div>
            </div>
            <div class="user-actions">
                <SfButton CssClass="e-warning" IconCss="e-icons e-edit">تعديل</SfButton>
                <SfButton CssClass="e-danger" IconCss="e-icons e-trash">حذف</SfButton>
            </div>
        </div>

        <div class="content-grid">
            @* Current Subscription Card *@
            <div class="card subscription-card">
                <h3>الاشتراك الحالي</h3>
                @if (User.CurrentSubscription != null)
                {
                    <div class="subscription-info">
                        <div class="plan-name">
                            <span class="label">الباقة</span>
                            <span class="value plan-badge">@User.CurrentSubscription.PlanName</span>
                        </div>
                        <div class="subscription-status">
                            <span class="label">الحالة</span>
                            <span class="value status-badge @GetSubscriptionStatusClass(User.CurrentSubscription.Status)">
                                @GetSubscriptionStatusText(User.CurrentSubscription.Status)
                            </span>
                        </div>
                        <div class="subscription-dates">
                            <div class="date-item">
                                <span class="label">تاريخ البدء</span>
                                <span class="value">@User.CurrentSubscription.StartDate.ToString("yyyy/MM/dd")</span>
                            </div>
                            <div class="date-item">
                                <span class="label">تاريخ الانتهاء</span>
                                <span class="value @(IsExpiringSoon(User.CurrentSubscription.EndDate) ? "warning" : "")">
                                    @(User.CurrentSubscription.EndDate?.ToString("yyyy/MM/dd") ?? "غير محدد")
                                </span>
                            </div>
                        </div>
                        <div class="listings-quota">
                            <div class="quota-header">
                                <span class="label">العروض المستخدمة</span>
                                <span class="quota-numbers">
                                    @User.CurrentSubscription.CurrentListings / @(User.CurrentSubscription.MaxListings == -1 ? "∞" : User.CurrentSubscription.MaxListings.ToString())
                                </span>
                            </div>
                            <div class="quota-bar">
                                <div class="quota-fill" style="width: @GetQuotaPercentage(User.CurrentSubscription)%"></div>
                            </div>
                            <div class="quota-remaining">
                                <span>المتبقي: </span>
                                <span class="remaining-value">
                                    @(User.CurrentSubscription.MaxListings == -1 ? "غير محدود" : User.CurrentSubscription.RemainingListings.ToString())
                                </span>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="no-subscription">
                        <i class="bi bi-credit-card"></i>
                        <p>لا يوجد اشتراك نشط</p>
                        <SfButton CssClass="e-primary" IconCss="e-icons e-plus">إضافة اشتراك</SfButton>
                    </div>
                }
            </div>

            @* Subscription History Card *@
            <div class="card history-card">
                <h3>تاريخ الاشتراكات</h3>
                @if (User.SubscriptionHistory.Any())
                {
                    <div class="history-timeline">
                        @foreach (var sub in User.SubscriptionHistory.OrderByDescending(s => s.StartDate))
                        {
                            <div class="timeline-item @(sub.Status == "active" ? "active" : "")">
                                <div class="timeline-marker">
                                    <i class="bi @(sub.Status == "active" ? "bi-check-circle-fill" : "bi-clock-history")"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-header">
                                        <span class="plan-name">@sub.PlanName</span>
                                        <span class="status-badge small @GetSubscriptionStatusClass(sub.Status)">
                                            @GetSubscriptionStatusText(sub.Status)
                                        </span>
                                    </div>
                                    <div class="timeline-dates">
                                        <span>@sub.StartDate.ToString("yyyy/MM/dd")</span>
                                        <span class="separator">-</span>
                                        <span>@(sub.EndDate?.ToString("yyyy/MM/dd") ?? "مستمر")</span>
                                    </div>
                                    <div class="timeline-details">
                                        <span>العروض: @sub.CurrentListings / @(sub.MaxListings == -1 ? "∞" : sub.MaxListings.ToString())</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="no-history">
                        <i class="bi bi-clock-history"></i>
                        <p>لا يوجد تاريخ اشتراكات</p>
                    </div>
                }
            </div>
        </div>

        @* User Listings *@
        <div class="card listings-card">
            <div class="card-header">
                <h3>عروض المستخدم</h3>
                <span class="count">@User.Listings.Count عرض</span>
            </div>
            @if (User.Listings.Any())
            {
                <SfGrid DataSource="@User.Listings" AllowPaging="true">
                    <GridPageSettings PageSize="5" />
                    <GridColumns>
                        <GridColumn Field="@nameof(ListingDto.Title)" HeaderText="العنوان" Width="250" />
                        <GridColumn Field="@nameof(ListingDto.Category)" HeaderText="الفئة" Width="120" />
                        <GridColumn Field="@nameof(ListingDto.Price)" HeaderText="السعر" Width="120" Format="N0" />
                        <GridColumn Field="@nameof(ListingDto.Status)" HeaderText="الحالة" Width="100">
                            <Template>
                                @{
                                    var listing = (context as ListingDto);
                                    <span class="status-badge @GetListingStatusClass(listing?.Status)">@listing?.Status</span>
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn Field="@nameof(ListingDto.CreatedAt)" HeaderText="تاريخ الإنشاء" Width="130" Format="d" />
                    </GridColumns>
                </SfGrid>
            }
            else
            {
                <div class="no-listings">
                    <i class="bi bi-building"></i>
                    <p>لا يوجد عروض لهذا المستخدم</p>
                </div>
            }
        </div>
    }
</div>

<style>
    .user-details-page {
        padding: 0;
    }

    .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 300px;
        gap: 16px;
    }

    .page-header {
        margin-bottom: 20px;
    }

    .user-info-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        display: flex;
        align-items: center;
        gap: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .user-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 28px;
        font-weight: 700;
        flex-shrink: 0;
    }

    .user-main-info {
        flex: 1;
    }

    .user-main-info h2 {
        margin: 0 0 8px 0;
        font-size: 24px;
        color: #1f2937;
    }

    .user-meta {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

    .user-contact {
        display: flex;
        gap: 24px;
        color: #6b7280;
        font-size: 14px;
    }

    .user-contact span {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .user-actions {
        display: flex;
        gap: 8px;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }

    .card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .card h3 {
        margin: 0 0 16px 0;
        font-size: 18px;
        color: #1f2937;
    }

    .subscription-info {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .plan-name, .subscription-status {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .subscription-dates {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .date-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .label {
        font-size: 13px;
        color: #6b7280;
    }

    .value {
        font-weight: 600;
        color: #1f2937;
    }

    .value.warning {
        color: #f59e0b;
    }

    .listings-quota {
        background: #f9fafb;
        padding: 16px;
        border-radius: 8px;
    }

    .quota-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .quota-numbers {
        font-weight: 600;
        color: #3b82f6;
    }

    .quota-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
    }

    .quota-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #6366f1);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .quota-remaining {
        font-size: 13px;
        color: #6b7280;
    }

    .remaining-value {
        font-weight: 600;
        color: #10b981;
    }

    .no-subscription, .no-history, .no-listings {
        text-align: center;
        padding: 40px 20px;
        color: #9ca3af;
    }

    .no-subscription i, .no-history i, .no-listings i {
        font-size: 48px;
        margin-bottom: 16px;
        display: block;
    }

    .history-timeline {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .timeline-item {
        display: flex;
        gap: 16px;
        padding: 12px;
        border-radius: 8px;
        background: #f9fafb;
    }

    .timeline-item.active {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .timeline-marker {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        flex-shrink: 0;
    }

    .timeline-item.active .timeline-marker {
        background: #10b981;
        color: white;
    }

    .timeline-content {
        flex: 1;
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }

    .timeline-header .plan-name {
        font-weight: 600;
        color: #1f2937;
    }

    .timeline-dates {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 4px;
    }

    .timeline-dates .separator {
        margin: 0 8px;
    }

    .timeline-details {
        font-size: 13px;
        color: #9ca3af;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .card-header .count {
        background: #e5e7eb;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 13px;
        color: #6b7280;
    }

    .role-badge, .status-badge, .plan-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .role-badge.admin { background: rgba(147, 51, 234, 0.1); color: #9333ea; }
    .role-badge.vendor { background: rgba(37, 99, 235, 0.1); color: #2563eb; }
    .role-badge.customer { background: rgba(100, 116, 139, 0.1); color: #64748b; }

    .status-badge.active, .status-badge.success { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .status-badge.expired, .status-badge.danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .status-badge.cancelled { background: rgba(107, 114, 128, 0.1); color: #6b7280; }
    .status-badge.warning { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }

    .status-badge.small {
        font-size: 0.7rem;
        padding: 2px 8px;
    }

    .plan-badge {
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
    }
</style>

@code {
    [Parameter]
    public string UserId { get; set; } = string.Empty;

    private UserDetailsDto? User { get; set; }

    protected override async Task OnInitializedAsync()
    {
        User = await ApiService.GetUserDetailsAsync(UserId);
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/users");
    }

    private string GetInitials(string name)
    {
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}";
        return parts.Length > 0 ? parts[0][0].ToString() : "?";
    }

    private string GetRoleClass(string? role) => role switch
    {
        "مدير" => "admin",
        "بائع" => "vendor",
        _ => "customer"
    };

    private string GetStatusClass(string? status) => status switch
    {
        "نشط" => "success",
        "معلق" => "warning",
        "محظور" => "danger",
        _ => ""
    };

    private string GetSubscriptionStatusClass(string? status) => status?.ToLower() switch
    {
        "active" => "active",
        "expired" => "expired",
        "cancelled" => "cancelled",
        _ => ""
    };

    private string GetSubscriptionStatusText(string? status) => status?.ToLower() switch
    {
        "active" => "نشط",
        "expired" => "منتهي",
        "cancelled" => "ملغي",
        _ => status ?? ""
    };

    private string GetListingStatusClass(string? status) => status switch
    {
        "نشط" => "success",
        "معلق" => "warning",
        "مرفوض" => "danger",
        _ => ""
    };

    private bool IsExpiringSoon(DateTime? endDate)
    {
        if (endDate == null) return false;
        return endDate.Value <= DateTime.Now.AddDays(7);
    }

    private int GetQuotaPercentage(UserSubscriptionDto? sub)
    {
        if (sub == null || sub.MaxListings <= 0) return 0;
        if (sub.MaxListings == -1) return 30; // Unlimited shows partial
        return Math.Min(100, (int)((double)sub.CurrentListings / sub.MaxListings * 100));
    }
}
