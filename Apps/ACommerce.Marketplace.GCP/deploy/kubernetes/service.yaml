# =============================================================================
# ACommerce Marketplace API - Service
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: acommerce-marketplace
  labels:
    app: acommerce-marketplace
    app.kubernetes.io/name: acommerce-marketplace
    app.kubernetes.io/component: api
  annotations:
    # GCP Cloud Load Balancer annotations
    cloud.google.com/neg: '{"ingress": true}'
    cloud.google.com/backend-config: '{"default": "acommerce-marketplace-backend-config"}'
spec:
  type: ClusterIP
  selector:
    app: acommerce-marketplace
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP

---
# =============================================================================
# Backend Config for GCP Load Balancer
# =============================================================================
apiVersion: cloud.google.com/v1
kind: BackendConfig
metadata:
  name: acommerce-marketplace-backend-config
  labels:
    app: acommerce-marketplace
spec:
  # Health Check Configuration
  healthCheck:
    type: HTTP
    requestPath: /healthz
    port: 8080
    checkIntervalSec: 15
    timeoutSec: 5
    healthyThreshold: 1
    unhealthyThreshold: 3

  # Connection Draining
  connectionDraining:
    drainingTimeoutSec: 30

  # Session Affinity (optional - for sticky sessions)
  # sessionAffinity:
  #   affinityType: "GENERATED_COOKIE"
  #   affinityCookieTtlSec: 3600

  # Cloud CDN (optional - for static content caching)
  # cdn:
  #   enabled: true
  #   cachePolicy:
  #     includeHost: true
  #     includeProtocol: true
  #     includeQueryString: false

  # Cloud Armor Security Policy (optional)
  # securityPolicy:
  #   name: acommerce-security-policy

  # Timeout
  timeoutSec: 30

---
# =============================================================================
# Ingress - GKE Ingress with HTTPS
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: acommerce-marketplace-ingress
  labels:
    app: acommerce-marketplace
  annotations:
    # Use GKE Ingress Controller
    kubernetes.io/ingress.class: "gce"

    # HTTPS redirect
    kubernetes.io/ingress.allow-http: "false"

    # Managed SSL Certificate
    networking.gke.io/managed-certificates: "acommerce-marketplace-cert"

    # Static IP (create with: gcloud compute addresses create acommerce-marketplace-ip --global)
    kubernetes.io/ingress.global-static-ip-name: "acommerce-marketplace-ip"

    # Frontend Config for HTTPS redirect
    networking.gke.io/v1beta1.FrontendConfig: "acommerce-marketplace-frontend-config"
spec:
  defaultBackend:
    service:
      name: acommerce-marketplace
      port:
        number: 80
  rules:
    - host: api.acommerce.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: acommerce-marketplace
                port:
                  number: 80

---
# =============================================================================
# Frontend Config for HTTPS Redirect
# =============================================================================
apiVersion: networking.gke.io/v1beta1
kind: FrontendConfig
metadata:
  name: acommerce-marketplace-frontend-config
  labels:
    app: acommerce-marketplace
spec:
  redirectToHttps:
    enabled: true
    responseCodeName: MOVED_PERMANENTLY_DEFAULT

---
# =============================================================================
# Managed Certificate
# =============================================================================
apiVersion: networking.gke.io/v1
kind: ManagedCertificate
metadata:
  name: acommerce-marketplace-cert
  labels:
    app: acommerce-marketplace
spec:
  domains:
    - api.acommerce.io
    # Add additional domains as needed
    # - api.customer-domain.com

---
# =============================================================================
# Network Policy - Restrict ingress/egress
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: acommerce-marketplace-network-policy
  labels:
    app: acommerce-marketplace
spec:
  podSelector:
    matchLabels:
      app: acommerce-marketplace
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from Ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
        - namespaceSelector:
            matchLabels:
              name: gke-system
      ports:
        - protocol: TCP
          port: 8080
    # Allow traffic from same namespace
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow HTTPS (for external APIs, GCP services)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: TCP
          port: 443
    # Allow PostgreSQL
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: TCP
          port: 5432
    # Allow Redis
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
