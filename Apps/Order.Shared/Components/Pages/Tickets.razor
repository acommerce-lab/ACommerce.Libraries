@page "/tickets"
@page "/ticket/{TicketId}"
@page "/tickets/new"
@inject NavigationManager Navigation
@inject OrderApiService ApiService

@if (Mode == PageMode.List)
{
    <TicketsListPage Tickets="@TicketsList"
                     IsLoading="@IsLoading"
                     ActiveFilter="@ActiveFilter"
                     OnFilterChange="HandleFilterChange"
                     OnTicketClick="HandleTicketClick"
                     OnCreateTicket="HandleCreateTicket" />
}
else if (Mode == PageMode.Detail && CurrentTicket != null)
{
    <TicketDetailPage Ticket="@CurrentTicket"
                      IsLoading="@IsLoading"
                      IsSending="@IsSending"
                      OnBack="HandleBack"
                      OnReply="HandleReply"
                      OnAttachment="HandleAttachment"
                      OnReopen="HandleReopen"
                      OnOrderClick="HandleOrderClick" />
}
else if (Mode == PageMode.Create)
{
    <CreateTicketPage Orders="@RecentOrders"
                      IsSubmitting="@IsSubmitting"
                      PreselectedOrderId="@PreselectedOrderId"
                      OnSubmit="HandleSubmit"
                      OnCancel="HandleBack"
                      OnAddAttachment="HandleAttachment" />
}

@code {
    [Parameter] public string? TicketId { get; set; }

    private enum PageMode { List, Detail, Create }
    private PageMode Mode = PageMode.List;

    private List<TicketListItem>? TicketsList;
    private TicketDetail? CurrentTicket;
    private List<OrderSummary>? RecentOrders;

    private bool IsLoading = true;
    private bool IsSending;
    private bool IsSubmitting;
    private string ActiveFilter = "all";
    private string? PreselectedOrderId;

    protected override async Task OnParametersSetAsync()
    {
        var uri = new Uri(Navigation.Uri);

        if (uri.AbsolutePath.EndsWith("/new"))
        {
            Mode = PageMode.Create;
            await LoadRecentOrders();
        }
        else if (!string.IsNullOrEmpty(TicketId))
        {
            Mode = PageMode.Detail;
            await LoadTicketDetail();
        }
        else
        {
            Mode = PageMode.List;
            await LoadTickets();
        }
    }

    private async Task LoadTickets()
    {
        IsLoading = true;
        try
        {
            var result = await ApiService.GetTicketsAsync();
            TicketsList = result.Select(t => new TicketListItem
            {
                Id = t.Id,
                Number = t.Number,
                Subject = t.Subject,
                Category = t.Category,
                CategoryLabel = TicketCategories.GetLabel(t.Category),
                Status = t.Status,
                StatusLabel = TicketStatuses.GetLabel(t.Status),
                LastMessage = t.LastMessage,
                CreatedAt = t.CreatedAt,
                UpdatedAt = t.UpdatedAt,
                UnreadReplies = t.UnreadReplies,
                LinkedOrderNumber = t.LinkedOrderNumber
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tickets: {ex.Message}");
            TicketsList = new List<TicketListItem>();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadTicketDetail()
    {
        IsLoading = true;
        try
        {
            var t = await ApiService.GetTicketAsync(TicketId!);
            CurrentTicket = new TicketDetail
            {
                Id = t.Id,
                Number = t.Number,
                Subject = t.Subject,
                Category = t.Category,
                CategoryLabel = TicketCategories.GetLabel(t.Category),
                Status = t.Status,
                StatusLabel = TicketStatuses.GetLabel(t.Status),
                CreatedAt = t.CreatedAt,
                LinkedOrderId = t.LinkedOrderId,
                LinkedOrderNumber = t.LinkedOrderNumber,
                Messages = t.Messages.Select(m => new TicketMessage
                {
                    Id = m.Id,
                    Content = m.Content,
                    SentAt = m.SentAt,
                    IsFromSupport = m.IsFromSupport,
                    SupportAgentName = m.AgentName
                }).ToList()
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading ticket: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadRecentOrders()
    {
        try
        {
            var orders = await ApiService.GetRecentOrdersAsync();
            RecentOrders = orders.Select(o => new OrderSummary
            {
                Id = o.Id,
                Number = o.Number,
                Date = o.CreatedAt
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading orders: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private Task HandleFilterChange(string filter)
    {
        ActiveFilter = filter;
        return Task.CompletedTask;
    }

    private void HandleTicketClick(string ticketId)
    {
        Navigation.NavigateTo($"/ticket/{ticketId}");
    }

    private void HandleCreateTicket()
    {
        Navigation.NavigateTo("/tickets/new");
    }

    private void HandleBack()
    {
        Navigation.NavigateTo("/tickets");
    }

    private async Task HandleReply(TicketReplyArgs args)
    {
        IsSending = true;
        try
        {
            await ApiService.ReplyToTicketAsync(args.TicketId, args.Message);
            await LoadTicketDetail();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending reply: {ex.Message}");
        }
        finally
        {
            IsSending = false;
        }
    }

    private Task HandleAttachment()
    {
        // Open file picker
        return Task.CompletedTask;
    }

    private async Task HandleReopen()
    {
        try
        {
            await ApiService.ReopenTicketAsync(TicketId!);
            await LoadTicketDetail();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error reopening ticket: {ex.Message}");
        }
    }

    private void HandleOrderClick(string orderId)
    {
        Navigation.NavigateTo($"/order/{orderId}");
    }

    private async Task HandleSubmit(CreateTicketArgs args)
    {
        IsSubmitting = true;
        try
        {
            var ticketId = await ApiService.CreateTicketAsync(args.Category, args.Subject, args.Message, args.LinkedOrderId);
            Navigation.NavigateTo($"/ticket/{ticketId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating ticket: {ex.Message}");
        }
        finally
        {
            IsSubmitting = false;
        }
    }
}
