@page "/"
@inject OrderApiService ApiService
@inject NavigationManager Navigation

<div class="home-page">
    <!-- Header -->
    <header class="home-header">
        <div class="header-content">
            <h1 class="app-title">Ø§ÙˆØ±Ø¯Ø±</h1>
            <p class="app-subtitle">Ø§ÙƒØªØ´Ù Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù†Ùƒ</p>
        </div>
        @if (UserLocation != null)
        {
            <div class="location-badge">
                <span>ğŸ“</span>
                <span>Ù…ÙˆÙ‚Ø¹Ùƒ Ù…Ø­Ø¯Ø¯</span>
            </div>
        }
    </header>

    <!-- Categories -->
    <section class="categories-section">
        <h2 class="section-title">Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h2>
        <div class="categories-scroll">
            <button class="category-chip @(SelectedCategory == null ? "active" : "")"
                    @onclick="() => SelectCategory(null)">
                Ø§Ù„ÙƒÙ„
            </button>
            @if (Categories != null)
            {
                @foreach (var category in Categories)
                {
                    <button class="category-chip @(SelectedCategory == category.Id ? "active" : "")"
                            @onclick="() => SelectCategory(category.Id)">
                        @category.Name
                    </button>
                }
            }
        </div>
    </section>

    <!-- Offers Grid -->
    <section class="offers-section">
        <div class="section-header">
            <h2 class="section-title">Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
            @if (Offers?.Total > 0)
            {
                <span class="offers-count">@Offers.Total Ø¹Ø±Ø¶</span>
            }
        </div>

        @if (IsLoading)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
        }
        else if (Offers?.Items?.Any() == true)
        {
            <div class="offers-grid">
                @foreach (var offer in Offers.Items)
                {
                    <div class="offer-card" @onclick="() => ViewOffer(offer.Id)">
                        <div class="offer-image">
                            @if (!string.IsNullOrEmpty(offer.ImageUrl))
                            {
                                <img src="@offer.ImageUrl" alt="@offer.Title" />
                            }
                            else
                            {
                                <div class="image-placeholder">ğŸ½ï¸</div>
                            }
                            @if (offer.DiscountPercent > 0)
                            {
                                <span class="discount-badge">@offer.DiscountPercent% Ø®ØµÙ…</span>
                            }
                        </div>
                        <div class="offer-content">
                            <h3 class="offer-title">@offer.Title</h3>
                            <div class="offer-vendor">
                                @if (offer.Vendor?.IsOpen == true)
                                {
                                    <span class="open-badge">Ù…ÙØªÙˆØ­</span>
                                }
                                else
                                {
                                    <span class="closed-badge">Ù…ØºÙ„Ù‚</span>
                                }
                                <span class="vendor-name">@offer.Vendor?.Name</span>
                                @if (offer.Vendor?.Distance.HasValue == true)
                                {
                                    <span class="distance">@offer.Vendor.Distance ÙƒÙ…</span>
                                }
                            </div>
                            <div class="offer-price">
                                <span class="current-price">@offer.Price Ø±.Ø³</span>
                                @if (offer.OriginalPrice.HasValue && offer.OriginalPrice > offer.Price)
                                {
                                    <span class="original-price">@offer.OriginalPrice Ø±.Ø³</span>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            @if (Offers.Page < Offers.TotalPages)
            {
                <button class="load-more-btn" @onclick="LoadMore">
                    ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯
                </button>
            }
        }
        else
        {
            <div class="empty-state">
                <span class="empty-icon">ğŸ”</span>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
            </div>
        }
    </section>
</div>

@code {
    private OffersResponse? Offers;
    private List<CategoryDto>? Categories;
    private Guid? SelectedCategory;
    private (double Lat, double Lng)? UserLocation;
    private bool IsLoading = true;
    private int CurrentPage = 1;

    protected override async Task OnInitializedAsync()
    {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await TryGetUserLocation();

        await LoadCategories();
        await LoadOffers();
    }

    private async Task TryGetUserLocation()
    {
        // ÙÙŠ MAUI Ø³Ù†Ø³ØªØ®Ø¯Ù… Geolocation API
        // Ø­Ø§Ù„ÙŠØ§Ù‹ Ù†Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø§Ù„Ø±ÙŠØ§Ø¶)
        UserLocation = (24.7136, 46.6753);
    }

    private async Task LoadCategories()
    {
        try
        {
            Categories = await ApiService.GetCategoriesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading categories: {ex.Message}");
        }
    }

    private async Task LoadOffers()
    {
        IsLoading = true;
        try
        {
            Offers = await ApiService.GetOffersAsync(
                latitude: UserLocation?.Lat,
                longitude: UserLocation?.Lng,
                categoryId: SelectedCategory,
                page: CurrentPage,
                pageSize: 20
            );
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading offers: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task SelectCategory(Guid? categoryId)
    {
        SelectedCategory = categoryId;
        CurrentPage = 1;
        await LoadOffers();
    }

    private async Task LoadMore()
    {
        CurrentPage++;
        try
        {
            var moreOffers = await ApiService.GetOffersAsync(
                latitude: UserLocation?.Lat,
                longitude: UserLocation?.Lng,
                categoryId: SelectedCategory,
                page: CurrentPage,
                pageSize: 20
            );

            if (moreOffers?.Items != null && Offers?.Items != null)
            {
                Offers.Items.AddRange(moreOffers.Items);
                Offers.Page = moreOffers.Page;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading more: {ex.Message}");
        }
    }

    private void ViewOffer(Guid offerId)
    {
        Navigation.NavigateTo($"/offer/{offerId}");
    }
}

<style>
    .home-page {
        padding: 16px;
    }

    .home-header {
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        color: white;
        padding: 24px 16px;
        border-radius: 16px;
        margin-bottom: 20px;
    }

    .app-title {
        font-size: 28px;
        font-weight: bold;
        margin: 0;
    }

    .app-subtitle {
        font-size: 14px;
        opacity: 0.9;
        margin: 4px 0 0;
    }

    .location-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: rgba(255,255,255,0.2);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        margin-top: 12px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 12px;
        color: #333;
    }

    .categories-section {
        margin-bottom: 20px;
    }

    .categories-scroll {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 8px;
        -webkit-overflow-scrolling: touch;
    }

    .categories-scroll::-webkit-scrollbar {
        display: none;
    }

    .category-chip {
        flex-shrink: 0;
        padding: 8px 16px;
        border: 1px solid #ddd;
        border-radius: 20px;
        background: white;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .category-chip.active {
        background: #FF6B35;
        color: white;
        border-color: #FF6B35;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .offers-count {
        font-size: 14px;
        color: #666;
    }

    .offers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
    }

    .offer-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .offer-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }

    .offer-image {
        position: relative;
        height: 120px;
        background: #f0f0f0;
    }

    .offer-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .image-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        background: linear-gradient(135deg, #FFE5D9 0%, #FFD7C4 100%);
    }

    .discount-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #FF3B30;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .offer-content {
        padding: 12px;
    }

    .offer-title {
        font-size: 14px;
        font-weight: 600;
        margin: 0 0 8px;
        color: #333;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .offer-vendor {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
        flex-wrap: wrap;
    }

    .open-badge {
        background: #34C759;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
    }

    .closed-badge {
        background: #FF3B30;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
    }

    .vendor-name {
        font-weight: 500;
    }

    .distance {
        color: #999;
    }

    .offer-price {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .current-price {
        font-size: 16px;
        font-weight: bold;
        color: #FF6B35;
    }

    .original-price {
        font-size: 13px;
        color: #999;
        text-decoration: line-through;
    }

    .loading-state, .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f0f0f0;
        border-top-color: #FF6B35;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .empty-icon {
        font-size: 48px;
        display: block;
        margin-bottom: 12px;
    }

    .load-more-btn {
        display: block;
        width: 100%;
        padding: 12px;
        margin-top: 16px;
        background: white;
        border: 1px solid #FF6B35;
        color: #FF6B35;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .load-more-btn:hover {
        background: #FF6B35;
        color: white;
    }
</style>
