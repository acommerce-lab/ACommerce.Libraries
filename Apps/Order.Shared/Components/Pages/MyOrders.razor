@page "/orders"
@inject NavigationManager Navigation
@inject OrderApiService ApiService

<OrdersListPage Orders="@Orders"
                IsLoading="@IsLoading"
                IsLoadingMore="@IsLoadingMore"
                HasMore="@HasMore"
                ActiveFilter="@ActiveFilter"
                OnFilterChange="HandleFilterChange"
                OnOrderClick="HandleOrderClick"
                OnReorder="HandleReorder"
                OnTrack="HandleTrack"
                OnChat="HandleChat"
                OnBrowse="HandleBrowse"
                OnLoadMore="HandleLoadMore" />

@code {
    private List<OrderListItem>? Orders;
    private bool IsLoading = true;
    private bool IsLoadingMore;
    private bool HasMore;
    private string ActiveFilter = "all";
    private int CurrentPage = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        IsLoading = true;
        try
        {
            var result = await ApiService.GetOrdersAsync(CurrentPage);
            Orders = result.Items.Select(o => new OrderListItem
            {
                Id = o.Id,
                Number = o.Number,
                Status = o.Status,
                StatusLabel = OrderStatuses.GetLabel(o.Status),
                Total = o.Total,
                Currency = "SAR",
                CreatedAt = o.CreatedAt,
                VendorName = o.VendorName,
                VendorLogo = o.VendorLogo,
                ItemsCount = o.ItemsCount,
                FirstItemName = o.FirstItemName,
                FirstItemImage = o.FirstItemImage,
                CanReorder = o.CanReorder,
                CanCancel = o.CanCancel,
                CanTrack = o.CanTrack,
                CanReview = o.CanReview,
                CanChat = o.CanChat
            }).ToList();
            HasMore = result.HasMore;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading orders: {ex.Message}");
            Orders = new List<OrderListItem>();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task HandleFilterChange(string filter)
    {
        ActiveFilter = filter;
        StateHasChanged();
    }

    private void HandleOrderClick(string orderId)
    {
        Navigation.NavigateTo($"/order/{orderId}");
    }

    private async Task HandleReorder(string orderId)
    {
        try
        {
            await ApiService.ReorderAsync(orderId);
            Navigation.NavigateTo("/cart");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error reordering: {ex.Message}");
        }
    }

    private void HandleTrack(string orderId)
    {
        Navigation.NavigateTo($"/order/{orderId}/track");
    }

    private void HandleChat(string orderId)
    {
        Navigation.NavigateTo($"/chat/{orderId}");
    }

    private void HandleBrowse()
    {
        Navigation.NavigateTo("/");
    }

    private async Task HandleLoadMore()
    {
        IsLoadingMore = true;
        try
        {
            CurrentPage++;
            var result = await ApiService.GetOrdersAsync(CurrentPage);
            var newOrders = result.Items.Select(o => new OrderListItem
            {
                Id = o.Id,
                Number = o.Number,
                Status = o.Status,
                StatusLabel = OrderStatuses.GetLabel(o.Status),
                Total = o.Total,
                Currency = "SAR",
                CreatedAt = o.CreatedAt,
                VendorName = o.VendorName,
                ItemsCount = o.ItemsCount,
                CanReorder = o.CanReorder,
                CanChat = o.CanChat
            });
            Orders?.AddRange(newOrders);
            HasMore = result.HasMore;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading more orders: {ex.Message}");
        }
        finally
        {
            IsLoadingMore = false;
        }
    }
}
