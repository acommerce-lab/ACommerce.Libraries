@page "/login"
@inject NavigationManager Navigation
@inject AuthStateService AuthState
@inject OrderApiService ApiService

<LoginPage IsLoading="@IsLoading"
           ErrorMessage="@ErrorMessage"
           ShowGoogleLogin="false"
           ShowAppleLogin="false"
           OnLogin="HandleLogin" />

@code {
    private bool IsLoading;
    private string? ErrorMessage;

    private async Task HandleLogin(LoginEventArgs args)
    {
        IsLoading = true;
        ErrorMessage = null;

        try
        {
            // For Order app, we use phone number with OTP
            // This is a simplified flow - in production, this would call the API
            if (args.LoginMethod == "phone")
            {
                // Store phone number and navigate to OTP verification
                Navigation.NavigateTo($"/verify-otp?phone={Uri.EscapeDataString(args.Username)}");
            }
            else
            {
                // Email/password login
                var result = await ApiService.LoginAsync(args.Username, args.Password);
                if (result.Success)
                {
                    await AuthState.LoginAsync(result.Token!, new UserData
                    {
                        Id = result.UserId!,
                        PhoneNumber = args.Username,
                        IsVerified = true
                    });

                    Navigation.NavigateTo("/");
                }
                else
                {
                    ErrorMessage = result.ErrorMessage ?? "فشل تسجيل الدخول";
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "حدث خطأ أثناء تسجيل الدخول";
            Console.WriteLine($"Login error: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }
}
