@page "/login"
@inject OrderApiService ApiService
@inject AuthStateService AuthState
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="login-page">
    <!-- Background Decoration -->
    <div class="bg-decoration">
        <div class="bg-circle bg-circle-1"></div>
        <div class="bg-circle bg-circle-2"></div>
        <div class="bg-circle bg-circle-3"></div>
    </div>

    <div class="login-container">
        <!-- Logo Section -->
        <div class="logo-section">
            <div class="logo-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <path d="M16 10a4 4 0 0 1-8 0"/>
                </svg>
            </div>
            <h1 class="logo-text">ÿßŸàÿ±ÿØÿ±</h1>
            <p class="logo-tagline">ÿßŸÉÿ™ÿ¥ŸÅ ÿ£ŸÅÿ∂ŸÑ ÿßŸÑÿπÿ±Ÿàÿ∂ ÿßŸÑŸäŸàŸÖŸäÿ©</p>
        </div>

        <!-- Login Card -->
        <div class="login-card">
            @if (Step == LoginStep.Phone)
            {
                <!-- Phone Number Step -->
                <div class="step-content">
                    <div class="step-header">
                        <h2>ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ</h2>
                        <p>ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅŸÉ ŸÑŸÑŸÖÿ™ÿßÿ®ÿπÿ©</p>
                    </div>

                    <div class="input-container">
                        <label class="input-label">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
                        <div class="phone-input-wrapper @(IsFocused ? "focused" : "") @(!string.IsNullOrEmpty(ErrorMessage) ? "error" : "")">
                            <div class="country-code-box">
                                <span class="flag">üá∏üá¶</span>
                                <span class="code">+966</span>
                            </div>
                            <input type="tel"
                                   @bind="PhoneNumber"
                                   @bind:event="oninput"
                                   @onfocus="() => IsFocused = true"
                                   @onblur="() => IsFocused = false"
                                   placeholder="5XXXXXXXX"
                                   maxlength="9"
                                   disabled="@IsLoading"
                                   class="phone-input" />
                        </div>
                        <p class="input-hint">ÿ≥ŸÜÿ±ÿ≥ŸÑ ŸÑŸÉ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿπÿ®ÿ± SMS</p>
                    </div>

                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="error-alert">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                            <span>@ErrorMessage</span>
                        </div>
                    }

                    <button class="submit-btn @(IsLoading || PhoneNumber?.Length < 9 ? "disabled" : "")"
                            @onclick="SendCode"
                            disabled="@(IsLoading || PhoneNumber?.Length < 9)">
                        @if (IsLoading)
                        {
                            <div class="btn-loader"></div>
                            <span>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...</span>
                        }
                        else
                        {
                            <span>ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ≠ŸÇŸÇ</span>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"/>
                                <polyline points="12 5 19 12 12 19"/>
                            </svg>
                        }
                    </button>
                </div>
            }
            else
            {
                <!-- Verification Code Step -->
                <div class="step-content">
                    <button class="back-btn" @onclick="GoBack">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"/>
                            <polyline points="12 19 5 12 12 5"/>
                        </svg>
                    </button>

                    <div class="step-header">
                        <h2>ÿ£ÿØÿÆŸÑ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ≠ŸÇŸÇ</h2>
                        <p>ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ŸÖÿ≤ ŸÖŸÉŸàŸÜ ŸÖŸÜ 4 ÿ£ÿ±ŸÇÿßŸÖ ÿ•ŸÑŸâ</p>
                        <p class="phone-display">@FormattedPhone</p>
                    </div>

                    @if (!string.IsNullOrEmpty(DebugCode))
                    {
                        <div class="debug-banner">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                            <span>ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±: <strong>@DebugCode</strong></span>
                        </div>
                    }

                    <div class="otp-container">
                        <div class="otp-inputs">
                            @for (int i = 0; i < 4; i++)
                            {
                                var index = i;
                                <input type="text"
                                       id="otp-@index"
                                       maxlength="1"
                                       inputmode="numeric"
                                       pattern="[0-9]"
                                       class="otp-digit @(FocusedIndex == index ? "focused" : "")"
                                       value="@(VerificationCode.Length > index ? VerificationCode[index].ToString() : "")"
                                       @oninput="e => OnCodeInput(index, e)"
                                       @onkeydown="e => OnCodeKeyDown(index, e)"
                                       @onfocus="() => FocusedIndex = index"
                                       disabled="@IsLoading" />
                            }
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="error-alert">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                            <span>@ErrorMessage</span>
                        </div>
                    }

                    <button class="submit-btn @(IsLoading || VerificationCode?.Length < 4 ? "disabled" : "")"
                            @onclick="VerifyCode"
                            disabled="@(IsLoading || VerificationCode?.Length < 4)">
                        @if (IsLoading)
                        {
                            <div class="btn-loader"></div>
                            <span>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ...</span>
                        }
                        else
                        {
                            <span>ÿ™ÿ£ŸÉŸäÿØ</span>
                        }
                    </button>

                    <div class="resend-section">
                        @if (ResendCountdown > 0)
                        {
                            <p class="countdown-text">
                                ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ÿπÿØ
                                <span class="countdown-number">@ResendCountdown</span>
                                ÿ´ÿßŸÜŸäÿ©
                            </p>
                        }
                        else
                        {
                            <button class="resend-btn" @onclick="ResendCode">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                ÿ•ÿπÿßÿØÿ© ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ŸÖÿ≤
                            </button>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Terms -->
        <p class="terms-text">
            ÿ®ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿå ÿ£ŸÜÿ™ ÿ™ŸàÿßŸÅŸÇ ÿπŸÑŸâ
            <a href="#">ÿ¥ÿ±Ÿàÿ∑ ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ</a>
            Ÿà
            <a href="#">ÿ≥Ÿäÿßÿ≥ÿ© ÿßŸÑÿÆÿµŸàÿµŸäÿ©</a>
        </p>
    </div>
</div>

@code {
    private enum LoginStep { Phone, Code }
    private LoginStep Step = LoginStep.Phone;

    private string? PhoneNumber;
    private string VerificationCode = "";
    private string? DebugCode;
    private string? ErrorMessage;
    private bool IsLoading;
    private bool IsFocused;
    private int FocusedIndex;
    private int ResendCountdown;

    private string FormattedPhone => $"+966 {PhoneNumber}";

    private async Task SendCode()
    {
        if (string.IsNullOrWhiteSpace(PhoneNumber) || PhoneNumber.Length < 9)
        {
            ErrorMessage = "ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿµÿ≠Ÿäÿ≠";
            return;
        }

        IsLoading = true;
        ErrorMessage = null;

        try
        {
            var result = await ApiService.SendVerificationCodeAsync($"+966{PhoneNumber}");
            if (result != null)
            {
                DebugCode = result.DebugCode;
                Step = LoginStep.Code;
                StartResendCountdown();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task VerifyCode()
    {
        if (string.IsNullOrWhiteSpace(VerificationCode) || VerificationCode.Length < 4)
        {
            ErrorMessage = "ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ≠ŸÇŸÇ";
            return;
        }

        IsLoading = true;
        ErrorMessage = null;

        try
        {
            var result = await ApiService.VerifyCodeAsync($"+966{PhoneNumber}", VerificationCode);
            if (result != null && !string.IsNullOrEmpty(result.Token))
            {
                // Save authentication state
                var userData = new UserData
                {
                    Id = result.Profile?.Id.ToString() ?? "",
                    FullName = result.Profile?.FullName ?? "",
                    PhoneNumber = result.Profile?.PhoneNumber ?? $"+966{PhoneNumber}",
                    Email = result.Profile?.Email,
                    Avatar = result.Profile?.AvatarUrl,
                    IsNewUser = string.IsNullOrEmpty(result.Profile?.FullName)
                };

                await AuthState.LoginAsync(result.Token, userData);

                // Navigate to home or profile if new user
                if (userData.IsNewUser)
                {
                    Navigation.NavigateTo("/profile");
                }
                else
                {
                    Navigation.NavigateTo("/");
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "ÿßŸÑÿ±ŸÖÿ≤ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿå ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task OnCodeInput(int index, ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? "";

        if (value.Length > 0 && char.IsDigit(value[0]))
        {
            var chars = VerificationCode.PadRight(4).ToCharArray();
            chars[index] = value[0];
            VerificationCode = new string(chars).TrimEnd();

            if (index < 3)
            {
                FocusedIndex = index + 1;
                await JS.InvokeVoidAsync("eval", $"document.getElementById('otp-{index + 1}')?.focus()");
            }
            else if (VerificationCode.Length == 4)
            {
                // Auto-submit when all 4 digits entered
                await VerifyCode();
            }
        }
    }

    private async Task OnCodeKeyDown(int index, KeyboardEventArgs e)
    {
        if (e.Key == "Backspace" && index > 0)
        {
            var currentValue = VerificationCode.Length > index ? VerificationCode[index].ToString() : "";
            if (string.IsNullOrEmpty(currentValue))
            {
                // Move to previous input
                FocusedIndex = index - 1;
                // Clear previous digit
                if (VerificationCode.Length >= index)
                {
                    var chars = VerificationCode.PadRight(4).ToCharArray();
                    chars[index - 1] = ' ';
                    VerificationCode = new string(chars).TrimEnd();
                }
                await JS.InvokeVoidAsync("eval", $"document.getElementById('otp-{index - 1}')?.focus()");
            }
        }
    }

    private async Task ResendCode()
    {
        VerificationCode = "";
        await SendCode();
    }

    private async void StartResendCountdown()
    {
        ResendCountdown = 60;
        while (ResendCountdown > 0)
        {
            await Task.Delay(1000);
            ResendCountdown--;
            StateHasChanged();
        }
    }

    private void GoBack()
    {
        Step = LoginStep.Phone;
        VerificationCode = "";
        DebugCode = null;
        ErrorMessage = null;
    }
}

<style>
    .login-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 50%, #FED7AA 100%);
        position: relative;
        overflow: hidden;
    }

    /* Background Decoration */
    .bg-decoration {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
    }

    .bg-circle {
        position: absolute;
        border-radius: 50%;
        background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(249, 115, 22, 0.05));
    }

    .bg-circle-1 {
        width: 300px;
        height: 300px;
        top: -100px;
        right: -100px;
    }

    .bg-circle-2 {
        width: 200px;
        height: 200px;
        bottom: 10%;
        left: -80px;
    }

    .bg-circle-3 {
        width: 150px;
        height: 150px;
        bottom: -50px;
        right: 20%;
    }

    .login-container {
        width: 100%;
        max-width: 400px;
        position: relative;
        z-index: 1;
    }

    /* Logo Section */
    .logo-section {
        text-align: center;
        margin-bottom: 32px;
    }

    .logo-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #F97316, #EA580C);
        border-radius: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        color: white;
        box-shadow: 0 12px 32px rgba(249, 115, 22, 0.4);
    }

    .logo-text {
        font-size: 36px;
        font-weight: 800;
        color: #1F2937;
        margin: 0 0 8px;
    }

    .logo-tagline {
        font-size: 16px;
        color: #6B7280;
        margin: 0;
    }

    /* Login Card */
    .login-card {
        background: white;
        border-radius: 24px;
        padding: 32px 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    }

    .step-content {
        position: relative;
    }

    .back-btn {
        position: absolute;
        top: 0;
        right: 0;
        width: 40px;
        height: 40px;
        border-radius: 12px;
        border: none;
        background: #F3F4F6;
        color: #6B7280;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .back-btn:hover {
        background: #E5E7EB;
        color: #374151;
    }

    .step-header {
        text-align: center;
        margin-bottom: 28px;
    }

    .step-header h2 {
        font-size: 24px;
        font-weight: 700;
        color: #1F2937;
        margin: 0 0 8px;
    }

    .step-header p {
        font-size: 15px;
        color: #6B7280;
        margin: 0;
    }

    .phone-display {
        font-size: 18px !important;
        font-weight: 600;
        color: #1F2937 !important;
        direction: ltr;
        margin-top: 8px !important;
    }

    /* Input Container */
    .input-container {
        margin-bottom: 24px;
    }

    .input-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }

    .phone-input-wrapper {
        display: flex;
        border: 2px solid #E5E7EB;
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.2s;
        background: #F9FAFB;
    }

    .phone-input-wrapper.focused {
        border-color: #F97316;
        background: white;
        box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.1);
    }

    .phone-input-wrapper.error {
        border-color: #EF4444;
    }

    .country-code-box {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0 16px;
        background: #F3F4F6;
        border-left: 1px solid #E5E7EB;
    }

    .flag {
        font-size: 20px;
    }

    .code {
        font-size: 15px;
        font-weight: 600;
        color: #374151;
    }

    .phone-input {
        flex: 1;
        border: none;
        padding: 16px;
        font-size: 18px;
        font-weight: 500;
        letter-spacing: 2px;
        direction: ltr;
        text-align: left;
        background: transparent;
    }

    .phone-input:focus {
        outline: none;
    }

    .phone-input::placeholder {
        color: #9CA3AF;
        letter-spacing: 1px;
    }

    .input-hint {
        font-size: 13px;
        color: #9CA3AF;
        margin: 8px 0 0;
    }

    /* OTP Container */
    .otp-container {
        margin-bottom: 24px;
    }

    .otp-inputs {
        display: flex;
        gap: 12px;
        justify-content: center;
        direction: ltr;
    }

    .otp-digit {
        width: 64px;
        height: 64px;
        border: 2px solid #E5E7EB;
        border-radius: 16px;
        text-align: center;
        font-size: 28px;
        font-weight: 700;
        color: #1F2937;
        background: #F9FAFB;
        transition: all 0.2s;
    }

    .otp-digit:focus,
    .otp-digit.focused {
        outline: none;
        border-color: #F97316;
        background: white;
        box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.1);
    }

    /* Debug Banner */
    .debug-banner {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: linear-gradient(135deg, #FEF3C7, #FDE68A);
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 20px;
        font-size: 14px;
        color: #92400E;
    }

    .debug-banner strong {
        font-size: 18px;
        letter-spacing: 4px;
    }

    /* Error Alert */
    .error-alert {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #FEF2F2;
        border: 1px solid #FECACA;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 20px;
        color: #DC2626;
        font-size: 14px;
    }

    /* Submit Button */
    .submit-btn {
        width: 100%;
        padding: 16px 24px;
        background: linear-gradient(135deg, #F97316, #EA580C);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.2s;
        box-shadow: 0 8px 24px rgba(249, 115, 22, 0.35);
    }

    .submit-btn:hover:not(.disabled) {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(249, 115, 22, 0.4);
    }

    .submit-btn.disabled {
        background: #D1D5DB;
        box-shadow: none;
        cursor: not-allowed;
    }

    .btn-loader {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Resend Section */
    .resend-section {
        margin-top: 24px;
        text-align: center;
    }

    .countdown-text {
        font-size: 14px;
        color: #6B7280;
        margin: 0;
    }

    .countdown-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 28px;
        height: 28px;
        background: #F3F4F6;
        border-radius: 8px;
        font-weight: 700;
        color: #374151;
        margin: 0 4px;
    }

    .resend-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: none;
        border: none;
        color: #F97316;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .resend-btn:hover {
        background: #FFF7ED;
    }

    /* Terms */
    .terms-text {
        text-align: center;
        font-size: 13px;
        color: #9CA3AF;
        margin: 24px 0 0;
    }

    .terms-text a {
        color: #F97316;
        text-decoration: none;
        font-weight: 500;
    }
</style>
