@page "/order/success/{OrderId:guid}"
@inject OrderApiService ApiService
@inject NavigationManager Navigation

<div class="success-page">
    <!-- Background Pattern -->
    <div class="bg-pattern"></div>

    @if (IsLoading)
    {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>جاري تحميل تفاصيل الطلب...</p>
        </div>
    }
    else if (Order != null)
    {
        <div class="success-container">
            <!-- Success Animation -->
            <div class="success-header">
                <div class="success-checkmark">
                    <div class="check-circle">
                        <svg class="check-icon" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="pulse-ring"></div>
                    <div class="pulse-ring delay"></div>
                </div>
                <h1>تم إرسال طلبك بنجاح!</h1>
                <p class="success-subtitle">سنبدأ في تحضير طلبك الآن</p>
            </div>

            <!-- Order Summary Card -->
            <div class="order-summary-card">
                <div class="order-id-section">
                    <span class="label">رقم الطلب</span>
                    <span class="order-number">#@Order.OrderNumber</span>
                </div>

                <div class="divider"></div>

                <!-- Order Details Grid -->
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-icon total">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                        </div>
                        <div class="detail-content">
                            <span class="detail-label">المبلغ الإجمالي</span>
                            <span class="detail-value price">@Order.TotalAmount.ToString("N0") ر.س</span>
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-icon delivery">
                            @if (Order.DeliveryType == DeliveryType.Pickup)
                            {
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                            }
                            else
                            {
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0-4 0"/>
                                    <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0-4 0"/>
                                    <path d="M5 17H3V6a1 1 0 0 1 1-1h9v12m-4 0h6m4 0h2v-6h-8m0-5h5l3 5"/>
                                </svg>
                            }
                        </div>
                        <div class="detail-content">
                            <span class="detail-label">طريقة الاستلام</span>
                            <span class="detail-value">
                                @(Order.DeliveryType == DeliveryType.Pickup ? "استلام من الكاشير" : "توصيل للسيارة")
                            </span>
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-icon payment">
                            @if (Order.PaymentMethod == PaymentMethod.Cash)
                            {
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            }
                            else
                            {
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                    <line x1="1" y1="10" x2="23" y2="10"/>
                                </svg>
                            }
                        </div>
                        <div class="detail-content">
                            <span class="detail-label">طريقة الدفع</span>
                            <span class="detail-value">
                                @(Order.PaymentMethod == PaymentMethod.Cash ? "الدفع نقداً" : "بطاقة ائتمان")
                            </span>
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-icon status">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </div>
                        <div class="detail-content">
                            <span class="detail-label">الحالة</span>
                            <span class="detail-value status-badge">@Order.StatusAr</span>
                        </div>
                    </div>
                </div>

                @if (Order.CashAmount.HasValue && Order.PaymentMethod == PaymentMethod.Cash)
                {
                    <div class="cash-info-box">
                        <div class="cash-row">
                            <span>المبلغ المدفوع</span>
                            <span class="amount">@Order.CashAmount.Value.ToString("N0") ر.س</span>
                        </div>
                        @if (Order.ChangeAmount.HasValue && Order.ChangeAmount > 0)
                        {
                            <div class="cash-row change">
                                <span>الباقي</span>
                                <span class="amount">@Order.ChangeAmount.Value.ToString("N0") ر.س</span>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Vendor Info Card -->
            @if (Order.Vendor != null)
            {
                <div class="vendor-card">
                    <div class="vendor-header">
                        <div class="vendor-avatar">
                            @if (!string.IsNullOrEmpty(Order.Vendor.LogoUrl))
                            {
                                <img src="@Order.Vendor.LogoUrl" alt="@Order.Vendor.Name" />
                            }
                            else
                            {
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                    <polyline points="9 22 9 12 15 12 15 22"/>
                                </svg>
                            }
                        </div>
                        <div class="vendor-details">
                            <span class="vendor-label">المتجر</span>
                            <span class="vendor-name">@Order.Vendor.Name</span>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(Order.Vendor.ContactPhone))
                    {
                        <a href="tel:@Order.Vendor.ContactPhone" class="vendor-phone-btn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                            <span>اتصل بالمتجر</span>
                        </a>
                    }
                </div>
            }

            <!-- Info Box -->
            <div class="info-box">
                <div class="info-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                </div>
                <div class="info-content">
                    <h3>ماذا الآن؟</h3>
                    @if (Order.DeliveryType == DeliveryType.Pickup)
                    {
                        <p>سنرسل لك إشعاراً عندما يكون طلبك جاهزاً للاستلام من الكاشير</p>
                    }
                    else
                    {
                        <p>سنرسل لك إشعاراً عندما يكون طلبك جاهزاً. يمكنك تحديث موقع سيارتك من صفحة تفاصيل الطلب</p>
                    }
                </div>
            </div>

            <!-- Actions -->
            <div class="action-buttons">
                <button class="primary-btn" @onclick="ViewOrderDetails">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    عرض تفاصيل الطلب
                </button>
                <button class="secondary-btn" @onclick="GoHome">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                    العودة للرئيسية
                </button>
            </div>
        </div>
    }
    else
    {
        <!-- Error State -->
        <div class="error-container">
            <div class="error-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
            </div>
            <h2>حدث خطأ</h2>
            <p>لم نتمكن من تحميل تفاصيل الطلب</p>
            <button class="retry-btn" @onclick="LoadOrder">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"/>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                </svg>
                إعادة المحاولة
            </button>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid OrderId { get; set; }

    private OrderDto? Order;
    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrder();
    }

    private async Task LoadOrder()
    {
        IsLoading = true;
        try
        {
            Order = await ApiService.GetOrderAsync(OrderId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading order: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void ViewOrderDetails()
    {
        Navigation.NavigateTo($"/orders/{OrderId}");
    }

    private void GoHome()
    {
        Navigation.NavigateTo("/");
    }
}

<style>
    .success-page {
        min-height: 100vh;
        background: linear-gradient(180deg, #F0FDF4 0%, #DCFCE7 30%, #F3F4F6 60%);
        padding: 24px 16px 40px;
        position: relative;
        overflow: hidden;
    }

    .bg-pattern {
        position: absolute;
        inset: 0;
        background-image: radial-gradient(circle at 2px 2px, rgba(34, 197, 94, 0.1) 1px, transparent 1px);
        background-size: 32px 32px;
        pointer-events: none;
    }

    /* Loading State */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
        text-align: center;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 3px solid #E5E7EB;
        border-top-color: #22C55E;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-bottom: 16px;
    }

    .loading-container p {
        color: #6B7280;
        font-size: 15px;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Success Container */
    .success-container {
        max-width: 440px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
    }

    /* Success Header */
    .success-header {
        text-align: center;
        margin-bottom: 28px;
    }

    .success-checkmark {
        position: relative;
        width: 88px;
        height: 88px;
        margin: 0 auto 20px;
    }

    .check-circle {
        width: 88px;
        height: 88px;
        background: linear-gradient(135deg, #22C55E, #16A34A);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        box-shadow: 0 12px 32px rgba(34, 197, 94, 0.4);
        animation: scaleIn 0.4s ease-out;
        position: relative;
        z-index: 2;
    }

    .check-icon {
        animation: drawCheck 0.5s ease-out 0.2s both;
    }

    @@keyframes scaleIn {
        from {
            transform: scale(0);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    @@keyframes drawCheck {
        from {
            stroke-dasharray: 30;
            stroke-dashoffset: 30;
        }
        to {
            stroke-dashoffset: 0;
        }
    }

    .pulse-ring {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 88px;
        height: 88px;
        border: 2px solid #22C55E;
        border-radius: 50%;
        animation: pulse 2s ease-out infinite;
    }

    .pulse-ring.delay {
        animation-delay: 0.5s;
    }

    @@keyframes pulse {
        0% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 0.5;
        }
        100% {
            transform: translate(-50%, -50%) scale(1.6);
            opacity: 0;
        }
    }

    .success-header h1 {
        font-size: 26px;
        font-weight: 700;
        color: #1F2937;
        margin: 0 0 8px;
    }

    .success-subtitle {
        font-size: 16px;
        color: #6B7280;
        margin: 0;
    }

    /* Order Summary Card */
    .order-summary-card {
        background: white;
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    }

    .order-id-section {
        text-align: center;
        padding-bottom: 20px;
    }

    .order-id-section .label {
        display: block;
        font-size: 14px;
        color: #6B7280;
        margin-bottom: 4px;
    }

    .order-number {
        font-size: 28px;
        font-weight: 800;
        color: #1F2937;
        letter-spacing: 1px;
    }

    .divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, #E5E7EB, transparent);
        margin-bottom: 20px;
    }

    /* Details Grid */
    .details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .detail-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }

    .detail-icon {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .detail-icon.total {
        background: linear-gradient(135deg, #FEF3C7, #FDE68A);
        color: #D97706;
    }

    .detail-icon.delivery {
        background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
        color: #2563EB;
    }

    .detail-icon.payment {
        background: linear-gradient(135deg, #E0E7FF, #C7D2FE);
        color: #4F46E5;
    }

    .detail-icon.status {
        background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
        color: #059669;
    }

    .detail-content {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .detail-label {
        font-size: 12px;
        color: #9CA3AF;
    }

    .detail-value {
        font-size: 14px;
        font-weight: 600;
        color: #1F2937;
    }

    .detail-value.price {
        color: #F97316;
        font-size: 16px;
    }

    .status-badge {
        display: inline-block;
        background: #FFF7ED;
        color: #EA580C;
        padding: 2px 10px;
        border-radius: 10px;
        font-size: 12px;
    }

    /* Cash Info Box */
    .cash-info-box {
        background: linear-gradient(135deg, #F0FDF4, #DCFCE7);
        border-radius: 12px;
        padding: 16px;
        margin-top: 20px;
    }

    .cash-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        font-size: 14px;
        color: #374151;
    }

    .cash-row.change {
        border-top: 1px dashed #A7F3D0;
        margin-top: 8px;
        padding-top: 16px;
        font-weight: 600;
    }

    .cash-row .amount {
        font-weight: 700;
        color: #16A34A;
    }

    /* Vendor Card */
    .vendor-card {
        background: white;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
    }

    .vendor-header {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .vendor-avatar {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        background: #F3F4F6;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        color: #9CA3AF;
    }

    .vendor-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .vendor-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .vendor-label {
        font-size: 12px;
        color: #9CA3AF;
    }

    .vendor-name {
        font-size: 16px;
        font-weight: 600;
        color: #1F2937;
    }

    .vendor-phone-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 14px;
        padding: 12px;
        background: #F0FDF4;
        border-radius: 12px;
        color: #16A34A;
        text-decoration: none;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .vendor-phone-btn:hover {
        background: #DCFCE7;
    }

    /* Info Box */
    .info-box {
        display: flex;
        gap: 16px;
        background: linear-gradient(135deg, #EFF6FF, #DBEAFE);
        border-radius: 16px;
        padding: 18px;
        margin-bottom: 24px;
    }

    .info-icon {
        width: 44px;
        height: 44px;
        background: white;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #2563EB;
        flex-shrink: 0;
    }

    .info-content h3 {
        font-size: 15px;
        font-weight: 600;
        color: #1E40AF;
        margin: 0 0 4px;
    }

    .info-content p {
        font-size: 14px;
        color: #3B82F6;
        margin: 0;
        line-height: 1.5;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .primary-btn,
    .secondary-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 16px 24px;
        border-radius: 14px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .primary-btn {
        background: linear-gradient(135deg, #F97316, #EA580C);
        color: white;
        box-shadow: 0 8px 24px rgba(249, 115, 22, 0.35);
    }

    .primary-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(249, 115, 22, 0.4);
    }

    .secondary-btn {
        background: white;
        color: #374151;
        border: 2px solid #E5E7EB;
    }

    .secondary-btn:hover {
        border-color: #D1D5DB;
        background: #F9FAFB;
    }

    /* Error State */
    .error-container {
        text-align: center;
        padding: 60px 20px;
        max-width: 320px;
        margin: 0 auto;
    }

    .error-icon {
        width: 80px;
        height: 80px;
        background: #FEF2F2;
        border-radius: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        color: #DC2626;
    }

    .error-container h2 {
        font-size: 20px;
        font-weight: 700;
        color: #1F2937;
        margin: 0 0 8px;
    }

    .error-container p {
        font-size: 15px;
        color: #6B7280;
        margin: 0 0 24px;
    }

    .retry-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: #F97316;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
    }
</style>
