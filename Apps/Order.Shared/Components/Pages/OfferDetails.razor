@page "/offer/{OfferId:guid}"
@inject OrderApiService ApiService
@inject NavigationManager Navigation

@if (IsLoading)
{
    <div class="loading-screen">
        <div class="loader-ring"></div>
        <p>جاري تحميل العرض...</p>
    </div>
}
else if (Offer == null)
{
    <div class="error-screen">
        <div class="error-icon">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        </div>
        <h2>العرض غير متوفر</h2>
        <p>ربما تم حذف هذا العرض أو انتهت صلاحيته</p>
        <button class="btn-back-home" @onclick="GoBack">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6"/>
            </svg>
            <span>العودة للرئيسية</span>
        </button>
    </div>
}
else
{
    <div class="offer-page">
        <!-- Hero Image -->
        <div class="hero-image">
            @if (!string.IsNullOrEmpty(Offer.ImageUrl))
            {
                <img src="@Offer.ImageUrl" alt="@Offer.Title" />
            }
            else
            {
                <div class="hero-placeholder">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="#F97316">
                        <path d="M8.1 13.34l2.83-2.83L3.91 3.5c-1.56 1.56-1.56 4.09 0 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.46-1.46-4.2-1.1-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 13l1.47-1.47z"/>
                    </svg>
                </div>
            }

            <!-- Top Navigation -->
            <div class="top-nav">
                <button class="nav-btn" @onclick="GoBack">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </button>
                <div class="nav-actions">
                    <button class="nav-btn">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="18" cy="5" r="3"/>
                            <circle cx="6" cy="12" r="3"/>
                            <circle cx="18" cy="19" r="3"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                    </button>
                    <button class="nav-btn favorite">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Discount Badge -->
            @if (Offer.DiscountPercent > 0)
            {
                <div class="hero-discount">
                    <span class="discount-value">@Offer.DiscountPercent%</span>
                    <span class="discount-label">خصم</span>
                </div>
            }
        </div>

        <!-- Content -->
        <div class="offer-content">
            <!-- Vendor Card -->
            @if (Offer.Vendor != null)
            {
                <div class="vendor-card" @onclick="() => ViewVendor(Offer.Vendor.Id)">
                    <div class="vendor-info">
                        @if (!string.IsNullOrEmpty(Offer.Vendor.LogoUrl))
                        {
                            <img src="@Offer.Vendor.LogoUrl" class="vendor-logo" alt="" />
                        }
                        else
                        {
                            <div class="vendor-logo-placeholder">
                                @(Offer.Vendor.Name?.Substring(0, 1) ?? "م")
                            </div>
                        }
                        <div class="vendor-details">
                            <h3 class="vendor-name">@Offer.Vendor.Name</h3>
                            <div class="vendor-meta">
                                @if (Offer.Vendor.IsOpen)
                                {
                                    <span class="status-badge open">
                                        <span class="status-dot"></span>
                                        مفتوح الآن
                                    </span>
                                }
                                else
                                {
                                    <span class="status-badge closed">
                                        <span class="status-dot"></span>
                                        مغلق
                                    </span>
                                }
                                @if (Offer.Vendor.Distance.HasValue)
                                {
                                    <span class="distance-badge">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                        </svg>
                                        @Offer.Vendor.Distance.Value.ToString("0.0") كم
                                    </span>
                                }
                            </div>
                        </div>
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#94A3B8" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                </div>
            }

            <!-- Title & Price -->
            <div class="offer-header">
                <h1 class="offer-title">@Offer.Title</h1>
                <div class="price-card">
                    <div class="price-main">
                        <span class="price-value">@Offer.Price.ToString("0.00")</span>
                        <span class="price-currency">ر.س</span>
                    </div>
                    @if (Offer.OriginalPrice.HasValue && Offer.OriginalPrice > Offer.Price)
                    {
                        <div class="price-original">
                            <span class="was-price">@Offer.OriginalPrice.Value.ToString("0.00") ر.س</span>
                            <span class="save-amount">وفر @((Offer.OriginalPrice.Value - Offer.Price).ToString("0.00")) ر.س</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Description -->
            @if (!string.IsNullOrEmpty(Offer.Description))
            {
                <div class="section-card">
                    <h2 class="section-title">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        تفاصيل العرض
                    </h2>
                    <p class="section-text">@Offer.Description</p>
                </div>
            }

            <!-- Quantity Selector -->
            <div class="section-card quantity-card">
                <h2 class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    الكمية
                </h2>
                <div class="quantity-control">
                    <button class="qty-btn minus" @onclick="DecreaseQuantity" disabled="@(Quantity <= 1)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                    </button>
                    <span class="qty-display">@Quantity</span>
                    <button class="qty-btn plus" @onclick="IncreaseQuantity">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Notes -->
            <div class="section-card">
                <h2 class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    ملاحظات
                    <span class="optional-tag">اختياري</span>
                </h2>
                <textarea class="notes-input" @bind="CustomerNotes" placeholder="أضف أي ملاحظات خاصة بطلبك..."></textarea>
            </div>
        </div>

        <!-- Footer -->
        <div class="order-footer">
            <div class="footer-total">
                <span class="total-label">الإجمالي</span>
                <span class="total-value">@((Offer.Price * Quantity).ToString("0.00")) ر.س</span>
            </div>
            <button class="btn-order" @onclick="ProceedToOrder" disabled="@(!Offer.Vendor?.IsOpen ?? true)">
                @if (Offer.Vendor?.IsOpen == true)
                {
                    <span>اطلب الآن</span>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="5" y1="12" x2="19" y2="12"/>
                        <polyline points="12,5 19,12 12,19"/>
                    </svg>
                }
                else
                {
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0110 0v4"/>
                    </svg>
                    <span>المتجر مغلق</span>
                }
            </button>
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid OfferId { get; set; }

    private OfferDto? Offer;
    private bool IsLoading = true;
    private int Quantity = 1;
    private string? CustomerNotes;

    protected override async Task OnInitializedAsync()
    {
        await LoadOffer();
    }

    private async Task LoadOffer()
    {
        IsLoading = true;
        try
        {
            Offer = await ApiService.GetOfferAsync(OfferId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading offer: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void IncreaseQuantity()
    {
        if (Quantity < 99)
            Quantity++;
    }

    private void DecreaseQuantity()
    {
        if (Quantity > 1)
            Quantity--;
    }

    private void ProceedToOrder()
    {
        var orderData = $"offerId={OfferId}&qty={Quantity}&notes={Uri.EscapeDataString(CustomerNotes ?? "")}";
        Navigation.NavigateTo($"/order/create?{orderData}");
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private void ViewVendor(Guid vendorId)
    {
        Navigation.NavigateTo($"/vendor/{vendorId}");
    }
}

<style>
    /* Loading & Error Screens */
    .loading-screen, .error-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 40px;
        text-align: center;
        background: #F8FAFC;
    }

    .loader-ring {
        width: 56px;
        height: 56px;
        border: 4px solid #E2E8F0;
        border-top-color: #F97316;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-bottom: 20px;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .loading-screen p {
        color: #64748B;
        font-size: 15px;
    }

    .error-icon {
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #DC2626;
        margin-bottom: 24px;
    }

    .error-screen h2 {
        font-size: 22px;
        font-weight: 700;
        color: #1E293B;
        margin: 0 0 8px;
    }

    .error-screen p {
        color: #64748B;
        margin: 0 0 24px;
    }

    .btn-back-home {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 14px 28px;
        background: linear-gradient(135deg, #F97316 0%, #EA580C 100%);
        color: white;
        border: none;
        border-radius: 14px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
    }

    /* Offer Page */
    .offer-page {
        min-height: 100vh;
        background: #F8FAFC;
        padding-bottom: 120px;
    }

    /* Hero Image */
    .hero-image {
        position: relative;
        height: 300px;
        background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%);
    }

    .hero-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .hero-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .top-nav {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, transparent 100%);
    }

    .nav-btn {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background: rgba(255,255,255,0.95);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1E293B;
        cursor: pointer;
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.2s;
    }

    .nav-btn:active {
        transform: scale(0.95);
    }

    .nav-actions {
        display: flex;
        gap: 10px;
    }

    .hero-discount {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        color: white;
        padding: 12px 18px;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        box-shadow: 0 4px 14px rgba(239, 68, 68, 0.4);
    }

    .discount-value {
        font-size: 28px;
        font-weight: 800;
        line-height: 1;
    }

    .discount-label {
        font-size: 12px;
        font-weight: 600;
    }

    /* Content */
    .offer-content {
        padding: 20px 16px;
        margin-top: -30px;
        position: relative;
        z-index: 10;
    }

    /* Vendor Card */
    .vendor-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
        padding: 16px;
        border-radius: 18px;
        margin-bottom: 16px;
        cursor: pointer;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        transition: all 0.2s;
    }

    .vendor-card:active {
        transform: scale(0.99);
    }

    .vendor-info {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .vendor-logo {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        object-fit: cover;
    }

    .vendor-logo-placeholder {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        background: linear-gradient(135deg, #F97316 0%, #EA580C 100%);
        color: white;
        font-size: 24px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .vendor-name {
        font-size: 16px;
        font-weight: 700;
        color: #1E293B;
        margin: 0 0 6px;
    }

    .vendor-meta {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .status-badge {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 12px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 8px;
    }

    .status-badge.open {
        background: #DCFCE7;
        color: #16A34A;
    }

    .status-badge.closed {
        background: #FEE2E2;
        color: #DC2626;
    }

    .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
    }

    .distance-badge {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        color: #64748B;
    }

    /* Offer Header */
    .offer-header {
        background: white;
        padding: 20px;
        border-radius: 18px;
        margin-bottom: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }

    .offer-title {
        font-size: 22px;
        font-weight: 700;
        color: #1E293B;
        margin: 0 0 16px;
        line-height: 1.4;
    }

    .price-card {
        background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%);
        padding: 16px;
        border-radius: 14px;
    }

    .price-main {
        display: flex;
        align-items: baseline;
        gap: 4px;
    }

    .price-value {
        font-size: 36px;
        font-weight: 800;
        color: #F97316;
    }

    .price-currency {
        font-size: 18px;
        font-weight: 600;
        color: #F97316;
    }

    .price-original {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 8px;
    }

    .was-price {
        font-size: 16px;
        color: #94A3B8;
        text-decoration: line-through;
    }

    .save-amount {
        font-size: 13px;
        font-weight: 600;
        color: #16A34A;
        background: #DCFCE7;
        padding: 4px 10px;
        border-radius: 6px;
    }

    /* Section Card */
    .section-card {
        background: white;
        padding: 20px;
        border-radius: 18px;
        margin-bottom: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
        font-weight: 700;
        color: #1E293B;
        margin: 0 0 14px;
    }

    .section-title svg {
        color: #64748B;
    }

    .optional-tag {
        font-size: 12px;
        font-weight: 500;
        color: #94A3B8;
        background: #F1F5F9;
        padding: 3px 8px;
        border-radius: 6px;
        margin-right: auto;
    }

    .section-text {
        color: #64748B;
        line-height: 1.7;
        margin: 0;
        white-space: pre-line;
    }

    /* Quantity Control */
    .quantity-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .quantity-card .section-title {
        margin: 0;
    }

    .quantity-control {
        display: flex;
        align-items: center;
        gap: 4px;
        background: #F1F5F9;
        padding: 4px;
        border-radius: 14px;
    }

    .qty-btn {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .qty-btn.minus {
        background: white;
        color: #64748B;
    }

    .qty-btn.plus {
        background: linear-gradient(135deg, #F97316 0%, #EA580C 100%);
        color: white;
    }

    .qty-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .qty-btn:active:not(:disabled) {
        transform: scale(0.95);
    }

    .qty-display {
        min-width: 50px;
        text-align: center;
        font-size: 20px;
        font-weight: 700;
        color: #1E293B;
    }

    /* Notes Input */
    .notes-input {
        width: 100%;
        padding: 16px;
        border: 1.5px solid #E2E8F0;
        border-radius: 14px;
        font-size: 15px;
        resize: none;
        min-height: 100px;
        font-family: inherit;
        background: #FAFBFC;
        transition: all 0.2s;
    }

    .notes-input:focus {
        outline: none;
        border-color: #F97316;
        background: white;
        box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.1);
    }

    .notes-input::placeholder {
        color: #94A3B8;
    }

    /* Footer */
    .order-footer {
        position: fixed;
        bottom: 70px;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 20px;
        background: white;
        border-top: 1px solid #E2E8F0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
    }

    .footer-total {
        display: flex;
        flex-direction: column;
    }

    .total-label {
        font-size: 12px;
        color: #64748B;
    }

    .total-value {
        font-size: 24px;
        font-weight: 800;
        color: #1E293B;
    }

    .btn-order {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 18px 24px;
        background: linear-gradient(135deg, #F97316 0%, #EA580C 100%);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 17px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 14px rgba(249, 115, 22, 0.35);
    }

    .btn-order:active:not(:disabled) {
        transform: scale(0.98);
    }

    .btn-order:disabled {
        background: #CBD5E1;
        box-shadow: none;
        cursor: not-allowed;
    }
</style>
