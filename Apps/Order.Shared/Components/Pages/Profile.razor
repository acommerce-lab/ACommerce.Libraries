@page "/profile"
@inject NavigationManager Navigation
@inject AuthStateService AuthState
@inject OrderApiService ApiService

<ProfilePage User="@UserInfo"
             OrdersCount="@OrdersCount"
             WishlistCount="0"
             ReviewsCount="0"
             AddressesCount="@AddressesCount"
             PendingOrdersCount="@PendingOrdersCount"
             AppVersion="1.0.0"
             OnAvatarClick="HandleAvatarClick"
             OnOrdersClick="() => Navigate('/orders')"
             OnWishlistClick="() => {}"
             OnReviewsClick="() => {}"
             OnLogout="HandleLogout" />

@code {
    private UserProfileInfo? UserInfo;
    private int OrdersCount;
    private int AddressesCount;
    private int PendingOrdersCount;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserData();
    }

    private async Task LoadUserData()
    {
        try
        {
            if (AuthState.CurrentUser != null)
            {
                UserInfo = new UserProfileInfo
                {
                    Name = AuthState.CurrentUser.FullName,
                    Email = AuthState.CurrentUser.Email,
                    AvatarUrl = AuthState.CurrentUser.AvatarUrl
                };
            }

            // Load counts from API
            var stats = await ApiService.GetUserStatsAsync();
            OrdersCount = stats.TotalOrders;
            AddressesCount = stats.SavedAddresses;
            PendingOrdersCount = stats.PendingOrders;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user data: {ex.Message}");
        }
    }

    private void HandleAvatarClick()
    {
        // Open image picker or navigate to edit profile
        Navigation.NavigateTo("/profile/edit");
    }

    private void Navigate(string url)
    {
        Navigation.NavigateTo(url);
    }

    private async Task HandleLogout()
    {
        await AuthState.LogoutAsync();
        Navigation.NavigateTo("/login");
    }
}
