@page "/notifications"
@inject NavigationManager Navigation
@inject OrderApiService ApiService

<NotificationsPage Notifications="@Notifications"
                   IsLoading="@IsLoading"
                   OnNotificationClick="HandleNotificationClick"
                   OnMarkAllRead="HandleMarkAllRead"
                   OnLoadMore="HandleLoadMore" />

@code {
    private List<NotificationItem>? Notifications;
    private bool IsLoading = true;
    private bool HasMore;

    protected override async Task OnInitializedAsync()
    {
        await LoadNotifications();
    }

    private async Task LoadNotifications()
    {
        IsLoading = true;
        try
        {
            var result = await ApiService.GetNotificationsAsync();
            Notifications = result.Select(n => new NotificationItem
            {
                Id = n.Id,
                Title = n.Title,
                Message = n.Message,
                Type = n.Type,
                IsRead = n.IsRead,
                CreatedAt = n.CreatedAt,
                Data = n.Data
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading notifications: {ex.Message}");
            Notifications = new List<NotificationItem>();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task HandleNotificationClick(NotificationItem notification)
    {
        // Mark as read
        if (!notification.IsRead)
        {
            await ApiService.MarkNotificationReadAsync(notification.Id);
            notification.IsRead = true;
        }

        // Navigate based on type
        if (notification.Data != null && notification.Data.TryGetValue("orderId", out var orderId))
        {
            Navigation.NavigateTo($"/order/{orderId}");
        }
    }

    private async Task HandleMarkAllRead()
    {
        try
        {
            await ApiService.MarkAllNotificationsReadAsync();
            if (Notifications != null)
            {
                foreach (var n in Notifications)
                {
                    n.IsRead = true;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error marking all as read: {ex.Message}");
        }
    }

    private async Task HandleLoadMore()
    {
        // Load more notifications
    }
}
