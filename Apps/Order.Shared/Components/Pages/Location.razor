@page "/location"
@page "/locations"
@inject NavigationManager Navigation
@inject OrderApiService ApiService

<LocationsListPage Locations="@Locations"
                   IsLoading="@IsLoading"
                   OnAddLocation="HandleAddLocation"
                   OnLocationClick="HandleLocationClick"
                   OnEditLocation="HandleEditLocation"
                   OnDeleteLocation="HandleDeleteLocation" />

@code {
    private List<SavedLocation>? Locations;
    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadLocations();
    }

    private async Task LoadLocations()
    {
        IsLoading = true;
        try
        {
            var result = await ApiService.GetSavedLocationsAsync();
            Locations = result.Select(l => new SavedLocation
            {
                Id = l.Id,
                Label = l.Label,
                Type = l.Type,
                Address = l.Address,
                BuildingNumber = l.BuildingNumber,
                Floor = l.Floor,
                Apartment = l.Apartment,
                District = l.District,
                City = l.City,
                Notes = l.Notes,
                Latitude = l.Latitude,
                Longitude = l.Longitude,
                IsDefault = l.IsDefault,
                CreatedAt = l.CreatedAt
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading locations: {ex.Message}");
            Locations = new List<SavedLocation>();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void HandleAddLocation()
    {
        Navigation.NavigateTo("/location/new");
    }

    private void HandleLocationClick(string locationId)
    {
        Navigation.NavigateTo($"/location/{locationId}");
    }

    private void HandleEditLocation(string locationId)
    {
        Navigation.NavigateTo($"/location/{locationId}/edit");
    }

    private async Task HandleDeleteLocation(string locationId)
    {
        try
        {
            await ApiService.DeleteLocationAsync(locationId);
            Locations?.RemoveAll(l => l.Id == locationId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting location: {ex.Message}");
        }
    }
}
