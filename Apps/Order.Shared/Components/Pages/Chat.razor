@page "/chats"
@page "/chat/{OrderId}"
@inject NavigationManager Navigation
@inject OrderApiService ApiService

@if (string.IsNullOrEmpty(OrderId))
{
    @* Chat List *@
    <ChatListPage Chats="@Chats"
                  IsLoading="@IsLoading"
                  OnChatClick="HandleChatClick" />
}
else
{
    @* Single Chat *@
    <ChatPage Chat="@CurrentChat"
              Messages="@Messages"
              IsLoading="@IsLoading"
              IsSending="@IsSending"
              OnBack="HandleBack"
              OnSend="HandleSend"
              OnAttachment="HandleAttachment" />
}

@code {
    [Parameter] public string? OrderId { get; set; }

    private List<ChatListInfo>? Chats;
    private ChatInfo? CurrentChat;
    private List<ChatMessageItem>? Messages;

    private bool IsLoading = true;
    private bool IsSending;

    protected override async Task OnParametersSetAsync()
    {
        if (string.IsNullOrEmpty(OrderId))
        {
            await LoadChats();
        }
        else
        {
            await LoadChat();
        }
    }

    private async Task LoadChats()
    {
        IsLoading = true;
        try
        {
            var result = await ApiService.GetChatsAsync();
            Chats = result.Select(c => new ChatListInfo
            {
                Id = c.Id,
                OrderId = c.OrderId,
                OrderNumber = c.OrderNumber,
                VendorName = c.VendorName,
                VendorLogo = c.VendorLogo,
                LastMessage = c.LastMessage,
                LastMessageTime = c.LastMessageTime,
                UnreadCount = c.UnreadCount,
                IsVendorOnline = c.IsVendorOnline
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading chats: {ex.Message}");
            Chats = new List<ChatListInfo>();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadChat()
    {
        IsLoading = true;
        try
        {
            var chat = await ApiService.GetChatAsync(OrderId!);
            CurrentChat = new ChatInfo
            {
                Id = chat.Id,
                OrderId = chat.OrderId,
                OrderNumber = chat.OrderNumber,
                OrderStatus = chat.OrderStatus,
                VendorName = chat.VendorName,
                VendorLogo = chat.VendorLogo,
                IsVendorOnline = chat.IsVendorOnline
            };

            Messages = chat.Messages.Select(m => new ChatMessageItem
            {
                Id = Guid.Parse(m.Id),
                Text = m.Content,
                Timestamp = m.SentAt,
                IsSent = m.IsFromMe,
                IsRead = m.IsRead,
                Type = ChatMessageType.Text
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading chat: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void HandleChatClick(string orderId)
    {
        Navigation.NavigateTo($"/chat/{orderId}");
    }

    private void HandleBack()
    {
        Navigation.NavigateTo("/chats");
    }

    private async Task HandleSend(string message)
    {
        IsSending = true;
        try
        {
            await ApiService.SendChatMessageAsync(OrderId!, message);
            Messages?.Add(new ChatMessageItem
            {
                Id = Guid.NewGuid(),
                Text = message,
                Timestamp = DateTime.Now,
                IsSent = true,
                IsRead = false,
                Type = ChatMessageType.Text
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending message: {ex.Message}");
        }
        finally
        {
            IsSending = false;
        }
    }

    private Task HandleAttachment()
    {
        // Open attachment picker
        return Task.CompletedTask;
    }
}
