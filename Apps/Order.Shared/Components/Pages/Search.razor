@page "/search"
@inject NavigationManager Navigation
@inject OrderApiService ApiService

<div class="search-page">
    <!-- Search Header -->
    <header class="search-header">
        <div class="search-input-wrapper">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#94A3B8" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text"
                   class="search-input"
                   placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿπÿ±ÿ∂ ÿ£Ÿà ŸÖÿ∑ÿπŸÖ..."
                   @bind="SearchQuery"
                   @bind:event="oninput"
                   @onkeyup="HandleKeyUp" />
            @if (!string.IsNullOrEmpty(SearchQuery))
            {
                <button class="clear-btn" @onclick="ClearSearch">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            }
        </div>
        <button class="cancel-btn" @onclick="GoBack">ÿ•ŸÑÿ∫ÿßÿ°</button>
    </header>

    @if (string.IsNullOrEmpty(SearchQuery))
    {
        <!-- Recent Searches -->
        @if (RecentSearches?.Any() == true)
        {
            <section class="recent-section">
                <div class="section-header">
                    <h3>ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©</h3>
                    <button class="clear-all" @onclick="ClearRecentSearches">ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ</button>
                </div>
                <div class="recent-list">
                    @foreach (var search in RecentSearches)
                    {
                        <button class="recent-item" @onclick="() => SetSearchQuery(search)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            <span>@search</span>
                        </button>
                    }
                </div>
            </section>
        }

        <!-- Popular Searches -->
        <section class="popular-section">
            <h3>ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ®ÿ≠ÿ´ÿßŸã</h3>
            <div class="popular-tags">
                <button class="popular-tag" @onclick='() => SetSearchQuery("ŸÇŸáŸàÿ©")'>‚òï ŸÇŸáŸàÿ©</button>
                <button class="popular-tag" @onclick='() => SetSearchQuery("ÿ®ÿ±ÿ¨ÿ±")'>üçî ÿ®ÿ±ÿ¨ÿ±</button>
                <button class="popular-tag" @onclick='() => SetSearchQuery("ÿ®Ÿäÿ™ÿ≤ÿß")'>üçï ÿ®Ÿäÿ™ÿ≤ÿß</button>
                <button class="popular-tag" @onclick='() => SetSearchQuery("ÿ≠ŸÑŸàŸäÿßÿ™")'>üç∞ ÿ≠ŸÑŸàŸäÿßÿ™</button>
                <button class="popular-tag" @onclick='() => SetSearchQuery("ÿπÿµŸäÿ±")'>ü•§ ÿπÿµŸäÿ±</button>
                <button class="popular-tag" @onclick='() => SetSearchQuery("ÿ¥ÿßŸàÿ±ŸÖÿß")'>üåØ ÿ¥ÿßŸàÿ±ŸÖÿß</button>
            </div>
        </section>
    }
    else
    {
        <!-- Search Results -->
        @if (IsLoading)
        {
            <div class="loading-container">
                <div class="skeleton-list">
                    @for (int i = 0; i < 5; i++)
                    {
                        <div class="skeleton-item">
                            <div class="skeleton-image"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-line"></div>
                                <div class="skeleton-line short"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        else if (SearchResults?.Any() == true)
        {
            <div class="results-header">
                <span>@SearchResults.Count ŸÜÿ™Ÿäÿ¨ÿ©</span>
            </div>
            <div class="results-list">
                @foreach (var offer in SearchResults)
                {
                    <article class="result-card" @onclick="() => ViewOffer(offer.Id)">
                        <div class="result-image">
                            @if (!string.IsNullOrEmpty(offer.ImageUrl))
                            {
                                <img src="@offer.ImageUrl" alt="@offer.Title" />
                            }
                            else
                            {
                                <div class="image-placeholder">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="#CBD5E1">
                                        <path d="M8.1 13.34l2.83-2.83L3.91 3.5c-1.56 1.56-1.56 4.09 0 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.46-1.46-4.2-1.1-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 13l1.47-1.47z"/>
                                    </svg>
                                </div>
                            }
                            @if (offer.DiscountPercent > 0)
                            {
                                <span class="discount-badge">@offer.DiscountPercent%</span>
                            }
                        </div>
                        <div class="result-content">
                            <h4 class="result-title">@offer.Title</h4>
                            <p class="result-vendor">@offer.Vendor?.Name</p>
                            <div class="result-footer">
                                <div class="result-price">
                                    <span class="price">@offer.Price.ToString("0.00")</span>
                                    <span class="currency">ÿ±.ÿ≥</span>
                                </div>
                                @if (offer.Vendor?.Distance.HasValue == true)
                                {
                                    <span class="result-distance">@offer.Vendor.Distance.Value.ToString("0.0") ŸÉŸÖ</span>
                                }
                            </div>
                        </div>
                        <svg class="result-arrow" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#CBD5E1" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"/>
                        </svg>
                    </article>
                }
            </div>
        }
        else
        {
            <div class="empty-results">
                <div class="empty-icon">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#CBD5E1" stroke-width="1.5">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                </div>
                <h3>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</h3>
                <p>ÿ¨ÿ±ÿ® ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ŸÉŸÑŸÖÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ©</p>
            </div>
        }
    }
</div>

@code {
    private string? SearchQuery;
    private List<OfferDto>? SearchResults;
    private List<string> RecentSearches = new() { "ŸÇŸáŸàÿ©", "ŸÉÿßŸÅŸäŸá", "Ÿàÿ¨ÿ®ÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ©" };
    private bool IsLoading;
    private System.Timers.Timer? _debounceTimer;

    private void HandleKeyUp(KeyboardEventArgs e)
    {
        _debounceTimer?.Stop();
        _debounceTimer = new System.Timers.Timer(300);
        _debounceTimer.Elapsed += async (s, args) =>
        {
            _debounceTimer?.Stop();
            await InvokeAsync(async () =>
            {
                await PerformSearch();
            });
        };
        _debounceTimer.Start();
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(SearchQuery))
        {
            SearchResults = null;
            StateHasChanged();
            return;
        }

        IsLoading = true;
        StateHasChanged();

        try
        {
            var result = await ApiService.SearchOffersAsync(SearchQuery);
            SearchResults = result?.Items;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Search error: {ex.Message}");
            SearchResults = new List<OfferDto>();
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private void SetSearchQuery(string query)
    {
        SearchQuery = query;
        _ = PerformSearch();
    }

    private void ClearSearch()
    {
        SearchQuery = null;
        SearchResults = null;
    }

    private void ClearRecentSearches()
    {
        RecentSearches.Clear();
    }

    private void ViewOffer(Guid offerId)
    {
        if (!string.IsNullOrEmpty(SearchQuery) && !RecentSearches.Contains(SearchQuery))
        {
            RecentSearches.Insert(0, SearchQuery);
            if (RecentSearches.Count > 5)
                RecentSearches.RemoveAt(5);
        }
        Navigation.NavigateTo($"/offer/{offerId}");
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}

<style>
    .search-page {
        min-height: 100vh;
        background: #F8FAFC;
        padding-bottom: 100px;
    }

    .search-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: white;
        border-bottom: 1px solid #E2E8F0;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .search-input-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 10px;
        background: #F1F5F9;
        border-radius: 12px;
        padding: 12px 16px;
    }

    .search-icon {
        flex-shrink: 0;
    }

    .search-input {
        flex: 1;
        border: none;
        background: none;
        font-size: 15px;
        color: #1E293B;
    }

    .search-input::placeholder {
        color: #94A3B8;
    }

    .search-input:focus {
        outline: none;
    }

    .clear-btn {
        background: none;
        border: none;
        padding: 4px;
        color: #94A3B8;
        cursor: pointer;
    }

    .cancel-btn {
        background: none;
        border: none;
        font-size: 14px;
        font-weight: 600;
        color: #F97316;
        cursor: pointer;
        padding: 8px;
    }

    /* Recent Searches */
    .recent-section, .popular-section {
        padding: 20px 16px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .section-header h3, .popular-section h3 {
        font-size: 16px;
        font-weight: 700;
        color: #1E293B;
        margin: 0 0 12px;
    }

    .section-header h3 {
        margin: 0;
    }

    .clear-all {
        background: none;
        border: none;
        font-size: 13px;
        color: #F97316;
        cursor: pointer;
    }

    .recent-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .recent-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: white;
        border: none;
        border-radius: 12px;
        text-align: right;
        cursor: pointer;
        font-size: 14px;
        color: #475569;
    }

    .recent-item svg {
        color: #94A3B8;
    }

    /* Popular Tags */
    .popular-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .popular-tag {
        padding: 10px 16px;
        background: white;
        border: 1.5px solid #E2E8F0;
        border-radius: 20px;
        font-size: 14px;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s;
    }

    .popular-tag:active {
        background: #FFF7ED;
        border-color: #F97316;
        color: #EA580C;
    }

    /* Results */
    .results-header {
        padding: 12px 16px;
        font-size: 13px;
        color: #94A3B8;
    }

    .results-list {
        padding: 0 16px;
    }

    .result-card {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px;
        background: white;
        border-radius: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .result-card:active {
        transform: scale(0.98);
    }

    .result-image {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        overflow: hidden;
        flex-shrink: 0;
        position: relative;
    }

    .result-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .image-placeholder {
        width: 100%;
        height: 100%;
        background: #F1F5F9;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .discount-badge {
        position: absolute;
        top: 6px;
        right: 6px;
        background: #EF4444;
        color: white;
        font-size: 10px;
        font-weight: 700;
        padding: 3px 6px;
        border-radius: 6px;
    }

    .result-content {
        flex: 1;
        min-width: 0;
    }

    .result-title {
        font-size: 15px;
        font-weight: 600;
        color: #1E293B;
        margin: 0 0 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .result-vendor {
        font-size: 13px;
        color: #64748B;
        margin: 0 0 8px;
    }

    .result-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .result-price {
        display: flex;
        align-items: baseline;
        gap: 3px;
    }

    .price {
        font-size: 16px;
        font-weight: 700;
        color: #F97316;
    }

    .currency {
        font-size: 12px;
        color: #F97316;
    }

    .result-distance {
        font-size: 12px;
        color: #94A3B8;
    }

    .result-arrow {
        flex-shrink: 0;
    }

    /* Empty State */
    .empty-results {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-icon {
        margin-bottom: 16px;
    }

    .empty-results h3 {
        font-size: 18px;
        font-weight: 700;
        color: #1E293B;
        margin: 0 0 8px;
    }

    .empty-results p {
        font-size: 14px;
        color: #94A3B8;
        margin: 0;
    }

    /* Loading Skeleton */
    .skeleton-list {
        padding: 16px;
    }

    .skeleton-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px;
        background: white;
        border-radius: 16px;
        margin-bottom: 12px;
    }

    .skeleton-image {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        background: linear-gradient(90deg, #F1F5F9 25%, #E2E8F0 50%, #F1F5F9 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    .skeleton-content {
        flex: 1;
    }

    .skeleton-line {
        height: 14px;
        background: linear-gradient(90deg, #F1F5F9 25%, #E2E8F0 50%, #F1F5F9 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 6px;
        margin-bottom: 10px;
    }

    .skeleton-line.short {
        width: 60%;
    }

    @@keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>
