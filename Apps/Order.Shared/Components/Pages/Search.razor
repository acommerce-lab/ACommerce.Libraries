@page "/search"
@inject OrderApiService ApiService
@inject NavigationManager Navigation

<div class="search-page">
    <!-- Search Header -->
    <header class="search-header">
        <div class="search-bar-container">
            <button class="back-btn" @onclick="GoBack">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"/>
                    <polyline points="12 19 5 12 12 5"/>
                </svg>
            </button>
            <div class="search-input-wrapper">
                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text"
                       value="@SearchQuery"
                       @oninput="OnSearchInput"
                       @onkeyup="HandleKeyUp"
                       placeholder="ابحث عن عروض أو متاجر..."
                       class="search-input"
                       autofocus />
                @if (!string.IsNullOrEmpty(SearchQuery))
                {
                    <button class="clear-btn" @onclick="ClearSearch">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                    </button>
                }
            </div>
        </div>
    </header>

    <div class="search-content">
        @if (string.IsNullOrEmpty(SearchQuery) || (!IsSearching && !HasSearched))
        {
            <!-- Initial State - Show recent and popular -->
            <div class="search-suggestions">
                @if (RecentSearches.Any())
                {
                    <div class="suggestion-section">
                        <div class="section-header">
                            <h3>البحث الأخير</h3>
                            <button class="clear-all-btn" @onclick="ClearRecentSearches">مسح الكل</button>
                        </div>
                        <div class="recent-list">
                            @foreach (var search in RecentSearches)
                            {
                                <button class="recent-item" @onclick="() => ApplySearch(search)">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12 6 12 12 16 14"/>
                                    </svg>
                                    <span>@search</span>
                                    <button class="remove-recent" @onclick:stopPropagation @onclick="() => RemoveRecentSearch(search)">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"/>
                                            <line x1="6" y1="6" x2="18" y2="18"/>
                                        </svg>
                                    </button>
                                </button>
                            }
                        </div>
                    </div>
                }

                <div class="suggestion-section">
                    <h3>الأكثر بحثاً</h3>
                    <div class="popular-tags">
                        @foreach (var tag in PopularSearches)
                        {
                            <button class="popular-tag" @onclick="() => ApplySearch(tag)">@tag</button>
                        }
                    </div>
                </div>

                <div class="suggestion-section">
                    <h3>التصنيفات</h3>
                    <div class="categories-grid">
                        @foreach (var category in Categories)
                        {
                            <button class="category-card" @onclick="() => ApplySearch(category.Name)">
                                <div class="category-icon" style="background: @category.Color">
                                    @((MarkupString)category.Icon)
                                </div>
                                <span>@category.Name</span>
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
        else if (IsSearching)
        {
            <!-- Loading State -->
            <div class="search-loading">
                <div class="loading-spinner"></div>
                <p>جاري البحث...</p>
            </div>
        }
        else if (SearchResults.Any())
        {
            <!-- Results -->
            <div class="search-results">
                <div class="results-header">
                    <span class="results-count">@SearchResults.Count نتيجة</span>
                    <div class="filter-chips">
                        <button class="filter-chip @(ActiveFilter == "all" ? "active" : "")"
                                @onclick="() => SetFilter('all')">الكل</button>
                        <button class="filter-chip @(ActiveFilter == "offers" ? "active" : "")"
                                @onclick="() => SetFilter('offers')">العروض</button>
                        <button class="filter-chip @(ActiveFilter == "vendors" ? "active" : "")"
                                @onclick="() => SetFilter('vendors')">المتاجر</button>
                    </div>
                </div>

                <div class="results-list">
                    @foreach (var result in FilteredResults)
                    {
                        <div class="result-card" @onclick="() => ViewResult(result)">
                            <div class="result-image">
                                @if (!string.IsNullOrEmpty(result.ImageUrl))
                                {
                                    <img src="@result.ImageUrl" alt="@result.Title" />
                                }
                                else
                                {
                                    <div class="image-placeholder">
                                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                            <circle cx="8.5" cy="8.5" r="1.5"/>
                                            <polyline points="21 15 16 10 5 21"/>
                                        </svg>
                                    </div>
                                }
                                @if (result.Type == "offer" && result.Discount > 0)
                                {
                                    <div class="discount-badge">@result.Discount%</div>
                                }
                            </div>
                            <div class="result-info">
                                <span class="result-type-badge @result.Type">
                                    @(result.Type == "offer" ? "عرض" : "متجر")
                                </span>
                                <h4 class="result-title">@result.Title</h4>
                                <p class="result-subtitle">@result.Subtitle</p>
                                @if (result.Type == "offer")
                                {
                                    <div class="result-price">
                                        <span class="current-price">@result.Price ر.س</span>
                                        @if (result.OriginalPrice > result.Price)
                                        {
                                            <span class="original-price">@result.OriginalPrice ر.س</span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <!-- No Results -->
            <div class="no-results">
                <div class="no-results-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        <line x1="8" y1="11" x2="14" y2="11"/>
                    </svg>
                </div>
                <h3>لا توجد نتائج</h3>
                <p>لم نتمكن من العثور على نتائج لـ "@SearchQuery"</p>
                <button class="try-again-btn" @onclick="ClearSearch">حاول بحث آخر</button>
            </div>
        }
    </div>
</div>

@code {
    private string SearchQuery = "";
    private bool IsSearching = false;
    private bool HasSearched = false;
    private string ActiveFilter = "all";
    private System.Timers.Timer? _debounceTimer;

    private List<string> RecentSearches = new()
    {
        "قهوة",
        "بيتزا",
        "ستاربكس"
    };

    private List<string> PopularSearches = new()
    {
        "قهوة مثلجة",
        "برجر",
        "فطور",
        "حلويات",
        "مشروبات",
        "سندويش"
    };

    private List<CategoryItem> Categories = new()
    {
        new("كافيهات", "#7C3AED", "<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><path d=\"M18 8h1a4 4 0 0 1 0 8h-1\"/><path d=\"M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z\"/><line x1=\"6\" y1=\"1\" x2=\"6\" y2=\"4\"/><line x1=\"10\" y1=\"1\" x2=\"10\" y2=\"4\"/><line x1=\"14\" y1=\"1\" x2=\"14\" y2=\"4\"/></svg>"),
        new("مطاعم", "#DC2626", "<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><path d=\"M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2\"/><path d=\"M7 2v20\"/><path d=\"M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7\"/></svg>"),
        new("حلويات", "#EC4899", "<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><path d=\"M12 8c-2.8 0-5 2.2-5 5v7h10v-7c0-2.8-2.2-5-5-5z\"/><path d=\"M12 8V4\"/><path d=\"M8 8l-1.5-2\"/><path d=\"M16 8l1.5-2\"/></svg>"),
        new("فطور", "#F59E0B", "<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><path d=\"M8 14s1.5 2 4 2 4-2 4-2\"/><line x1=\"9\" y1=\"9\" x2=\"9.01\" y2=\"9\"/><line x1=\"15\" y1=\"9\" x2=\"15.01\" y2=\"9\"/></svg>"),
    };

    private List<SearchResult> SearchResults = new();

    private IEnumerable<SearchResult> FilteredResults => ActiveFilter switch
    {
        "offers" => SearchResults.Where(r => r.Type == "offer"),
        "vendors" => SearchResults.Where(r => r.Type == "vendor"),
        _ => SearchResults
    };

    private void OnSearchInput(ChangeEventArgs e)
    {
        SearchQuery = e.Value?.ToString() ?? "";

        // Reset search state when query changes
        if (string.IsNullOrWhiteSpace(SearchQuery))
        {
            HasSearched = false;
            SearchResults.Clear();
            IsSearching = false;
            _debounceTimer?.Stop();
            return;
        }

        // Debounce auto-search
        _debounceTimer?.Stop();
        _debounceTimer = new System.Timers.Timer(500);
        _debounceTimer.Elapsed += async (s, e) =>
        {
            _debounceTimer?.Stop();
            await InvokeAsync(async () =>
            {
                await PerformSearch();
            });
        };
        _debounceTimer.Start();
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(SearchQuery))
        {
            _debounceTimer?.Stop();
            await PerformSearch();
        }
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(SearchQuery)) return;

        IsSearching = true;
        HasSearched = true;
        StateHasChanged();

        // Add to recent searches
        if (!RecentSearches.Contains(SearchQuery))
        {
            RecentSearches.Insert(0, SearchQuery);
            if (RecentSearches.Count > 5)
            {
                RecentSearches.RemoveAt(5);
            }
        }

        // Simulate API call
        await Task.Delay(600);

        // Mock results - filter based on query
        var query = SearchQuery.ToLower();
        var allResults = new List<SearchResult>
        {
            new("offer", "عرض القهوة المثلجة", "ستاربكس", "/images/coffee.jpg", 15, 25, 40),
            new("vendor", "ستاربكس", "كافيه • مشروبات", "/images/starbucks.jpg", 0, 0, 0),
            new("offer", "كومبو الفطور", "دانكن", "/images/breakfast.jpg", 25, 35, 29),
            new("offer", "بيتزا مارجريتا", "بيتزا هت", "/images/pizza.jpg", 35, 45, 22),
            new("offer", "قهوة لاتيه", "كافيه نيرو", "/images/latte.jpg", 18, 22, 18),
            new("vendor", "بيتزا هت", "مطعم • بيتزا", "/images/pizzahut.jpg", 0, 0, 0),
        };

        // Simple search matching
        SearchResults = allResults.Where(r =>
            r.Title.Contains(query) ||
            r.Subtitle.Contains(query) ||
            r.Title.Contains(SearchQuery) ||
            r.Subtitle.Contains(SearchQuery)
        ).ToList();

        IsSearching = false;
        StateHasChanged();
    }

    private void ApplySearch(string query)
    {
        SearchQuery = query;
        _ = PerformSearch();
    }

    private void ClearSearch()
    {
        SearchQuery = "";
        SearchResults.Clear();
        HasSearched = false;
        IsSearching = false;
        _debounceTimer?.Stop();
    }

    private void ClearRecentSearches()
    {
        RecentSearches.Clear();
    }

    private void RemoveRecentSearch(string search)
    {
        RecentSearches.Remove(search);
    }

    private void SetFilter(string filter)
    {
        ActiveFilter = filter;
    }

    private void ViewResult(SearchResult result)
    {
        if (result.Type == "offer")
        {
            Navigation.NavigateTo($"/offers/{Guid.NewGuid()}"); // Would use actual ID
        }
        else
        {
            // Navigate to vendor page
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private record CategoryItem(string Name, string Color, string Icon);
    private record SearchResult(string Type, string Title, string Subtitle, string ImageUrl, decimal Price, decimal OriginalPrice, int Discount);
}

<style>
    .search-page {
        min-height: 100vh;
        background: #F3F4F6;
    }

    /* Search Header */
    .search-header {
        background: white;
        padding: 16px;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }

    .search-bar-container {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .back-btn {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        border: none;
        background: #F3F4F6;
        color: #374151;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s;
    }

    .back-btn:hover {
        background: #E5E7EB;
    }

    .search-input-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 12px;
        background: #F3F4F6;
        border-radius: 14px;
        padding: 0 16px;
        transition: all 0.2s;
    }

    .search-input-wrapper:focus-within {
        background: #F9FAFB;
        box-shadow: 0 0 0 2px #F97316;
    }

    .search-icon {
        color: #9CA3AF;
        flex-shrink: 0;
    }

    .search-input {
        flex: 1;
        border: none;
        background: none;
        padding: 14px 0;
        font-size: 16px;
        color: #1F2937;
    }

    .search-input:focus {
        outline: none;
    }

    .search-input::placeholder {
        color: #9CA3AF;
    }

    .clear-btn {
        padding: 4px;
        background: none;
        border: none;
        color: #9CA3AF;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Search Content */
    .search-content {
        padding: 20px 16px 100px;
    }

    /* Suggestions */
    .suggestion-section {
        margin-bottom: 28px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .suggestion-section h3 {
        font-size: 16px;
        font-weight: 700;
        color: #1F2937;
        margin: 0;
    }

    .clear-all-btn {
        background: none;
        border: none;
        color: #F97316;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
    }

    /* Recent Searches */
    .recent-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .recent-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        background: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: right;
        width: 100%;
    }

    .recent-item:hover {
        background: #F9FAFB;
    }

    .recent-item svg {
        color: #9CA3AF;
        flex-shrink: 0;
    }

    .recent-item span {
        flex: 1;
        font-size: 15px;
        color: #374151;
    }

    .remove-recent {
        padding: 4px;
        background: none;
        border: none;
        color: #D1D5DB;
        cursor: pointer;
    }

    .remove-recent:hover {
        color: #9CA3AF;
    }

    /* Popular Tags */
    .popular-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .popular-tag {
        padding: 10px 18px;
        background: white;
        border: 2px solid #E5E7EB;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
    }

    .popular-tag:hover {
        border-color: #F97316;
        color: #F97316;
    }

    /* Categories Grid */
    .categories-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }

    .category-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 16px 8px;
        background: white;
        border: none;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .category-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .category-icon {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .category-card span {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
    }

    /* Loading State */
    .search-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #E5E7EB;
        border-top-color: #F97316;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-bottom: 16px;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .search-loading p {
        color: #6B7280;
        font-size: 15px;
    }

    /* Search Results */
    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .results-count {
        font-size: 14px;
        color: #6B7280;
    }

    .filter-chips {
        display: flex;
        gap: 8px;
    }

    .filter-chip {
        padding: 8px 16px;
        background: white;
        border: 2px solid #E5E7EB;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        color: #6B7280;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-chip.active {
        background: #F97316;
        border-color: #F97316;
        color: white;
    }

    /* Results List */
    .results-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .result-card {
        display: flex;
        gap: 14px;
        background: white;
        border-radius: 16px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
    }

    .result-image {
        width: 90px;
        height: 90px;
        border-radius: 12px;
        overflow: hidden;
        flex-shrink: 0;
        position: relative;
    }

    .result-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .image-placeholder {
        width: 100%;
        height: 100%;
        background: #F3F4F6;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #D1D5DB;
    }

    .discount-badge {
        position: absolute;
        top: 6px;
        right: 6px;
        background: #DC2626;
        color: white;
        font-size: 11px;
        font-weight: 700;
        padding: 3px 8px;
        border-radius: 8px;
    }

    .result-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .result-type-badge {
        display: inline-block;
        width: fit-content;
        font-size: 11px;
        font-weight: 600;
        padding: 3px 10px;
        border-radius: 8px;
    }

    .result-type-badge.offer {
        background: #FEF3C7;
        color: #D97706;
    }

    .result-type-badge.vendor {
        background: #DBEAFE;
        color: #2563EB;
    }

    .result-title {
        font-size: 15px;
        font-weight: 600;
        color: #1F2937;
        margin: 0;
    }

    .result-subtitle {
        font-size: 13px;
        color: #6B7280;
        margin: 0;
    }

    .result-price {
        display: flex;
        align-items: baseline;
        gap: 8px;
        margin-top: auto;
    }

    .current-price {
        font-size: 16px;
        font-weight: 700;
        color: #F97316;
    }

    .original-price {
        font-size: 13px;
        color: #9CA3AF;
        text-decoration: line-through;
    }

    /* No Results */
    .no-results {
        text-align: center;
        padding: 60px 20px;
    }

    .no-results-icon {
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, #FFF7ED, #FFEDD5);
        border-radius: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        color: #F97316;
    }

    .no-results h3 {
        font-size: 20px;
        font-weight: 700;
        color: #1F2937;
        margin: 0 0 8px;
    }

    .no-results p {
        font-size: 15px;
        color: #6B7280;
        margin: 0 0 24px;
    }

    .try-again-btn {
        padding: 12px 28px;
        background: linear-gradient(135deg, #F97316, #EA580C);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
    }
</style>
