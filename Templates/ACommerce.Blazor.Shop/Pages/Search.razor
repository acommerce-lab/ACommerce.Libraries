@page "/search"
@using ACommerce.Client.Categories
@using ACommerce.Client.ProductListings
@inject ProductListingsClient ListingsClient
@inject CategoriesClient CategoriesClient
@inject CartStateService CartState
@inject NavigationManager Navigation
@inject NotificationService Notification

<PageTitle>Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„Ø§ØªØ± - Search & Filters</PageTitle>

<div class="search-page">
	<!-- Search Bar -->
	<div class="search-header">
		<SfTextBox @bind-Value="searchQuery"
				   Placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª..."
				   CssClass="search-input"
				   @onkeyup="HandleSearchKeyPress">
			<InputGroupButtons>
				<InputGroupButton>
					<SfButton IsPrimary="true" OnClick="PerformSearch">
						ğŸ” Ø¨Ø­Ø«
					</SfButton>
				</InputGroupButton>
			</InputGroupButtons>
		</SfTextBox>
	</div>

	<div class="search-content">
		<!-- Filters Sidebar -->
		<aside class="filters-sidebar">
			<SfCard>
				<CardHeader Title="Ø§Ù„ÙÙ„Ø§ØªØ±" />
				<CardContent>
					<!-- Category Filter -->
					<div class="filter-group">
						<h4>Ø§Ù„ØªØµÙ†ÙŠÙ</h4>
						<SfDropDownList TValue="Guid?"
										TItem="CategoryDto"
										@bind-Value="filters.CategoryId"
										DataSource="@categories"
										Placeholder="Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ">
							<DropDownListFieldSettings Text="Name" Value="Id" />
							<DropDownListEvents TValue="Guid?" TItem="CategoryDto" ValueChange="OnCategoryFilterChanged" />
						</SfDropDownList>
					</div>

					<!-- Price Range -->
					<div class="filter-group">
						<h4>Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±</h4>
						<div class="price-inputs">
							<SfNumericTextBox @bind-Value="filters.MinPrice"
											  Placeholder="Ù…Ù†"
											  Format="C0"
											  Min="0">
							</SfNumericTextBox>
							<span>Ø¥Ù„Ù‰</span>
							<SfNumericTextBox @bind-Value="filters.MaxPrice"
											  Placeholder="Ø¥Ù„Ù‰"
											  Format="C0"
											  Min="0">
							</SfNumericTextBox>
						</div>
						<SfButton CssClass="apply-filter-btn" OnClick="ApplyFilters">
							ØªØ·Ø¨ÙŠÙ‚
						</SfButton>
					</div>

					<!-- Rating Filter -->
					<div class="filter-group">
						<h4>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h4>
						<SfDropDownList TValue="int?"
										TItem="RatingOption"
										@bind-Value="filters.MinRating"
										DataSource="@ratingOptions"
										Placeholder="Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…">
							<DropDownListFieldSettings Text="Label" Value="Value" />
							<DropDownListEvents TValue="int?" TItem="RatingOption" ValueChange="OnRatingFilterChanged" />
						</SfDropDownList>
					</div>

					<!-- Availability -->
					<div class="filter-group">
						<SfCheckBox @bind-Checked="filters.InStockOnly"
									Label="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙ‚Ø·"
									TChecked="bool">
							<CheckBoxEvents TChecked="bool" ValueChange="OnCheckboxFilterChanged" />
						</SfCheckBox>
					</div>

					<!-- Featured -->
					<div class="filter-group">
						<SfCheckBox @bind-Checked="filters.FeaturedOnly"
									Label="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© ÙÙ‚Ø·"
									TChecked="bool">
							<CheckBoxEvents TChecked="bool" ValueChange="OnCheckboxFilterChanged" />
						</SfCheckBox>
					</div>

					<!-- Clear Filters -->
					<SfButton CssClass="clear-filters-btn" OnClick="ClearFilters">
						Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
					</SfButton>
				</CardContent>
			</SfCard>
		</aside>

		<!-- Results -->
		<div class="search-results">
			<div class="results-header">
				<h3>@GetResultsText()</h3>
				<SfDropDownList TValue="string"
								TItem="SortOption"
								@bind-Value="sortBy"
								DataSource="@sortOptions"
								Placeholder="ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨">
					<DropDownListFieldSettings Text="Label" Value="Value" />
					<DropDownListEvents TValue="string" TItem="SortOption" ValueChange="OnSortChanged" />
				</SfDropDownList>
			</div>

			@if (isLoading)
			{
				<div class="loading-container">
					<SfSpinner />
					<p>Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«...</p>
				</div>
			}
			else if (searchResults == null || !searchResults.Any())
			{
				<div class="no-results">
					<div class="no-results-icon">ğŸ”</div>
					<h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h3>
					<p>Ø¬Ø±Ø¨ ØªØºÙŠÙŠØ± Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„ÙÙ„Ø§ØªØ±</p>
				</div>
			}
			else
			{
				<div class="products-grid">
					@foreach (var listing in searchResults)
					{
						<ProductCard Listing="@listing" OnAddToCart="HandleAddToCart" />
					}
				</div>

				<!-- Pagination -->
				@if (totalPages > 1)
				{
					<div class="pagination">
						<SfPager CurrentPage="@currentPage"
								 PageCount="@totalPages"
								 PageSize="@pageSize"
								 TotalItemsCount="@totalItems">
							<PagerEvents PageChanged="OnPageChanged" />
						</SfPager>
					</div>
				}
			}
		</div>
	</div>
</div>

@code {
	[SupplyParameterFromQuery]
	private string? q { get; set; }

	private string searchQuery = "";
	private List<CategoryDto>? categories;
	private List<ProductListingDto>? searchResults;
	private bool isLoading = false;

	private SearchFilters filters = new();
	private string sortBy = "relevance";

	private int currentPage = 1;
	private int pageSize = 20;
	private int totalItems = 0;
	private int totalPages = 0;

	private List<SortOption> sortOptions = new()
	{
		new() { Value = "relevance", Label = "Ø§Ù„Ø£ÙƒØ«Ø± ØµÙ„Ø©" },
		new() { Value = "price_asc", Label = "Ø§Ù„Ø³Ø¹Ø±: Ù…Ù† Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø£Ø¹Ù„Ù‰" },
		new() { Value = "price_desc", Label = "Ø§Ù„Ø³Ø¹Ø±: Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ù‚Ù„" },
		new() { Value = "newest", Label = "Ø§Ù„Ø£Ø­Ø¯Ø«" },
		new() { Value = "bestsellers", Label = "Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹" },
		new() { Value = "rating", Label = "Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹" }
	};

	private List<RatingOption> ratingOptions = new()
	{
		new() { Value = 4, Label = "â­â­â­â­ ÙˆØ£Ø¹Ù„Ù‰" },
		new() { Value = 3, Label = "â­â­â­ ÙˆØ£Ø¹Ù„Ù‰" },
		new() { Value = 2, Label = "â­â­ ÙˆØ£Ø¹Ù„Ù‰" }
	};

	protected override async Task OnInitializedAsync()
	{
		searchQuery = q ?? "";
		await LoadCategories();
		await PerformSearch();
	}

	private async Task LoadCategories()
	{
		try
		{
			categories = await CategoriesClient.GetAllAsync();
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª: {ex.Message}");
		}
	}

	private async Task PerformSearch()
	{
		isLoading = true;
		try
		{
			var request = new SearchListingsRequest
			{
				Query = searchQuery,
				CategoryId = filters.CategoryId,
				MinPrice = filters.MinPrice,
				MaxPrice = filters.MaxPrice,
				MinRating = filters.MinRating,
				InStockOnly = filters.InStockOnly,
				IsFeatured = filters.FeaturedOnly ? true : null,
				PageNumber = currentPage,
				PageSize = pageSize,
				SortBy = GetSortField(sortBy),
				SortDescending = sortBy.EndsWith("_desc") || sortBy == "newest" || sortBy == "bestsellers" || sortBy == "rating"
			};

			var result = await ListingsClient.SearchAsync(request);
			searchResults = result?.Items ?? new();
			totalItems = result?.TotalCount ?? 0;
			totalPages = (int)Math.Ceiling(totalItems / (double)pageSize);
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: {ex.Message}");
		}
		finally
		{
			isLoading = false;
		}
	}

	private string GetSortField(string sort) => sort switch
	{
		"price_asc" or "price_desc" => "Price",
		"newest" => "CreatedAt",
		"bestsellers" => "Sales",
		"rating" => "Rating",
		_ => "Relevance"
	};

	private void HandleSearchKeyPress(KeyboardEventArgs e)
	{
		if (e.Key == "Enter")
		{
			_ = PerformSearch();
		}
	}

	private async Task ApplyFilters()
	{
		currentPage = 1;
		await PerformSearch();
	}

	private async Task OnCategoryFilterChanged(ChangeEventArgs<Guid?, CategoryDto> args)
	{
		currentPage = 1;
		await PerformSearch();
	}

	private async Task OnRatingFilterChanged(ChangeEventArgs<int?, RatingOption> args)
	{
		currentPage = 1;
		await PerformSearch();
	}

	private async Task OnCheckboxFilterChanged(ChangeEventArgs<bool> args)
	{
		currentPage = 1;
		await PerformSearch();
	}

	private async Task OnSortChanged(ChangeEventArgs<string, SortOption>? args = null)
	{
		currentPage = 1;
		await PerformSearch();
	}

	private async Task OnPageChanged(PageChangedEventArgs args)
	{
		currentPage = args.CurrentPage;
		await PerformSearch();
	}

	private async Task ClearFilters()
	{
		filters = new SearchFilters();
		sortBy = "relevance";
		currentPage = 1;
		await PerformSearch();
	}

	private async Task HandleAddToCart(Guid listingId)
	{
		var success = await CartState.AddToCartAsync(listingId, 1);
		if (success)
		{
			Notification.ShowSuccess("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©");
		}
	}

	private string GetResultsText()
	{
		if (totalItems == 0) return "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬";
		return $"Ø¹Ø±Ø¶ {searchResults?.Count ?? 0} Ù…Ù† {totalItems} Ù…Ù†ØªØ¬";
	}

	// Models
	private class SearchFilters
	{
		public Guid? CategoryId { get; set; }
		public decimal? MinPrice { get; set; }
		public decimal? MaxPrice { get; set; }
		public int? MinRating { get; set; }
		public bool InStockOnly { get; set; }
		public bool FeaturedOnly { get; set; }
	}

	private class SortOption
	{
		public string Value { get; set; } = string.Empty;
		public string Label { get; set; } = string.Empty;
	}

	private class RatingOption
	{
		public int Value { get; set; }
		public string Label { get; set; } = string.Empty;
	}
}

<style>
	.search-page {
		padding: var(--spacing-lg);
	}

	.search-header {
		margin-bottom: var(--spacing-xl);
	}

	.search-input {
		width: 100%;
		max-width: 800px;
		margin: 0 auto;
	}

	.search-content {
		display: grid;
		grid-template-columns: 280px 1fr;
		gap: var(--spacing-xl);
	}

	/* Filters */
	.filters-sidebar {
		position: sticky;
		top: var(--spacing-lg);
		height: fit-content;
	}

	.filter-group {
		margin-bottom: var(--spacing-lg);
		padding-bottom: var(--spacing-lg);
		border-bottom: 1px solid var(--border-color);
	}

	.filter-group:last-child {
		border-bottom: none;
	}

	.filter-group h4 {
		margin-bottom: var(--spacing-md);
		font-size: var(--font-size-base);
		font-weight: 600;
	}

	.price-inputs {
		display: flex;
		align-items: center;
		gap: var(--spacing-sm);
	}

	.apply-filter-btn {
		width: 100%;
		margin-top: var(--spacing-sm);
	}

	.clear-filters-btn {
		width: 100%;
		margin-top: var(--spacing-md);
	}

	/* Results */
	.search-results {
		min-height: 600px;
	}

	.results-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: var(--spacing-lg);
		padding-bottom: var(--spacing-md);
		border-bottom: 2px solid var(--border-color);
	}

	.products-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
		gap: var(--spacing-lg);
		margin-bottom: var(--spacing-xl);
	}

	.no-results {
		text-align: center;
		padding: var(--spacing-xl) 0;
	}

	.no-results-icon {
		font-size: 64px;
		margin-bottom: var(--spacing-md);
		opacity: 0.5;
	}

	.no-results h3 {
		margin-bottom: var(--spacing-sm);
		color: var(--text-primary);
	}

	.no-results p {
		color: var(--text-secondary);
	}

	.pagination {
		margin-top: var(--spacing-xl);
		display: flex;
		justify-content: center;
	}

	.loading-container {
		text-align: center;
		padding: var(--spacing-xl);
	}

	/* Responsive */
	@@media (max-width: 768px) {
		.search-content {
			grid-template-columns: 1fr;
		}

		.filters-sidebar {
			position: static;
		}
	}
</style>
