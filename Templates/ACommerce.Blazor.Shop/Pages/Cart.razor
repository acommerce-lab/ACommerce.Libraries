@page "/cart"
@inject CartStateService CartState
@inject NavigationManager Navigation
@inject NotificationService Notification

<PageTitle>Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ - Shopping Cart</PageTitle>

<div class="cart-page">
	<h1>Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h1>

	@if (CartState.IsLoading)
	{
		<div class="loading-container">
			<SfSpinner />
		</div>
	}
	else if (CartState.CurrentCart == null || !CartState.CurrentCart.Items.Any())
	{
		<div class="empty-cart">
			<div class="empty-icon">ğŸ›’</div>
			<h3>Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©</h3>
			<p>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø³Ù„ØªÙƒ</p>
			<SfButton IsPrimary="true" OnClick="@(() => Navigation.NavigateTo("/products"))">
				ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
			</SfButton>
		</div>
	}
	else
	{
		<div class="cart-content">
			<div class="cart-items-section">
				<SfCard>
					<CardHeader Title="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" />
					<CardContent>
						<div class="cart-items">
							@foreach (var item in CartState.CurrentCart.Items)
							{
								<div class="cart-item">
									<div class="item-image">
										@if (!string.IsNullOrEmpty(item.ImageUrl))
										{
											<img src="@item.ImageUrl" alt="@item.ProductName" />
										}
										else
										{
											<div class="image-placeholder">ğŸ“¦</div>
										}
									</div>

									<div class="item-info">
										<h4>@item.ProductName</h4>
										<p class="item-vendor">@item.VendorName</p>
										@if (item.Properties.Any())
										{
											<div class="item-properties">
												@foreach (var prop in item.Properties)
												{
													<span class="property-tag">@prop.Key: @prop.Value</span>
												}
											</div>
										}
									</div>

									<div class="item-quantity">
										<SfNumericTextBox @bind-Value="item.Quantity"
														  Min="1"
														  Max="@item.MaxQuantity"
														  ShowSpinButton="true"
														  Format="n0">
											<NumericTextBoxEvents ValueChange="() => UpdateQuantity(item.Id, item.Quantity)" />
										</SfNumericTextBox>
									</div>

									<div class="item-price">
										<p class="price">@item.TotalPrice.ToString("C")</p>
										<p class="unit-price">@item.UnitPrice.ToString("C") / ÙˆØ­Ø¯Ø©</p>
									</div>

									<div class="item-actions">
										<SfButton IconCss="e-icons e-delete"
												  CssClass="delete-btn"
												  OnClick="() => RemoveItem(item.Id)">
										</SfButton>
									</div>
								</div>
							}
						</div>
					</CardContent>
				</SfCard>
			</div>

			<div class="cart-summary-section">
				<SfCard CssClass="summary-card">
					<CardHeader Title="Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨" />
					<CardContent>
						<div class="summary-row">
							<span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span>
							<span>@CartState.SubTotal.ToString("C")</span>
						</div>

						@if (CartState.CurrentCart.DiscountAmount > 0)
						{
							<div class="summary-row discount">
								<span>Ø§Ù„Ø®ØµÙ…</span>
								<span>-@CartState.CurrentCart.DiscountAmount.ToString("C")</span>
							</div>
						}

						<div class="summary-row">
							<span>Ø§Ù„Ø´Ø­Ù†</span>
							<span>@GetShippingText()</span>
						</div>

						<div class="summary-row">
							<span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</span>
							<span>@CartState.CurrentCart.TaxAmount.ToString("C")</span>
						</div>

						<div class="summary-divider"></div>

						<div class="summary-row total">
							<strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</strong>
							<strong class="total-amount">@CartState.Total.ToString("C")</strong>
						</div>

						<!-- Coupon -->
						<div class="coupon-section">
							<SfTextBox @bind-Value="couponCode"
									   Placeholder="Ø±Ù…Ø² Ø§Ù„Ø®ØµÙ…">
								<InputGroupButtons>
									<InputGroupButton>
										<SfButton OnClick="ApplyCoupon" Disabled="@isApplyingCoupon">
											ØªØ·Ø¨ÙŠÙ‚
										</SfButton>
									</InputGroupButton>
								</InputGroupButtons>
							</SfTextBox>
						</div>

						<SfButton IsPrimary="true"
								  CssClass="checkout-btn"
								  OnClick="GoToCheckout">
							Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹
						</SfButton>
					</CardContent>
				</SfCard>

				<!-- Payment Methods Info -->
				<div class="payment-methods-info">
					<p>Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø©:</p>
					<div class="payment-icons">
						<span>ğŸ’³</span>
						<span>ğŸ“±</span>
						<span>ğŸ</span>
					</div>
				</div>
			</div>
		</div>
	}
</div>

@code {
	private string couponCode = "";
	private bool isApplyingCoupon = false;

	protected override async Task OnInitializedAsync()
	{
		await CartState.LoadCartAsync();
	}

	private async Task UpdateQuantity(Guid itemId, int newQuantity)
	{
		await CartState.UpdateItemQuantityAsync(itemId, newQuantity);
	}

	private async Task RemoveItem(Guid itemId)
	{
		var success = await CartState.RemoveFromCartAsync(itemId);
		if (success)
		{
			Notification.ShowSuccess("ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø©");
		}
	}

	private async Task ApplyCoupon()
	{
		if (string.IsNullOrWhiteSpace(couponCode)) return;

		isApplyingCoupon = true;
		try
		{
			var success = await CartState.ApplyCouponAsync(couponCode);
			if (success)
			{
				Notification.ShowSuccess("ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø±Ù…Ø² Ø§Ù„Ø®ØµÙ…");
				couponCode = "";
			}
			else
			{
				Notification.ShowError("Ø±Ù…Ø² Ø§Ù„Ø®ØµÙ… ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©");
			}
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£: {ex.Message}");
		}
		finally
		{
			isApplyingCoupon = false;
		}
	}

	private void GoToCheckout()
	{
		Navigation.NavigateTo("/checkout");
	}

	private string GetShippingText()
	{
		var shipping = CartState.CurrentCart?.ShippingAmount ?? 0;
		return shipping == 0 ? "Ù…Ø¬Ø§Ù†Ø§Ù‹" : shipping.ToString("C");
	}
}

<style>
	.cart-page {
		max-width: 1400px;
		margin: 0 auto;
		padding: var(--spacing-lg);
	}

	.cart-page h1 {
		margin-bottom: var(--spacing-xl);
	}

	.cart-content {
		display: grid;
		grid-template-columns: 1fr 400px;
		gap: var(--spacing-xl);
	}

	/* Cart Items */
	.cart-items {
		display: flex;
		flex-direction: column;
		gap: var(--spacing-md);
	}

	.cart-item {
		display: flex;
		gap: var(--spacing-md);
		padding: var(--spacing-md);
		border-bottom: 1px solid var(--border-color);
		align-items: center;
	}

	.item-image {
		width: 100px;
		height: 100px;
		border-radius: var(--border-radius);
		overflow: hidden;
		background: var(--bg-secondary);
		flex-shrink: 0;
	}

	.item-image img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.image-placeholder {
		width: 100%;
		height: 100%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 48px;
		opacity: 0.3;
	}

	.item-info {
		flex: 1;
		min-width: 0;
	}

	.item-info h4 {
		margin: 0 0 var(--spacing-xs) 0;
		font-size: var(--font-size-base);
	}

	.item-vendor {
		margin: 0;
		font-size: var(--font-size-sm);
		color: var(--text-secondary);
	}

	.item-properties {
		display: flex;
		flex-wrap: wrap;
		gap: var(--spacing-xs);
		margin-top: var(--spacing-sm);
	}

	.property-tag {
		background: var(--bg-tertiary);
		padding: 2px 8px;
		border-radius: 12px;
		font-size: var(--font-size-xs);
	}

	.item-quantity {
		width: 120px;
	}

	.item-price {
		text-align: center;
		min-width: 100px;
	}

	.item-price .price {
		margin: 0;
		font-size: 20px;
		font-weight: 600;
		color: var(--price-color);
	}

	.item-price .unit-price {
		margin: 0;
		font-size: var(--font-size-xs);
		color: var(--text-secondary);
	}

	/* Summary */
	.cart-summary-section {
		position: sticky;
		top: 80px;
		height: fit-content;
	}

	.summary-card {
		margin-bottom: var(--spacing-md);
	}

	.summary-row {
		display: flex;
		justify-content: space-between;
		padding: var(--spacing-sm) 0;
	}

	.summary-row.discount {
		color: var(--success-color);
	}

	.summary-row.total {
		font-size: var(--font-size-lg);
		padding-top: var(--spacing-md);
	}

	.total-amount {
		color: var(--price-color);
		font-size: 24px;
	}

	.summary-divider {
		height: 1px;
		background: var(--border-color);
		margin: var(--spacing-md) 0;
	}

	.coupon-section {
		margin: var(--spacing-lg) 0;
	}

	.checkout-btn {
		width: 100%;
		padding: var(--spacing-md);
		font-size: 18px;
		font-weight: 600;
	}

	.payment-methods-info {
		text-align: center;
		padding: var(--spacing-md);
		background: var(--bg-secondary);
		border-radius: var(--border-radius);
	}

	.payment-methods-info p {
		margin-bottom: var(--spacing-sm);
		font-size: var(--font-size-sm);
		color: var(--text-secondary);
	}

	.payment-icons {
		display: flex;
		justify-content: center;
		gap: var(--spacing-md);
		font-size: 32px;
	}

	.empty-cart {
		text-align: center;
		padding: var(--spacing-xl) 0;
	}

	.empty-icon {
		font-size: 80px;
		margin-bottom: var(--spacing-md);
		opacity: 0.3;
	}

	.loading-container {
		text-align: center;
		padding: var(--spacing-xl);
	}

	/* Responsive */
	@media (max-width: 1024px) {
		.cart-content {
			grid-template-columns: 1fr;
		}

		.cart-summary-section {
			position: static;
		}
	}
</style>
