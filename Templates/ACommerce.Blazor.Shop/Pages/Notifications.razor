@page "/notifications"
@inject NotificationsClient NotificationsClient
@inject RealtimeClient RealtimeClient
@inject NavigationManager Navigation
@inject NotificationService Notification
@implements IAsyncDisposable

<PageTitle>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª - Notifications</PageTitle>

<div class="notifications-page">
	<SfCard>
		<CardHeader>
			<div class="notifications-header">
				<h2>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
				<div class="header-actions">
					@if (unreadCount > 0)
					{
						<SfButton OnClick="MarkAllAsRead">
							âœ“ ØªØ¹Ù„ÙŠÙ… Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡
						</SfButton>
					}
					<SfButton OnClick="ManagePushNotifications">
						âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
					</SfButton>
				</div>
			</div>
		</CardHeader>

		<!-- Tabs -->
		<CardContent>
			<SfTab>
				<TabItems>
					<TabItem>
						<ChildContent>
							<TabHeader Text="@($"Ø§Ù„ÙƒÙ„ ({totalCount})")" />
						</ChildContent>
						<ContentTemplate>
							<div class="notifications-list">
								@if (isLoading)
								{
									<div class="loading-container">
										<SfSpinner />
									</div>
								}
								else
								{
									<NotificationsList Items="@allNotifications"
													   OnItemClick="HandleNotificationClick"
													   OnDelete="HandleDelete" />
								}
							</div>
						</ContentTemplate>
					</TabItem>

					<TabItem>
						<ChildContent>
							<TabHeader Text="@($"ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© ({unreadCount})")" />
						</ChildContent>
						<ContentTemplate>
							<div class="notifications-list">
								<NotificationsList Items="@unreadNotifications"
												   OnItemClick="HandleNotificationClick"
												   OnDelete="HandleDelete" />
							</div>
						</ContentTemplate>
					</TabItem>

					<TabItem>
						<ChildContent>
							<TabHeader Text="Ø§Ù„Ø·Ù„Ø¨Ø§Øª" />
						</ChildContent>
						<ContentTemplate>
							<div class="notifications-list">
								<NotificationsList Items="@orderNotifications"
												   OnItemClick="HandleNotificationClick"
												   OnDelete="HandleDelete" />
							</div>
						</ContentTemplate>
					</TabItem>

					<TabItem>
						<ChildContent>
							<TabHeader Text="Ø§Ù„Ø±Ø³Ø§Ø¦Ù„" />
						</ChildContent>
						<ContentTemplate>
							<div class="notifications-list">
								<NotificationsList Items="@messageNotifications"
												   OnItemClick="HandleNotificationClick"
												   OnDelete="HandleDelete" />
							</div>
						</ContentTemplate>
					</TabItem>
				</TabItems>
			</SfTab>
		</CardContent>
	</SfCard>
</div>

<!-- Push Notification Settings Dialog -->
<SfDialog @bind-Visible="showPushSettings"
		  Width="500px"
		  IsModal="true">
	<DialogTemplates>
		<Header>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</Header>
		<Content>
			<div class="push-settings-content">
				<div class="settings-info">
					<p>Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯ÙØ¹ (Push Notifications) Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ</p>
				</div>

				<div class="settings-group">
					<SfCheckBox @bind-Checked="pushSettings.EnablePush"
								Label="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©"
								TChecked="bool" />
				</div>

				<div class="settings-group">
					<h4>Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:</h4>
					<SfCheckBox @bind-Checked="pushSettings.OrderUpdates"
								Label="ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª"
								TChecked="bool" />
					<SfCheckBox @bind-Checked="pushSettings.ChatMessages"
								Label="Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"
								TChecked="bool" />
					<SfCheckBox @bind-Checked="pushSettings.Promotions"
								Label="Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª"
								TChecked="bool" />
					<SfCheckBox @bind-Checked="pushSettings.SystemAlerts"
								Label="ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…"
								TChecked="bool" />
				</div>

				<div class="settings-group">
					<h4>Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø©:</h4>
					<SfTimePicker @bind-Value="pushSettings.QuietTimeStart"
								  Placeholder="Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù‡Ø§Ø¯Ø¦" />
					<SfTimePicker @bind-Value="pushSettings.QuietTimeEnd"
								  Placeholder="Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù‡Ø§Ø¯Ø¦" />
					<p class="settings-hint">Ù„Ù† ØªØªÙ„Ù‚Ù‰ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø®Ù„Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</p>
				</div>

				@if (pushSettings.EnablePush && !isPushSubscribed)
				{
					<div class="firebase-info">
						<p>ğŸ”” Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø­ÙØ¸" Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©</p>
					</div>
				}
			</div>
		</Content>
		<FooterTemplate>
			<SfButton IsPrimary="true" OnClick="SavePushSettings">Ø­ÙØ¸</SfButton>
			<SfButton OnClick="() => showPushSettings = false">Ø¥Ù„ØºØ§Ø¡</SfButton>
		</FooterTemplate>
	</DialogTemplates>
</SfDialog>

@code {
	private List<Components.NotificationsList.NotificationDto>? allNotifications;
	private List<Components.NotificationsList.NotificationDto>? unreadNotifications => allNotifications?.Where(n => !n.IsRead).ToList();
	private List<Components.NotificationsList.NotificationDto>? orderNotifications => allNotifications?.Where(n => n.Type == "Order").ToList();
	private List<Components.NotificationsList.NotificationDto>? messageNotifications => allNotifications?.Where(n => n.Type == "Message").ToList();

	private bool isLoading = true;
	private int totalCount => allNotifications?.Count ?? 0;
	private int unreadCount => unreadNotifications?.Count ?? 0;

	private bool showPushSettings = false;
	private bool isPushSubscribed = false;
	private PushSettings pushSettings = new();

	protected override async Task OnInitializedAsync()
	{
		await LoadNotifications();
		await ConnectToRealtime();
		await CheckPushSubscription();
	}

	private async Task LoadNotifications()
	{
		isLoading = true;
		try
		{
			// TODO: Map from ACommerce.Client.Notifications.NotificationResponse to local NotificationDto
			// var sdkNotifications = await NotificationsClient.GetMyNotificationsAsync();
			// For now using mock data
			allNotifications = new List<Components.NotificationsList.NotificationDto>
			{
				new() { Id = Guid.NewGuid(), Type = "Order", Title = "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯", Message = "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­", IsRead = false, CreatedAt = DateTime.Now.AddHours(-1) },
				new() { Id = Guid.NewGuid(), Type = "Message", Title = "Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©", Message = "Ù„Ø¯ÙŠÙƒ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¨Ø§Ø¦Ø¹", IsRead = true, CreatedAt = DateTime.Now.AddDays(-1) },
				new() { Id = Guid.NewGuid(), Type = "Order", Title = "ØªÙ… Ø§Ù„Ø´Ø­Ù†", Message = "Ø·Ù„Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ", IsRead = false, CreatedAt = DateTime.Now.AddDays(-2) }
			};
			await Task.Delay(100); // Simulate load
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: {ex.Message}");
		}
		finally
		{
			isLoading = false;
		}
	}

	private async Task ConnectToRealtime()
	{
		try
		{
			await RealtimeClient.ConnectAsync("Notifications", "/hubs/notifications");

			// Listen for new notifications
			RealtimeClient.On<Components.NotificationsList.NotificationDto>("NewNotification", async (notification) =>
			{
				allNotifications ??= new();
				allNotifications.Insert(0, notification);
				await InvokeAsync(StateHasChanged);

				// Show toast
				Notification.ShowInfo(notification.Title);
			});
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: {ex.Message}");
		}
	}

	private async Task CheckPushSubscription()
	{
		try
		{
			// TODO: Map from ACommerce.Client.Notifications.PushSettings to local PushSettings
			// var sdkSettings = await NotificationsClient.GetPushSettingsAsync();
			// For now using mock data
			pushSettings = new PushSettings
			{
				EnablePush = false,
				OrderUpdates = true,
				ChatMessages = true,
				Promotions = false,
				SystemAlerts = true
			};
			isPushSubscribed = pushSettings.EnablePush && !string.IsNullOrEmpty(pushSettings.FirebaseToken);
			await Task.Delay(50); // Simulate load
		}
		catch (Exception ex)
		{
			// Silent fail - push notifications are optional
		}
	}

	private async Task HandleNotificationClick(Guid notificationId)
	{
		try
		{
			// Mark as read
			await NotificationsClient.MarkAsReadAsync(notificationId);

			// Update local state
			var notification = allNotifications?.FirstOrDefault(n => n.Id == notificationId);
			if (notification != null)
			{
				notification.IsRead = true;
				StateHasChanged();

				// Navigate to related resource
				if (!string.IsNullOrEmpty(notification.ActionUrl))
				{
					Navigation.NavigateTo(notification.ActionUrl);
				}
			}
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£: {ex.Message}");
		}
	}

	private async Task HandleDelete(Guid notificationId)
	{
		try
		{
			await NotificationsClient.DeleteNotificationAsync(notificationId);
			allNotifications?.RemoveAll(n => n.Id == notificationId);
			StateHasChanged();
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£: {ex.Message}");
		}
	}

	private async Task MarkAllAsRead()
	{
		try
		{
			await NotificationsClient.MarkAllAsReadAsync();
			if (allNotifications != null)
			{
				foreach (var n in allNotifications)
				{
					n.IsRead = true;
				}
				StateHasChanged();
			}
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£: {ex.Message}");
		}
	}

	private void ManagePushNotifications()
	{
		showPushSettings = true;
	}

	private async Task SavePushSettings()
	{
		try
		{
			if (pushSettings.EnablePush && !isPushSubscribed)
			{
				// Request Firebase permission and get token
				// This would use JavaScript Interop to Firebase SDK
				// var token = await JS.InvokeAsync<string>("requestFirebaseToken");
				// pushSettings.FirebaseToken = token;
			}

			// TODO: Map to ACommerce.Client.Notifications.PushSettings and call SDK
			// await NotificationsClient.UpdatePushSettingsAsync(new Client.Notifications.PushSettings { ... });
			// For now simulating save
			await Task.Delay(300);
			isPushSubscribed = pushSettings.EnablePush;
			showPushSettings = false;
			Notification.ShowSuccess("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£: {ex.Message}");
		}
	}

	public async ValueTask DisposeAsync()
	{
		await RealtimeClient.DisconnectAsync();
	}

	// PushSettings class for local state
	private class PushSettings
	{
		public bool EnablePush { get; set; }
		public bool OrderUpdates { get; set; } = true;
		public bool ChatMessages { get; set; } = true;
		public bool Promotions { get; set; } = true;
		public bool SystemAlerts { get; set; } = true;
		public TimeSpan? QuietTimeStart { get; set; }
		public TimeSpan? QuietTimeEnd { get; set; }
		public string? FirebaseToken { get; set; }
	}
}

<style>
	.notifications-page {
		padding: var(--spacing-lg);
		max-width: 1000px;
		margin: 0 auto;
	}

	.notifications-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: var(--spacing-md);
	}

	.header-actions {
		display: flex;
		gap: var(--spacing-sm);
	}

	.notifications-list {
		min-height: 400px;
	}

	.loading-container {
		text-align: center;
		padding: var(--spacing-xl);
	}

	/* Push Settings */
	.push-settings-content {
		padding: var(--spacing-md);
	}

	.settings-info {
		padding: var(--spacing-md);
		background: var(--bg-secondary);
		border-radius: var(--border-radius);
		margin-bottom: var(--spacing-lg);
	}

	.settings-group {
		margin-bottom: var(--spacing-lg);
		padding-bottom: var(--spacing-lg);
		border-bottom: 1px solid var(--border-color);
	}

	.settings-group:last-child {
		border-bottom: none;
	}

	.settings-group h4 {
		margin-bottom: var(--spacing-md);
	}

	.settings-hint {
		font-size: var(--font-size-sm);
		color: var(--text-secondary);
		margin-top: var(--spacing-xs);
	}

	.firebase-info {
		padding: var(--spacing-md);
		background: var(--info-bg);
		border: 1px solid var(--info-border);
		border-radius: var(--border-radius);
		color: var(--info-text);
	}
</style>
