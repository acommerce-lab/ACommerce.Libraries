@page "/login"
@using ACommerce.Client.Auth.Models
@inject AuthClient AuthClient
@inject NavigationManager Navigation
@inject NotificationService Notification

<PageTitle>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Login</PageTitle>

<div class="auth-container">
	<SfCard CssClass="auth-card">
		<CardHeader Title="@GetTitle()" />
		<CardContent>
			@if (authMode == AuthMode.Selection)
			{
				<div class="auth-methods">
					<h4>Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h4>

					<SfButton CssClass="auth-method-btn" OnClick="() => SelectAuthMethod(AuthMode.Phone)">
						<span class="icon">ğŸ“±</span>
						<span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span>
					</SfButton>

					<SfButton CssClass="auth-method-btn" OnClick="() => SelectAuthMethod(AuthMode.Email)">
						<span class="icon">ğŸ“§</span>
						<span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
					</SfButton>

					<SfButton CssClass="auth-method-btn" OnClick="() => SelectAuthMethod(AuthMode.Google)">
						<span class="icon">ğŸ”µ</span>
						<span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Google</span>
					</SfButton>

					<SfButton CssClass="auth-method-btn" OnClick="() => SelectAuthMethod(AuthMode.Apple)">
						<span class="icon">ğŸ</span>
						<span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Apple</span>
					</SfButton>

					<SfButton CssClass="auth-method-btn" OnClick="() => SelectAuthMethod(AuthMode.Nafath)">
						<span class="icon">ğŸ‡¸ğŸ‡¦</span>
						<span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ù†ÙØ§Ø° (Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©)</span>
					</SfButton>
				</div>
			}
			else if (authMode == AuthMode.Phone)
			{
				<EditForm Model="@phoneModel" OnValidSubmit="LoginWithPhone">
					<DataAnnotationsValidator />
					<ValidationSummary />

					<SfTextBox @bind-Value="phoneModel.PhoneNumber"
							   Placeholder="05XXXXXXXX"
							   FloatLabelType="FloatLabelType.Auto">
						<label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
					</SfTextBox>

					<div class="auth-actions">
						<SfButton Type="Submit" IsPrimary="true" Disabled="@isLoading">
							@if (isLoading) { <SfSpinner /> } else { <span>Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</span> }
						</SfButton>
						<SfButton OnClick="BackToSelection">Ø±Ø¬ÙˆØ¹</SfButton>
					</div>
				</EditForm>
			}
			else if (authMode == AuthMode.Email)
			{
				<EditForm Model="@emailModel" OnValidSubmit="LoginWithEmail">
					<DataAnnotationsValidator />
					<ValidationSummary />

					<SfTextBox @bind-Value="emailModel.Email"
							   Placeholder="example@domain.com"
							   FloatLabelType="FloatLabelType.Auto">
						<label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
					</SfTextBox>

					<SfTextBox @bind-Value="emailModel.Password"
							   Type="InputType.Password"
							   FloatLabelType="FloatLabelType.Auto">
						<label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
					</SfTextBox>

					<div class="auth-actions">
						<SfButton Type="Submit" IsPrimary="true" Disabled="@isLoading">
							@if (isLoading) { <SfSpinner /> } else { <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span> }
						</SfButton>
						<SfButton OnClick="BackToSelection">Ø±Ø¬ÙˆØ¹</SfButton>
					</div>
				</EditForm>
			}
			else if (authMode == AuthMode.Nafath)
			{
				<div class="nafath-info">
					<p>Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ Ù…Ù†ØµØ© Ù†ÙØ§Ø° Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©</p>
					<SfButton IsPrimary="true" OnClick="LoginWithNafath" Disabled="@isLoading">
						@if (isLoading) { <SfSpinner /> } else { <span>Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¥Ù„Ù‰ Ù†ÙØ§Ø°</span> }
					</SfButton>
					<SfButton OnClick="BackToSelection">Ø±Ø¬ÙˆØ¹</SfButton>
				</div>
			}
		</CardContent>
		<CardFooter>
			<div class="auth-footer">
				<p>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="/register">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a></p>
			</div>
		</CardFooter>
	</SfCard>
</div>

@code {
	private enum AuthMode { Selection, Phone, Email, Google, Apple, Nafath }

	private AuthMode authMode = AuthMode.Selection;
	private bool isLoading = false;

	private PhoneLoginModel phoneModel = new();
	private EmailLoginModel emailModel = new();

	private string GetTitle() => authMode switch
	{
		AuthMode.Phone => "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„",
		AuthMode.Email => "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
		AuthMode.Nafath => "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ù†ÙØ§Ø°",
		_ => "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"
	};

	private void SelectAuthMethod(AuthMode mode)
	{
		authMode = mode;

		// OAuth methods - redirect immediately
		if (mode == AuthMode.Google)
		{
			Navigation.NavigateTo("/api/auth/external/google", forceLoad: true);
		}
		else if (mode == AuthMode.Apple)
		{
			Navigation.NavigateTo("/api/auth/external/apple", forceLoad: true);
		}
	}

	private void BackToSelection()
	{
		authMode = AuthMode.Selection;
		phoneModel = new();
		emailModel = new();
	}

	private async Task LoginWithPhone()
	{
		isLoading = true;
		try
		{
			var result = await AuthClient.RequestPhoneOtpAsync(new RequestPhoneOtpRequest
			{
				PhoneNumber = phoneModel.PhoneNumber
			});

			if (result?.Success == true)
			{
				Navigation.NavigateTo($"/auth/two-factor?phone={phoneModel.PhoneNumber}");
			}
			else
			{
				Notification.ShowError("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚");
			}
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£: {ex.Message}");
		}
		finally
		{
			isLoading = false;
		}
	}

	private async Task LoginWithEmail()
	{
		isLoading = true;
		try
		{
			var result = await AuthClient.LoginAsync(new LoginRequest
			{
				Email = emailModel.Email,
				Password = emailModel.Password
			});

			if (result?.RequiresTwoFactor == true)
			{
				Navigation.NavigateTo($"/auth/two-factor?email={emailModel.Email}");
			}
			else if (result?.Token != null)
			{
				// Store token and redirect to home
				await StoreTokenAndRedirect(result.Token);
			}
			else
			{
				Notification.ShowError("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
			}
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£: {ex.Message}");
		}
		finally
		{
			isLoading = false;
		}
	}

	private async Task LoginWithNafath()
	{
		isLoading = true;
		try
		{
			// Request Nafath authentication
			var result = await AuthClient.InitiateNafathAuthAsync(new NafathAuthRequest
			{
				RedirectUrl = $"{Navigation.BaseUri}auth/nafath-callback"
			});

			if (result?.AuthUrl != null)
			{
				Navigation.NavigateTo(result.AuthUrl, forceLoad: true);
			}
			else
			{
				Notification.ShowError("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ù†ØµØ© Ù†ÙØ§Ø°");
			}
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£: {ex.Message}");
		}
		finally
		{
			isLoading = false;
		}
	}

	private async Task StoreTokenAndRedirect(string token)
	{
		// Store token in localStorage or secure storage
		await AuthClient.SetTokenAsync(token);
		Navigation.NavigateTo("/");
	}

	// Models
	private class PhoneLoginModel
	{
		public string PhoneNumber { get; set; } = string.Empty;
	}

	private class EmailLoginModel
	{
		public string Email { get; set; } = string.Empty;
		public string Password { get; set; } = string.Empty;
	}
}

<style>
	.auth-container {
		display: flex;
		justify-content: center;
		align-items: center;
		min-height: 80vh;
		padding: var(--spacing-lg);
	}

	.auth-card {
		width: 100%;
		max-width: 500px;
	}

	.auth-methods {
		display: flex;
		flex-direction: column;
		gap: var(--spacing-md);
	}

	.auth-method-btn {
		width: 100%;
		padding: var(--spacing-md);
		display: flex;
		align-items: center;
		gap: var(--spacing-sm);
		justify-content: flex-start;
		text-align: right;
	}

	.auth-method-btn .icon {
		font-size: 24px;
	}

	.auth-actions {
		display: flex;
		gap: var(--spacing-sm);
		margin-top: var(--spacing-lg);
	}

	.auth-footer {
		text-align: center;
		padding: var(--spacing-md);
	}

	.auth-footer a {
		color: var(--primary-color);
		text-decoration: none;
		font-weight: 600;
	}
</style>
