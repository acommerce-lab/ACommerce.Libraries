@page "/auth/nafath-select-number"
@inject AuthClient AuthClient
@inject NavigationManager Navigation
@inject NotificationService Notification

<PageTitle>Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ - Select Phone Number</PageTitle>

<div class="auth-container">
	<SfCard CssClass="auth-card">
		<CardHeader Title="Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" />
		<CardContent>
			<div class="selection-info">
				<p>Ù„Ø¯ÙŠÙƒ Ø¹Ø¯Ø© Ø£Ø±Ù‚Ø§Ù… Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù†ÙØ§Ø°. Ø§Ø®ØªØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡:</p>
			</div>

			@if (isLoading)
			{
				<div class="loading-container">
					<SfSpinner />
					<p>Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…...</p>
				</div>
			}
			else if (phoneNumbers.Any())
			{
				<div class="number-list">
					@foreach (var number in phoneNumbers)
					{
						<SfButton CssClass="number-option"
								  IsPrimary="@(selectedNumber == number)"
								  OnClick="() => SelectNumber(number)">
							<span class="number-icon">ğŸ“±</span>
							<span class="number-text">@number</span>
						</SfButton>
					}
				</div>

				<div class="auth-actions">
					<SfButton IsPrimary="true"
							  Disabled="@(string.IsNullOrEmpty(selectedNumber) || isSubmitting)"
							  OnClick="ConfirmSelection">
						@if (isSubmitting) { <SfSpinner /> } else { <span>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</span> }
					</SfButton>
					<SfButton OnClick="@(() => Navigation.NavigateTo("/login"))">
						Ø¥Ù„ØºØ§Ø¡
					</SfButton>
				</div>
			}
			else
			{
				<div class="error-container">
					<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù…ØªØ§Ø­Ø©</p>
					<SfButton OnClick="@(() => Navigation.NavigateTo("/login"))">
						Ø±Ø¬ÙˆØ¹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
					</SfButton>
				</div>
			}
		</CardContent>
	</SfCard>
</div>

@code {
	[SupplyParameterFromQuery]
	private string? sessionId { get; set; }

	private List<string> phoneNumbers = new();
	private string? selectedNumber;
	private bool isLoading = true;
	private bool isSubmitting = false;

	protected override async Task OnInitializedAsync()
	{
		if (string.IsNullOrEmpty(sessionId))
		{
			Notification.ShowError("Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ù…ÙÙ‚ÙˆØ¯");
			Navigation.NavigateTo("/login");
			return;
		}

		await LoadPhoneNumbers();
	}

	private async Task LoadPhoneNumbers()
	{
		isLoading = true;
		try
		{
			var result = await AuthClient.GetNafathPhoneNumbersAsync(sessionId!);
			phoneNumbers = result?.PhoneNumbers ?? new List<string>();

			if (!phoneNumbers.Any())
			{
				Notification.ShowError("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù…Ø³Ø¬Ù„Ø©");
				Navigation.NavigateTo("/login");
			}
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…: {ex.Message}");
			Navigation.NavigateTo("/login");
		}
		finally
		{
			isLoading = false;
		}
	}

	private void SelectNumber(string number)
	{
		selectedNumber = number;
	}

	private async Task ConfirmSelection()
	{
		if (string.IsNullOrEmpty(selectedNumber)) return;

		isSubmitting = true;
		try
		{
			var result = await AuthClient.SelectNafathNumberAsync(new SelectNafathNumberRequest
			{
				SessionId = sessionId!,
				PhoneNumber = selectedNumber
			});

			if (result?.Token != null)
			{
				await StoreTokenAndRedirect(result.Token);
			}
			else if (result?.RequiresTwoFactor == true)
			{
				Navigation.NavigateTo($"/auth/two-factor?phone={selectedNumber}");
			}
			else
			{
				Notification.ShowError("ÙØ´Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±Ù‚Ù…");
			}
		}
		catch (Exception ex)
		{
			Notification.ShowError($"Ø®Ø·Ø£: {ex.Message}");
		}
		finally
		{
			isSubmitting = false;
		}
	}

	private async Task StoreTokenAndRedirect(string token)
	{
		await AuthClient.SetTokenAsync(token);
		Navigation.NavigateTo("/");
	}

	private class VerifyModel
	{
		public string Code { get; set; } = string.Empty;
	}
}

<style>
	.auth-container {
		display: flex;
		justify-content: center;
		align-items: center;
		min-height: 80vh;
		padding: var(--spacing-lg);
	}

	.auth-card {
		width: 100%;
		max-width: 600px;
	}

	.selection-info {
		text-align: center;
		margin-bottom: var(--spacing-lg);
		padding: var(--spacing-md);
		background: var(--bg-secondary);
		border-radius: var(--border-radius);
	}

	.loading-container {
		text-align: center;
		padding: var(--spacing-xl);
	}

	.number-list {
		display: flex;
		flex-direction: column;
		gap: var(--spacing-sm);
		margin: var(--spacing-lg) 0;
	}

	.number-option {
		width: 100%;
		padding: var(--spacing-md);
		display: flex;
		align-items: center;
		gap: var(--spacing-md);
		justify-content: flex-start;
		font-size: 18px;
		font-family: monospace;
		transition: all 0.2s;
	}

	.number-option:hover {
		transform: translateX(-4px);
	}

	.number-icon {
		font-size: 24px;
	}

	.auth-actions {
		display: flex;
		flex-direction: column;
		gap: var(--spacing-sm);
		margin-top: var(--spacing-lg);
	}

	.error-container {
		text-align: center;
		padding: var(--spacing-xl);
	}
</style>
