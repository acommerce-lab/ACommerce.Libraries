@namespace ACommerce.Templates.Customer.Components
@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject IJSRuntime JS

<div class="ac-interactive-map @Class" @key="_componentKey">
    <div class="ac-map-frame" id="@_mapContainerId" style="height: @(Height)px; width: 100%;" @onclick="OnMapClicked">
        @* Map will be rendered by JS *@
        @if (_isLoading)
        {
            <div class="ac-map-loading">
                <AcSpinner Text="جاري تحميل الخريطة..." />
            </div>
        }
        else if (!_mapInitialized)
        {
            <div class="ac-map-placeholder-inner">
                <i class="bi bi-geo-alt"></i>
                <span>اضغط لتحديد الموقع</span>
            </div>
        }
    </div>

    @if (ShowControls)
    {
        <div class="ac-map-controls">
            <button type="button" class="ac-map-control-btn" @onclick="GetCurrentLocation" disabled="@_isGettingLocation">
                @if (_isGettingLocation)
                {
                    <i class="bi bi-arrow-clockwise spinning"></i>
                }
                else
                {
                    <i class="bi bi-crosshair2"></i>
                }
                <span>موقعي الحالي</span>
            </button>

            @if (Latitude.HasValue && Longitude.HasValue)
            {
                <div class="ac-map-coords-display">
                    <i class="bi bi-pin-map"></i>
                    <span>@Latitude?.ToString("F4"), @Longitude?.ToString("F4")</span>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public double? Latitude { get; set; }
    [Parameter] public EventCallback<double?> LatitudeChanged { get; set; }

    [Parameter] public double? Longitude { get; set; }
    [Parameter] public EventCallback<double?> LongitudeChanged { get; set; }

    [Parameter] public EventCallback<(double Lat, double Lng)> OnLocationSelected { get; set; }
    [Parameter] public EventCallback OnRequestCurrentLocation { get; set; }

    [Parameter] public double DefaultLatitude { get; set; } = 24.7136; // Riyadh
    [Parameter] public double DefaultLongitude { get; set; } = 46.6753;
    [Parameter] public int DefaultZoom { get; set; } = 12;
    [Parameter] public int Height { get; set; } = 250;
    [Parameter] public bool ShowControls { get; set; } = true;
    [Parameter] public bool Interactive { get; set; } = true;
    [Parameter] public string? Class { get; set; }

    // Use unique key to prevent DOM recycling issues in MAUI WebView
    private readonly string _componentKey = Guid.NewGuid().ToString("N");
    private readonly string _mapContainerId = $"map_{Guid.NewGuid():N}";
    private bool _mapInitialized;
    private bool _isLoading;
    private bool _isGettingLocation;
    private bool _isDisposed;
    private DotNetObjectReference<AcInteractiveMap>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isDisposed)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await InitializeMapAsync();
        }
    }

    private async Task InitializeMapAsync()
    {
        if (_isDisposed) return;

        _isLoading = true;
        StateHasChanged();

        try
        {
            // Important: Add delay for MAUI WebView DOM readiness
            await Task.Delay(150);

            if (_isDisposed) return;

            var initialLat = Latitude ?? DefaultLatitude;
            var initialLng = Longitude ?? DefaultLongitude;

            // Destroy any existing map first
            try
            {
                await JS.InvokeVoidAsync("AcMap.destroy", _mapContainerId);
            }
            catch { /* Ignore if map doesn't exist */ }

            await JS.InvokeVoidAsync("AcMap.initialize", _mapContainerId, _dotNetRef, new
            {
                latitude = initialLat,
                longitude = initialLng,
                zoom = DefaultZoom,
                height = Height,
                interactive = Interactive,
                hasMarker = Latitude.HasValue && Longitude.HasValue
            });

            _mapInitialized = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Map initialization error: {ex.Message}");
            _mapInitialized = false;
        }
        finally
        {
            _isLoading = false;
            if (!_isDisposed)
            {
                StateHasChanged();
            }
        }
    }

    private async Task OnMapClicked()
    {
        if (!_mapInitialized && !_isLoading && !_isDisposed)
        {
            await InitializeMapAsync();
        }
    }

    private async Task GetCurrentLocation()
    {
        _isGettingLocation = true;
        StateHasChanged();

        try
        {
            await OnRequestCurrentLocation.InvokeAsync();
        }
        finally
        {
            _isGettingLocation = false;
            if (!_isDisposed)
            {
                StateHasChanged();
            }
        }
    }

    [JSInvokable]
    public async Task OnMapLocationSelected(double lat, double lng)
    {
        if (_isDisposed) return;

        Latitude = lat;
        Longitude = lng;

        await LatitudeChanged.InvokeAsync(lat);
        await LongitudeChanged.InvokeAsync(lng);
        await OnLocationSelected.InvokeAsync((lat, lng));

        StateHasChanged();
    }

    public async Task SetLocation(double lat, double lng)
    {
        if (_isDisposed) return;

        Latitude = lat;
        Longitude = lng;

        await LatitudeChanged.InvokeAsync(lat);
        await LongitudeChanged.InvokeAsync(lng);

        if (_mapInitialized)
        {
            try
            {
                await JS.InvokeVoidAsync("AcMap.setMarker", _mapContainerId, lat, lng);
            }
            catch { /* Ignore JS errors during disposal */ }
        }
        else
        {
            await InitializeMapAsync();
        }

        StateHasChanged();
    }

    public async Task CenterOnLocation(double lat, double lng, int? zoom = null)
    {
        if (_mapInitialized && !_isDisposed)
        {
            try
            {
                await JS.InvokeVoidAsync("AcMap.centerOn", _mapContainerId, lat, lng, zoom ?? DefaultZoom);
            }
            catch { /* Ignore JS errors during disposal */ }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_isDisposed) return;
        _isDisposed = true;

        if (_mapInitialized)
        {
            try
            {
                await JS.InvokeVoidAsync("AcMap.destroy", _mapContainerId);
            }
            catch { /* Ignore errors during disposal */ }
        }

        _dotNetRef?.Dispose();
    }
}
