@namespace ACommerce.Templates.Customer.Components
@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject IJSRuntime JS

@*
    IMPORTANT: The map container (ac-map-frame) must be COMPLETELY EMPTY.
    Blazor should not render any children inside it.
    This prevents DOM conflicts between Blazor and Leaflet.
    See: https://stackoverflow.com/questions/71461417/blazor-doubts-regarding-modifying-dom-from-javascript
*@
<div class="ac-interactive-map @Class">
    <div class="ac-map-wrapper" style="position: relative; height: @(Height)px;">
        @* Map container - MUST BE EMPTY - controlled entirely by JavaScript *@
        <div class="ac-map-frame"
             id="@_mapContainerId"
             style="height: 100%; width: 100%; position: absolute; top: 0; left: 0; z-index: 1;">
        </div>

        @* Loading overlay - positioned OUTSIDE map container to avoid DOM conflicts *@
        @if (_isLoading)
        {
            <div class="ac-map-overlay-loading" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 10; display: flex; align-items: center; justify-content: center; background: var(--ashare-gray-100);">
                <AcSpinner Text="جاري تحميل الخريطة..." />
            </div>
        }
    </div>

    @if (ShowControls)
    {
        <div class="ac-map-controls">
            <button type="button" class="ac-map-control-btn" @onclick="GetCurrentLocation" disabled="@_isGettingLocation">
                @if (_isGettingLocation)
                {
                    <i class="bi bi-arrow-clockwise spinning"></i>
                }
                else
                {
                    <i class="bi bi-crosshair2"></i>
                }
                <span>موقعي الحالي</span>
            </button>

            @if (Latitude.HasValue && Longitude.HasValue)
            {
                <div class="ac-map-coords-display">
                    <i class="bi bi-pin-map"></i>
                    <span>@Latitude?.ToString("F4"), @Longitude?.ToString("F4")</span>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public double? Latitude { get; set; }
    [Parameter] public EventCallback<double?> LatitudeChanged { get; set; }

    [Parameter] public double? Longitude { get; set; }
    [Parameter] public EventCallback<double?> LongitudeChanged { get; set; }

    [Parameter] public EventCallback<(double Lat, double Lng)> OnLocationSelected { get; set; }
    [Parameter] public EventCallback OnRequestCurrentLocation { get; set; }

    [Parameter] public double DefaultLatitude { get; set; } = 24.7136; // Riyadh
    [Parameter] public double DefaultLongitude { get; set; } = 46.6753;
    [Parameter] public int DefaultZoom { get; set; } = 12;
    [Parameter] public int Height { get; set; } = 250;
    [Parameter] public bool ShowControls { get; set; } = true;
    [Parameter] public bool Interactive { get; set; } = true;
    [Parameter] public string? Class { get; set; }

    private readonly string _mapContainerId = $"map_{Guid.NewGuid():N}";
    private bool _mapInitialized;
    private bool _isLoading;
    private bool _isGettingLocation;
    private bool _isDisposed;
    private DotNetObjectReference<AcInteractiveMap>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isDisposed)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await InitializeMapAsync();
        }
    }

    private async Task InitializeMapAsync()
    {
        if (_isDisposed) return;

        _isLoading = true;
        StateHasChanged();

        try
        {
            // Wait for DOM to be ready
            await Task.Delay(100);

            if (_isDisposed) return;

            var initialLat = Latitude ?? DefaultLatitude;
            var initialLng = Longitude ?? DefaultLongitude;

            await JS.InvokeVoidAsync("AcMap.initialize", _mapContainerId, _dotNetRef, new
            {
                latitude = initialLat,
                longitude = initialLng,
                zoom = DefaultZoom,
                height = Height,
                interactive = Interactive,
                hasMarker = Latitude.HasValue && Longitude.HasValue
            });

            _mapInitialized = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Map initialization error: {ex.Message}");
            _mapInitialized = false;
        }
        finally
        {
            _isLoading = false;
            if (!_isDisposed)
            {
                StateHasChanged();
            }
        }
    }

    private async Task GetCurrentLocation()
    {
        _isGettingLocation = true;
        StateHasChanged();

        try
        {
            await OnRequestCurrentLocation.InvokeAsync();
        }
        finally
        {
            _isGettingLocation = false;
            if (!_isDisposed)
            {
                StateHasChanged();
            }
        }
    }

    [JSInvokable]
    public async Task OnMapLocationSelected(double lat, double lng)
    {
        if (_isDisposed) return;

        Latitude = lat;
        Longitude = lng;

        await LatitudeChanged.InvokeAsync(lat);
        await LongitudeChanged.InvokeAsync(lng);
        await OnLocationSelected.InvokeAsync((lat, lng));

        StateHasChanged();
    }

    public async Task SetLocation(double lat, double lng)
    {
        if (_isDisposed) return;

        Latitude = lat;
        Longitude = lng;

        await LatitudeChanged.InvokeAsync(lat);
        await LongitudeChanged.InvokeAsync(lng);

        if (_mapInitialized)
        {
            try
            {
                await JS.InvokeVoidAsync("AcMap.setMarker", _mapContainerId, lat, lng);
            }
            catch { /* Ignore JS errors during disposal */ }
        }

        StateHasChanged();
    }

    public async Task CenterOnLocation(double lat, double lng, int? zoom = null)
    {
        if (_mapInitialized && !_isDisposed)
        {
            try
            {
                await JS.InvokeVoidAsync("AcMap.centerOn", _mapContainerId, lat, lng, zoom ?? DefaultZoom);
            }
            catch { /* Ignore JS errors during disposal */ }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_isDisposed) return;
        _isDisposed = true;

        if (_mapInitialized)
        {
            try
            {
                await JS.InvokeVoidAsync("AcMap.destroy", _mapContainerId);
            }
            catch { /* Ignore errors during disposal */ }
        }

        _dotNetRef?.Dispose();
    }
}
