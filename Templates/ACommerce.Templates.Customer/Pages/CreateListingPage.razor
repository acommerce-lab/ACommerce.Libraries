@namespace ACommerce.Templates.Customer.Pages
@using ACommerce.Templates.Customer.Components
@using ACommerce.Templates.Customer.Services
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Http.Json
@using System.Net.Http.Headers
@using ACommerce.Client.Auth
@using ACommerce.Client.Files

@inject IImageCompressionService? ImageCompressionService

<div class="ac-page ac-create-listing-page">
    @* Header *@
    <div class="ac-page-header">
        <div class="ac-header-content">
            @if (CurrentStep != CreateListingStep.SelectCategory && CurrentStep != CreateListingStep.Success)
            {
                <button class="ac-back-btn" @onclick="GoBack">
                    <i class="bi bi-arrow-right"></i>
                </button>
            }
            <h1 class="ac-page-title">
                @if (CurrentStep == CreateListingStep.SelectCategory)
                {
                    <span>إنشاء عرض جديد</span>
                }
                else if (SelectedCategory != null)
                {
                    <i class="bi @SelectedCategory.Icon"></i>
                    <span>@SelectedCategory.Name</span>
                }
            </h1>
        </div>
    </div>

    @* Progress Steps *@
    @if (CurrentStep != CreateListingStep.SelectCategory && CurrentStep != CreateListingStep.Success && CurrentStep != CreateListingStep.Error)
    {
        <div class="ac-progress-container">
            <div class="ac-progress-bar">
                <div class="ac-progress-fill" style="width: @GetProgressPercentage()%"></div>
            </div>
            <div class="ac-progress-steps">
                <div class="ac-step @(CurrentStep >= CreateListingStep.FillDetails ? "active" : "") @(CurrentStep > CreateListingStep.FillDetails ? "completed" : "")">
                    <div class="ac-step-icon">
                        @if (CurrentStep > CreateListingStep.FillDetails)
                        {
                            <i class="bi bi-check"></i>
                        }
                        else
                        {
                            <span>1</span>
                        }
                    </div>
                    <span class="ac-step-label">التفاصيل</span>
                </div>
                <div class="ac-step @(CurrentStep >= CreateListingStep.AddImages ? "active" : "") @(CurrentStep > CreateListingStep.AddImages ? "completed" : "")">
                    <div class="ac-step-icon">
                        @if (CurrentStep > CreateListingStep.AddImages)
                        {
                            <i class="bi bi-check"></i>
                        }
                        else
                        {
                            <span>2</span>
                        }
                    </div>
                    <span class="ac-step-label">الصور</span>
                </div>
                <div class="ac-step @(CurrentStep >= CreateListingStep.SetLocation ? "active" : "") @(CurrentStep > CreateListingStep.SetLocation ? "completed" : "")">
                    <div class="ac-step-icon">
                        @if (CurrentStep > CreateListingStep.SetLocation)
                        {
                            <i class="bi bi-check"></i>
                        }
                        else
                        {
                            <span>3</span>
                        }
                    </div>
                    <span class="ac-step-label">الموقع</span>
                </div>
                <div class="ac-step @(CurrentStep >= CreateListingStep.Review ? "active" : "")">
                    <div class="ac-step-icon">
                        <span>4</span>
                    </div>
                    <span class="ac-step-label">مراجعة</span>
                </div>
            </div>
        </div>
    }

    @* Content based on current step *@
    <div class="ac-page-content">
        @* IMPORTANT: Map component placed OUTSIDE switch to prevent DOM conflicts in MAUI WebView *@
        @* Only render after user first reaches the location step, then keep in DOM *@
        @if (_hasReachedLocationStep)
        {
            <div class="ac-persistent-map-container" style="display: @(CurrentStep == CreateListingStep.SetLocation ? "block" : "none");">
                <div class="ac-location-section">
                    <div class="ac-form-section">
                        <div class="ac-section-header">
                            <i class="bi bi-geo-alt"></i>
                            <h2>موقع العرض</h2>
                        </div>
                        <p class="ac-section-desc">حرّك الخريطة واضغط لتحديد موقع عرضك بدقة</p>
                    </div>

                    <div class="ac-location-card">
                        @* Interactive Map Component - kept in stable DOM location *@
                        <AcInteractiveMap @ref="_mapComponent"
                                          Latitude="@Model.Latitude"
                                          LatitudeChanged="(lat) => Model.Latitude = lat"
                                          Longitude="@Model.Longitude"
                                          LongitudeChanged="(lng) => Model.Longitude = lng"
                                          OnLocationSelected="OnLocationSelectedFromMap"
                                          OnRequestCurrentLocation="RequestLocation"
                                          Height="280"
                                          ShowControls="true"
                                          Interactive="true" />

                        <div style="margin-top: 16px;">
                            <AcInput Id="address"
                                     Label="العنوان التفصيلي (اختياري)"
                                     Placeholder="مثال: حي النرجس، شارع الأمير سلطان"
                                     Value="@Model.Address"
                                     ValueChanged="(v) => Model.Address = v"
                                     IconStart="bi-signpost" />
                        </div>
                    </div>

                    <div class="ac-form-actions">
                        <AcButton Text="التالي"
                                  IconEnd="bi-arrow-left"
                                  OnClick="GoToReview"
                                  FullWidth="true" />
                    </div>
                </div>
            </div>
        }

        @switch (CurrentStep)
        {
            case CreateListingStep.SelectCategory:
                <div class="ac-category-selection">
                    <div class="ac-section-header">
                        <i class="bi bi-grid-3x3-gap"></i>
                        <h2>اختر نوع العرض</h2>
                    </div>
                    <p class="ac-section-desc">حدد الفئة المناسبة لعرضك للوصول لأكبر شريحة من المهتمين</p>

                    <div class="ac-category-grid">
                        @if (Categories != null)
                        {
                            @foreach (var category in Categories)
                            {
                                <div class="ac-category-card" @onclick="() => SelectCategory(category)">
                                    <div class="ac-category-icon-wrapper">
                                        @if (!string.IsNullOrEmpty(category.Icon))
                                        {
                                            <i class="bi @category.Icon"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-folder"></i>
                                        }
                                    </div>
                                    <div class="ac-category-info">
                                        <h3 class="ac-category-name">@category.Name</h3>
                                        @if (!string.IsNullOrEmpty(category.Description))
                                        {
                                            <p class="ac-category-desc">@category.Description</p>
                                        }
                                    </div>
                                    <i class="bi bi-chevron-left ac-category-arrow"></i>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="ac-loading-card">
                                <AcSpinner Text="جاري تحميل الفئات..." />
                            </div>
                        }
                    </div>
                </div>
                break;

            case CreateListingStep.FillDetails:
                <div class="ac-details-form">
                    <div class="ac-form-section">
                        <div class="ac-section-header">
                            <i class="bi bi-card-text"></i>
                            <h2>تفاصيل العرض</h2>
                        </div>
                        <p class="ac-section-desc">أدخل المعلومات الأساسية لعرضك</p>
                    </div>

                    @* Validation Alert *@
                    @if (!IsLoadingAttributes && ValidationErrorCount > 0)
                    {
                        <div class="ac-validation-alert">
                            <div class="ac-alert-icon">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                            </div>
                            <div class="ac-alert-content">
                                <span class="ac-alert-title">يوجد @ValidationErrorCount @(ValidationErrorCount == 1 ? "حقل مطلوب" : "حقول مطلوبة") غير مكتمل</span>
                                <span class="ac-alert-desc">أكمل الحقول المحددة بـ (*) للمتابعة</span>
                            </div>
                        </div>
                    }

                    @* Dynamic attributes based on category - including title *@
                    @if (IsLoadingAttributes)
                    {
                        <div class="ac-loading-section">
                            <AcSpinner Text="جاري تحميل الخصائص..." />
                        </div>
                    }
                    else if (FilteredAttributes != null && FilteredAttributes.Any())
                    {
                        <div class="ac-attributes-container">
                            <AcDynamicForm Attributes="@FilteredAttributes"
                                           Values="@Model.Attributes"
                                           ValuesChanged="OnAttributesChanged"
                                           OnValidationChanged="OnValidationChanged" />
                        </div>
                    }
                    else
                    {
                        <div class="ac-empty-section">
                            <i class="bi bi-inbox"></i>
                            <p>لا توجد خصائص محددة لهذه الفئة</p>
                        </div>
                    }

                    <div class="ac-form-actions">
                        <AcButton Text="التالي"
                                  IconEnd="bi-arrow-left"
                                  OnClick="GoToImages"
                                  FullWidth="true"
                                  Disabled="@(!IsDetailsValid)" />
                    </div>
                </div>
                break;

            case CreateListingStep.AddImages:
                <div class="ac-images-section">
                    <div class="ac-form-section">
                        <div class="ac-section-header">
                            <i class="bi bi-images"></i>
                            <h2>صور العرض</h2>
                        </div>
                        <p class="ac-section-desc">أضف صوراً واضحة وجذابة لعرضك (حتى 10 صور)</p>
                    </div>

                    <div class="ac-upload-container">
                        <div class="ac-upload-area @(Model.Images.Any() ? "has-images" : "") @(_isUploadingImages ? "uploading" : "")"
                             @onclick="HandleAddImagesClick"
                             style="cursor: pointer;">
                            <div class="ac-upload-content">
                                @if (_isUploadingImages)
                                {
                                    <div class="ac-upload-icon uploading">
                                        <div class="ac-upload-spinner"></div>
                                    </div>
                                    <div class="ac-upload-text">
                                        <span class="ac-upload-title">جاري رفع الصور...</span>
                                        <span class="ac-upload-hint">@_uploadProgress</span>
                                    </div>
                                }
                                else
                                {
                                    <div class="ac-upload-icon">
                                        <i class="bi bi-cloud-arrow-up"></i>
                                    </div>
                                    <div class="ac-upload-text">
                                        <span class="ac-upload-title">اضغط لإضافة صور</span>
                                        <span class="ac-upload-hint">الكاميرا أو المعرض - حتى 10MB</span>
                                    </div>
                                }
                            </div>
                        </div>
                        @* Fallback InputFile for web/unsupported platforms *@
                        @if (MediaPickerService == null)
                        {
                            <label class="ac-upload-area-fallback" style="display: none;">
                                <InputFile @ref="_inputFileRef"
                                           OnChange="HandleImageUpload"
                                           accept="image/*"
                                           multiple
                                           disabled="@_isUploadingImages" />
                            </label>
                        }
                    </div>

                    @* رسالة خطأ رفع الصور *@
                    @if (!string.IsNullOrEmpty(_imageUploadError))
                    {
                        <div class="ac-upload-error">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <span>@_imageUploadError</span>
                            <button class="ac-error-dismiss" @onclick="() => _imageUploadError = null">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    }

                    @if (Model.Images.Any())
                    {
                        <div class="ac-images-preview">
                            <div class="ac-preview-header">
                                <span class="ac-preview-count">
                                    <i class="bi bi-image"></i>
                                    @Model.Images.Count من 10 صور
                                </span>
                                @if (Model.Images.Count > 0)
                                {
                                    <button class="ac-clear-all" @onclick="ClearAllImages">
                                        <i class="bi bi-trash"></i>
                                        حذف الكل
                                    </button>
                                }
                            </div>
                            <div class="ac-image-grid">
                                @foreach (var (image, index) in Model.Images.Select((img, i) => (img, i)))
                                {
                                    <div class="ac-image-item @(index == 0 ? "main-image" : "")">
                                        @if (index == 0)
                                        {
                                            <span class="ac-main-badge">الصورة الرئيسية</span>
                                        }
                                        <img src="@image" alt="صورة @(index + 1)" />
                                        <div class="ac-image-overlay">
                                            <button class="ac-image-action" @onclick="() => SetMainImage(index)" title="تعيين كصورة رئيسية">
                                                <i class="bi bi-star"></i>
                                            </button>
                                            <button class="ac-image-action delete" @onclick="() => RemoveImage(index)" title="حذف">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="ac-no-images">
                            <i class="bi bi-image"></i>
                            <p>لم تقم بإضافة أي صور بعد</p>
                            <small>الصور تساعد في جذب المزيد من المهتمين</small>
                        </div>
                    }

                    <div class="ac-form-actions">
                        <AcButton Text="التالي"
                                  IconEnd="bi-arrow-left"
                                  OnClick="GoToLocation"
                                  FullWidth="true" />
                    </div>
                </div>
                break;

            case CreateListingStep.SetLocation:
                @* Content moved outside switch to prevent DOM conflicts with Leaflet in MAUI WebView *@
                @* See ac-persistent-map-container above *@
                break;

            case CreateListingStep.Review:
                <div class="ac-review-section">
                    <div class="ac-form-section">
                        <div class="ac-section-header">
                            <i class="bi bi-eye"></i>
                            <h2>معاينة العرض</h2>
                        </div>
                        <p class="ac-section-desc">راجع عرضك كما سيظهر للآخرين</p>
                    </div>

                    @* Preview Card - Professional Design *@
                    <div class="ac-listing-preview-card">
                        @* Image Gallery Preview *@
                        <div class="ac-preview-gallery">
                            @if (Model.Images.Any())
                            {
                                <div class="ac-gallery-main">
                                    <img src="@Model.Images.First()" alt="صورة العرض" />
                                    <div class="ac-gallery-badge">
                                        <i class="bi bi-images"></i>
                                        <span>@Model.Images.Count</span>
                                    </div>
                                </div>
                                @if (Model.Images.Count > 1)
                                {
                                    <div class="ac-gallery-thumbs">
                                        @foreach (var img in Model.Images.Skip(1).Take(4))
                                        {
                                            <div class="ac-thumb-item">
                                                <img src="@img" alt="" />
                                            </div>
                                        }
                                        @if (Model.Images.Count > 5)
                                        {
                                            <div class="ac-thumb-more">
                                                <span>+@(Model.Images.Count - 5)</span>
                                            </div>
                                        }
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="ac-gallery-empty">
                                    <i class="bi bi-image"></i>
                                    <span>لا توجد صور</span>
                                </div>
                            }
                        </div>

                        @* Category & Type Badge *@
                        <div class="ac-preview-badges">
                            <span class="ac-type-badge">
                                <i class="bi @SelectedCategory?.Icon"></i>
                                @SelectedCategory?.Name
                            </span>
                        </div>

                        @* Main Info Section *@
                        <div class="ac-preview-main-info">
                            <h2 class="ac-preview-title">@GetTitleFromAttributes()</h2>

                            @if (!string.IsNullOrEmpty(Model.Address))
                            {
                                <div class="ac-preview-location">
                                    <i class="bi bi-geo-alt-fill"></i>
                                    <span>@Model.Address</span>
                                </div>
                            }
                            else if (Model.Latitude.HasValue && Model.Longitude.HasValue)
                            {
                                <div class="ac-preview-location">
                                    <i class="bi bi-geo-alt-fill"></i>
                                    <span>موقع محدد على الخريطة</span>
                                </div>
                            }
                        </div>

                        @* Attributes Grid *@
                        @{
                            var displayAttributes = Model.Attributes
                                .Where(a => a.Code != "title" && a.Code != "description" && HasDisplayValue(a))
                                .Select(a => new { Input = a, Def = CategoryAttributes?.FirstOrDefault(d => d.Id == a.AttributeId) })
                                .Where(x => x.Def != null)
                                .ToList();
                        }
                        @if (displayAttributes.Any())
                        {
                            <div class="ac-preview-attrs-section">
                                <h3 class="ac-attrs-title">
                                    <i class="bi bi-list-check"></i>
                                    تفاصيل العرض
                                </h3>
                                <div class="ac-attrs-grid">
                                    @foreach (var attr in displayAttributes)
                                    {
                                        <div class="ac-attr-card">
                                            <div class="ac-attr-icon">
                                                <i class="bi @GetAttributeIcon(attr.Def!.Code)"></i>
                                            </div>
                                            <div class="ac-attr-content">
                                                <span class="ac-attr-label">@attr.Def!.Name</span>
                                                <span class="ac-attr-value">@GetAttributeDisplayValue(attr.Input, attr.Def!)</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @* Description Section *@
                        @{
                            var descAttr = Model.Attributes.FirstOrDefault(a => a.Code == "description");
                            if (!string.IsNullOrEmpty(descAttr?.TextValue))
                            {
                                <div class="ac-preview-desc-section">
                                    <h3 class="ac-desc-title">
                                        <i class="bi bi-text-paragraph"></i>
                                        الوصف
                                    </h3>
                                    <p class="ac-desc-text">@descAttr.TextValue</p>
                                </div>
                            }
                        }

                        @* Location Map Preview *@
                        @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
                        {
                            <div class="ac-preview-map-section">
                                <h3 class="ac-map-title">
                                    <i class="bi bi-pin-map"></i>
                                    الموقع
                                </h3>

                                @* Static Map Preview (using static image to avoid Leaflet conflicts) *@
                                <div class="ac-static-map-preview" @onclick="OpenInNativeMaps">
                                    <img src="@GetStaticMapUrl(Model.Latitude.Value, Model.Longitude.Value, 15)"
                                         alt="موقع العقار"
                                         loading="lazy" />
                                    <div class="ac-static-map-marker">
                                        <i class="bi bi-geo-alt-fill"></i>
                                    </div>
                                    <div class="ac-static-map-overlay">
                                        <i class="bi bi-arrows-fullscreen"></i>
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(Model.Address))
                                {
                                    <div class="ac-preview-address">
                                        <i class="bi bi-geo-alt"></i>
                                        <span>@Model.Address</span>
                                    </div>
                                }

                                @* Open in Native Maps Button *@
                                <button type="button" class="ac-open-maps-btn" @onclick="OpenInNativeMaps">
                                    <i class="bi bi-map"></i>
                                    <span>فتح في الخرائط</span>
                                </button>
                            </div>
                        }
                    </div>

                    <div class="ac-form-actions">
                        <AcButton Text="نشر العرض"
                                  IconStart="bi-send"
                                  OnClick="SubmitListing"
                                  FullWidth="true"
                                  Variant="ButtonVariant.Primary" />
                    </div>
                </div>
                break;

            case CreateListingStep.Submitting:
                <div class="ac-submitting-section">
                    <AcSpinner Size="SpinnerSize.Large" Text="جاري نشر العرض..." />
                </div>
                break;

            case CreateListingStep.Success:
                <div class="ac-success-section">
                    <div class="ac-success-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <h2>تم نشر العرض بنجاح!</h2>
                    <p>سيظهر عرضك للمستخدمين الآن</p>

                    <div class="ac-form-actions">
                        <AcButton Text="عرض التفاصيل"
                                  OnClick="ViewListing"
                                  FullWidth="true"
                                  Variant="ButtonVariant.Primary" />
                        <AcButton Text="إنشاء عرض آخر"
                                  OnClick="CreateAnother"
                                  FullWidth="true"
                                  Variant="ButtonVariant.Secondary" />
                    </div>
                </div>
                break;

            case CreateListingStep.Error:
                <div class="ac-error-section">
                    <div class="ac-error-icon">
                        <i class="bi bi-x-circle-fill"></i>
                    </div>
                    <h2>حدث خطأ</h2>
                    <p>@ErrorMessage</p>

                    <div class="ac-form-actions">
                        <AcButton Text="حاول مرة أخرى"
                                  OnClick="RetrySubmit"
                                  FullWidth="true" />
                    </div>
                </div>
                break;
        }
    </div>
</div>

@code {
    [Parameter] public List<ListingCategory>? Categories { get; set; }
    [Parameter] public EventCallback<Guid> OnLoadCategoryAttributes { get; set; }
    [Parameter] public EventCallback<CreateListingModel> OnSubmit { get; set; }
    [Parameter] public EventCallback<Guid> OnViewListing { get; set; }
    [Parameter] public EventCallback OnRequestLocation { get; set; }
    [Parameter] public EventCallback<InputFileChangeEventArgs> OnImageUpload { get; set; }

    public CreateListingStep CurrentStep { get; set; } = CreateListingStep.SelectCategory;
    public ListingCategory? SelectedCategory { get; set; }
    public List<ListingAttributeDefinition>? CategoryAttributes { get; set; }
    public CreateListingModel Model { get; set; } = new();
    public bool IsLoadingAttributes { get; set; }
    public string? ErrorMessage { get; set; }
    public Guid? CreatedListingId { get; set; }
    private bool _isFormValid = true;
    private Dictionary<string, string> _validationErrors = new();
    private AcInteractiveMap? _mapComponent;
    private bool _hasReachedLocationStep;
    private bool _isUploadingImages;
    private string _uploadProgress = "";
    private const long MaxFileSize = 10 * 1024 * 1024; // 10MB

    // Filter out images attribute - it's handled separately
    private List<ListingAttributeDefinition>? FilteredAttributes =>
        CategoryAttributes?.Where(a => a.Code != "images").ToList();

    // Count of validation errors (required fields not filled)
    private int ValidationErrorCount
    {
        get
        {
            if (FilteredAttributes == null) return 0;

            var count = 0;
            var requiredAttributes = FilteredAttributes.Where(a => a.IsRequired).ToList();
            foreach (var attr in requiredAttributes)
            {
                var input = Model.Attributes.FirstOrDefault(v => v.AttributeId == attr.Id);
                if (input == null || !HasValue(input))
                    count++;
            }
            return count;
        }
    }

    // Validation: check required fields including title from dynamic attributes
    private bool IsDetailsValid
    {
        get
        {
            if (FilteredAttributes == null) return false;

            var requiredAttributes = FilteredAttributes.Where(a => a.IsRequired).ToList();
            foreach (var attr in requiredAttributes)
            {
                var input = Model.Attributes.FirstOrDefault(v => v.AttributeId == attr.Id);
                if (input == null || !HasValue(input))
                    return false;
            }
            return _isFormValid;
        }
    }

    private bool HasValue(ListingAttributeInput input) =>
        !string.IsNullOrEmpty(input.TextValue) ||
        input.NumberValue.HasValue ||
        input.BooleanValue.HasValue ||
        input.DateValue.HasValue ||
        (input.MultiSelectValues?.Any() ?? false);

    private bool HasDisplayValue(ListingAttributeInput input) =>
        HasValue(input) &&
        !(input.BooleanValue == false && !input.NumberValue.HasValue && string.IsNullOrEmpty(input.TextValue));

    private int GetProgressPercentage() => CurrentStep switch
    {
        CreateListingStep.FillDetails => 25,
        CreateListingStep.AddImages => 50,
        CreateListingStep.SetLocation => 75,
        CreateListingStep.Review => 100,
        _ => 0
    };

    private string GetTitleFromAttributes()
    {
        var titleAttr = Model.Attributes.FirstOrDefault(a => a.Code == "title");
        return titleAttr?.TextValue ?? "عرض جديد";
    }

    public void SetCategories(List<ListingCategory> categories)
    {
        Categories = categories;
        StateHasChanged();
    }

    public void SetCategoryAttributes(List<ListingAttributeDefinition> attributes)
    {
        CategoryAttributes = attributes;
        IsLoadingAttributes = false;

        // Set title in Model.Title from attributes for backwards compatibility
        var titleAttr = attributes.FirstOrDefault(a => a.Code == "title");
        if (titleAttr != null)
        {
            var existingInput = Model.Attributes.FirstOrDefault(a => a.Code == "title");
            if (existingInput == null)
            {
                Model.Attributes.Add(new ListingAttributeInput
                {
                    AttributeId = titleAttr.Id,
                    Code = "title",
                    TextValue = Model.Title
                });
            }
        }

        StateHasChanged();
    }

    public async Task SetLocation(double latitude, double longitude, string? address = null)
    {
        Model.Latitude = latitude;
        Model.Longitude = longitude;
        if (!string.IsNullOrEmpty(address))
        {
            Model.Address = address;
        }

        // Update the map component if it exists
        if (_mapComponent != null)
        {
            await _mapComponent.SetLocation(latitude, longitude);
        }

        StateHasChanged();
    }

    public void SetCreatedListingId(Guid id)
    {
        CreatedListingId = id;
        CurrentStep = CreateListingStep.Success;
        StateHasChanged();
    }

    public void SetError(string message)
    {
        ErrorMessage = message;
        CurrentStep = CreateListingStep.Error;
        StateHasChanged();
    }

    /// <summary>
    /// إلغاء عملية الإرسال والعودة لصفحة المراجعة
    /// يُستخدم عند إلغاء الدفع أو الاشتراك
    /// </summary>
    public void CancelSubmission()
    {
        CurrentStep = CreateListingStep.Review;
        StateHasChanged();
    }

    public void AddImage(string imageUrl)
    {
        if (Model.Images.Count < 10)
        {
            Model.Images.Add(imageUrl);
            StateHasChanged();
        }
    }

    private async Task SelectCategory(ListingCategory category)
    {
        SelectedCategory = category;
        Model.CategoryId = category.Id;
        CurrentStep = CreateListingStep.FillDetails;
        IsLoadingAttributes = true;
        await OnLoadCategoryAttributes.InvokeAsync(category.Id);
    }

    private void GoBack()
    {
        CurrentStep = CurrentStep switch
        {
            CreateListingStep.FillDetails => CreateListingStep.SelectCategory,
            CreateListingStep.AddImages => CreateListingStep.FillDetails,
            CreateListingStep.SetLocation => CreateListingStep.AddImages,
            CreateListingStep.Review => CreateListingStep.SetLocation,
            CreateListingStep.Error => CreateListingStep.Review,
            _ => CurrentStep
        };

        if (CurrentStep == CreateListingStep.SelectCategory)
        {
            ResetForm();
        }
    }

    private void GoToImages()
    {
        try
        {
            // Sync title from attributes to Model.Title for backwards compatibility
            if (Model.Attributes != null && Model.Attributes.Any())
            {
                var titleInput = Model.Attributes.FirstOrDefault(a => a.Code == "title");
                if (titleInput != null)
                {
                    Model.Title = titleInput.TextValue ?? "";
                }
            }
            CurrentStep = CreateListingStep.AddImages;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[CreateListingPage] Error in GoToImages: {ex.Message}");
            // في حالة حدوث خطأ، ننتقل للخطوة التالية على أي حال
            CurrentStep = CreateListingStep.AddImages;
        }
    }

    private void GoToLocation()
    {
        _hasReachedLocationStep = true;
        CurrentStep = CreateListingStep.SetLocation;
    }

    private void GoToReview()
    {
        CurrentStep = CreateListingStep.Review;
    }

    private async Task RequestLocation()
    {
        await OnRequestLocation.InvokeAsync();
    }

    private void OnMapClick()
    {
        // No longer needed - handled by AcInteractiveMap component
    }

    private void OnLocationSelectedFromMap((double Lat, double Lng) location)
    {
        Model.Latitude = location.Lat;
        Model.Longitude = location.Lng;
        StateHasChanged();
    }

    [Inject] private IJSRuntime? JS { get; set; }
    [Inject] private HttpClient? Http { get; set; }
    [Inject] private TokenManager? TokenManager { get; set; }
    [Inject] private FilesClient? FilesClientService { get; set; }
    [Inject] private IMediaPickerService? MediaPickerService { get; set; }

    private InputFile? _inputFileRef;

    private async Task OpenInNativeMaps()
    {
        if (Model.Latitude.HasValue && Model.Longitude.HasValue && JS != null)
        {
            var label = GetTitleFromAttributes() ?? "الموقع";
            await JS.InvokeVoidAsync("AcMap.openNativeMaps", Model.Latitude.Value, Model.Longitude.Value, label);
        }
    }

    private string GetStaticMapUrl(double lat, double lng, int zoom)
    {
        // Use OpenStreetMap static tile approach
        // Calculate tile coordinates from lat/lng
        var n = Math.Pow(2, zoom);
        var x = (int)((lng + 180.0) / 360.0 * n);
        var latRad = lat * Math.PI / 180.0;
        var y = (int)((1.0 - Math.Log(Math.Tan(latRad) + 1.0 / Math.Cos(latRad)) / Math.PI) / 2.0 * n);

        // Return OpenStreetMap tile URL
        return $"https://tile.openstreetmap.org/{zoom}/{x}/{y}.png";
    }

    private string? _imageUploadError;

    /// <summary>
    /// معالجة النقر على منطقة إضافة الصور
    /// </summary>
    private async Task HandleAddImagesClick()
    {
        if (_isUploadingImages) return;

        _imageUploadError = null;

        // استخدام MediaPicker إذا كان متاحاً (MAUI)
        if (MediaPickerService != null)
        {
            try
            {
                var remainingSlots = 10 - Model.Images.Count;
                if (remainingSlots <= 0)
                {
                    _imageUploadError = "تم الوصول للحد الأقصى (10 صور)";
                    return;
                }

                var results = await MediaPickerService.PickOrCapturePhotosAsync(remainingSlots);

                if (results.Any())
                {
                    await ProcessMediaPickerResults(results);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[CreateListingPage] Error using MediaPicker: {ex.Message}");
                _imageUploadError = "حدث خطأ أثناء اختيار الصور. حاول مرة أخرى.";
            }
        }
        else if (JS != null)
        {
            // Fallback للويب - trigger InputFile click
            try
            {
                await JS.InvokeVoidAsync("eval", "document.querySelector('.ac-upload-area-fallback input[type=file]')?.click()");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[CreateListingPage] Error triggering file input: {ex.Message}");
            }
        }

        StateHasChanged();
    }

    /// <summary>
    /// معالجة نتائج MediaPicker ورفعها للخادم
    /// </summary>
    private async Task ProcessMediaPickerResults(List<MediaPickResult> results)
    {
        if (!results.Any()) return;

        _isUploadingImages = true;
        var totalFiles = results.Count;
        var processedFiles = 0;
        var failedFiles = 0;

        try
        {
            foreach (var result in results)
            {
                if (Model.Images.Count >= 10) break;

                processedFiles++;
                _uploadProgress = $"جاري ضغط ورفع {processedFiles} من {totalFiles}...";
                StateHasChanged();

                try
                {
                    if (result.OpenReadAsync != null && FilesClientService != null)
                    {
                        Stream streamToUpload;
                        string contentType = result.ContentType;
                        long originalSize = 0;
                        long compressedSize = 0;

                        // ضغط الصورة قبل الرفع إذا كانت خدمة الضغط متاحة
                        if (ImageCompressionService != null)
                        {
                            _uploadProgress = $"جاري ضغط {processedFiles} من {totalFiles}...";
                            StateHasChanged();

                            using var originalStream = await result.OpenReadAsync();
                            originalSize = originalStream.CanSeek ? originalStream.Length : 0;

                            Console.WriteLine($"[CreateListingPage] Compressing {result.FileName} (original: {originalSize / 1024.0:F2} KB)");

                            var compressionResult = await ImageCompressionService.CompressAsync(
                                originalStream,
                                maxWidth: 1920,
                                maxHeight: 1920,
                                quality: 75);

                            if (compressionResult.Success && compressionResult.Stream != null)
                            {
                                streamToUpload = compressionResult.Stream;
                                compressedSize = compressionResult.CompressedSize;
                                contentType = "image/jpeg"; // SkiaSharp يحول لـ JPEG
                                Console.WriteLine($"[CreateListingPage] Compressed to {compressedSize / 1024.0:F2} KB (saved {compressionResult.CompressionRatio:F1}%)");
                            }
                            else
                            {
                                Console.WriteLine($"[CreateListingPage] Compression failed: {compressionResult.ErrorMessage}, using original");
                                // في حالة فشل الضغط، نستخدم الصورة الأصلية
                                streamToUpload = await result.OpenReadAsync();
                            }
                        }
                        else
                        {
                            Console.WriteLine($"[CreateListingPage] ImageCompressionService not available, using original image");
                            streamToUpload = await result.OpenReadAsync();
                        }

                        _uploadProgress = $"جاري رفع {processedFiles} من {totalFiles}...";
                        StateHasChanged();

                        Console.WriteLine($"[CreateListingPage] Uploading {result.FileName} via FilesClient");

                        var uploadResult = await FilesClientService.UploadMediaAsync(
                            streamToUpload,
                            result.FileName.Replace(Path.GetExtension(result.FileName), ".jpg"),
                            contentType,
                            "listings");

                        // تنظيف stream الضغط
                        if (streamToUpload != null && ImageCompressionService != null)
                        {
                            await streamToUpload.DisposeAsync();
                        }

                        if (uploadResult != null && !string.IsNullOrEmpty(uploadResult.Url))
                        {
                            Console.WriteLine($"[CreateListingPage] Upload successful: {uploadResult.Url}");
                            Model.Images.Add(uploadResult.Url);
                            StateHasChanged();
                        }
                        else
                        {
                            Console.WriteLine($"[CreateListingPage] Upload returned null for {result.FileName}");
                            failedFiles++;
                        }
                    }
                    else
                    {
                        Console.WriteLine($"[CreateListingPage] Cannot upload: stream={result.OpenReadAsync != null}, FilesClient={FilesClientService != null}");
                        failedFiles++;
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[CreateListingPage] Error uploading {result.FileName}: {ex.Message}");
                    failedFiles++;
                }
            }

            if (failedFiles > 0)
            {
                _imageUploadError = $"تعذر رفع {failedFiles} صورة. حاول مرة أخرى.";
            }
        }
        finally
        {
            _isUploadingImages = false;
            _uploadProgress = "";
            StateHasChanged();
        }
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        if (_isUploadingImages) return;

        _imageUploadError = null;
        IReadOnlyList<IBrowserFile> files;

        try
        {
            files = e.GetMultipleFiles(10 - Model.Images.Count);
            if (!files.Any()) return;
        }
        catch (Exception ex)
        {
            // معالجة خطأ الوصول للكاميرا أو الملفات
            Console.WriteLine($"[CreateListingPage] Error accessing files/camera: {ex.Message}");
            _imageUploadError = "تعذر الوصول للصور. تأكد من منح التطبيق صلاحية الوصول للصور والكاميرا.";
            StateHasChanged();
            return;
        }

        _isUploadingImages = true;
        var totalFiles = files.Count;
        var processedFiles = 0;
        var failedFiles = 0;

        try
        {
            foreach (var file in files)
            {
                if (Model.Images.Count >= 10)
                {
                    break;
                }

                if (file.Size > MaxFileSize)
                {
                    Console.WriteLine($"File {file.Name} exceeds 10MB limit");
                    failedFiles++;
                    continue;
                }

                if (!file.ContentType.StartsWith("image/"))
                {
                    Console.WriteLine($"File {file.Name} is not an image");
                    failedFiles++;
                    continue;
                }

                processedFiles++;
                _uploadProgress = $"جاري رفع {processedFiles} من {totalFiles}...";
                StateHasChanged();

                try
                {
                    if (FilesClientService != null)
                    {
                        Stream streamToUpload;
                        string contentType = file.ContentType;

                        // ضغط الصورة قبل الرفع إذا كانت خدمة الضغط متاحة
                        if (ImageCompressionService != null)
                        {
                            _uploadProgress = $"جاري ضغط {processedFiles} من {totalFiles}...";
                            StateHasChanged();

                            using var originalStream = file.OpenReadStream(MaxFileSize);
                            Console.WriteLine($"[CreateListingPage] Compressing {file.Name} (original: {file.Size / 1024.0:F2} KB)");

                            var compressionResult = await ImageCompressionService.CompressAsync(
                                originalStream,
                                maxWidth: 1920,
                                maxHeight: 1920,
                                quality: 75);

                            if (compressionResult.Success && compressionResult.Stream != null)
                            {
                                streamToUpload = compressionResult.Stream;
                                contentType = "image/jpeg";
                                Console.WriteLine($"[CreateListingPage] Compressed to {compressionResult.CompressedSize / 1024.0:F2} KB (saved {compressionResult.CompressionRatio:F1}%)");
                            }
                            else
                            {
                                Console.WriteLine($"[CreateListingPage] Compression failed: {compressionResult.ErrorMessage}, using original");
                                streamToUpload = file.OpenReadStream(MaxFileSize);
                            }
                        }
                        else
                        {
                            streamToUpload = file.OpenReadStream(MaxFileSize);
                        }

                        _uploadProgress = $"جاري رفع {processedFiles} من {totalFiles}...";
                        StateHasChanged();

                        Console.WriteLine($"[CreateListingPage] Uploading {file.Name} via FilesClient");

                        var result = await FilesClientService.UploadMediaAsync(
                            streamToUpload,
                            file.Name.Replace(Path.GetExtension(file.Name), ".jpg"),
                            contentType,
                            "listings");

                        // تنظيف stream الضغط
                        if (ImageCompressionService != null)
                        {
                            await streamToUpload.DisposeAsync();
                        }

                        if (result != null && !string.IsNullOrEmpty(result.Url))
                        {
                            Console.WriteLine($"[CreateListingPage] Upload successful: {result.Url}");
                            Model.Images.Add(result.Url);
                            StateHasChanged();
                        }
                        else
                        {
                            Console.WriteLine($"[CreateListingPage] Upload returned null or empty URL for {file.Name}");
                            failedFiles++;
                        }
                    }
                    else if (Http != null)
                    {
                        // Fallback to HttpClient if FilesClient is not available
                        // Note: This requires HttpClient to have BaseAddress configured
                        using var stream = file.OpenReadStream(MaxFileSize);
                        using var content = new MultipartFormDataContent();
                        using var fileContent = new StreamContent(stream);
                        fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);
                        content.Add(fileContent, "file", file.Name);

                        // Add authorization token
                        var token = TokenManager != null ? await TokenManager.GetTokenAsync() : null;
                        Console.WriteLine($"[CreateListingPage] Token: {(string.IsNullOrEmpty(token) ? "NULL/EMPTY" : $"Bearer {token.Substring(0, Math.Min(20, token.Length))}...")}");

                        using var request = new HttpRequestMessage(HttpMethod.Post, "/api/media/upload?directory=listings");
                        request.Content = content;
                        if (!string.IsNullOrEmpty(token))
                        {
                            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
                        }

                        var response = await Http.SendAsync(request);
                        if (response.IsSuccessStatusCode)
                        {
                            var result = await response.Content.ReadFromJsonAsync<MediaUploadResult>();
                            if (result != null && !string.IsNullOrEmpty(result.Url))
                            {
                                Model.Images.Add(result.Url);
                                StateHasChanged();
                            }
                            else
                            {
                                failedFiles++;
                            }
                        }
                        else
                        {
                            var errorBody = await response.Content.ReadAsStringAsync();
                            Console.WriteLine($"Upload failed for {file.Name}: {response.StatusCode} - {errorBody}");
                            failedFiles++;
                        }
                    }
                    else
                    {
                        Console.WriteLine("FilesClient and HttpClient not available, falling back to base64");
                        using var stream = file.OpenReadStream(MaxFileSize);
                        using var memoryStream = new MemoryStream();
                        await stream.CopyToAsync(memoryStream);
                        var bytes = memoryStream.ToArray();
                        var base64 = Convert.ToBase64String(bytes);
                        var dataUrl = $"data:{file.ContentType};base64,{base64}";
                        Model.Images.Add(dataUrl);
                        StateHasChanged();
                    }
                }
                catch (UnauthorizedAccessException)
                {
                    Console.WriteLine($"[CreateListingPage] Permission denied for {file.Name}");
                    _imageUploadError = "تعذر الوصول للصورة. تأكد من منح صلاحيات الوصول.";
                    failedFiles++;
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error processing file {file.Name}: {ex.Message}");
                    failedFiles++;
                }
            }

            // عرض رسالة إذا فشل رفع بعض الصور
            if (failedFiles > 0 && string.IsNullOrEmpty(_imageUploadError))
            {
                _imageUploadError = $"تعذر رفع {failedFiles} صورة. حاول مرة أخرى.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[CreateListingPage] Critical error in image upload: {ex.Message}");
            _imageUploadError = "حدث خطأ أثناء رفع الصور. حاول مرة أخرى.";
        }
        finally
        {
            _isUploadingImages = false;
            _uploadProgress = "";
            StateHasChanged();
        }
    }

    private void RemoveImage(int index)
    {
        if (index >= 0 && index < Model.Images.Count)
        {
            Model.Images.RemoveAt(index);
            StateHasChanged();
        }
    }

    private void SetMainImage(int index)
    {
        if (index > 0 && index < Model.Images.Count)
        {
            var image = Model.Images[index];
            Model.Images.RemoveAt(index);
            Model.Images.Insert(0, image);
            StateHasChanged();
        }
    }

    private void ClearAllImages()
    {
        Model.Images.Clear();
        StateHasChanged();
    }

    private void OnAttributesChanged(List<ListingAttributeInput> values)
    {
        Model.Attributes = values;

        // Sync title
        var titleInput = values.FirstOrDefault(a => a.Code == "title");
        if (titleInput != null)
        {
            Model.Title = titleInput.TextValue ?? "";
        }

        StateHasChanged();
    }

    private void OnValidationChanged(bool isValid)
    {
        _isFormValid = isValid;
        StateHasChanged();
    }

    private async Task SubmitListing()
    {
        CurrentStep = CreateListingStep.Submitting;
        await OnSubmit.InvokeAsync(Model);
    }

    private async Task ViewListing()
    {
        if (CreatedListingId.HasValue)
        {
            await OnViewListing.InvokeAsync(CreatedListingId.Value);
        }
    }

    private void CreateAnother()
    {
        ResetForm();
        CurrentStep = CreateListingStep.SelectCategory;
    }

    private void RetrySubmit()
    {
        CurrentStep = CreateListingStep.Review;
    }

    private void ResetForm()
    {
        SelectedCategory = null;
        CategoryAttributes = null;
        Model = new CreateListingModel();
        CreatedListingId = null;
        ErrorMessage = null;
        _validationErrors.Clear();
        _hasReachedLocationStep = false;
    }

    private string GetAttributeDisplayValue(ListingAttributeInput input, ListingAttributeDefinition def)
    {
        if (input.MultiSelectValues?.Any() == true)
        {
            var displayValues = input.MultiSelectValues
                .Select(v => def.Values.FirstOrDefault(dv => dv.Value == v)?.DisplayName ?? v)
                .ToList();
            return string.Join("، ", displayValues);
        }

        if (input.BooleanValue.HasValue)
        {
            return input.BooleanValue.Value ? "نعم" : "لا";
        }

        if (input.DateValue.HasValue)
        {
            return input.DateValue.Value.ToString("yyyy/MM/dd");
        }

        if (input.NumberValue.HasValue)
        {
            return input.NumberValue.Value.ToString("N0");
        }

        if (!string.IsNullOrEmpty(input.TextValue))
        {
            // البحث عن DisplayName للقيم المحددة
            var displayName = def.Values.FirstOrDefault(v => v.Value == input.TextValue)?.DisplayName;
            return displayName ?? input.TextValue;
        }

        return "-";
    }

    private string GetAttributeIcon(string code)
    {
        return code.ToLower() switch
        {
            "price" or "min_budget" or "max_budget" => "bi-currency-dollar",
            "rooms" or "bedrooms" => "bi-door-open",
            "bathrooms" => "bi-droplet",
            "area" or "size" => "bi-aspect-ratio",
            "floor" => "bi-layers",
            "age" or "year" => "bi-calendar",
            "furnished" => "bi-lamp",
            "parking" => "bi-car-front",
            "elevator" => "bi-arrow-up-square",
            "pool" => "bi-water",
            "garden" => "bi-tree",
            "security" => "bi-shield-check",
            "ac" or "air_conditioning" => "bi-snow",
            "heating" => "bi-thermometer-sun",
            "internet" or "wifi" => "bi-wifi",
            "gym" => "bi-heart-pulse",
            "balcony" => "bi-grid-1x2",
            "city" or "location" => "bi-geo-alt",
            "neighborhood" or "district" => "bi-pin-map",
            "type" or "category" => "bi-tag",
            "gender" or "sex" => "bi-person",
            "nationality" => "bi-flag",
            "occupation" or "job" => "bi-briefcase",
            "smoking" => "bi-slash-circle",
            "pets" => "bi-heart",
            "phone" or "call" => "bi-telephone",
            "whatsapp" => "bi-whatsapp",
            "email" => "bi-envelope",
            "amenities" => "bi-stars",
            _ => "bi-info-circle"
        };
    }

    private class MediaUploadResult
    {
        public string ObjectName { get; set; } = string.Empty;
        public string Url { get; set; } = string.Empty;
        public string ContentType { get; set; } = string.Empty;
        public long Size { get; set; }
    }
}
