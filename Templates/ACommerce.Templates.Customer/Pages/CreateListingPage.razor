@namespace ACommerce.Templates.Customer.Pages
@using ACommerce.Templates.Customer.Components
@using Microsoft.JSInterop

<div class="ac-page ac-create-listing-page">
    @* Header *@
    <div class="ac-page-header">
        <div class="ac-header-content">
            @if (CurrentStep != CreateListingStep.SelectCategory && CurrentStep != CreateListingStep.Success)
            {
                <button class="ac-back-btn" @onclick="GoBack">
                    <i class="bi bi-arrow-right"></i>
                </button>
            }
            <h1 class="ac-page-title">
                @if (CurrentStep == CreateListingStep.SelectCategory)
                {
                    <span>إنشاء عرض جديد</span>
                }
                else if (SelectedCategory != null)
                {
                    <i class="bi @SelectedCategory.Icon"></i>
                    <span>@SelectedCategory.Name</span>
                }
            </h1>
        </div>
    </div>

    @* Progress Steps *@
    @if (CurrentStep != CreateListingStep.SelectCategory && CurrentStep != CreateListingStep.Success && CurrentStep != CreateListingStep.Error)
    {
        <div class="ac-progress-container">
            <div class="ac-progress-bar">
                <div class="ac-progress-fill" style="width: @GetProgressPercentage()%"></div>
            </div>
            <div class="ac-progress-steps">
                <div class="ac-step @(CurrentStep >= CreateListingStep.FillDetails ? "active" : "") @(CurrentStep > CreateListingStep.FillDetails ? "completed" : "")">
                    <div class="ac-step-icon">
                        @if (CurrentStep > CreateListingStep.FillDetails)
                        {
                            <i class="bi bi-check"></i>
                        }
                        else
                        {
                            <span>1</span>
                        }
                    </div>
                    <span class="ac-step-label">التفاصيل</span>
                </div>
                <div class="ac-step @(CurrentStep >= CreateListingStep.AddImages ? "active" : "") @(CurrentStep > CreateListingStep.AddImages ? "completed" : "")">
                    <div class="ac-step-icon">
                        @if (CurrentStep > CreateListingStep.AddImages)
                        {
                            <i class="bi bi-check"></i>
                        }
                        else
                        {
                            <span>2</span>
                        }
                    </div>
                    <span class="ac-step-label">الصور</span>
                </div>
                <div class="ac-step @(CurrentStep >= CreateListingStep.SetLocation ? "active" : "") @(CurrentStep > CreateListingStep.SetLocation ? "completed" : "")">
                    <div class="ac-step-icon">
                        @if (CurrentStep > CreateListingStep.SetLocation)
                        {
                            <i class="bi bi-check"></i>
                        }
                        else
                        {
                            <span>3</span>
                        }
                    </div>
                    <span class="ac-step-label">الموقع</span>
                </div>
                <div class="ac-step @(CurrentStep >= CreateListingStep.Review ? "active" : "")">
                    <div class="ac-step-icon">
                        <span>4</span>
                    </div>
                    <span class="ac-step-label">مراجعة</span>
                </div>
            </div>
        </div>
    }

    @* Content based on current step *@
    <div class="ac-page-content">
        @switch (CurrentStep)
        {
            case CreateListingStep.SelectCategory:
                <div class="ac-category-selection">
                    <div class="ac-section-header">
                        <i class="bi bi-grid-3x3-gap"></i>
                        <h2>اختر نوع العرض</h2>
                    </div>
                    <p class="ac-section-desc">حدد الفئة المناسبة لعرضك للوصول لأكبر شريحة من المهتمين</p>

                    <div class="ac-category-grid">
                        @if (Categories != null)
                        {
                            @foreach (var category in Categories)
                            {
                                <div class="ac-category-card" @onclick="() => SelectCategory(category)">
                                    <div class="ac-category-icon-wrapper">
                                        @if (!string.IsNullOrEmpty(category.Icon))
                                        {
                                            <i class="bi @category.Icon"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-folder"></i>
                                        }
                                    </div>
                                    <div class="ac-category-info">
                                        <h3 class="ac-category-name">@category.Name</h3>
                                        @if (!string.IsNullOrEmpty(category.Description))
                                        {
                                            <p class="ac-category-desc">@category.Description</p>
                                        }
                                    </div>
                                    <i class="bi bi-chevron-left ac-category-arrow"></i>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="ac-loading-card">
                                <AcSpinner Text="جاري تحميل الفئات..." />
                            </div>
                        }
                    </div>
                </div>
                break;

            case CreateListingStep.FillDetails:
                <div class="ac-details-form">
                    <div class="ac-form-section">
                        <div class="ac-section-header">
                            <i class="bi bi-card-text"></i>
                            <h2>تفاصيل العرض</h2>
                        </div>
                        <p class="ac-section-desc">أدخل المعلومات الأساسية لعرضك</p>
                    </div>

                    @* Validation Alert *@
                    @if (!IsLoadingAttributes && ValidationErrorCount > 0)
                    {
                        <div class="ac-validation-alert">
                            <div class="ac-alert-icon">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                            </div>
                            <div class="ac-alert-content">
                                <span class="ac-alert-title">يوجد @ValidationErrorCount @(ValidationErrorCount == 1 ? "حقل مطلوب" : "حقول مطلوبة") غير مكتمل</span>
                                <span class="ac-alert-desc">أكمل الحقول المحددة بـ (*) للمتابعة</span>
                            </div>
                        </div>
                    }

                    @* Dynamic attributes based on category - including title *@
                    @if (IsLoadingAttributes)
                    {
                        <div class="ac-loading-section">
                            <AcSpinner Text="جاري تحميل الخصائص..." />
                        </div>
                    }
                    else if (FilteredAttributes != null && FilteredAttributes.Any())
                    {
                        <div class="ac-attributes-container">
                            <AcDynamicForm Attributes="@FilteredAttributes"
                                           Values="@Model.Attributes"
                                           ValuesChanged="OnAttributesChanged"
                                           OnValidationChanged="OnValidationChanged" />
                        </div>
                    }
                    else
                    {
                        <div class="ac-empty-section">
                            <i class="bi bi-inbox"></i>
                            <p>لا توجد خصائص محددة لهذه الفئة</p>
                        </div>
                    }

                    <div class="ac-form-actions">
                        <AcButton Text="التالي"
                                  IconEnd="bi-arrow-left"
                                  OnClick="GoToImages"
                                  FullWidth="true"
                                  Disabled="@(!IsDetailsValid)" />
                    </div>
                </div>
                break;

            case CreateListingStep.AddImages:
                <div class="ac-images-section">
                    <div class="ac-form-section">
                        <div class="ac-section-header">
                            <i class="bi bi-images"></i>
                            <h2>صور العرض</h2>
                        </div>
                        <p class="ac-section-desc">أضف صوراً واضحة وجذابة لعرضك (حتى 10 صور)</p>
                    </div>

                    <div class="ac-upload-container">
                        <label class="ac-upload-area @(Model.Images.Any() ? "has-images" : "")" for="imageUpload">
                            <div class="ac-upload-content">
                                <div class="ac-upload-icon">
                                    <i class="bi bi-cloud-arrow-up"></i>
                                </div>
                                <div class="ac-upload-text">
                                    <span class="ac-upload-title">اضغط لإضافة صور</span>
                                    <span class="ac-upload-hint">PNG, JPG حتى 5MB</span>
                                </div>
                            </div>
                            <input type="file"
                                   id="imageUpload"
                                   accept="image/*"
                                   multiple
                                   @onchange="HandleImageUpload"
                                   style="display: none" />
                        </label>
                    </div>

                    @if (Model.Images.Any())
                    {
                        <div class="ac-images-preview">
                            <div class="ac-preview-header">
                                <span class="ac-preview-count">
                                    <i class="bi bi-image"></i>
                                    @Model.Images.Count من 10 صور
                                </span>
                                @if (Model.Images.Count > 0)
                                {
                                    <button class="ac-clear-all" @onclick="ClearAllImages">
                                        <i class="bi bi-trash"></i>
                                        حذف الكل
                                    </button>
                                }
                            </div>
                            <div class="ac-image-grid">
                                @foreach (var (image, index) in Model.Images.Select((img, i) => (img, i)))
                                {
                                    <div class="ac-image-item @(index == 0 ? "main-image" : "")">
                                        @if (index == 0)
                                        {
                                            <span class="ac-main-badge">الصورة الرئيسية</span>
                                        }
                                        <img src="@image" alt="صورة @(index + 1)" />
                                        <div class="ac-image-overlay">
                                            <button class="ac-image-action" @onclick="() => SetMainImage(index)" title="تعيين كصورة رئيسية">
                                                <i class="bi bi-star"></i>
                                            </button>
                                            <button class="ac-image-action delete" @onclick="() => RemoveImage(index)" title="حذف">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="ac-no-images">
                            <i class="bi bi-image"></i>
                            <p>لم تقم بإضافة أي صور بعد</p>
                            <small>الصور تساعد في جذب المزيد من المهتمين</small>
                        </div>
                    }

                    <div class="ac-form-actions">
                        <AcButton Text="التالي"
                                  IconEnd="bi-arrow-left"
                                  OnClick="GoToLocation"
                                  FullWidth="true" />
                    </div>
                </div>
                break;

            case CreateListingStep.SetLocation:
                <div class="ac-location-section">
                    <div class="ac-form-section">
                        <div class="ac-section-header">
                            <i class="bi bi-geo-alt"></i>
                            <h2>موقع العرض</h2>
                        </div>
                        <p class="ac-section-desc">حرّك الخريطة واضغط لتحديد موقع عرضك بدقة</p>
                    </div>

                    <div class="ac-location-card">
                        @* Interactive Map Component *@
                        <AcInteractiveMap @ref="_mapComponent"
                                          Latitude="@Model.Latitude"
                                          LatitudeChanged="(lat) => Model.Latitude = lat"
                                          Longitude="@Model.Longitude"
                                          LongitudeChanged="(lng) => Model.Longitude = lng"
                                          OnLocationSelected="OnLocationSelectedFromMap"
                                          OnRequestCurrentLocation="RequestLocation"
                                          Height="280"
                                          ShowControls="true"
                                          Interactive="true" />

                        <div style="margin-top: 16px;">
                            <AcInput Id="address"
                                     Label="العنوان التفصيلي (اختياري)"
                                     Placeholder="مثال: حي النرجس، شارع الأمير سلطان"
                                     Value="@Model.Address"
                                     ValueChanged="(v) => Model.Address = v"
                                     IconStart="bi-signpost" />
                        </div>
                    </div>

                    <div class="ac-form-actions">
                        <AcButton Text="التالي"
                                  IconEnd="bi-arrow-left"
                                  OnClick="GoToReview"
                                  FullWidth="true" />
                    </div>
                </div>
                break;

            case CreateListingStep.Review:
                <div class="ac-review-section">
                    <div class="ac-form-section">
                        <div class="ac-section-header">
                            <i class="bi bi-eye"></i>
                            <h2>معاينة العرض</h2>
                        </div>
                        <p class="ac-section-desc">راجع عرضك كما سيظهر للآخرين</p>
                    </div>

                    @* Preview Card - Professional Design *@
                    <div class="ac-listing-preview-card">
                        @* Image Gallery Preview *@
                        <div class="ac-preview-gallery">
                            @if (Model.Images.Any())
                            {
                                <div class="ac-gallery-main">
                                    <img src="@Model.Images.First()" alt="صورة العرض" />
                                    <div class="ac-gallery-badge">
                                        <i class="bi bi-images"></i>
                                        <span>@Model.Images.Count</span>
                                    </div>
                                </div>
                                @if (Model.Images.Count > 1)
                                {
                                    <div class="ac-gallery-thumbs">
                                        @foreach (var img in Model.Images.Skip(1).Take(4))
                                        {
                                            <div class="ac-thumb-item">
                                                <img src="@img" alt="" />
                                            </div>
                                        }
                                        @if (Model.Images.Count > 5)
                                        {
                                            <div class="ac-thumb-more">
                                                <span>+@(Model.Images.Count - 5)</span>
                                            </div>
                                        }
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="ac-gallery-empty">
                                    <i class="bi bi-image"></i>
                                    <span>لا توجد صور</span>
                                </div>
                            }
                        </div>

                        @* Category & Type Badge *@
                        <div class="ac-preview-badges">
                            <span class="ac-type-badge">
                                <i class="bi @SelectedCategory?.Icon"></i>
                                @SelectedCategory?.Name
                            </span>
                        </div>

                        @* Main Info Section *@
                        <div class="ac-preview-main-info">
                            <h2 class="ac-preview-title">@GetTitleFromAttributes()</h2>

                            @if (!string.IsNullOrEmpty(Model.Address))
                            {
                                <div class="ac-preview-location">
                                    <i class="bi bi-geo-alt-fill"></i>
                                    <span>@Model.Address</span>
                                </div>
                            }
                            else if (Model.Latitude.HasValue && Model.Longitude.HasValue)
                            {
                                <div class="ac-preview-location">
                                    <i class="bi bi-geo-alt-fill"></i>
                                    <span>موقع محدد على الخريطة</span>
                                </div>
                            }
                        </div>

                        @* Attributes Grid *@
                        @{
                            var displayAttributes = Model.Attributes
                                .Where(a => a.Code != "title" && a.Code != "description" && HasDisplayValue(a))
                                .Select(a => new { Input = a, Def = CategoryAttributes?.FirstOrDefault(d => d.Id == a.AttributeId) })
                                .Where(x => x.Def != null)
                                .ToList();
                        }
                        @if (displayAttributes.Any())
                        {
                            <div class="ac-preview-attrs-section">
                                <h3 class="ac-attrs-title">
                                    <i class="bi bi-list-check"></i>
                                    تفاصيل العرض
                                </h3>
                                <div class="ac-attrs-grid">
                                    @foreach (var attr in displayAttributes)
                                    {
                                        <div class="ac-attr-card">
                                            <div class="ac-attr-icon">
                                                <i class="bi @GetAttributeIcon(attr.Def!.Code)"></i>
                                            </div>
                                            <div class="ac-attr-content">
                                                <span class="ac-attr-label">@attr.Def!.Name</span>
                                                <span class="ac-attr-value">@GetAttributeDisplayValue(attr.Input, attr.Def!)</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @* Description Section *@
                        @{
                            var descAttr = Model.Attributes.FirstOrDefault(a => a.Code == "description");
                            if (!string.IsNullOrEmpty(descAttr?.TextValue))
                            {
                                <div class="ac-preview-desc-section">
                                    <h3 class="ac-desc-title">
                                        <i class="bi bi-text-paragraph"></i>
                                        الوصف
                                    </h3>
                                    <p class="ac-desc-text">@descAttr.TextValue</p>
                                </div>
                            }
                        }

                        @* Location Map Preview *@
                        @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
                        {
                            <div class="ac-preview-map-section">
                                <h3 class="ac-map-title">
                                    <i class="bi bi-pin-map"></i>
                                    الموقع
                                </h3>

                                @* Static Map Preview *@
                                <AcInteractiveMap Latitude="@Model.Latitude"
                                                  Longitude="@Model.Longitude"
                                                  Height="150"
                                                  ShowControls="false"
                                                  Interactive="false"
                                                  DefaultZoom="15" />

                                @if (!string.IsNullOrEmpty(Model.Address))
                                {
                                    <div class="ac-preview-address">
                                        <i class="bi bi-geo-alt"></i>
                                        <span>@Model.Address</span>
                                    </div>
                                }

                                @* Open in Native Maps Button *@
                                <button type="button" class="ac-open-maps-btn" @onclick="OpenInNativeMaps">
                                    <i class="bi bi-map"></i>
                                    <span>فتح في الخرائط</span>
                                </button>
                            </div>
                        }
                    </div>

                    <div class="ac-form-actions">
                        <AcButton Text="نشر العرض"
                                  IconStart="bi-send"
                                  OnClick="SubmitListing"
                                  FullWidth="true"
                                  Variant="ButtonVariant.Primary" />
                    </div>
                </div>
                break;

            case CreateListingStep.Submitting:
                <div class="ac-submitting-section">
                    <AcSpinner Size="SpinnerSize.Large" Text="جاري نشر العرض..." />
                </div>
                break;

            case CreateListingStep.Success:
                <div class="ac-success-section">
                    <div class="ac-success-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <h2>تم نشر العرض بنجاح!</h2>
                    <p>سيظهر عرضك للمستخدمين الآن</p>

                    <div class="ac-form-actions">
                        <AcButton Text="عرض التفاصيل"
                                  OnClick="ViewListing"
                                  FullWidth="true"
                                  Variant="ButtonVariant.Primary" />
                        <AcButton Text="إنشاء عرض آخر"
                                  OnClick="CreateAnother"
                                  FullWidth="true"
                                  Variant="ButtonVariant.Secondary" />
                    </div>
                </div>
                break;

            case CreateListingStep.Error:
                <div class="ac-error-section">
                    <div class="ac-error-icon">
                        <i class="bi bi-x-circle-fill"></i>
                    </div>
                    <h2>حدث خطأ</h2>
                    <p>@ErrorMessage</p>

                    <div class="ac-form-actions">
                        <AcButton Text="حاول مرة أخرى"
                                  OnClick="RetrySubmit"
                                  FullWidth="true" />
                    </div>
                </div>
                break;
        }
    </div>
</div>

@code {
    [Parameter] public List<ListingCategory>? Categories { get; set; }
    [Parameter] public EventCallback<Guid> OnLoadCategoryAttributes { get; set; }
    [Parameter] public EventCallback<CreateListingModel> OnSubmit { get; set; }
    [Parameter] public EventCallback<Guid> OnViewListing { get; set; }
    [Parameter] public EventCallback OnRequestLocation { get; set; }
    [Parameter] public EventCallback<InputFileChangeEventArgs> OnImageUpload { get; set; }

    public CreateListingStep CurrentStep { get; set; } = CreateListingStep.SelectCategory;
    public ListingCategory? SelectedCategory { get; set; }
    public List<ListingAttributeDefinition>? CategoryAttributes { get; set; }
    public CreateListingModel Model { get; set; } = new();
    public bool IsLoadingAttributes { get; set; }
    public string? ErrorMessage { get; set; }
    public Guid? CreatedListingId { get; set; }
    private bool _isFormValid = true;
    private Dictionary<string, string> _validationErrors = new();
    private AcInteractiveMap? _mapComponent;

    // Filter out images attribute - it's handled separately
    private List<ListingAttributeDefinition>? FilteredAttributes =>
        CategoryAttributes?.Where(a => a.Code != "images").ToList();

    // Count of validation errors (required fields not filled)
    private int ValidationErrorCount
    {
        get
        {
            if (FilteredAttributes == null) return 0;

            var count = 0;
            var requiredAttributes = FilteredAttributes.Where(a => a.IsRequired).ToList();
            foreach (var attr in requiredAttributes)
            {
                var input = Model.Attributes.FirstOrDefault(v => v.AttributeId == attr.Id);
                if (input == null || !HasValue(input))
                    count++;
            }
            return count;
        }
    }

    // Validation: check required fields including title from dynamic attributes
    private bool IsDetailsValid
    {
        get
        {
            if (FilteredAttributes == null) return false;

            var requiredAttributes = FilteredAttributes.Where(a => a.IsRequired).ToList();
            foreach (var attr in requiredAttributes)
            {
                var input = Model.Attributes.FirstOrDefault(v => v.AttributeId == attr.Id);
                if (input == null || !HasValue(input))
                    return false;
            }
            return _isFormValid;
        }
    }

    private bool HasValue(ListingAttributeInput input) =>
        !string.IsNullOrEmpty(input.TextValue) ||
        input.NumberValue.HasValue ||
        input.BooleanValue.HasValue ||
        input.DateValue.HasValue ||
        (input.MultiSelectValues?.Any() ?? false);

    private bool HasDisplayValue(ListingAttributeInput input) =>
        HasValue(input) &&
        !(input.BooleanValue == false && !input.NumberValue.HasValue && string.IsNullOrEmpty(input.TextValue));

    private int GetProgressPercentage() => CurrentStep switch
    {
        CreateListingStep.FillDetails => 25,
        CreateListingStep.AddImages => 50,
        CreateListingStep.SetLocation => 75,
        CreateListingStep.Review => 100,
        _ => 0
    };

    private string GetTitleFromAttributes()
    {
        var titleAttr = Model.Attributes.FirstOrDefault(a => a.Code == "title");
        return titleAttr?.TextValue ?? "عرض جديد";
    }

    public void SetCategories(List<ListingCategory> categories)
    {
        Categories = categories;
        StateHasChanged();
    }

    public void SetCategoryAttributes(List<ListingAttributeDefinition> attributes)
    {
        CategoryAttributes = attributes;
        IsLoadingAttributes = false;

        // Set title in Model.Title from attributes for backwards compatibility
        var titleAttr = attributes.FirstOrDefault(a => a.Code == "title");
        if (titleAttr != null)
        {
            var existingInput = Model.Attributes.FirstOrDefault(a => a.Code == "title");
            if (existingInput == null)
            {
                Model.Attributes.Add(new ListingAttributeInput
                {
                    AttributeId = titleAttr.Id,
                    Code = "title",
                    TextValue = Model.Title
                });
            }
        }

        StateHasChanged();
    }

    public async Task SetLocation(double latitude, double longitude, string? address = null)
    {
        Model.Latitude = latitude;
        Model.Longitude = longitude;
        if (!string.IsNullOrEmpty(address))
        {
            Model.Address = address;
        }

        // Update the map component if it exists
        if (_mapComponent != null)
        {
            await _mapComponent.SetLocation(latitude, longitude);
        }

        StateHasChanged();
    }

    public void SetCreatedListingId(Guid id)
    {
        CreatedListingId = id;
        CurrentStep = CreateListingStep.Success;
        StateHasChanged();
    }

    public void SetError(string message)
    {
        ErrorMessage = message;
        CurrentStep = CreateListingStep.Error;
        StateHasChanged();
    }

    public void AddImage(string imageUrl)
    {
        if (Model.Images.Count < 10)
        {
            Model.Images.Add(imageUrl);
            StateHasChanged();
        }
    }

    private async Task SelectCategory(ListingCategory category)
    {
        SelectedCategory = category;
        Model.CategoryId = category.Id;
        CurrentStep = CreateListingStep.FillDetails;
        IsLoadingAttributes = true;
        await OnLoadCategoryAttributes.InvokeAsync(category.Id);
    }

    private void GoBack()
    {
        CurrentStep = CurrentStep switch
        {
            CreateListingStep.FillDetails => CreateListingStep.SelectCategory,
            CreateListingStep.AddImages => CreateListingStep.FillDetails,
            CreateListingStep.SetLocation => CreateListingStep.AddImages,
            CreateListingStep.Review => CreateListingStep.SetLocation,
            CreateListingStep.Error => CreateListingStep.Review,
            _ => CurrentStep
        };

        if (CurrentStep == CreateListingStep.SelectCategory)
        {
            ResetForm();
        }
    }

    private void GoToImages()
    {
        // Sync title from attributes to Model.Title for backwards compatibility
        var titleInput = Model.Attributes.FirstOrDefault(a => a.Code == "title");
        if (titleInput != null)
        {
            Model.Title = titleInput.TextValue ?? "";
        }
        CurrentStep = CreateListingStep.AddImages;
    }

    private void GoToLocation()
    {
        CurrentStep = CreateListingStep.SetLocation;
    }

    private void GoToReview()
    {
        CurrentStep = CreateListingStep.Review;
    }

    private async Task RequestLocation()
    {
        await OnRequestLocation.InvokeAsync();
    }

    private void OnMapClick()
    {
        // No longer needed - handled by AcInteractiveMap component
    }

    private void OnLocationSelectedFromMap((double Lat, double Lng) location)
    {
        Model.Latitude = location.Lat;
        Model.Longitude = location.Lng;
        StateHasChanged();
    }

    [Inject] private IJSRuntime? JS { get; set; }

    private async Task OpenInNativeMaps()
    {
        if (Model.Latitude.HasValue && Model.Longitude.HasValue && JS != null)
        {
            var label = GetTitleFromAttributes() ?? "الموقع";
            await JS.InvokeVoidAsync("AcMap.openNativeMaps", Model.Latitude.Value, Model.Longitude.Value, label);
        }
    }

    private async Task HandleImageUpload(ChangeEventArgs e)
    {
        // يتم التعامل مع رفع الصور في التطبيق المضيف
        // هذا placeholder فقط
    }

    private void RemoveImage(int index)
    {
        if (index >= 0 && index < Model.Images.Count)
        {
            Model.Images.RemoveAt(index);
            StateHasChanged();
        }
    }

    private void SetMainImage(int index)
    {
        if (index > 0 && index < Model.Images.Count)
        {
            var image = Model.Images[index];
            Model.Images.RemoveAt(index);
            Model.Images.Insert(0, image);
            StateHasChanged();
        }
    }

    private void ClearAllImages()
    {
        Model.Images.Clear();
        StateHasChanged();
    }

    private void OnAttributesChanged(List<ListingAttributeInput> values)
    {
        Model.Attributes = values;

        // Sync title
        var titleInput = values.FirstOrDefault(a => a.Code == "title");
        if (titleInput != null)
        {
            Model.Title = titleInput.TextValue ?? "";
        }

        StateHasChanged();
    }

    private void OnValidationChanged(bool isValid)
    {
        _isFormValid = isValid;
        StateHasChanged();
    }

    private async Task SubmitListing()
    {
        CurrentStep = CreateListingStep.Submitting;
        await OnSubmit.InvokeAsync(Model);
    }

    private async Task ViewListing()
    {
        if (CreatedListingId.HasValue)
        {
            await OnViewListing.InvokeAsync(CreatedListingId.Value);
        }
    }

    private void CreateAnother()
    {
        ResetForm();
        CurrentStep = CreateListingStep.SelectCategory;
    }

    private void RetrySubmit()
    {
        CurrentStep = CreateListingStep.Review;
    }

    private void ResetForm()
    {
        SelectedCategory = null;
        CategoryAttributes = null;
        Model = new CreateListingModel();
        CreatedListingId = null;
        ErrorMessage = null;
        _validationErrors.Clear();
    }

    private string GetAttributeDisplayValue(ListingAttributeInput input, ListingAttributeDefinition def)
    {
        if (input.MultiSelectValues?.Any() == true)
        {
            var displayValues = input.MultiSelectValues
                .Select(v => def.Values.FirstOrDefault(dv => dv.Value == v)?.DisplayName ?? v)
                .ToList();
            return string.Join("، ", displayValues);
        }

        if (input.BooleanValue.HasValue)
        {
            return input.BooleanValue.Value ? "نعم" : "لا";
        }

        if (input.DateValue.HasValue)
        {
            return input.DateValue.Value.ToString("yyyy/MM/dd");
        }

        if (input.NumberValue.HasValue)
        {
            return input.NumberValue.Value.ToString("N0");
        }

        if (!string.IsNullOrEmpty(input.TextValue))
        {
            // البحث عن DisplayName للقيم المحددة
            var displayName = def.Values.FirstOrDefault(v => v.Value == input.TextValue)?.DisplayName;
            return displayName ?? input.TextValue;
        }

        return "-";
    }

    private string GetAttributeIcon(string code)
    {
        return code.ToLower() switch
        {
            "price" or "min_budget" or "max_budget" => "bi-currency-dollar",
            "rooms" or "bedrooms" => "bi-door-open",
            "bathrooms" => "bi-droplet",
            "area" or "size" => "bi-aspect-ratio",
            "floor" => "bi-layers",
            "age" or "year" => "bi-calendar",
            "furnished" => "bi-lamp",
            "parking" => "bi-car-front",
            "elevator" => "bi-arrow-up-square",
            "pool" => "bi-water",
            "garden" => "bi-tree",
            "security" => "bi-shield-check",
            "ac" or "air_conditioning" => "bi-snow",
            "heating" => "bi-thermometer-sun",
            "internet" or "wifi" => "bi-wifi",
            "gym" => "bi-heart-pulse",
            "balcony" => "bi-grid-1x2",
            "city" or "location" => "bi-geo-alt",
            "neighborhood" or "district" => "bi-pin-map",
            "type" or "category" => "bi-tag",
            "gender" or "sex" => "bi-person",
            "nationality" => "bi-flag",
            "occupation" or "job" => "bi-briefcase",
            "smoking" => "bi-slash-circle",
            "pets" => "bi-heart",
            "phone" or "call" => "bi-telephone",
            "whatsapp" => "bi-whatsapp",
            "email" => "bi-envelope",
            "amenities" => "bi-stars",
            _ => "bi-info-circle"
        };
    }
}
