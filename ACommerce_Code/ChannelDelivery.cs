using ACommerce.Notifications.Abstractions.Enums;

namespace ACommerce.Notifications.Abstractions.Models;

/// <summary>
/// ???? ???? ????? ??????? ??? ???? ?????
/// </summary>
public class ChannelDelivery
{
	/// <summary>
	/// ?????? ????????? ???????
	/// </summary>
	public required NotificationChannel Channel { get; init; }

	/// <summary>
	/// ???? ??????? ???????
	/// </summary>
	public DeliveryStatus Status { get; set; } = DeliveryStatus.Pending;

	/// <summary>
	/// ??? ????????? ???? ???
	/// </summary>
	public int RetryCount { get; set; } = 0;

	/// <summary>
	/// ???? ?????? ???? ?????????
	/// </summary>
	public int MaxRetries { get; init; } = 3;

	/// <summary>
	/// ????? ??????? ??? ?? ?????? (??? ???????? ?? ?? ??????)
	/// </summary>
	public TimeSpan RetryDelay { get; init; } = TimeSpan.FromMinutes(5);

	/// <summary>
	/// ????? ??? ?????? ?????
	/// </summary>
	public DateTimeOffset? LastAttemptAt { get; set; }

	/// <summary>
	/// ????? ???????? ??????? ???????
	/// </summary>
	public DateTimeOffset? NextRetryAt { get; set; }

	/// <summary>
	/// ????? ??????? ??????
	/// </summary>
	public DateTimeOffset? SentAt { get; set; }

	/// <summary>
	/// ????? ????? ?? ???? ?????
	/// </summary>
	public string? ErrorMessage { get; set; }

	/// <summary>
	/// ?????? ?????? ???? ??????? (??? Message ID ?? Firebase)
	/// </summary>
	public Dictionary<string, object>? Metadata { get; set; }

	/// <summary>
	/// ??????? ????????? ?? ??????
	/// </summary>
	public string? ResponseData { get; set; }

	/// <summary>
	/// ?? ???? ????? ?????????
	/// </summary>
	public bool CanRetry()
	{
		if (Status != DeliveryStatus.Failed)
			return false;

		if (RetryCount >= MaxRetries)
			return false;

		if (NextRetryAt.HasValue && NextRetryAt.Value > DateTimeOffset.UtcNow)
			return false;

		return true;
	}

	/// <summary>
	/// ????? ?????? ????? ????? ???? ???????? ???????
	/// </summary>
	public void RecordFailure(string error)
	{
		Status = DeliveryStatus.Failed;
		ErrorMessage = error;
		LastAttemptAt = DateTimeOffset.UtcNow;
		RetryCount++;

		// Exponential backoff: RetryDelay * (2 ^ RetryCount)
		var delayMultiplier = Math.Pow(2, RetryCount - 1);
		var nextDelay = TimeSpan.FromTicks((long)(RetryDelay.Ticks * delayMultiplier));

		NextRetryAt = DateTimeOffset.UtcNow.Add(nextDelay);
	}

	/// <summary>
	/// ????? ?????? ?????
	/// </summary>
	public void RecordSuccess(Dictionary<string, object>? metadata = null, string? responseData = null)
	{
		Status = DeliveryStatus.Sent;
		SentAt = DateTimeOffset.UtcNow;
		LastAttemptAt = DateTimeOffset.UtcNow;
		ErrorMessage = null;
		Metadata = metadata;
		ResponseData = responseData;
	}

	/// <summary>
	/// ??? ????? ??? ???????
	/// </summary>
	public void MarkAsSending()
	{
		Status = DeliveryStatus.Sending;
		LastAttemptAt = DateTimeOffset.UtcNow;
	}

	/// <summary>
	/// ??? ????? ????? ????????
	/// </summary>
	public void MarkAsExpired()
	{
		Status = DeliveryStatus.Expired;
	}
}

